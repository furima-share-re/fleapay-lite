# 手数料率マスタ 運用手順書

**作成日**: 2025 年 1 月  
**対象**: 運用担当者

---

## 📋 概要

`fee_rate_master`テーブルは、プラン別の手数料率を管理するマスタテーブルです。

---

## 🔧 手数料率の変更手順

### 基本方針

**未来予約はしない（変更日は手動で切替）**

### 変更手順

将来「来月から手数料変更」をしたい場合:

1. **変更日当日に新しいレコードをINSERT**
   ```sql
   INSERT INTO fee_rate_master (plan_type, fee_rate, effective_from)
   VALUES ('standard', 0.0800, now());
   ```
   - `effective_to`は`NULL`のまま（現在適用中を意味する）

2. **古いレコードの`effective_to`を更新**
   ```sql
   UPDATE fee_rate_master
   SET effective_to = now() - interval '1 second'
   WHERE plan_type = 'standard'
     AND effective_to IS NULL
     AND id != (SELECT id FROM fee_rate_master WHERE plan_type = 'standard' AND effective_to IS NULL ORDER BY effective_from DESC LIMIT 1);
   ```
   - 過去日時を設定して、有効期間を終了させる

### 注意事項

- 同一プランで`effective_to IS NULL`のレコードは1件のみ（ユニーク制約）
- 新しいレコードをINSERTする前に、古いレコードの`effective_to`を更新すること
- 変更は手動で行う（自動バッチは使用しない）

---

## 🔄 代替運用案

別テーブル/別列で管理し、切替バッチで`effective_to`を埋める運用も可能です。

---

## 📝 関連ドキュメント

- `supabase/migrations/20250116_120000_create_fee_rate_master.sql` - テーブル定義
- `手数料徴収機能実装_レビュー資料.md` - 実装詳細

---

**最終更新**: 2025 年 1 月


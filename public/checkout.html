<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FleaPay â€“ Checkout</title>
  <!-- Brand Fonts: Nunito Sans + Noto Sans JP -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Nunito+Sans:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    /* =====================
       FleaPay Brand Tokens
       (v5.0 aligned)
       ===================== */
    :root{
      /* Core */
      --shin-ai:#1B365D;       /* æ·±è— â€“ trust */
      --kinari:#FBF7F0;        /* ç”Ÿæˆã‚Š â€“ warmth */
      --sumi:#1A1A1A;          /* å¢¨ â€“ body */
      --usuzumi:#666666;       /* è–„å¢¨ â€“ helper */
      /* Triggers */
      --hakken:#E63946;        /* ç™ºè¦‹ãƒ¬ãƒƒãƒ‰ â€“ CTA only */
      --kintsugi:#B8902E;      /* é‡‘ç¶™ãã‚´ãƒ¼ãƒ«ãƒ‰ â€“ accent */
      /* UI state */
      --ok:#2D5B3F;
      --warn:#B8860B;
      --err:#8B2635;
      /* Effect */
      --card-shadow:0 10px 30px rgba(27,54,93,.10);
      --radius-xl:20px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: "Nunito Sans", "Noto Sans JP", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--sumi);
      background: var(--kinari);
      background-image: radial-gradient(1200px 700px at 80% -10%, rgba(230,57,70,.06) 0%, transparent 60%),
                        radial-gradient(1200px 700px at -20% 110%, rgba(27,54,93,.08) 0%, transparent 60%);
    }
    /* å’Œç´™ã®å¾®ç´°ãƒã‚¤ã‚º */
    body::before{
      content:"";position:fixed;inset:0;pointer-events:none;opacity:.25;z-index:-1;
      background-image: radial-gradient(circle at 25% 25%, rgba(255,255,255,.9) 1px, transparent 1px),
                        radial-gradient(circle at 75% 75%, rgba(27,54,93,.12) 1px, transparent 1px);
      background-size:60px 60px,80px 80px;
    }

    .container{max-width:640px;margin:0 auto;padding:20px}

    /* ==== App Bar with Brand Logo ==== */
    .appbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .logo{display:flex;gap:8px;align-items:baseline;user-select:none}
    .logo__wordmark{
      font-family:"Nunito Sans", system-ui;
      font-weight:900;letter-spacing:.03em;line-height:1;
      color:var(--shin-ai);
    }
    .logo__wordmark .pay{color:var(--kintsugi)} /* é‡‘ç¶™ãã¯æ–‡å­—è£…é£¾ã®ã¿ã«ä½¿ç”¨ */
    .logo__sparkle{font-size:14px;opacity:.9;margin-left:2px}
    .app-actions{display:flex;gap:8px}

    /* Language toggle */
    .lang-switch{display:flex;gap:4px;background:rgba(255,255,255,.6);border:1px solid rgba(27,54,93,.15);border-radius:999px;padding:3px}
    .lang-btn{width:34px;height:34px;border:0;background:transparent;border-radius:50%;font-size:14px;cursor:pointer}
    .lang-btn:focus-visible{outline:3px solid rgba(230,57,70,.45)}
    .lang-btn.active{background:rgba(27,54,93,.08)}

    /* ==== Card ==== */
    .card{
      position:relative;background:#fff;border:1px solid rgba(27,54,93,.12);
      border-radius:var(--radius-xl);padding:20px;box-shadow:var(--card-shadow);overflow:hidden
    }

    /* Sakura minimal accents (2% rule) */
    .card::after{content:"ğŸŒ¸";position:absolute;bottom:40px;right:24px;font-size:16px;opacity:.45;animation:sway 4s ease-in-out infinite}
    @keyframes sway{0%,100%{transform:translateY(0) rotate(0)}50%{transform:translateY(-6px) rotate(5deg)}}

    .header{padding:8px 0 12px}
    .header h1{margin:8px 0 2px;font-size:24px;letter-spacing:.04em;color:var(--shin-ai)}
    .sub-message{margin:0;color:var(--usuzumi);font-size:14px}

    /* ==== Price Box (Value Typography) ==== */
    .priceBox{
      background:linear-gradient(180deg,#fff, #fafbff);
      border:2px solid transparent;border-radius:var(--radius-xl);padding:22px 18px;position:relative;overflow:hidden;margin:10px 0 14px
    }
    .priceBox::before{content:"";position:absolute;left:0;right:0;top:0;height:3px;opacity:.9;
      background:linear-gradient(90deg,var(--hakken) 0%, #ff8a65 25%, var(--shin-ai) 50%, #5c7cfa 75%, var(--hakken) 100%)}

    .priceHead{display:grid;grid-template-columns:auto 1fr;align-items:end;gap:10px}
    .ccy{font-size:12px;letter-spacing:.12em;color:#475569;border:1px solid rgba(27,54,93,.15);border-radius:999px;padding:4px 8px;background:#fff}
    .price{font-weight:900;font-size:48px;letter-spacing:1px;line-height:1;margin:8px 0;
      background:linear-gradient(135deg,var(--shin-ai),var(--hakken));
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .summary{margin:12px 0 0;font-size:13px;color:#334155;white-space:pre-line}
    .summary-title{margin:12px 0 0;font-size:13px;font-weight:700;color:#0f172a}

    /* ==== Loading shimmer ==== */
    .loading{position:relative;color:transparent}
    .loading::after{content:"";position:absolute;inset:0;border-radius:6px;background:linear-gradient(90deg,#eef2f7 25%,#f7f9fc 37%,#eef2f7 63%);background-size:400% 100%;animation:shimmer 1.2s infinite}
    @keyframes shimmer{0%{background-position:100% 0}100%{background-position:0 0}}

    .progress{position:fixed;top:0;left:0;height:3px;width:0;background:linear-gradient(90deg,#ff7a5a,#ffb06b);box-shadow:0 0 10px rgba(255,122,90,.6);transition:width .3s ease;z-index:9999}
    body.loading .progress{width:65%}
    body.ready .progress{width:100%;transition:width .4s ease .2s}

    /* ==== CTA Button (Impulse Typography) ==== */
    .btn{width:100%;border:0;border-radius:12px;padding:14px 16px;background:linear-gradient(135deg,var(--shin-ai) 0%, #243B6B 100%);
      color:#fff;font-size:18px;font-weight:900;letter-spacing:.04em;position:relative;overflow:hidden;box-shadow:0 8px 25px rgba(27,54,93,.25);
      cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;transition:transform .12s ease, box-shadow .12s ease}
    .btn:disabled{opacity:.6;cursor:not-allowed;filter:grayscale(.15)}
    .btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 12px 35px rgba(27,54,93,.32)}
    .btn.heartbeat{animation:heartbeat 0.8s ease-in-out infinite}
    @keyframes heartbeat{0%{transform:scale(1)}40%{transform:scale(1.04)}100%{transform:scale(1)}}
    .btn:focus-visible{outline:3px solid rgba(230,57,70,.6);outline-offset:2px}

    /* ==== LP Link Below Button ==== */
    .lp-link-wrapper{
      margin-top:12px;
      padding-top:12px;
      border-top:1px solid rgba(27,54,93,.08);
      text-align:center;
    }
    .lp-link{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:13px;
      font-weight:700;
      color:var(--shin-ai);
      text-decoration:none;
      background:linear-gradient(135deg, rgba(27,54,93,.05), rgba(27,54,93,.08));
      border:1px solid rgba(27,54,93,.15);
      border-radius:999px;
      padding:8px 16px;
      transition:all .2s ease;
    }
    .lp-link:hover{
      background:linear-gradient(135deg, rgba(27,54,93,.08), rgba(27,54,93,.12));
      border-color:rgba(27,54,93,.25);
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(27,54,93,.15);
    }
    .lp-link:focus-visible{
      outline:3px solid rgba(230,57,70,.45);
      outline-offset:2px;
    }
    .lp-link::before{
      content:"â„¹ï¸";
      font-size:15px;
    }

    .brands{display:flex;gap:10px;justify-content:center;align-items:center;margin-top:10px;flex-wrap:wrap}
    .brand-icon{padding:4px 8px;font-size:11px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:6px;color:#64748b}

    /* ==== Trust Badges ==== */
    .security-badges{display:flex;justify-content:center;gap:16px;margin:16px 0;flex-wrap:wrap}
    .security-badge{display:flex;align-items:center;gap:6px;background:#fff;border:1px solid #e7f3ff;border-radius:999px;padding:8px 12px;font-size:12px;color:var(--shin-ai);box-shadow:0 2px 8px rgba(0,0,0,.05)}
    .security-icon{width:16px;height:16px;color:#10b981}

    .note-block{margin-top:12px;font-size:11px;color:#64748b;line-height:1.6}
    .note-block p{margin:2px 0}

    /* ==== Themes by time ==== */
    .theme-evening{background-image:radial-gradient(1200px 700px at 80% -10%, rgba(255,212,163,.18) 0%, transparent 60%),
                                     radial-gradient(1200px 700px at -20% 110%, rgba(230,238,249,.25) 0%, transparent 60%)}
    .theme-night{background:#0f172a;color:#f8fafc}
    .theme-night .card{background:rgba(255,255,255,.96);backdrop-filter:blur(10px)}

    /* ==== Empty State: Guide Screen ==== */
    .empty-state-view {
      text-align: center;
      padding: 32px 20px;
      animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* æ¡œã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .sakura-float {
      font-size: 36px;
      animation: sakura-gentle 3s ease-in-out infinite;
      display: block;
      margin-bottom: 16px;
    }

    @keyframes sakura-gentle {
      0%, 100% { 
        transform: translateY(0) rotate(-5deg);
        opacity: 0.6;
      }
      50% { 
        transform: translateY(-8px) rotate(5deg);
        opacity: 0.9;
      }
    }

    /* ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    .main-message {
      margin-bottom: 32px;
    }

    .exciting-title {
      font-family: 'Nunito Sans', 'Noto Sans JP', sans-serif;
      font-weight: 700;
      font-size: 24px;
      color: var(--hakken);
      letter-spacing: 0.02em;
      margin: 0 0 8px 0;
      animation: gentle-pulse 1.5s ease-in-out infinite;
    }

    @keyframes gentle-pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.03); }
    }

    .sub-title {
      font-family: 'Nunito Sans', 'Noto Sans JP', sans-serif;
      font-weight: 600;
      font-size: 16px;
      color: var(--shin-ai);
      margin: 0;
      line-height: 1.5;
    }

    /* 3ã‚¹ãƒ†ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰ */
    .steps-guide {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 28px;
    }

    .step-card {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 16px;
      background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(251,247,240,0.8));
      border: 1px solid rgba(27,54,93,0.12);
      border-radius: 12px;
      text-align: left;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .step-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .step-discover::before { background: #4A90E2; }
    .step-communicate::before { background: #F5A623; }
    .step-payment::before { background: var(--kintsugi); }

    .step-card:hover {
      transform: translateX(4px);
      box-shadow: 0 4px 12px rgba(27,54,93,0.1);
    }

    .step-card:hover::before {
      opacity: 1;
    }

    .step-icon {
      font-size: 28px;
      flex-shrink: 0;
      animation: icon-bounce 2s ease-in-out infinite;
    }

    @keyframes icon-bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-4px); }
    }

    .step-content {
      flex: 1;
    }

    .step-title {
      font-family: 'Nunito Sans', 'Noto Sans JP', sans-serif;
      font-weight: 700;
      font-size: 15px;
      color: var(--shin-ai);
      margin: 0 0 4px 0;
      letter-spacing: 0.01em;
    }

    .step-desc {
      font-family: 'Nunito Sans', 'Noto Sans JP', sans-serif;
      font-weight: 400;
      font-size: 13px;
      color: var(--usuzumi);
      margin: 0;
      line-height: 1.5;
    }

    /* ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .security-section {
      margin: 24px 0;
      border-top: 1px solid rgba(27,54,93,0.08);
      padding-top: 20px;
    }

    .security-toggle {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 16px;
      background: linear-gradient(135deg, rgba(27,54,93,0.05), rgba(27,54,93,0.08));
      border: 1px solid rgba(27,54,93,0.15);
      border-radius: 999px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Nunito Sans', 'Noto Sans JP', sans-serif;
      font-weight: 700;
      font-size: 14px;
      color: var(--shin-ai);
    }

    .security-toggle:hover {
      background: linear-gradient(135deg, rgba(27,54,93,0.08), rgba(27,54,93,0.12));
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(27,54,93,0.15);
    }

    .security-toggle:focus-visible {
      outline: 3px solid rgba(230,57,70,0.45);
      outline-offset: 2px;
    }

    .toggle-icon {
      font-size: 16px;
    }

    .toggle-arrow {
      font-size: 12px;
      transition: transform 0.3s ease;
      margin-left: 4px;
    }

    .security-toggle[aria-expanded="true"] .toggle-arrow {
      transform: rotate(180deg);
    }

    .security-details {
      margin-top: 16px;
      padding: 16px;
      background: rgba(255,255,255,0.6);
      border: 1px solid rgba(27,54,93,0.08);
      border-radius: 12px;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .security-item {
      margin-bottom: 16px;
      text-align: left;
    }

    .security-item:last-of-type {
      margin-bottom: 12px;
    }

    .security-badge-mini {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }

    .security-icon-mini {
      width: 16px;
      height: 16px;
      color: #10b981;
    }

    .security-icon-text {
      font-size: 16px;
    }

    .security-badge-mini span {
      font-family: 'Nunito Sans', 'Noto Sans JP', sans-serif;
      font-weight: 700;
      font-size: 13px;
      color: var(--shin-ai);
    }

    .security-explain {
      font-family: 'Nunito Sans', 'Noto Sans JP', sans-serif;
      font-size: 12px;
      color: var(--usuzumi);
      margin: 0 0 0 22px;
      line-height: 1.5;
    }

    .security-link {
      display: inline-flex;
      align-items: center;
      margin-top: 8px;
      padding: 8px 16px;
      font-family: 'Nunito Sans', 'Noto Sans JP', sans-serif;
      font-weight: 700;
      font-size: 13px;
      color: var(--shin-ai);
      text-decoration: none;
      background: rgba(27,54,93,0.05);
      border-radius: 999px;
      transition: all 0.2s ease;
    }

    .security-link:hover {
      background: rgba(27,54,93,0.1);
      transform: translateX(2px);
    }

    /* ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ’ãƒ³ãƒˆ */
    .refresh-hint {
      margin-top: 24px;
      padding-top: 16px;
    }

    .kintsugi-line-pulse {
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--kintsugi), transparent);
      margin-bottom: 8px;
      animation: pulse-line 2s ease-in-out infinite;
    }

    @keyframes pulse-line {
      0%, 100% { 
        opacity: 0.4;
        transform: scaleX(0.5);
      }
      50% { 
        opacity: 1;
        transform: scaleX(1);
      }
    }

    .hint-text {
      font-family: 'Nunito Sans', 'Noto Sans JP', sans-serif;
      font-size: 12px;
      color: var(--usuzumi);
      margin: 0;
      font-style: italic;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
    @media (max-width: 480px) {
      .empty-state-view {
        padding: 24px 16px;
      }
      
      .exciting-title {
        font-size: 21px;
      }
      
      .sub-title {
        font-size: 15px;
      }
      
      .step-card {
        padding: 14px;
      }
      
      .step-icon {
        font-size: 24px;
      }
    }

    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å‰Šæ¸›å¯¾å¿œ */
    @media (prefers-reduced-motion: reduce) {
      .sakura-float,
      .exciting-title,
      .gentle-pulse,
      .icon-bounce,
      .kintsugi-line-pulse,
      .sway,
      .heartbeat {
        animation: none;
      }
    }

    /* Helpers */
    .muted{color:#64748b}
    .center{text-align:center}
    .mt8{margin-top:8px}.mt16{margin-top:16px}.mt24{margin-top:24px}
  </style>
</head>
<body class="loading">
  <div class="progress" aria-hidden="true"></div>
  <div class="container">
    <div class="appbar" role="banner">
      <div class="logo" aria-label="FleaPay">
        <div class="logo__wordmark" style="font-size:20px">
          Flea<span class="pay">Pay</span>
        </div>
        <span class="logo__sparkle" aria-hidden="true">âœ¨</span>
      </div>
      <div class="app-actions">
        <div class="lang-switch" role="group" aria-label="Language">
          <button class="lang-btn active" data-lang="ja" aria-label="æ—¥æœ¬èª">ğŸ‡¯ğŸ‡µ</button>
          <button class="lang-btn" data-lang="en" aria-label="English">ğŸ‡ºğŸ‡¸</button>
          <button class="lang-btn" data-lang="zh" aria-label="ä¸­æ–‡">ğŸ‡¨ğŸ‡³</button>
        </div>
      </div>
    </div>

    <div class="card" role="main">
      <header class="header">
        <h1 class="welcome-message" data-lang-content data-lang-key="welcome">ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›!</h1>
      </header>

      <section class="priceBox" id="priceBox" aria-live="polite">
        <!-- é€šå¸¸è¡¨ç¤º(å•†å“ã‚ã‚Š) -->
        <div id="normalView" class="normal-view">
          <div class="priceHead">
            <span class="ccy">JPY</span>
            <div id="amount" class="price loading" aria-label="åˆè¨ˆé‡‘é¡">â€”</div>
          </div>
          <p id="summary" class="summary muted loading"></p>
        </div>

        <!-- ç©ºçŠ¶æ…‹è¡¨ç¤º(å•†å“ãªã—) -->
        <div id="emptyView" class="empty-state-view" style="display: none;">
          
          <!-- æ¡œã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ -->
          <div class="sakura-float" aria-hidden="true">ğŸŒ¸</div>
          
          <!-- ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
          <div class="main-message">
            <h2 class="exciting-title" data-lang-content data-lang-key="emptyTitle">
              ã¡ã‚‡ã£ã¨å¾…ã£ã¦!
            </h2>
            <p class="sub-title" data-lang-content data-lang-key="emptySubtitle">
              ã¾ã å®ç‰©ã‚’é¸ã‚“ã§ã„ãªã„ã‚ˆ?
            </p>
          </div>

          <!-- 3ã‚¹ãƒ†ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰ -->
          <div class="steps-guide">
            
            <!-- Step 1 -->
            <div class="step-card step-discover">
              <div class="step-icon">ğŸ“</div>
              <div class="step-content">
                <h3 class="step-title" data-lang-content data-lang-key="step1Title">
                  Step 1: å®ç‰©ã‚’è¦‹ã¤ã‘ã‚ˆã†
                </h3>
                <p class="step-desc" data-lang-content data-lang-key="step1Desc">
                  ãŠæ°—ã«å…¥ã‚Šã®å•†å“ã‚’æ¢ã—ã¦ã­
                </p>
              </div>
            </div>

            <!-- Step 2 -->
            <div class="step-card step-communicate">
              <div class="step-icon">ğŸ’¬</div>
              <div class="step-content">
                <h3 class="step-title" data-lang-content data-lang-key="step2Title">
                  Step 2: å‡ºåº—è€…ã•ã‚“ã«ä¼ãˆã‚ˆã†
                </h3>
                <p class="step-desc" data-lang-content data-lang-key="step2Desc">
                  ã€Œã“ã‚Œãã ã•ã„!ã€ã¨ä¼ãˆã¦ã­
                </p>
              </div>
            </div>

            <!-- Step 3 -->
            <div class="step-card step-payment">
              <div class="step-icon">âœ¨</div>
              <div class="step-content">
                <h3 class="step-title" data-lang-content data-lang-key="step3Title">
                  Step 3: å®‰å¿ƒæ±ºæ¸ˆ
                </h3>
                <p class="step-desc" data-lang-content data-lang-key="step3Desc">
                  å‡ºåº—è€…ã•ã‚“ãŒæº–å‚™ã—ãŸã‚‰ã“ã®QRã§æ±ºæ¸ˆã§ãã‚‹ã‚ˆ!
                </p>
              </div>
            </div>

          </div>

          <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ”ãƒ¼ãƒ«(æŠ˜ã‚ŠãŸãŸã¿å¼) -->
          <div class="security-section">
            <button class="security-toggle" id="securityToggle" aria-expanded="false">
              <span class="toggle-icon">ğŸ”’</span>
              <span class="toggle-text" data-lang-content data-lang-key="securityQuestion">
                FleaPayã¯å®‰å…¨?
              </span>
              <span class="toggle-arrow">â–¼</span>
            </button>
            
            <div class="security-details" id="securityDetails" style="display: none;">
              <div class="security-item">
                <div class="security-badge-mini">
                  <svg class="security-icon-mini" viewBox="0 0 24 24" fill="none">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" stroke="currentColor" stroke-width="2"/>
                  </svg>
                  <span data-lang-content data-lang-key="securityBadge1">SSLæš—å·åŒ–</span>
                </div>
                <p class="security-explain" data-lang-content data-lang-key="securityExplain1">
                  ã‚«ãƒ¼ãƒ‰æƒ…å ±ã¯æœ€é«˜æ°´æº–ã§ä¿è­·
                </p>
              </div>
              
              <div class="security-item">
                <div class="security-badge-mini">
                  <svg class="security-icon-mini" viewBox="0 0 24 24" fill="none">
                    <rect x="3" y="11" width="18" height="11" rx="2" stroke="currentColor" stroke-width="2"/>
                    <circle cx="12" cy="16" r="1" fill="currentColor"/>
                  </svg>
                  <span data-lang-content data-lang-key="securityBadge2">Stripeèªè¨¼</span>
                </div>
                <p class="security-explain" data-lang-content data-lang-key="securityExplain2">
                  ä¸–ç•Œä¸­ã§ä½¿ã‚ã‚Œã‚‹æ±ºæ¸ˆã‚·ã‚¹ãƒ†ãƒ 
                </p>
              </div>
              
              <div class="security-item">
                <div class="security-badge-mini">
                  <span class="security-icon-text">ğŸ’³</span>
                  <span data-lang-content data-lang-key="securityBadge3">æƒ…å ±ä¿å­˜ãªã—</span>
                </div>
                <p class="security-explain" data-lang-content data-lang-key="securityExplain3">
                  ã‚«ãƒ¼ãƒ‰ç•ªå·ã¯FleaPayã«ä¿å­˜ã•ã‚Œã¾ã›ã‚“
                </p>
              </div>

              <!-- LPèª˜å° -->
              <a href="https://thajlmrw.gensparkspace.com/" target="_blank" rel="noopener noreferrer" class="security-link" data-lang-content data-lang-key="securityLearnMore">
                ã‚‚ã£ã¨è©³ã—ãè¦‹ã‚‹ â†’
              </a>
            </div>
          </div>

          <!-- ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ’ãƒ³ãƒˆ(è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤ä¸­) -->
          <div class="refresh-hint">
            <div class="kintsugi-line-pulse"></div>
            <p class="hint-text" data-lang-content data-lang-key="refreshHint">
              å‡ºåº—è€…ã•ã‚“ã®æº–å‚™ã‚’å¾…ã£ã¦ã„ã¾ã™â€¦
            </p>
          </div>

        </div>
      </section>

      <div class="security-badges">
        <div class="security-badge">
          <svg class="security-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" stroke="currentColor" stroke-width="2"/>
          </svg>
          <span data-lang-content data-lang-key="ssl">SSLæš—å·åŒ–</span>
        </div>
        <div class="security-badge">
          <svg class="security-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>
            <circle cx="12" cy="16" r="1" fill="currentColor"/>
            <path d="M7 11V7a5 5 0 0 1 10 0v4" stroke="currentColor" stroke-width="2"/>
          </svg>
          <span data-lang-content data-lang-key="stripe">Stripeèªè¨¼</span>
        </div>
      </div>

      <div class="mt8">
        <p class="muted" style="text-align:center; font-size:13px; margin-top:6px; margin-bottom:12px; line-height:1.6;" data-lang-content data-lang-key="stripeRedirect">
          ã“ã®ã‚ã¨ã€å®‰å…¨ãª Stripe ã®æ±ºæ¸ˆç”»é¢ã«ç§»å‹•ã—ã¾ã™ã€‚æ¬¡ã®ç”»é¢ã§ã‚«ãƒ¼ãƒ‰ç•ªå· â†’ æœ‰åŠ¹æœŸé™ â†’ åç¾©(ãƒ­ãƒ¼ãƒå­—)ã‚’å…¥åŠ›ã—ã¦ã€Šæ”¯æ‰•ã†ã€‹ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
        </p>
        <button id="payBtn" class="btn heartbeat" disabled>
          <svg aria-hidden="true" viewBox="0 0 24 24" width="18" height="18">
            <path d="M5 12h14M13 5l7 7-7 7" fill="none" stroke="currentColor" stroke-width="2"/>
          </svg>
          <span id="payLabel">Pay Now</span>
        </button>
        
        <!-- LP Link Below Button -->
        <div class="lp-link-wrapper">
          <a href="https://thajlmrw.gensparkspace.com/" target="_blank" rel="noopener noreferrer" class="lp-link" data-lang-content data-lang-key="about">
            FleaPayã«ã¤ã„ã¦
          </a>
        </div>
        
        <div class="note-block" aria-live="polite">
          <p data-lang-content data-lang-key="confirm1">ãƒ»é–“é•ã„ãŒãªã„ã‹ã”ç¢ºèªãã ã•ã„</p>
          <p data-lang-content data-lang-key="confirm2">ãƒ»å•†å“å—ã‘å–ã‚Šå¾Œã®è¿”å“ãƒ»äº¤æ›ã¯ã§ãã¾ã›ã‚“</p>
          <p data-lang-content data-lang-key="safety">ğŸ”’ ã“ã®æ±ºæ¸ˆã¯ Stripe ã®å›½éš›åŸºæº–ã§ä¿è­·ã•ã‚Œã¦ã„ã¾ã™ã€‚ã‚«ãƒ¼ãƒ‰æƒ…å ±ã¯ FleaPay ã«ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚</p>
        </div>
        <div class="brands" aria-hidden="true">
          <div class="brand-icon">Visa</div>
          <div class="brand-icon">Mastercard</div>
          <div class="brand-icon">Apple Pay</div>
          <div class="brand-icon">Google Pay</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---- Time-based theme ----
    (function(){
      const hour = new Date().getHours();
      let timeTheme = 'day';
      if (hour >= 18 || hour < 6) timeTheme = 'night';
      else if (hour >= 16) timeTheme = 'evening';
      document.body.classList.add('theme-' + timeTheme);
    })();

    // ---- i18n ----
    const languages = {
      ja: { 
        welcome: 'ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›!',
        enjoy: 'ãƒ•ãƒªãƒã¨ãŠç¥­ã‚Šã‚’ãŠæ¥½ã—ã¿ãã ã•ã„ ğŸ†',
        pay: '{amount} ã‚’æ”¯æ‰•ã†',
        fetching: 'å‡¦ç†ä¸­...',
        errorCheckout: 'æ±ºæ¸ˆå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
        errorRateLimit: 'ã‚¢ã‚¯ã‚»ã‚¹ãŒé›†ä¸­ã—ã¦ã„ã¾ã™ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
        errorNotFound: 'æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚å‡ºåº—è€…ã«ç¢ºèªã—ã¦ãã ã•ã„ã€‚',
        errorForbidden: 'ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚',
        ssl: 'SSLæš—å·åŒ–',
        stripe: 'Stripeèªè¨¼',
        summaryTitle: 'ğŸ› ã”è³¼å…¥å†…å®¹(å‡ºåº—è€…ãŒç¢ºèªæ¸ˆã¿ã§ã™)',
        confirm1: 'ãƒ»é–“é•ã„ãŒãªã„ã‹ã”ç¢ºèªãã ã•ã„',
        confirm2: 'ãƒ»å•†å“å—ã‘å–ã‚Šå¾Œã®è¿”å“ãƒ»äº¤æ›ã¯ã§ãã¾ã›ã‚“',
        safety: 'ğŸ”’ ã“ã®æ±ºæ¸ˆã¯ Stripe ã®å›½éš›åŸºæº–ã§ä¿è­·ã•ã‚Œã¦ã„ã¾ã™ã€‚ã‚«ãƒ¼ãƒ‰æƒ…å ±ã¯ FleaPay ã«ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚',
        note: 'è¡¨ç¤ºã®å¤–è²¨æ›ç®—ã¯å‚è€ƒå€¤ã§ã™ã€‚å®Ÿéš›ã®æ±ºæ¸ˆã¯ã™ã¹ã¦æ—¥æœ¬å††(JPY)ã§è¡Œã‚ã‚Œã¾ã™ã€‚ã“ã®ç”»é¢ã¯ã€å‡ºåº—è€…ã‹ã‚‰å—ã‘å–ã£ãŸå•†å“ã®æ”¯æ‰•ã„ç”»é¢ã§ã™ã€‚',
        about: 'FleaPayã«ã¤ã„ã¦',
        emptyTitle: 'ã¡ã‚‡ã£ã¨å¾…ã£ã¦!',
        emptySubtitle: 'ã¾ã å®ç‰©ã‚’é¸ã‚“ã§ã„ãªã„ã‚ˆ?',
        step1Title: 'Step 1: å®ç‰©ã‚’è¦‹ã¤ã‘ã‚ˆã†',
        step1Desc: 'ãŠæ°—ã«å…¥ã‚Šã®å•†å“ã‚’æ¢ã—ã¦ã­',
        step2Title: 'Step 2: å‡ºåº—è€…ã•ã‚“ã«ä¼ãˆã‚ˆã†',
        step2Desc: 'ã€Œã“ã‚Œãã ã•ã„!ã€ã¨ä¼ãˆã¦ã­',
        step3Title: 'Step 3: å®‰å¿ƒæ±ºæ¸ˆ',
        step3Desc: 'å‡ºåº—è€…ã•ã‚“ãŒæº–å‚™ã—ãŸã‚‰ã“ã®QRã§æ±ºæ¸ˆã§ãã‚‹ã‚ˆ!',
        securityQuestion: 'FleaPayã¯å®‰å…¨?',
        securityBadge1: 'SSLæš—å·åŒ–',
        securityExplain1: 'ã‚«ãƒ¼ãƒ‰æƒ…å ±ã¯æœ€é«˜æ°´æº–ã§ä¿è­·',
        securityBadge2: 'Stripeèªè¨¼',
        securityExplain2: 'ä¸–ç•Œä¸­ã§ä½¿ã‚ã‚Œã‚‹æ±ºæ¸ˆã‚·ã‚¹ãƒ†ãƒ ',
        securityBadge3: 'æƒ…å ±ä¿å­˜ãªã—',
        securityExplain3: 'ã‚«ãƒ¼ãƒ‰ç•ªå·ã¯FleaPayã«ä¿å­˜ã•ã‚Œã¾ã›ã‚“',
        securityLearnMore: 'ã‚‚ã£ã¨è©³ã—ãè¦‹ã‚‹ â†’',
        refreshHint: 'å‡ºåº—è€…ã•ã‚“ã®æº–å‚™ã‚’å¾…ã£ã¦ã„ã¾ã™â€¦',
        stripeRedirect: 'ã“ã®ã‚ã¨ã€å®‰å…¨ãª Stripe ã®æ±ºæ¸ˆç”»é¢ã«ç§»å‹•ã—ã¾ã™ã€‚æ¬¡ã®ç”»é¢ã§ã‚«ãƒ¼ãƒ‰ç•ªå· â†’ æœ‰åŠ¹æœŸé™ â†’ åç¾©(ãƒ­ãƒ¼ãƒå­—)ã‚’å…¥åŠ›ã—ã¦ã€Šæ”¯æ‰•ã†ã€‹ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚'
      },
      en: { 
        welcome: 'Welcome!',
        enjoy: 'Enjoy the flea market & festival ğŸ†',
        pay: 'Pay {amount}',
        fetching: 'Processing...',
        errorCheckout: 'Payment processing error occurred. Please try again.',
        errorRateLimit: 'Too many requests. Please wait a moment and try again.',
        errorNotFound: 'Order not found. Please check with the seller.',
        errorForbidden: 'Access denied.',
        ssl: 'SSL encryption',
        stripe: 'Powered by Stripe',
        summaryTitle: 'ğŸ› Items to purchase (confirmed by seller)',
        confirm1: 'ãƒ»Please check that the items and amount are correct.',
        confirm2: 'ãƒ»Returns or exchanges are not available after you receive the item.',
        safety: 'ğŸ”’ Payments are processed securely by Stripe. Your card details are not stored by FleaPay.',
        note: 'Any foreign currency shown is indicative only. Your payment is charged in Japanese yen (JPY). This is the payment screen for the items you selected from the seller.',
        about: 'About FleaPay',
        emptyTitle: 'Wait a moment!',
        emptySubtitle: "Haven't chosen your treasure yet?",
        step1Title: 'Step 1: Find Your Treasure',
        step1Desc: 'Look for your favorite items',
        step2Title: 'Step 2: Tell the Seller',
        step2Desc: 'Say "I want this!"',
        step3Title: 'Step 3: Safe Payment',
        step3Desc: 'Once the seller is ready, pay with this QR!',
        securityQuestion: 'Is FleaPay Safe?',
        securityBadge1: 'SSL Encrypted',
        securityExplain1: 'Your card info is protected',
        securityBadge2: 'Stripe Certified',
        securityExplain2: 'Trusted payment system worldwide',
        securityBadge3: 'No Storage',
        securityExplain3: 'Card numbers not saved by FleaPay',
        securityLearnMore: 'Learn More â†’',
        refreshHint: 'Waiting for seller preparationâ€¦',
        stripeRedirect: 'You will be redirected to Stripe\'s secure payment page next. On the next Stripe page, enter your card number â†’ expiry date â†’ name, then press Pay.'
      },
      zh: { 
        welcome: 'æ¬¢è¿å…‰ä¸´!',
        enjoy: 'ç¥æ‚¨åœ¨é›†å¸‚å’Œç¥­å…¸ç©å¾—å¼€å¿ƒ ğŸ†',
        pay: 'æ”¯ä»˜ {amount}',
        fetching: 'å¤„ç†ä¸­...',
        errorCheckout: 'æ”¯ä»˜å¤„ç†å‡ºé”™ã€‚è¯·å†è¯•ä¸€æ¬¡ã€‚',
        errorRateLimit: 'è®¿é—®è¿‡äºé¢‘ç¹ã€‚è¯·ç¨å€™å†è¯•ã€‚',
        errorNotFound: 'æœªæ‰¾åˆ°è®¢å•ã€‚è¯·ä¸æ‘‡ä¸»ç¡®è®¤ã€‚',
        errorForbidden: 'è®¿é—®è¢«æ‹’ç»ã€‚',
        ssl: 'SSL åŠ å¯†',
        stripe: 'Stripe ä¿éšœ',
        summaryTitle: 'ğŸ› è´­ä¹°å†…å®¹(å·²ç”±æ‘Šä¸»ç¡®è®¤)',
        confirm1: 'ãƒ»è¯·ç¡®è®¤å•†å“å’Œé‡‘é¢æ˜¯å¦æ­£ç¡®ã€‚',
        confirm2: 'ãƒ»å•†å“é¢†å–åæ— æ³•é€€è´§æˆ–æ¢è´§ã€‚',
        safety: 'ğŸ”’ æœ¬æ¬¡æ”¯ä»˜ç”± Stripe å®‰å…¨å¤„ç†,æ‚¨çš„å¡ä¿¡æ¯ä¸ä¼šä¿å­˜åœ¨ FleaPayã€‚',
        note: 'ç”»é¢ä¸Šçš„å¤–å¸æ¢ç®—ä»…ä¾›å‚è€ƒ,å®é™…æ‰£æ¬¾è´§å¸ä¸ºæ—¥å…ƒ(JPY)ã€‚æ­¤ç”»é¢ä¸ºæ‚¨å‘æ‘Šä¸»è´­ä¹°å•†å“çš„æ”¯ä»˜é¡µé¢ã€‚',
        about: 'å…³äºFleaPay',
        emptyTitle: 'ç­‰ä¸€ä¸‹!',
        emptySubtitle: 'è¿˜æ²¡æœ‰é€‰å¥½å®ç‰©å—?',
        step1Title: 'Step 1: å‘ç°å®ç‰©',
        step1Desc: 'å¯»æ‰¾ä½ å–œæ¬¢çš„å•†å“',
        step2Title: 'Step 2: å‘Šè¯‰æ‘Šä¸»',
        step2Desc: 'è¯´"æˆ‘è¦è¿™ä¸ª!"',
        step3Title: 'Step 3: å®‰å…¨æ”¯ä»˜',
        step3Desc: 'æ‘Šä¸»å‡†å¤‡å¥½å,ç”¨è¿™ä¸ªQRç æ”¯ä»˜!',
        securityQuestion: 'FleaPayå®‰å…¨å—?',
        securityBadge1: 'SSLåŠ å¯†',
        securityExplain1: 'å¡ç‰‡ä¿¡æ¯å—åˆ°æœ€é«˜çº§åˆ«ä¿æŠ¤',
        securityBadge2: 'Stripeè®¤è¯',
        securityExplain2: 'å…¨çƒä¿¡èµ–çš„æ”¯ä»˜ç³»ç»Ÿ',
        securityBadge3: 'ä¸ä¿å­˜ä¿¡æ¯',
        securityExplain3: 'FleaPayä¸ä¿å­˜å¡å·',
        securityLearnMore: 'äº†è§£æ›´å¤š â†’',
        refreshHint: 'æ­£åœ¨ç­‰å¾…æ‘Šä¸»å‡†å¤‡â€¦',
        stripeRedirect: 'æ¥ä¸‹æ¥ä¼šè·³è½¬åˆ° Stripe å®‰å…¨æ”¯ä»˜é¡µé¢ã€‚åœ¨ Stripe é¡µé¢è¾“å…¥ å¡å· â†’ æœ‰æ•ˆæœŸ â†’ å§“å(æ‹¼éŸ³),ç„¶åç‚¹å‡»ã€æ”¯ä»˜ã€‘ã€‚'
      }
    };
    let currentLang = 'ja';

    function switchLanguage(lang) {
      currentLang = languages[lang] ? lang : 'ja';
      document.querySelectorAll('[data-lang-content]').forEach(el => {
        const key = el.dataset.langKey;
        if (languages[currentLang] && languages[currentLang][key]) {
          el.textContent = languages[currentLang][key];
        }
      });
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === currentLang);
      });
      if (window.__amountInt) updatePayLabel(window.__amountInt);
    }

    // URL param
    function getParam(name){
      const url = new URL(location.href);
      return url.searchParams.get(name);
    }

    // Formatting
    function formatJPY(n){
      return new Intl.NumberFormat('ja-JP',{style:'currency',currency:'JPY'}).format(n);
    }

    function updatePayLabel(amount) {
      const t = languages[currentLang]?.pay || 'Pay {amount}';
      const label = t.replace('{amount}', formatJPY(amount));
      document.getElementById('payLabel').textContent = label;
    }

    // ===== è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ =====
    let retryCount = 0;
    const MAX_RETRIES = 12;
    let retryTimer = null;

    function startAutoRetry() {
      if (retryCount >= MAX_RETRIES) {
        console.log('[AutoRetry] æœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°ã«åˆ°é”ã—ã¾ã—ãŸ');
        const hintText = document.querySelector('.hint-text');
        if (hintText) {
          hintText.textContent = currentLang === 'ja' ? 
            'å‡ºåº—è€…ã•ã‚“ãŒã¾ã æº–å‚™ã—ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†åº¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚' :
            currentLang === 'en' ?
            'The seller may not be ready yet. Please wait and try again later.' :
            'æ‘Šä¸»å¯èƒ½è¿˜æ²¡å‡†å¤‡å¥½ã€‚è¯·ç¨å€™å†è¯•ã€‚';
          hintText.style.color = 'var(--warn)';
        }
        return;
      }
      retryTimer = setTimeout(() => {
        retryCount++;
        console.log(`[AutoRetry] ãƒªãƒˆãƒ©ã‚¤ ${retryCount}/${MAX_RETRIES}`);
        fetchLatest();
      }, 5000);
    }

    function showEmptyState(normalView, emptyView) {
      normalView.style.display = 'none';
      emptyView.style.display = 'block';
      document.getElementById('payBtn').disabled = true;
      if (!retryTimer) {
        startAutoRetry();
      }
    }

    function showNormalView(normalView, emptyView) {
      normalView.style.display = 'block';
      emptyView.style.display = 'none';
      if (retryTimer) {
        clearTimeout(retryTimer);
        retryTimer = null;
        retryCount = 0;
      }
    }

    // ===== ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ =====
    const securityToggle = document.getElementById('securityToggle');
    const securityDetails = document.getElementById('securityDetails');
    if (securityToggle && securityDetails) {
      securityToggle.addEventListener('click', function() {
        const isExpanded = securityToggle.getAttribute('aria-expanded') === 'true';
        if (isExpanded) {
          securityToggle.setAttribute('aria-expanded', 'false');
          securityDetails.style.display = 'none';
        } else {
          securityToggle.setAttribute('aria-expanded', 'true');
          securityDetails.style.display = 'block';
        }
      });
    }

    // ---- è¨€èªåˆ‡æ›¿ã‚¤ãƒ™ãƒ³ãƒˆ ----
    document.querySelectorAll('.lang-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        switchLanguage(btn.dataset.lang);
      });
    });

    // ---- è‡ªå‹•è¨€èªæ¤œå‡º ----
    const ua = navigator.language || 'en';
    if (ua.startsWith('ja')) { 
      switchLanguage('ja'); 
    } else if (ua.startsWith('zh')) { 
      switchLanguage('zh'); 
    } else { 
      switchLanguage('en'); 
    }

    // ---- Fetch data ----
    const orderId = getParam('order');
    const sellerId = getParam('s');
    const normalView = document.getElementById('normalView');
    const emptyView = document.getElementById('emptyView');
    let currentOrderData = null;

    // â— seller-only ã® URL ã®ã¨ãã€è‡ªå‹•ã§ orderId ã‚’å–å¾—ã—ã¦ä»˜ã‘ã¦å†èª­ã¿è¾¼ã¿
    if (!orderId && sellerId) {
      fetch(`/api/price/latest?s=${sellerId}`)
        .then(r => r.json())
        .then(data => {
          if (data.orderId) {
            location.href = `/checkout.html?s=${sellerId}&order=${data.orderId}`;
          }
        })
        .catch(err => {
          console.warn('[FleaPay] è‡ªå‹•orderIdå–å¾—ã«å¤±æ•—:', err);
        });
    }

    function fetchLatest(){
      // orderIdã¾ãŸã¯sellerIdãŒå¿…è¦
      if (!orderId && !sellerId) {
        console.warn('[FleaPay] order ã¾ãŸã¯ s ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¬ã‚¤ãƒ‰ç”»é¢ã‚’è¡¨ç¤ºã€‚');
        showEmptyState(normalView, emptyView);
        document.body.classList.remove('loading');
        document.body.classList.add('ready');
        return;
      }

      // âœ… ä¿®æ­£: orderIdãŒã‚ã‚‹å ´åˆã¯ /api/seller/order-detail ã‚’ä½¿ç”¨
      let url;
      if (orderId) {
        url = `/api/seller/order-detail?s=${sellerId}&orderId=${encodeURIComponent(orderId)}`;
      } else if (sellerId) {
        url = `/api/price/latest?s=${encodeURIComponent(sellerId)}`;
      }

      console.log('[FleaPay] APIå‘¼ã³å‡ºã—:', url);

      fetch(url)
        .then(r => {
          if (!r.ok) {
            if (r.status === 404) {
              throw new Error('ORDER_NOT_FOUND');
            } else if (r.status === 429) {
              throw new Error('RATE_LIMITED');
            }
            throw new Error(`HTTP ${r.status}`);
          }
          return r.json();
        })
        .then(data => {
          console.log('[FleaPay] APIå¿œç­”:', data);

          // ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
          if (data.error) {
            if (data.error === 'expired') {
              console.warn('[FleaPay] æ³¨æ–‡ãŒæœŸé™åˆ‡ã‚Œã§ã™ï¼ˆ10åˆ†çµŒéï¼‰');
              showEmptyState(normalView, emptyView);
              return;
            } else if (data.error === 'not_found') {
              console.warn('[FleaPay] æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
              showEmptyState(normalView, emptyView);
              return;
            }
            throw new Error(data.error);
          }

          // æ­£å¸¸ãƒ‡ãƒ¼ã‚¿ãƒã‚§ãƒƒã‚¯
          if (data && data.amount && parseInt(data.amount, 10) > 0) {
            // æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            // âœ… ä¿®æ­£: sellerId, summary (memoã¨summaryä¸¡æ–¹ã‚’ã‚µãƒãƒ¼ãƒˆ) ã‚’è¿½åŠ 
            currentOrderData = {
              orderId: data.orderId,
              sellerId: data.sellerId || sellerId,  // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰å–å¾—ã€ãªã‘ã‚Œã°URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰
              amount: data.amount,
              summary: data.summary || data.memo || ''  // summaryå„ªå…ˆã€ãªã‘ã‚Œã°memo
            };

            // æ­£å¸¸ãƒ‡ãƒ¼ã‚¿ â†’ é€šå¸¸è¡¨ç¤º
            showNormalView(normalView, emptyView);
            
            const amountInt = parseInt(data.amount, 10);
            window.__amountInt = amountInt;
            document.getElementById('amount').textContent = formatJPY(amountInt);
            document.getElementById('amount').classList.remove('loading');

            // âœ… ä¿®æ­£: summaryã¨memoä¸¡æ–¹ã‚’ã‚µãƒãƒ¼ãƒˆ
            const summaryText = (data.summary || data.memo || '').trim();
            const summaryEl = document.getElementById('summary');
            if (summaryText) {
              summaryEl.textContent = summaryText;
            } else {
              summaryEl.textContent = '';
            }
            summaryEl.classList.remove('loading');

            updatePayLabel(amountInt);

            const btn = document.getElementById('payBtn');
            btn.disabled = false;
            btn.classList.remove('heartbeat');
            
            // âœ… ä¿®æ­£: /api/checkout/session ã‚’å‘¼ã³å‡ºã—ã¦Stripe URLã‚’å–å¾—
            btn.onclick = async () => {
              try {
                btn.disabled = true;
                const originalText = btn.querySelector('#payLabel').textContent;
                btn.querySelector('#payLabel').textContent = languages[currentLang].fetching || 'å‡¦ç†ä¸­...';
                
                console.log('[FleaPay] æ±ºæ¸ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆé–‹å§‹');

                const response = await fetch('/api/checkout/session', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    sellerId: currentOrderData.sellerId,
                    orderId: currentOrderData.orderId,
                    summary: currentOrderData.summary,
                    latest: !orderId
                  })
                });
                
                console.log('[FleaPay] æ±ºæ¸ˆAPIå¿œç­”ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', response.status);

                if (!response.ok) {
                  const errorData = await response.json().catch(() => ({}));
                  console.error('[FleaPay] æ±ºæ¸ˆAPIã‚¨ãƒ©ãƒ¼:', errorData);
                  
                  if (response.status === 429) {
                    alert(languages[currentLang].errorRateLimit || 'ã‚¢ã‚¯ã‚»ã‚¹ãŒé›†ä¸­ã—ã¦ã„ã¾ã™ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                  } else if (response.status === 404) {
                    alert(languages[currentLang].errorNotFound || 'æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
                  } else if (response.status === 403) {
                    alert(languages[currentLang].errorForbidden || 'ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚');
                  } else {
                    alert(languages[currentLang].errorCheckout || 'æ±ºæ¸ˆå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                  }
                  
                  btn.disabled = false;
                  btn.querySelector('#payLabel').textContent = originalText;
                  return;
                }
                
                const result = await response.json();
                console.log('[FleaPay] æ±ºæ¸ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆæˆåŠŸ:', result);
                
                if (result.url) {
                  console.log('[FleaPay] Stripeã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ:', result.url);
                  window.location.href = result.url;
                } else {
                  console.error('[FleaPay] æ±ºæ¸ˆURLå–å¾—å¤±æ•—:', result);
                  alert(languages[currentLang].errorCheckout || 'æ±ºæ¸ˆãƒªãƒ³ã‚¯ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                  btn.disabled = false;
                  btn.querySelector('#payLabel').textContent = originalText;
                }
              } catch (error) {
                console.error('[FleaPay] æ±ºæ¸ˆå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                alert(languages[currentLang].errorCheckout || 'æ±ºæ¸ˆå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                btn.disabled = false;
                btn.querySelector('#payLabel').textContent = languages[currentLang].pay.replace('{amount}', formatJPY(amountInt));
              }
            };

            document.body.classList.remove('loading');
            document.body.classList.add('ready');
          } else {
            // é‡‘é¡ãŒ0ã¾ãŸã¯æœªè¨­å®š â†’ ç©ºçŠ¶æ…‹ç”»é¢
            console.warn('[FleaPay] é‡‘é¡ãŒ0ã¾ãŸã¯æœªè¨­å®š');
            showEmptyState(normalView, emptyView);
            document.body.classList.remove('loading');
            document.body.classList.add('ready');
          }
        })
        .catch(err => {
          console.error('[FleaPay Fetch Error]', err);
          // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ç©ºçŠ¶æ…‹ç”»é¢
          showEmptyState(normalView, emptyView);
          document.body.classList.remove('loading');
          document.body.classList.add('ready');
        });
    }

    // åˆæœŸèª­ã¿è¾¼ã¿
    fetchLatest();
  </script>
</body>
</html>
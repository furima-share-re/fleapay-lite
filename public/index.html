<!doctype html><html lang="ja"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>お支払い | FleaPay</title>
<style>
body{font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif;max-width:560px;margin:40px auto;padding:0 16px}
.card{border:1px solid #eee;border-radius:12px;padding:16px}
button{padding:12px 16px;border-radius:10px;border:0;cursor:pointer}
label{display:block;margin:8px 0}
</style>
<script src="https://js.stripe.com/v3/"></script>
</head><body>
<h1>お支払い</h1>
<div class="card">
  <label>金額（円）<input id="amount" type="number" value="2592" min="100" step="1"></label>
  <label>出店者 accountId（acct_...）<input id="acct" type="text" placeholder="acct_..." /></label>
  <button id="start">決済を開始</button>
</div>
<div id="paybox" style="display:none;margin-top:24px" class="card">
  <form id="payment-form">
    <div id="payment-element"></div><br>
    <button id="submit">支払う</button>
    <div id="err" style="color:#d00;margin-top:8px"></div>
  </form>
</div>
<script>
let stripe,elements,clientSecret;
document.getElementById("start").onclick = async () => {
  const amount = Number(document.getElementById("amount").value);
  const sellerAccountId = document.getElementById("acct").value.trim();
  if (!sellerAccountId) return alert("出店者の accountId を入力してください");
  const r = await fetch("/api/payments", { method:"POST", headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ amount, sellerAccountId, description: "fleamarket" }) });
  const data = await r.json();
  clientSecret = data.clientSecret;
  stripe = Stripe(data.publishableKey);
  elements = stripe.elements({ clientSecret, locale: "ja", appearance: { theme: "flat" } });
  elements.create("payment").mount("#payment-element");
  document.getElementById("paybox").style.display = "block";
};
document.getElementById("payment-form").onsubmit = async (e) => {
  e.preventDefault();
  const { error } = await stripe.confirmPayment({
    elements,
    confirmParams: { return_url: location.origin + "/thanks.html" },
    redirect: "if_required"
  });
  if (error) document.getElementById("err").textContent = error.message || "決済に失敗しました";
};
</script>
</body></html>

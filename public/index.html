<!-- head 内にあることを確認 -->
<script src="https://js.stripe.com/v3/"></script>

<script>
async function ensureStripeJs() {
  if (typeof Stripe === "function") return; // もう読めてる
  // 念のため動的ロード（head に追加）
  await new Promise((resolve, reject) => {
    const s = document.createElement("script");
    s.src = "https://js.stripe.com/v3/";
    s.onload = resolve;
    s.onerror = () => reject(new Error("Stripe.js load failed"));
    document.head.appendChild(s);
  });
}

let stripe, elements, clientSecret;

document.getElementById("start").onclick = async () => {
  try {
    await ensureStripeJs(); // ★ここで確実に読み込む
  } catch (e) {
    alert("Stripe.js を読み込めませんでした。拡張機能やネットワーク制限を確認してください。");
    console.error(e);
    return;
  }

  const amount = Number(document.getElementById("amount").value);
  const sellerAccountId = document.getElementById("acct").value.trim();
  if (!sellerAccountId) return alert("出店者の accountId を入力してください");

  const r = await fetch("/api/payments", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ amount, sellerAccountId, description: "fleamarket" })
  });

  const text = await r.text();
  let data; try { data = JSON.parse(text) } catch (_) {}
  if (!r.ok || !data || !data.clientSecret || !data.publishableKey) {
    alert("決済の初期化に失敗しました。\n" + text);
    console.error("payments API error:", text);
    return;
  }

  stripe = Stripe(data.publishableKey);
  elements = stripe.elements({ clientSecret: data.clientSecret, appearance: { theme: "flat" }, locale: "ja" });
  elements.create("payment").mount("#payment-element");
  document.getElementById("paybox").style.display = "block";
};
</script>

<!doctype html>
<html lang="ja">
<head>
  <!-- =========================================================
       FleaPayï½œå‡ºåº—è€…UIï¼ˆã“ã©ã‚‚/ãŠã¨ãªï¼‰ å€¤æœ­ãªã—å†™çœŸã«ã‚‚å¯¾å¿œ
       â˜…ãƒ•ãƒªãƒå®Ÿæ…‹ã«åˆã‚ã›ã¦ç°¡ç•¥åŒ–ç‰ˆ
       ãƒ»AIã¯å¸¸æ™‚ONï¼ˆ/api/analyze-itemï¼‰
       ãƒ»å•†å“å†…è¨³ã¯ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ï¼ˆsummaryï¼‰
       ãƒ»é‡‘é¡ã¯ã€Œã”ã†ã‘ã„é‡‘é¡ã€ã‚’1ã¤ã ã‘å…¥åŠ›
       ãƒ»ã‚¹ãƒ†ãƒƒãƒ—4 / ãŠã¨ãªç¢ºèªã‚‚ã€Œsummaryï¼‹åˆè¨ˆã€ã®ã¿
       
       ã€ãƒ‘ãƒƒãƒé©ç”¨æ¸ˆã¿ v3 - OCRæœ€é©åŒ–ç‰ˆ + UXæ”¹å–„ãƒ‘ãƒƒãƒã€‘
       1. æ’®å½±ç”»é¢ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³åŒ–ï¼ˆã‚«ãƒ¡ãƒ©å…¨ç”»é¢ï¼‹ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤UIï¼‰
       2. é€ä¿¡ãƒ‡ãƒ¼ã‚¿å¼·åŒ–ï¼ˆnot_foundå¯¾ç­–ãƒ»ãƒ‡ãƒãƒƒã‚°å¼·åŒ–ï¼‰
       3. /api/pending/start ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®å¤‰æ›´
       4. QR URLç”Ÿæˆã®æŸ”è»ŸåŒ–ï¼ˆã‚µãƒ¼ãƒãƒ¬ã‚¹ãƒãƒ³ã‚¹å„ªå…ˆï¼‰
       5. â˜…OCRç²¾åº¦å‘ä¸Šâ˜…
          - é«˜è§£åƒåº¦ã‚«ãƒ¡ãƒ©è¨­å®šï¼ˆ1600x1200, 4:3ï¼‰
          - ã‚ªãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãƒ»ã‚ºãƒ¼ãƒ å¯¾å¿œ
          - ä¸­å¤®ã‚¯ãƒ­ãƒƒãƒ—ã§å€¤æœ­ã‚’æ‹¡å¤§
          - ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆï¼†æ˜ã‚‹ã•è£œæ­£
          - JPEGå“è³ªå‘ä¸Šï¼ˆ0.95ï¼‰
          - å‘ãè‡ªå‹•è£œæ­£ï¼ˆç¸¦æ¨ªï¼‰
       6. â˜…UXæ”¹å–„ãƒ‘ãƒƒãƒâ˜…
          - åˆæœŸçŠ¶æ…‹ã§ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
          - ä¾¡æ ¼å…¥åŠ›ã‚¯ãƒªã‚¢æ©Ÿèƒ½
          - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ”¹å–„
       ========================================================= -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FleaPayï½œå‡ºåº—è€…UIï¼ˆOCRæœ€é©åŒ–ç‰ˆï¼‰</title>

  <!-- Normalize -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/modern-normalize/2.0.0/modern-normalize.min.css"
        integrity="sha512-LC1aJ7fRkY7O0l6D4J0m0qH2P0Q8rj3bJv9V3nX8v9M3h7Ww4H0r+g8fV2r1uVhWwWqM0B3C1qfKq1QwqQv7xQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"/>

  <style>
    /* ========== åŸºæœ¬ãƒˆãƒ¼ã‚¯ãƒ³ ========== */
    :root{
      --color-bg: #f0f4f8;
      --color-primary: #3b82f6;
      --color-text: #1e293b;
      --radius: 12px;
      --shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    *{box-sizing:border-box;}
    body{
      margin:0;padding:0;
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
      background:var(--color-bg);
      color:var(--color-text);
    }
    
    /* ========== ã‚³ãƒ³ãƒ†ãƒŠ ========== */
    #app{
      max-width:500px;
      margin:0 auto;
      background:#fff;
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }
    
    /* ========== ã‚¹ãƒ†ãƒƒãƒ—å…±é€š ========== */
    .step{display:none; flex-direction:column; padding:1rem; flex:1;}
    .step.active{display:flex;}
    .step h2{
      font-size:1.5rem;
      margin:0 0 1rem;
      display:flex;
      align-items:center;
      gap:0.5rem;
    }
    .step h2 .emoji{font-size:1.8rem;}
    
    /* ========== ãƒœã‚¿ãƒ³ ========== */
    .btn{
      background:var(--color-primary);
      color:#fff;
      border:none;
      padding:1rem;
      border-radius:var(--radius);
      font-size:1rem;
      font-weight:600;
      cursor:pointer;
      box-shadow:var(--shadow);
      transition:transform 0.1s;
    }
    .btn:active{transform:scale(0.98);}
    .btn:disabled{
      background:#cbd5e1;
      cursor:not-allowed;
      transform:none;
    }
    .btn-secondary{
      background:#64748b;
    }
    
    /* ========== Step1: ã‚«ãƒ¡ãƒ©ç”»é¢ï¼ˆãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ï¼‰ ========== */
    #step1{
      padding:0; /* ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ç”¨ */
      position:relative;
    }
    #videoContainer{
      position:relative;
      width:100%;
      height:100vh;
      background:#000;
      overflow:hidden;
    }
    #video{
      position:absolute;
      top:0;left:0;
      width:100%;
      height:100%;
      object-fit:cover;
    }
    #canvas{display:none;}
    
    /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤UI */
    #cameraOverlay{
      position:absolute;
      top:0;left:0;
      width:100%;
      height:100%;
      pointer-events:none;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      padding:1rem;
    }
    .overlay-top, .overlay-bottom{
      pointer-events:auto;
    }
    .overlay-top{
      background:rgba(0,0,0,0.5);
      color:#fff;
      padding:1rem;
      border-radius:var(--radius);
      text-align:center;
    }
    .overlay-middle{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%, -50%);
      border:3px dashed rgba(255,255,255,0.6);
      border-radius:var(--radius);
      width:80%;
      height:60%;
      pointer-events:none;
    }
    .overlay-middle::after{
      content:'ğŸ“ ã­ãµã ã‚’ ã“ã“ã« ã‚ã‚ã›ã¦ã­';
      position:absolute;
      bottom:-3rem;
      left:50%;
      transform:translateX(-50%);
      color:#fff;
      background:rgba(0,0,0,0.7);
      padding:0.5rem 1rem;
      border-radius:var(--radius);
      font-size:0.9rem;
      white-space:nowrap;
    }
    .overlay-bottom{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:1rem;
    }
    #captureBtn{
      width:80px;
      height:80px;
      border-radius:50%;
      background:#fff;
      border:5px solid var(--color-primary);
      font-size:2rem;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition:transform 0.1s;
    }
    #captureBtn:active{transform:scale(0.95);}
    #torchBtn{
      width:50px;
      height:50px;
      border-radius:50%;
      background:rgba(255,255,255,0.3);
      border:2px solid #fff;
      color:#fff;
      font-size:1.5rem;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition:all 0.2s;
    }
    #torchBtn.active{
      background:#fbbf24;
      border-color:#fbbf24;
    }
    
    /* ========== Step2: AIè§£æä¸­ ========== */
    #step2{
      align-items:center;
      justify-content:center;
      gap:2rem;
    }
    #step2 .loader{
      width:60px;
      height:60px;
      border:6px solid #e2e8f0;
      border-top-color:var(--color-primary);
      border-radius:50%;
      animation:spin 1s linear infinite;
    }
    @keyframes spin{
      to{transform:rotate(360deg);}
    }
    
    /* ========== Step3: ä¾¡æ ¼å…¥åŠ› ========== */
    .preview{
      margin-bottom:1rem;
      border-radius:var(--radius);
      overflow:hidden;
      box-shadow:var(--shadow);
    }
    .preview img{
      width:100%;
      display:block;
    }
    .info-box{
      background:#f1f5f9;
      padding:1rem;
      border-radius:var(--radius);
      margin-bottom:1rem;
      font-size:0.9rem;
      line-height:1.6;
    }
    .price-input-group{
      margin-bottom:1.5rem;
    }
    .price-input-group label{
      display:block;
      font-weight:600;
      margin-bottom:0.5rem;
    }
    .price-input-wrapper{
      display:flex;
      align-items:center;
      gap:0.5rem;
      background:#f8fafc;
      border:2px solid #cbd5e1;
      border-radius:var(--radius);
      padding:0.5rem 1rem;
    }
    .price-input-wrapper.focused{
      border-color:var(--color-primary);
      background:#fff;
    }
    .price-input-wrapper .currency{
      font-size:1.2rem;
      font-weight:600;
      color:#64748b;
    }
    .price-input-wrapper input{
      flex:1;
      border:none;
      background:transparent;
      font-size:1.5rem;
      font-weight:600;
      outline:none;
      padding:0.5rem 0;
    }
    
    /* ========== Step4: æœ€çµ‚ç¢ºèª ========== */
    .confirm-card{
      background:#f8fafc;
      border-radius:var(--radius);
      padding:1.5rem;
      margin-bottom:1.5rem;
      box-shadow:var(--shadow);
    }
    .confirm-row{
      display:flex;
      justify-content:space-between;
      margin-bottom:0.5rem;
      font-size:0.95rem;
    }
    .confirm-row.total{
      margin-top:1rem;
      padding-top:1rem;
      border-top:2px solid #cbd5e1;
      font-size:1.3rem;
      font-weight:700;
      color:var(--color-primary);
    }
    .checkbox-group{
      background:#fef3c7;
      padding:1rem;
      border-radius:var(--radius);
      margin-bottom:1rem;
      display:flex;
      align-items:center;
      gap:0.75rem;
    }
    .checkbox-group input[type="checkbox"]{
      width:24px;
      height:24px;
      cursor:pointer;
    }
    .checkbox-group label{
      font-weight:600;
      cursor:pointer;
      flex:1;
    }
    
    /* ========== Step5: ç™»éŒ²å®Œäº† ========== */
    #step5{
      align-items:center;
      text-align:center;
      padding:2rem 1rem;
    }
    .qr-container{
      margin:2rem 0;
      padding:2rem;
      background:#f8fafc;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    #qrcode{
      display:inline-block;
      padding:1rem;
      background:#fff;
      border-radius:var(--radius);
    }
    
    /* ========== ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚° ========== */
    #debugPanel{
      position:fixed;
      bottom:0;
      left:0;
      right:0;
      max-height:200px;
      overflow-y:auto;
      background:rgba(0,0,0,0.9);
      color:#0f0;
      font-family:monospace;
      font-size:11px;
      padding:0.5rem;
      display:none;
      z-index:9999;
    }
    #debugPanel.show{display:block;}
    #debugToggle{
      position:fixed;
      bottom:10px;
      right:10px;
      background:#000;
      color:#0f0;
      border:1px solid #0f0;
      padding:0.5rem;
      cursor:pointer;
      z-index:10000;
      border-radius:4px;
    }
  </style>
</head>

<body>
<div id="app">
  
  <!-- ========== Step1: ã‚«ãƒ¡ãƒ©æ’®å½±ï¼ˆãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ï¼‰ ========== -->
  <div id="step1" class="step active">
    <div id="videoContainer">
      <video id="video" autoplay playsinline></video>
      <canvas id="canvas"></canvas>
      
      <div id="cameraOverlay">
        <div class="overlay-top">
          <div class="emoji">âœ¨</div>
          <div>AIãŒ ã¿ã¦ã„ã¾ã™â€¦</div>
          <div style="font-size:0.8rem; margin-top:0.5rem;">ã­ãµã ã‚’ ãŠãŠãã ã¯ã£ãã‚Š ã†ã¤ã—ã¦ã­</div>
        </div>
        <div class="overlay-middle"></div>
        <div class="overlay-bottom">
          <button id="torchBtn">ğŸ’¡</button>
          <button id="captureBtn">ğŸ“·</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ========== Step2: AIè§£æä¸­ ========== -->
  <div id="step2" class="step">
    <div class="loader"></div>
    <h2><span class="emoji">ğŸ¤–</span> AI ãŒ ã‹ã‚“ãŒãˆã¦ã„ã¾ã™â€¦</h2>
  </div>
  
  <!-- ========== Step3: å•†å“æƒ…å ±ï¼†ä¾¡æ ¼å…¥åŠ› ========== -->
  <div id="step3" class="step">
    <h2><span class="emoji">ğŸ“</span> ã—ã‚‡ã†ã²ã‚“ ã˜ã‚‡ã†ã»ã†</h2>
    
    <div class="preview">
      <img id="previewImg" alt="å•†å“å†™çœŸ"/>
    </div>
    
    <div class="info-box" id="itemSummary">
      ï¼ˆã—ã‚‡ã†ã²ã‚“ ã˜ã‚‡ã†ã»ã† ãªã—ï¼‰
    </div>
    
    <h2><span class="emoji">ğŸ’°</span> ã”ã†ã‘ã„ã® ã­ã ã‚“ã‚’ ã„ã‚Œã‚ˆã†</h2>
    <p style="color:#64748b; font-size:0.9rem; margin-bottom:1rem;">
      ã“ã¾ã‹ã„ ãŸã‚“ã‹ ã‚„ ã–ã„ã“ ã¯ ã„ã‚Šã¾ã›ã‚“ã€‚<br/>
      ã€Œãœã‚“ã¶ã§ ã„ãã‚‰ï¼Ÿã€ã ã‘ ã„ã‚Œã¦ã­ã€‚
    </p>
    
    <div class="price-input-group">
      <label for="totalPriceInput">ã”ã†ã‘ã„ é‡‘é¡</label>
      <div class="price-input-wrapper" id="priceWrapper">
        <span class="currency">Â¥</span>
        <input type="number" 
               id="totalPriceInput" 
               placeholder="0" 
               min="0" 
               step="1"/>
      </div>
    </div>
    
    <!-- æœ€åˆã¯é‡‘é¡ãŒ 0 ãªã®ã§ãƒœã‚¿ãƒ³ã¯ç„¡åŠ¹ã«ã—ã¦ãŠã -->
    <button class="btn" id="nextToConfirm" disabled>ğŸ‘€ ã•ã„ã—ã‚…ã† ã‹ãã«ã‚“</button>
  </div>
  
  <!-- ========== Step4: æœ€çµ‚ç¢ºèªï¼ˆä¿è­·è€…ãƒã‚§ãƒƒã‚¯ï¼‰ ========== -->
  <div id="step4" class="step">
    <h2><span class="emoji">ğŸ‘€</span> ã“ã‚Œã§ ã ã„ã˜ã‚‡ã†ã¶ï¼</h2>
    
    <div class="preview">
      <img id="confirmImg" alt="å•†å“å†™çœŸ"/>
    </div>
    
    <div class="confirm-card">
      <div class="confirm-row">
        <span>ã—ã‚‡ã†ã²ã‚“ï¼š</span>
        <span id="confirmSummary">-</span>
      </div>
      <div class="confirm-row total">
        <span>ã”ã†ã‘ã„ï¼š</span>
        <span id="confirmTotal">Â¥0</span>
      </div>
    </div>
    
    <h2><span class="emoji">ğŸ”</span> ä¿è­·è€…ç¢ºèª</h2>
    <div class="checkbox-group">
      <input type="checkbox" id="parentCheck"/>
      <label for="parentCheck">å†…å®¹ã‚’ç¢ºèªã—ã¾ã—ãŸ</label>
    </div>
    
    <button class="btn" id="registerBtn" disabled>âœ… ã¨ã†ã‚ã ã™ã‚‹</button>
  </div>
  
  <!-- ========== Step5: ç™»éŒ²å®Œäº†ï¼†QRã‚³ãƒ¼ãƒ‰è¡¨ç¤º ========== -->
  <div id="step5" class="step">
    <h2><span class="emoji">âœ…</span> ã¨ã†ã‚ã ã‹ã‚“ã‚Šã‚‡ã†ï¼</h2>
    <p>ã“ã®QRã‚³ãƒ¼ãƒ‰ã‚’ ãŠãã‚ƒãã•ã‚“ã« ã¿ã›ã¦ã­</p>
    
    <div class="qr-container">
      <div id="qrcode"></div>
    </div>
    
    <button class="btn btn-secondary" onclick="location.reload()">
      ğŸ”„ ã¤ãã® ã—ã‚‡ã†ã²ã‚“ ã‚’ ã¨ã†ã‚ã
    </button>
  </div>
  
</div>

<!-- ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ« -->
<button id="debugToggle">ğŸ› ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</button>
<div id="debugPanel"></div>

<!-- QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<script>
(function(){
  'use strict';
  
  /* ========== ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚° ========== */
  const debugLog = (() => {
    const panel = document.getElementById('debugPanel');
    const toggle = document.getElementById('debugToggle');
    let visible = false;
    
    toggle.addEventListener('click', () => {
      visible = !visible;
      panel.classList.toggle('show', visible);
    });
    
    return (msg) => {
      const time = new Date().toLocaleTimeString('ja-JP');
      const line = document.createElement('div');
      line.textContent = `[${time}] ${msg}`;
      panel.appendChild(line);
      panel.scrollTop = panel.scrollHeight;
      console.log(msg);
    };
  })();
  
  /* ========== ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ ========== */
  let capturedImageDataURL = null;
  let aiAnalysisResult = null;
  let sellerId = null;
  let videoStream = null;
  let torchEnabled = false;
  
  /* ========== Stepåˆ¶å¾¡ ========== */
  function showStep(stepId){
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.getElementById(stepId).classList.add('active');
    debugLog(`Step changed: ${stepId}`);
  }
  
  /* ========== URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰sellerIdå–å¾— ========== */
  function getSellerIdFromURL(){
    const params = new URLSearchParams(window.location.search);
    const s = params.get('s');
    if(!s){
      debugLog('âš ï¸ sellerId not found in URL. Using default: seller_demo');
      return 'seller_demo';
    }
    debugLog(`âœ… sellerId detected: ${s}`);
    return s;
  }
  
  /* ========== Step1: ã‚«ãƒ¡ãƒ©èµ·å‹•ï¼†æ’®å½±ï¼ˆOCRæœ€é©åŒ–ç‰ˆï¼‰ ========== */
  async function initCamera(){
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const captureBtn = document.getElementById('captureBtn');
    const torchBtn = document.getElementById('torchBtn');
    
    try {
      // (A) OCRå‘ã‘é«˜è§£åƒåº¦è¨­å®šï¼ˆ4:3, 1600x1200ï¼‰
      videoStream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: { ideal: 'environment' },
          width:  { ideal: 1600 },
          height: { ideal: 1200 },
          aspectRatio: { ideal: 4/3 }
        },
        audio: false
      });
      
      video.srcObject = videoStream;
      debugLog(`âœ… Camera started: ${video.videoWidth}x${video.videoHeight}`);
      
      // (B) ã‚ªãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãƒ»ã‚ºãƒ¼ãƒ è¨­å®šï¼ˆå¯¾å¿œç«¯æœ«ã®ã¿ï¼‰
      const track = videoStream.getVideoTracks()[0];
      const caps = track.getCapabilities?.();
      
      if(caps){
        debugLog(`ğŸ“· Camera capabilities: ${JSON.stringify(caps)}`);
        
        const constraints = { advanced: [] };
        
        // ã‚ªãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹
        if(caps.focusMode && caps.focusMode.includes('continuous')){
          constraints.advanced.push({ focusMode: 'continuous' });
          debugLog('âœ… Continuous autofocus enabled');
        }
        
        // è»½ãã‚ºãƒ¼ãƒ ï¼ˆå€¤æœ­ã‚’å¤§ããï¼‰
        if(caps.zoom){
          const midZoom = Math.min(
            caps.zoom.max,
            (caps.zoom.max + caps.zoom.min) / 2
          );
          constraints.advanced.push({ zoom: midZoom });
          debugLog(`âœ… Zoom set to: ${midZoom}`);
        }
        
        if(constraints.advanced.length > 0){
          await track.applyConstraints(constraints);
        }
      }
      
      // (C) ãƒˆãƒ¼ãƒï¼ˆãƒ©ã‚¤ãƒˆï¼‰æ©Ÿèƒ½
      if(caps && caps.torch){
        torchBtn.style.display = 'flex';
        torchBtn.addEventListener('click', async () => {
          torchEnabled = !torchEnabled;
          try {
            await track.applyConstraints({
              advanced: [{ torch: torchEnabled }]
            });
            torchBtn.classList.toggle('active', torchEnabled);
            debugLog(`ğŸ’¡ Torch: ${torchEnabled ? 'ON' : 'OFF'}`);
          } catch(e){
            debugLog(`âš ï¸ Torch toggle failed: ${e.message}`);
          }
        });
      } else {
        torchBtn.style.display = 'none';
      }
      
    } catch(err) {
      debugLog(`âŒ Camera error: ${err.message}`);
      alert('ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      return;
    }
    
    // æ’®å½±ãƒœã‚¿ãƒ³
    captureBtn.addEventListener('click', () => {
      captureAndProcessImage(video, canvas);
    });
  }
  
  /* ========== ç”»åƒã‚­ãƒ£ãƒ—ãƒãƒ£ï¼†OCRæœ€é©åŒ–å‡¦ç† ========== */
  function captureAndProcessImage(video, canvas){
    const vw = video.videoWidth  || 640;
    const vh = video.videoHeight || 480;
    
    debugLog(`ğŸ“¸ Capturing: ${vw}x${vh}`);
    
    // (D) ä¸­å¤®ã‚¯ãƒ­ãƒƒãƒ—ï¼ˆ80%ï¼‰ã§å€¤æœ­ã‚’æ‹¡å¤§
    const sx = vw * 0.1;
    const sy = vh * 0.1;
    const sw = vw * 0.8;
    const sh = vh * 0.8;
    
    // (G) å‘ãè‡ªå‹•è£œæ­£
    const needRotate = vw > vh && window.innerHeight > window.innerWidth;
    
    // OCRç”¨ã«1024pxå››æ–¹ã«æ­£è¦åŒ–
    const SIZE = 1024;
    
    if(needRotate){
      // 90åº¦å›è»¢ãŒå¿…è¦
      canvas.width  = SIZE;
      canvas.height = SIZE;
      const ctx = canvas.getContext('2d');
      
      // (E) ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆï¼†æ˜ã‚‹ã•è£œæ­£
      ctx.filter = 'contrast(1.25) brightness(1.05)';
      
      ctx.save();
      ctx.translate(SIZE/2, SIZE/2);
      ctx.rotate(-Math.PI / 2);
      ctx.drawImage(video, sx, sy, sw, sh, -SIZE/2, -SIZE/2, SIZE, SIZE);
      ctx.restore();
      ctx.filter = 'none';
      
      debugLog('ğŸ”„ Image rotated 90Â° for portrait mode');
    } else {
      // å›è»¢ä¸è¦
      canvas.width  = SIZE;
      canvas.height = SIZE;
      const ctx = canvas.getContext('2d');
      
      // (E) ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆï¼†æ˜ã‚‹ã•è£œæ­£
      ctx.filter = 'contrast(1.25) brightness(1.05)';
      ctx.drawImage(video, sx, sy, sw, sh, 0, 0, SIZE, SIZE);
      ctx.filter = 'none';
    }
    
    // (F) JPEGå“è³ªå‘ä¸Šï¼ˆ0.95ï¼‰
    capturedImageDataURL = canvas.toDataURL('image/jpeg', 0.95);
    debugLog(`âœ… Image captured (OCR optimized): ${capturedImageDataURL.substring(0,50)}...`);
    debugLog(`ğŸ“¦ Image size: ${Math.round(capturedImageDataURL.length / 1024)}KB`);
    
    // ã‚«ãƒ¡ãƒ©åœæ­¢
    if(videoStream){
      videoStream.getTracks().forEach(t => t.stop());
      debugLog('ğŸ“· Camera stopped');
    }
    
    // AIè§£æã¸
    showStep('step2');
    analyzeImage();
  }
  
  /* ========== Step2: AIç”»åƒè§£æ ========== */
  async function analyzeImage(){
    if(!capturedImageDataURL){
      debugLog('âŒ No image to analyze');
      alert('ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“');
      showStep('step1');
      return;
    }
    
    const blob = dataURLtoBlob(capturedImageDataURL);
    const formData = new FormData();
    formData.append('image', blob, 'item.jpg');
    
    debugLog('ğŸ“¤ Sending image to /api/analyze-item...');
    
    try{
      const res = await fetch('/api/analyze-item', {
        method: 'POST',
        body: formData
      });
      
      if(!res.ok){
        throw new Error(`HTTP ${res.status}`);
      }
      
      const data = await res.json();
      debugLog(`âœ… AI response: ${JSON.stringify(data)}`);
      
      aiAnalysisResult = data;
      showStep('step3');
      renderStep3();
      
    } catch(err) {
      debugLog(`âŒ AI analysis failed: ${err.message}`);
      alert('AIè§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã ã•ã„ã€‚');
      showStep('step1');
      location.reload();
    }
  }
  
  /* ========== Step3: å•†å“æƒ…å ±è¡¨ç¤ºï¼†ä¾¡æ ¼å…¥åŠ› ========== */
  function renderStep3(){
    const previewImg = document.getElementById('previewImg');
    const itemSummary = document.getElementById('itemSummary');
    const totalPriceInput = document.getElementById('totalPriceInput');
    const nextBtn = document.getElementById('nextToConfirm');
    const priceWrapper = document.getElementById('priceWrapper');
    
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒ
    previewImg.src = capturedImageDataURL;
    
    // AIè§£æçµæœï¼ˆsummaryï¼‰
    if(aiAnalysisResult && aiAnalysisResult.summary){
      itemSummary.textContent = aiAnalysisResult.summary;
    } else {
      itemSummary.textContent = 'ï¼ˆAI ã§ ã—ã‚‡ã†ã²ã‚“ ã‚’ ã«ã‚“ã—ã ã§ãã¾ã›ã‚“ã§ã—ãŸï¼‰';
    }
    
    // åˆæœŸçŠ¶æ…‹ï¼šãƒœã‚¿ãƒ³ç„¡åŠ¹ï¼†é‡‘é¡ã‚¯ãƒªã‚¢
    nextBtn.disabled = true;
    totalPriceInput.value = '';
    
    // ä¾¡æ ¼å…¥åŠ›ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ¼”å‡º
    totalPriceInput.addEventListener('focus', () => {
      priceWrapper.classList.add('focused');
    });
    totalPriceInput.addEventListener('blur', () => {
      priceWrapper.classList.remove('focused');
    });
    
    // ä¾¡æ ¼å…¥åŠ›ã§æ¬¡ã¸ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–
    totalPriceInput.addEventListener('input', () => {
      const val = parseInt(totalPriceInput.value, 10);
      nextBtn.disabled = !(val > 0);
    });
    
    // æ¬¡ã¸ãƒœã‚¿ãƒ³
    nextBtn.addEventListener('click', () => {
      showStep('step4');
      renderStep4();
    });
  }
  
  /* ========== Step4: æœ€çµ‚ç¢ºèª ========== */
  function renderStep4(){
    const confirmImg = document.getElementById('confirmImg');
    const confirmSummary = document.getElementById('confirmSummary');
    const confirmTotal = document.getElementById('confirmTotal');
    const parentCheck = document.getElementById('parentCheck');
    const registerBtn = document.getElementById('registerBtn');
    
    confirmImg.src = capturedImageDataURL;
    
    const summary = (aiAnalysisResult && aiAnalysisResult.summary) 
                    ? aiAnalysisResult.summary 
                    : 'ï¼ˆã—ã‚‡ã†ã²ã‚“ ã˜ã‚‡ã†ã»ã† ãªã—ï¼‰';
    confirmSummary.textContent = summary;
    
    const totalVal = parseInt(document.getElementById('totalPriceInput').value, 10) || 0;
    confirmTotal.textContent = `Â¥${totalVal.toLocaleString()}`;
    
    // ä¿è­·è€…ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
    parentCheck.addEventListener('change', () => {
      registerBtn.disabled = !parentCheck.checked;
    });
    
    // ç™»éŒ²ãƒœã‚¿ãƒ³
    registerBtn.addEventListener('click', async () => {
      registerBtn.disabled = true;
      registerBtn.textContent = 'ğŸ“¤ ã¨ã†ã‚ã ã¡ã‚…ã†â€¦';
      
      await registerSale(summary, totalVal);
    });
  }
  
  /* ========== Step5: ã‚µãƒ¼ãƒã¸ç™»éŒ²ï¼ˆãƒ‘ãƒƒãƒé©ç”¨ç‰ˆï¼‰ ========== */
  async function registerSale(summary, amount){
    debugLog('=== registerSale START ===');
    debugLog(`sellerId: ${sellerId}`);
    debugLog(`amount: ${amount}`);
    debugLog(`summary: ${summary}`);
    
    const payload = {
      sellerId: sellerId,
      amount: amount,
      summary: summary,
      imageData: capturedImageDataURL,
      aiAnalysis: aiAnalysisResult || {}
    };
    
    debugLog(`ğŸ“¤ Sending to /api/pending/start: ${JSON.stringify({
      sellerId: payload.sellerId,
      amount: payload.amount,
      summary: payload.summary,
      imageLength: payload.imageData ? payload.imageData.length : 0,
      aiAnalysis: payload.aiAnalysis
    })}`);
    
    try{
      const res = await fetch('/api/pending/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      
      debugLog(`ğŸ“¥ Response status: ${res.status}`);
      
      if(!res.ok){
        const errorText = await res.text();
        debugLog(`âŒ Server error: ${errorText}`);
        throw new Error(`HTTP ${res.status}: ${errorText}`);
      }
      
      const data = await res.json();
      debugLog(`âœ… Server response: ${JSON.stringify(data)}`);
      
      // QR URL ã®æ±ºå®šï¼ˆæŸ”è»Ÿå¯¾å¿œï¼‰
      let qrURL = null;
      
      if(data.purchaseUrl){
        qrURL = data.purchaseUrl;
        debugLog(`âœ… Using purchaseUrl from server: ${qrURL}`);
      } else if(data.checkoutUrl){
        qrURL = data.checkoutUrl;
        debugLog(`âœ… Using checkoutUrl from server: ${qrURL}`);
      } else {
        // ã‚µãƒ¼ãƒãŒURLã‚’è¿”ã•ãªã„å ´åˆã€ãƒ•ãƒ­ãƒ³ãƒˆå´ã§ç”Ÿæˆ
        const baseURL = window.location.origin;
        qrURL = `${baseURL}/checkout.html?s=${sellerId}`;
        debugLog(`âš ï¸ Server did not return URL, generated: ${qrURL}`);
      }
      
      // Step5ã¸ç§»å‹•ã—ã¦QRè¡¨ç¤º
      showStep('step5');
      displayQR(qrURL);
      
      debugLog('=== registerSale SUCCESS ===');
      
    } catch(err) {
      debugLog(`âŒ registerSale failed: ${err.message}`);
      alert(`ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.message}`);
      document.getElementById('registerBtn').disabled = false;
      document.getElementById('registerBtn').textContent = 'âœ… ã¨ã†ã‚ã ã™ã‚‹';
    }
  }
  
  /* ========== QRã‚³ãƒ¼ãƒ‰è¡¨ç¤º ========== */
  function displayQR(url){
    const container = document.getElementById('qrcode');
    container.innerHTML = '';
    
    new QRCode(container, {
      text: url,
      width: 256,
      height: 256,
      colorDark: '#000',
      colorLight: '#fff',
      correctLevel: QRCode.CorrectLevel.M
    });
    
    debugLog(`âœ… QR code displayed: ${url}`);
  }
  
  /* ========== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼šDataURL â†’ Blob ========== */
  function dataURLtoBlob(dataURL){
    const arr = dataURL.split(',');
    const mime = arr[0].match(/:(.*?);/)[1];
    const bstr = atob(arr[1]);
    let n = bstr.length;
    const u8arr = new Uint8Array(n);
    while(n--){
      u8arr[n] = bstr.charCodeAt(n);
    }
    return new Blob([u8arr], {type:mime});
  }
  
  /* ========== åˆæœŸåŒ– ========== */
  document.addEventListener('DOMContentLoaded', () => {
    debugLog('=== App Initialized (OCR Optimized + UX Patch) ===');
    sellerId = getSellerIdFromURL();
    initCamera();
  });
  
})();
</script>

</body>
</html>
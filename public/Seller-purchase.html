<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å‡ºåº—è€… ãƒšãƒ³ãƒ‡ã‚£ãƒ³ã‚°ç™»éŒ² & å›ºå®šQRæ¡ˆå†…ï¼ˆç¢ºèªç”»é¢ï¼‹matsuriç‰ˆï¼‰</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/modern-normalize/2.0.0/modern-normalize.min.css" rel="stylesheet">
  <style>
    :root {
      --bg:#f7f7fb;--panel:#fff;--text:#222;--sub:#666;--brand:#5a6bff;
      --ok:#1a9b63;--err:#e5484d;--bd:#e6e6ee;--warn:#c97a00;
    }
    body {background:var(--bg);color:var(--text);font:16px/1.6 system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP",Arial,sans-serif;}
    .wrap {max-width:820px;margin:24px auto;padding:0 16px;}
    h1 {font-size:1.6rem;margin:8px 0 16px;}
    h2 {font-size:1.15rem;margin:0 0 10px;}
    .card {background:var(--panel);border:1px solid var(--bd);border-radius:16px;padding:20px;margin:14px 0;box-shadow:0 2px 10px rgba(0,0,0,.04);}
    label {display:block;font-size:.9rem;color:var(--sub);margin:6px 0 6px;}
    input, textarea {width:100%;padding:12px 14px;border:1px solid var(--bd);border-radius:12px;background:#fff;outline:none;font:inherit;}
    textarea {min-height:110px;white-space:pre-wrap;}
    .row {display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .btn {display:inline-flex;align-items:center;justify-content:center;gap:.5em;padding:12px 16px;border-radius:999px;border:1px solid var(--bd);background:#fff;cursor:pointer;}
    .btn.primary {background:var(--brand);border-color:var(--brand);color:#fff;}
    .btn.ghost {background:#fff;}
    .btn.warn {background:#fff3d6;border-color:#ffd27a;}
    .btn:disabled {opacity:.6;cursor:not-allowed;}
    .chip {display:inline-block;padding:6px 10px;border-radius:999px;background:#f1f2ff;border:1px solid #dfe2ff;color:#3943ff;font-size:.85rem;margin-right:6px;}
    .muted {color:var(--sub);font-size:.9rem;}
    .msg {padding:12px 14px;border-radius:12px;margin:10px 0;border:1px solid transparent;}
    .msg.ok {background:#e9f7ef;color:#0f6b43;border-color:#c9eedc;}
    .msg.err {background:#fff1f1;color:#a1161b;border-color:#ffd7d9;}
    .msg.warn {background:#fff7e6;color:#6b4a00;border-color:#ffe1a6;}
    .qrbox {display:flex;flex-direction:column;align-items:center;gap:12px;padding:16px;border:1px dashed var(--bd);border-radius:14px;background:#fff;}
    .grid3 {display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px;margin:8px 0;}
    .preset .btn {padding:10px 12px;}
    .hint {font-size:.82rem;color:#888;}
    .right {display:flex;justify-content:flex-end;}
    .preview {width:100%;max-width:340px;border-radius:12px;border:1px solid var(--bd);overflow:hidden;}
    .preview img {display:block;width:100%;height:auto;}
    .badge {display:inline-block;font-size:.75rem;padding:2px 8px;border-radius:999px;border:1px solid var(--bd);background:#fff;}
    .space {height:6px;}
    .kbd {font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:.8rem;padding:2px 6px;border:1px solid var(--bd);border-radius:6px;background:#fff;}
    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .overlay {position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999;}
    .overlay.show {display:flex;}
    .modal {width:min(560px,100%);background:#fff;border-radius:18px;border:1px solid var(--bd);box-shadow:0 10px 30px rgba(0,0,0,.18);padding:18px;}
    .modal h3 {margin:0 0 8px;font-size:1.25rem;}
    .list {margin:8px 0 12px;padding-left:0;list-style:none;}
    .list li {padding:6px 0;border-bottom:1px dashed #eee;}
    .modal .rowbtn {display:flex;gap:10px;justify-content:flex-end;margin-top:12px;}
    .ck {display:flex;align-items:center;gap:8px;margin-top:6px;}
    .priceXL {font-size:1.6rem;font-weight:700;}
    .divider {height:1px;background:#eee;margin:10px 0;}
    .note {font-size:.85rem;color:#555;}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>å‡ºåº—è€… ãƒšãƒ³ãƒ‡ã‚£ãƒ³ã‚°ç™»éŒ² & å›ºå®šQRæ¡ˆå†…ï¼ˆmatsuriç‰ˆï¼‰</h1>

    <!-- å‡ºåº—è€…æƒ…å ± -->
    <div class="card">
      <h2>1. å‡ºåº—è€…ãƒ»AIè§£æ</h2>
      <label for="sellerId">å‡ºåº—è€…IDï¼ˆsellerPublicIdï¼‰</label>
      <input id="sellerId" placeholder="ä¾‹ï¼‰seller-test01" aria-label="å‡ºåº—è€…ID">

      <div class="space"></div>
      <input id="file" type="file" accept="image/*" capture="environment">
      <button class="btn primary" id="btnAnalyze">AIã§å•†å“åãƒ»é‡‘é¡ã‚’è§£æ</button>
      <div id="aiMsg" class="msg" style="display:none"></div>
      <figure class="preview" id="preview" hidden><img id="previewImg" alt="preview"></figure>
    </div>

    <!-- é‡‘é¡å…¥åŠ› -->
    <div class="card">
      <h2>2. åˆè¨ˆé‡‘é¡ãƒ»å•†å“æ¦‚è¦</h2>
      <div class="row">
        <div>
          <label for="amount">åˆè¨ˆé‡‘é¡ï¼ˆå††ï¼‰</label>
          <input id="amount" inputmode="numeric" placeholder="1000">
        </div>
        <div>
          <label>ãƒ—ãƒªã‚»ãƒƒãƒˆ</label>
          <div class="grid3 preset">
            <button class="btn" data-preset="500">Â¥500</button>
            <button class="btn" data-preset="1000">Â¥1,000</button>
            <button class="btn" data-preset="1500">Â¥1,500</button>
          </div>
        </div>
      </div>
      <label for="summary">å•†å“æ¦‚è¦ï¼ˆä¾‹ï¼šã‚Šã‚“ã”ã‚¸ãƒ¥ãƒ¼ã‚¹ Ã—1ï¼‰</label>
      <textarea id="summary"></textarea>
    </div>

    <!-- é‡‘é¡ç™»éŒ² -->
    <div class="card">
      <h2>3. é‡‘é¡ã‚’ç™»éŒ²ï¼ˆç¢ºèªç”»é¢ã‚ã‚Šï¼‰</h2>
      <div style="display:flex;gap:10px;margin-bottom:8px;">
        <button class="btn primary" id="btnRegister">é‡‘é¡ã‚’ç™»éŒ²</button>
        <button class="btn ghost" id="btnReset">ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
      <div id="msg" class="msg" style="display:none"></div>
    </div>

    <!-- å›ºå®šQR -->
    <div class="card" id="qrCard">
      <h2>4. å›ºå®šQRï¼ˆè³¼å…¥è€…æç¤ºç”¨ï¼‰</h2>
      <div class="qrbox">
        <div id="qrcode"></div>
        <button class="btn" id="openBuyer">è³¼å…¥è€…ç”¨ãƒšãƒ¼ã‚¸ã‚’é–‹ã</button>
      </div>
      <p class="hint">ã“ã®QR/ãƒªãƒ³ã‚¯ã¯å›ºå®šã§ã™ã€‚é‡‘é¡ã¯ã€Œãƒšãƒ³ãƒ‡ã‚£ãƒ³ã‚°ç™»éŒ²ã€ã—ãŸæœ€æ–°ã®å€¤ãŒè³¼å…¥è€…å´ã§è‡ªå‹•åæ˜ ã•ã‚Œã¾ã™ã€‚</p>
    </div>
  </div>

  <!-- ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="overlay" id="confirmOverlay">
    <div class="modal">
      <h3>ğŸ§¾ å†…å®¹ã‚’ã‹ãã«ã‚“</h3>
      <div class="divider"></div>
      <div class="ttl muted">å•†å“ãƒªã‚¹ãƒˆ</div>
      <ul class="list" id="confirmList"></ul>
      <div class="ttl muted">åˆè¨ˆé‡‘é¡</div>
      <div class="priceXL" id="confirmPrice">Â¥ -</div>
      <label class="ck">
        <input type="checkbox" id="adultCheck">
        <span>ğŸ‘¤ ãŠã¨ãª ã« ã¿ã¦ã‚‚ã‚‰ã£ãŸ</span>
      </label>
      <div class="rowbtn">
        <button class="btn ghost" id="btnEdit">ãªãŠã™</button>
        <button class="btn primary" id="btnConfirm" disabled>ã¯ã„ï¼ˆç™»éŒ²ã™ã‚‹ï¼‰</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>
  const $ = s => document.querySelector(s);
  const params = new URLSearchParams(location.search);
  const CHECKOUT_PATH = params.get('cp') || '/checkout-matsuri.html';
  let qrInstance = null;

  const showMsg=(type,text)=>{const el=$('#msg');el.className='msg '+type;el.textContent=text;el.style.display='block';};
  const clearMsg=()=>{$('#msg').style.display='none';};

  (function init(){
    const sid=params.get('s')||''; if(sid)$('#sellerId').value=sid;

    // å‡ºåº—è€…IDå¤‰æ›´ã§QRå³æ›´æ–°
    $('#sellerId').addEventListener('input',()=>setFixedQR($('#sellerId').value));

    // ãƒ—ãƒªã‚»ãƒƒãƒˆ
    document.querySelectorAll('[data-preset]').forEach(b=>b.addEventListener('click',()=>$('#amount').value=b.dataset.preset));

    // AIãƒœã‚¿ãƒ³
    $('#btnAnalyze').addEventListener('click',onAnalyze);
    $('#file').addEventListener('change',e=>{
      const f=e.target.files?.[0];
      if(!f)return;
      $('#previewImg').src=URL.createObjectURL(f);
      $('#preview').hidden=false;
    });

    // ç™»éŒ²ãƒœã‚¿ãƒ³
    $('#btnRegister').addEventListener('click',openConfirm);
    $('#btnEdit').addEventListener('click',closeConfirm);
    $('#adultCheck').addEventListener('change',()=>$('#btnConfirm').disabled=!$('#adultCheck').checked);
    $('#btnConfirm').addEventListener('click',performRegister);
    $('#btnReset').addEventListener('click',()=>{$('#amount').value='';$('#summary').value='';clearMsg();});

    setFixedQR($('#sellerId').value||'');
  })();

  async function onAnalyze(){
    const f=$('#file').files?.[0];
    if(!f){showMsg('err','ç”»åƒã‚’é¸ã‚“ã§ãã ã•ã„');return;}
    try{
      const fd=new FormData();fd.append('file',f,f.name);
      const res=await fetch('/api/analyze-item',{method:'POST',body:fd});
      const json=await res.json();
      if(!res.ok||json.error)throw new Error(json.error||'è§£æå¤±æ•—');
      if(json.summary)$('#summary').value=json.summary;
      if(json.amount)$('#amount').value=json.amount;
      showMsg('ok','AIè§£æãŒå®Œäº†ã—ã¾ã—ãŸ');
    }catch(e){showMsg('err',e.message);}
  }

  // ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
  function openConfirm(){
    const sid=$('#sellerId').value.trim();
    const amount=parseInt($('#amount').value);
    const summary=$('#summary').value.trim();
    if(!sid){showMsg('err','å‡ºåº—è€…IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
    if(!amount||amount<100){showMsg('err','é‡‘é¡ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');return;}

    const lines=summary.split(/\n/).map(v=>v.trim()).filter(Boolean);
    const ul=$('#confirmList');ul.innerHTML='';
    if(lines.length===0){ul.innerHTML='<li>ï¼ˆå•†å“æƒ…å ±ãªã—ï¼‰</li>';}
    else lines.forEach(l=>{const li=document.createElement('li');li.textContent='ğŸ› '+l;ul.appendChild(li);});
    $('#confirmPrice').textContent='Â¥'+amount.toLocaleString();
    $('#adultCheck').checked=false;$('#btnConfirm').disabled=true;
    $('#confirmOverlay').classList.add('show');
  }
  const closeConfirm=()=>$('#confirmOverlay').classList.remove('show');

  // ç™»éŒ²å‡¦ç†
  async function performRegister(){
    const sellerId=$('#sellerId').value.trim();
    const amount=parseInt($('#amount').value);
    const summary=$('#summary').value.trim();
    try{
      const res=await fetch('/api/pending/start',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({sellerId,amount,summary})
      });
      const json=await res.json();
      if(!res.ok||json.error)throw new Error(json.error||'ç™»éŒ²å¤±æ•—');
      closeConfirm();
      showMsg('ok','ç™»éŒ²ã—ã¾ã—ãŸã€‚è³¼å…¥è€…å´ã«åæ˜ ã•ã‚Œã¾ã™ã€‚');
      flashQR();
    }catch(e){closeConfirm();showMsg('err',e.message);}
  }

  function flashQR(){
    const card=$('#qrCard');
    card.style.boxShadow='0 0 0 3px #c9eedc,0 6px 24px rgba(0,0,0,.12)';
    setTimeout(()=>{card.style.boxShadow='none';},900);
  }

  // QRç”Ÿæˆ
  function setFixedQR(sellerId){
    const target=$('#qrcode');
    const url=`${location.origin}${CHECKOUT_PATH}?s=${encodeURIComponent(sellerId||'')}`;
    target.innerHTML='';
    qrInstance=new QRCode(target,{text:url,width:200,height:200,correctLevel:QRCode.CorrectLevel.M});
    $('#openBuyer').onclick=()=>window.open(url,'_blank');
  }
  </script>
</body>
</html>

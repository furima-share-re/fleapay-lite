<!doctype html>
<html lang="ja">
<head>
  <!-- =========================================================
       FleaPayï½œå‡ºåº—è€…UIï¼ˆã“ã©ã‚‚/ãŠã¨ãªï¼‰ å€¤æœ­ãªã—å†™çœŸã«ã‚‚å¯¾å¿œ
       ãƒ»AIã¯å¸¸æ™‚ONï¼ˆ/api/analyze-itemï¼‰
       ãƒ»ã€Œå“åã®ã¿ã€æŠ½å‡ºã§ã‚‚OK â†’ ä¾¡æ ¼ãƒ‘ãƒƒãƒ‰ã§å˜ä¾¡/æ•°é‡ã‚’è£œå®Œ
       ãƒ»æ’®å½±â†’è‡ªå‹•ã§æ¬¡ç”»é¢é·ç§» / èª­ã¿è¾¼ã¿ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
       ãƒ»å•†å“æ˜ç´°ï¼ˆAI or æ‰‹å‹• or ä¾¡æ ¼ãƒ‘ãƒƒãƒ‰ï¼‰
       ãƒ»é‡‘é¡ãƒ—ãƒªã‚»ãƒƒãƒˆï¼‹ãƒ†ãƒ³ã‚­ãƒ¼
       ãƒ»åŒç”»é¢ç¢ºèªï¼‹æ—§åˆ†é›¢ç¢ºèªã‚¹ãƒ†ãƒƒãƒ—ï¼ˆæ®‹ç½®ï¼‰
       ãƒ»å¤§äººãƒ¢ãƒ¼ãƒ€ãƒ«ç¢ºèªâ†’ç™»éŒ²
       ãƒ»å›ºå®šQRï¼ˆè³¼å…¥è€…æç¤ºç”¨ï¼‰
       ãƒ»ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ï¼ˆHTTP/æœ¬æ–‡ï¼‰
       ========================================================= -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FleaPayï½œå‡ºåº—è€…UIï¼ˆå€¤æœ­ãªã—å¯¾å¿œç‰ˆï¼‰</title>

  <!-- Normalize -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/modern-normalize/2.0.0/modern-normalize.min.css"
        integrity="sha512-LC1aJ7fRkY7O0l6D4J0m0qH2P0Q8rj3bJv9V3nX8v9M3h7Ww4H0r+g8fV2r1uVhWwWqM0B3C1qfKq1QwqQv7xQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"/>

  <style>
    /* ========== åŸºæœ¬ãƒˆãƒ¼ã‚¯ãƒ³ ========== */
    :root{
      --bg:#f7f7fb;
      --panel:#fff;
      --text:#222;
      --sub:#666;
      --brand:#5a6bff;
      --ok:#1a9b63;
      --err:#e5484d;
      --bd:#e6e6ee;
      --muted:#888;
    }

    /* ========== ãƒ™ãƒ¼ã‚¹ ========== */
    html,body{
      background:var(--bg);
      color:var(--text);
      font:16px/1.6 system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP",Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      text-rendering:optimizeLegibility;
    }

    .wrap{ max-width:960px; margin:20px auto; padding:0 16px; }

    header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin:8px 0 14px; }

    .brand{ display:flex; align-items:center; gap:10px; }
    .brand h1{ margin:0; font-size:1.45rem; font-weight:750; letter-spacing:.02em; }

    .modeSwitch{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }

    .chip{ display:inline-flex; align-items:center; gap:.5em; padding:10px 14px; border-radius:999px; border:1px solid var(--bd); background:#fff; cursor:pointer; user-select:none; transition:.15s ease; font-weight:600; }
    .chip.active{ background:var(--brand); border-color:var(--brand); color:#fff; box-shadow:0 2px 8px rgba(90,107,255,.25); }

    .card{ background:var(--panel); border:1px solid var(--bd); border-radius:16px; padding:20px; margin:14px 0; box-shadow:0 2px 10px rgba(0,0,0,.04); }

    h2{ margin:0 0 8px; font-size:1.15rem; letter-spacing:.01em; }

    label{ display:block; font-size:.92rem; color:var(--sub); margin:6px 0 6px; }

    input, textarea{ width:100%; padding:12px 14px; border:1px solid var(--bd); border-radius:12px; background:#fff; outline:none; font:inherit; }
    textarea{ min-height:120px; white-space:pre-wrap; }

    .row{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }

    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:.5em; padding:12px 16px; border-radius:999px; border:1px solid var(--bd); background:#fff; cursor:pointer; user-select:none; transition:.12s ease; font-weight:650; }
    .btn:hover{ transform:translateY(-1px); }
    .btn:active{ transform:translateY(0); }
    .btn.primary{ background:var(--brand); border-color:var(--brand); color:#fff; box-shadow:0 2px 8px rgba(90,107,255,.25); }
    .btn.ghost{ background:#fff; }
    .btn.warn{ background:#fff3d6; border-color:#ffd27a; }
    .btn:disabled{ opacity:.62; cursor:not-allowed; transform:none; box-shadow:none; }

    .msg{ padding:12px 14px; border-radius:12px; margin:10px 0; border:1px solid transparent; font-weight:600; }
    .msg.ok{ background:#e9f7ef; color:#0f6b43; border-color:#c9eedc; }
    .msg.err{ background:#fff1f1; color:#a1161b; border-color:#ffd7d9; }

    .hint{ font-size:.86rem; color:var(--muted); }

    .qrbox{ display:flex; flex-direction:column; align-items:center; gap:12px; padding:16px; border:1px dashed var(--bd); border-radius:14px; background:#fff; }

    .divider{ height:1px; background:#eee; margin:12px 0; }

    .kbd{ font-family:ui-monospace,Menlo,Consolas,monospace; font-size:.84rem; padding:2px 6px; border:1px solid var(--bd); border-radius:6px; background:#fff; }

    /* ========== ã“ã©ã‚‚ãƒ¢ãƒ¼ãƒ‰ ========== */
    #kidApp{ display:none }
    #kidApp.active{ display:block }

    .kid-screen{ display:none; flex-direction:column; align-items:center; justify-content:center; gap:18px; text-align:center; }
    .kid-screen.active{ display:flex !important }

    .kid-h1{ font-size:1.85rem; font-weight:800; letter-spacing:.01em; }
    .kid-big{ font-size:1.35rem; padding:18px 24px; border-radius:20px; }

    .kid-preset{ display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:12px; width:100%; }
    .kid-preset .btn{ height:80px; font-size:1.35rem; }

    .kid-qr{ width:260px; height:260px; background:#fff; border:4px solid #000; border-radius:12px; display:flex; align-items:center; justify-content:center; overflow:hidden; }

    .kid-hint{ font-size:1rem; color:#333 }

    .fileinput{ display:none }

    /* ========== ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ»ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ ========== */
    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; padding:16px; z-index:9999; backdrop-filter:saturate(1.1) blur(2px); }
    .overlay.show{ display:flex }

    .modal{ width:min(600px,100%); background:#fff; border-radius:18px; border:1px solid var(--bd); box-shadow:0 12px 30px rgba(0,0,0,.18); padding:18px; }
    .modal h3{ margin:0 0 8px; font-size:1.28rem; letter-spacing:.01em; }

    .list{ margin:8px 0 12px; padding-left:0; list-style:none; max-height:240px; overflow:auto; border:1px dashed #eee; border-radius:10px; padding:10px; background:#fff; }

    .rowbtn{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px; }

    .ck{ display:flex; align-items:center; gap:8px; margin-top:6px; font-size:1rem; }

    .priceXL{ font-size:1.6rem; font-weight:800; letter-spacing:.02em; }

    /* ========== ãƒ†ãƒ³ã‚­ãƒ¼ ========== */
    .numpad{ display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:8px; }
    .numpad .btn{ height:64px; font-size:1.25rem; }

    /* ========== èª­ã¿è¾¼ã¿ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ ========== */
    .loading-ol{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; flex-direction:column; background:rgba(255,255,255,.94); z-index:10000; }
    .loading-ol.show{ display:flex }
    .spinner{ width:72px; height:72px; border-radius:50%; border:8px solid #e5e7eb; border-top-color:var(--brand); animation:spin 1s linear infinite; margin-bottom:16px; }
    @keyframes spin{ to{ transform:rotate(360deg) } }

    /* ========== ãƒ‡ãƒãƒƒã‚° ========== */
    details.debug{ margin-top:12px }
    details.debug pre{ white-space:pre-wrap; font-family:ui-monospace,Consolas,monospace; background:#fff; border:1px solid #eee; border-radius:10px; padding:10px; min-height:64px; }

    /* ========== ä¾¡æ ¼ãƒ‘ãƒƒãƒ‰ ========== */
    #k2-pricepad{ width:100%; text-align:left; display:none; }
    .pp-item{ border:1px dashed #e5e7eb; border-radius:12px; padding:10px; margin-top:8px; background:#fff; }
    .pp-title{ font-weight:800; margin-bottom:6px; }
    .pp-row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .pp-quick .btn{ height:40px; }
    .pp-qty{ display:flex; align-items:center; gap:6px; }
    .pp-qty input{ width:72px; text-align:center; }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- ========== ãƒ˜ãƒƒãƒ€ãƒ¼ ========== -->
    <header>
      <div class="brand">
        <svg width="28" height="28" viewBox="0 0 24 24" aria-hidden="true">
          <circle cx="12" cy="12" r="10" fill="#5a6bff" opacity=".12"/>
          <path d="M6 13.5c2 2 4 2 6 0s4-2 6 0" stroke="#5a6bff" stroke-width="2" fill="none" stroke-linecap="round"/>
        </svg>
        <h1>FleaPayï½œå‡ºåº—è€…UI</h1>
      </div>
      <div class="modeSwitch" role="tablist" aria-label="ãƒ¢ãƒ¼ãƒ‰ãã‚Šã‹ãˆ">
        <button class="chip active" id="tabKid" role="tab" aria-selected="true">ğŸ§’ ã“ã©ã‚‚</button>
        <button class="chip" id="tabAdult" role="tab" aria-selected="false">ğŸ‘¤ ãŠã¨ãª</button>
      </div>
    </header>

    <!-- ========== ã“ã©ã‚‚ãƒ¢ãƒ¼ãƒ‰ ========== -->
    <div id="kidApp" class="active" aria-label="ã“ã©ã‚‚ ã‚‚ãƒ¼ã©">
      <!-- å‡ºåº—è€…ID -->
      <div class="card" style="padding:12px 16px">
        <label for="sellerIdKid">ğŸ†” ã—ã‚…ã£ã¦ã‚“ã—ã‚ƒIDï¼ˆãŠã¨ãªãŒ ã„ã‚Œã‚‹ï¼‰</label>
        <input id="sellerIdKid" placeholder="seller-test01" aria-label="ã—ã‚…ã£ã¦ã‚“ã—ã‚ƒ ã‚¢ã‚¤ãƒ‡ã‚£ãƒ¼">
        <div class="hint">â€» URLã® <span class="kbd">?s=&lt;ID&gt;</span> ã§åˆæœŸå€¤ã€‚å¤‰ãˆã‚‹ã¨QRã‚‚è‡ªå‹•æ›´æ–°ã€‚</div>
      </div>

      <!-- â‘  æ’®å½± -->
      <div id="k-step1" class="card kid-screen active">
        <div class="kid-h1">ğŸ“· ã—ã‚ƒã—ã‚“ã‚’ ã¨ã‚‹</div>
        <input id="kidFile" class="fileinput" type="file" accept="image/*" capture="environment" aria-label="ã—ã‚ƒã—ã‚“">
        <button class="btn primary kid-big" id="k-take">ã—ã‚ƒã—ã‚“ã‚’ ã¨ã‚‹</button>
        <div id="k-aiMsg" class="msg" style="display:none"></div>
        <div class="hint">ã—ã‚ƒã—ã‚“ã¯ AI ã« ãŠãã£ã¦ã€ã—ã‚‡ã†ã²ã‚“ ã‚’ ã¿ã¤ã‘ã¾ã™ã€‚AIãŒæœªæ¥ç¶šã§ã‚‚ã¤ã¥ã‘ã‚‰ã‚Œã¾ã™ã€‚</div>
      </div>

      <!-- â‘¡ é‡‘é¡ï¼‹æ˜ç´°ï¼‹åŒç”»é¢ç¢ºèª -->
      <div id="k-step2" class="card kid-screen">
        <div class="kid-h1">ğŸ’° ãã‚“ãŒã ã‚’ ãˆã‚‰ã¶</div>

        <!-- æ˜ç´°ï¼ˆAI/æ‰‹å‹•/ä¾¡æ ¼ãƒ‘ãƒƒãƒ‰çµæœã‚’è¡¨ç¤ºï¼‰ -->
        <div style="width:100%;text-align:left">
          <div style="font-weight:700;margin:4px 0 6px">ğŸ› ã—ã‚‡ã†ã²ã‚“ ã® ãŒã„ã‚ˆã†</div>
          <div id="k2-summary-view"
               class="kid-hint"
               style="background:#fff;border:1px solid #eee;border-radius:10px;padding:10px;min-height:56px">ï¼ˆã—ã‚‡ã†ã²ã‚“ ã˜ã‚‡ã†ã»ã† ãªã—ï¼‰</div>

          <!-- æ‰‹å‹•å…¥åŠ›ï¼ˆAIãŒç©ºã®æ™‚ã«è¡¨ç¤ºï¼‰ -->
          <div id="k2-summary-edit-wrap" style="margin-top:8px;display:none">
            <label style="font-weight:700">âœï¸ ã¦ã§ ã„ã‚Œã‚‹ï¼ˆå„è¡Œã€Œå•†å“å Ã—æ•°é‡ã€ï¼‰</label>
            <textarea id="k2-summary-edit" placeholder="ã‚«ãƒ¼ãƒ‰ Ã—1&#10;ã‚­ãƒ¼ãƒ›ãƒ«ãƒ€ãƒ¼ Ã—2"></textarea>
            <div class="right" style="margin-top:8px">
              <button class="btn" id="k2-summary-apply">ã“ã®ãªã„ã‚ˆã†ã§ ã¤ã‹ã†</button>
            </div>
          </div>
        </div>

        <!-- ä¾¡æ ¼ãƒ‘ãƒƒãƒ‰ï¼ˆå˜ä¾¡/æ•°é‡ è£œå®Œï¼‰ -->
        <div id="k2-pricepad" class="card" style="display:none">
          <h2 style="margin-bottom:6px">ğŸ”¢ ã­ã ã‚“ ã‚’ ã„ã‚Œã¦ã­</h2>
          <div id="k2-pricepad-body"></div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
            <button class="btn" id="k2-pricepad-cancel">ã‚„ã‚ã‚‹</button>
            <button class="btn primary" id="k2-pricepad-ok">ã‘ã£ã¦ã„</button>
          </div>
        </div>

        <!-- é‡‘é¡ãƒ—ãƒªã‚»ãƒƒãƒˆ -->
        <div class="kid-preset" style="margin-top:12px">
          <button class="btn" data-kid-price="500">500ãˆã‚“</button>
          <button class="btn" data-kid-price="1000">1,000ãˆã‚“</button>
          <button class="btn" data-kid-price="1500">1,500ãˆã‚“</button>
        </div>

        <!-- ãƒ†ãƒ³ã‚­ãƒ¼ -->
        <button class="btn" id="k-more" style="margin-top:8px">ã»ã‹ï¼ˆã¦ã„ã‚Œã„ ã°ã‚“ã”ã†ï¼‰</button>

        <div id="k-amtView" class="kid-hint" style="margin-top:4px">ã„ã¾ï¼šâ€”</div>

        <div class="divider"></div>

        <!-- åŒç”»é¢ç¢ºèª -->
        <div style="width:100%;text-align:left">
          <div style="font-weight:700;margin:4px 0 6px">ğŸ§¾ ã‹ãã«ã‚“</div>
          <div class="kid-hint"><strong>ã”ã†ã‘ã„ï¼š</strong><span id="k2-sum">â€”</span></div>

          <label class="ck" style="font-size:1.05rem">
            <input type="checkbox" id="k2-adult">
            <span>ğŸ‘¤ ãŠã¨ãª ã« ã¿ã¦ã‚‚ã‚‰ã£ãŸ</span>
          </label>

          <div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-top:8px">
            <button class="btn primary kid-big" id="k2-go" disabled>ã¯ã„ï¼ˆQRã¸ï¼‰</button>
          </div>
        </div>

        <!-- ãƒ‡ãƒãƒƒã‚° -->
        <details class="debug">
          <summary>ğŸ”§ ãƒ‡ãƒãƒƒã‚°</summary>
          <div>analyze: <code>/api/analyze-item</code></div>
          <div>pending: <code>/api/pending/start</code></div>
          <pre id="dbg-log">ï¼ˆãƒ­ã‚°ãªã—ï¼‰</pre>
        </details>
      </div>

      <!-- â‘¢ æ—§ï¼šç‹¬ç«‹ç¢ºèªï¼ˆéå¸¸ç”¨ã«æ®‹ç½®ï¼‰ -->
      <div id="k-step3" class="card kid-screen">
        <div class="kid-h1">ğŸ§¾ ã‹ãã«ã‚“ï¼ˆæ—§ï¼‰</div>
        <div id="k-listWrap" class="hint" style="width:100%;text-align:left"></div>
        <div class="kid-hint"><strong>ã”ã†ã‘ã„ï¼š</strong><span id="k-sum">â€”</span></div>
        <label class="ck" style="font-size:1.1rem">
          <input type="checkbox" id="k-adult"> ğŸ‘¤ ãŠã¨ãª ã« ã¿ã¦ã‚‚ã‚‰ã£ãŸ
        </label>
        <div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center">
          <button class="btn ghost kid-big" id="k-back">ãªãŠã™</button>
          <button class="btn primary kid-big" id="k-go" disabled>ã¯ã„ï¼ˆQRã¸ï¼‰</button>
        </div>
      </div>

      <!-- â‘£ QR -->
      <div id="k-step4" class="card kid-screen">
        <div class="kid-h1">âœ… QR ã‚’ ãŠãã‚ƒãã•ã¾ ã« ã¿ã›ã‚‹</div>
        <div class="kid-qr"><div id="k-qrcode"></div></div>
        <button class="btn kid-big" id="k-open">ãŠãã‚ƒãã•ã¾ ãƒšãƒ¼ã‚¸ã‚’ ã²ã‚‰ã</button>
        <div class="hint">ã“ã®QR/ãƒªãƒ³ã‚¯ã¯ã“ã¦ã„ã€‚æœ€æ–°ã®ç™»éŒ²é‡‘é¡ãŒè‡ªå‹•åæ˜ ã€‚</div>
      </div>
    </div>

    <!-- ========== ãŠã¨ãªãƒ¢ãƒ¼ãƒ‰ ========== -->
    <div id="adultApp" style="display:none" aria-label="ãŠã¨ãª ã‚‚ãƒ¼ã©">
      <!-- AIè§£æ -->
      <div class="card">
        <h2>1. å‡ºåº—è€…ãƒ»AIè§£æ</h2>

        <label for="sellerId">å‡ºåº—è€…IDï¼ˆsellerPublicIdï¼‰</label>
        <input id="sellerId" placeholder="seller-test01" aria-label="å‡ºåº—è€…ID">

        <div class="row" style="margin-top:8px">
          <div>
            <label>ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«</label>
            <input id="file" type="file" accept="image/*" capture="environment">
            <div style="display:flex;gap:10px;margin-top:8px">
              <button class="btn primary" id="btnAnalyze">AIã§è§£æ</button>
              <button class="btn ghost" id="btnClearPreview">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ¶ˆå»</button>
            </div>
            <div id="aiMsg" class="msg" style="display:none"></div>
          </div>

          <figure class="preview" id="preview" hidden>
            <img id="previewImg" alt="preview" style="max-width:100%;border-radius:12px">
          </figure>
        </div>
      </div>

      <!-- é‡‘é¡/æ˜ç´° -->
      <div class="card">
        <h2>2. åˆè¨ˆé‡‘é¡ãƒ»å•†å“æ¦‚è¦</h2>

        <div class="row">
          <div>
            <label for="amount">åˆè¨ˆé‡‘é¡ï¼ˆå††ï¼‰</label>
            <input id="amount" inputmode="numeric" placeholder="1000">
          </div>
          <div>
            <label>ãƒ—ãƒªã‚»ãƒƒãƒˆ</label>
            <div class="kid-preset">
              <button class="btn" data-preset="500">Â¥500</button>
              <button class="btn" data-preset="1000">Â¥1,000</button>
              <button class="btn" data-preset="1500">Â¥1,500</button>
            </div>
          </div>
        </div>

        <label for="summary">å•†å“æ¦‚è¦ï¼ˆå„è¡Œã€Œå•†å“å * ä¾¡æ ¼å†† * æ•°é‡ã€ã‚‚ã—ãã¯ã€Œå•†å“å Ã—æ•°é‡ã€ï¼‰</label>
        <textarea id="summary" placeholder="ã‚Šã‚“ã”ã‚¸ãƒ¥ãƒ¼ã‚¹ * 500å†† * 1&#10;ã‚¯ãƒƒã‚­ãƒ¼ Ã—2"></textarea>
      </div>

      <!-- ç™»éŒ² â†’ ãƒ¢ãƒ¼ãƒ€ãƒ«ç¢ºèª -->
      <div class="card">
        <h2>3. é‡‘é¡ã‚’ç™»éŒ²ï¼ˆç¢ºèªç”»é¢ã‚ã‚Šï¼‰</h2>
        <div style="display:flex;gap:10px;margin-bottom:8px">
          <button class="btn primary" id="btnRegister">é‡‘é¡ã‚’ç™»éŒ²</button>
          <button class="btn ghost" id="btnReset">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        <div id="msg" class="msg" style="display:none"></div>
      </div>

      <!-- å›ºå®šQR -->
      <div class="card" id="qrCard">
        <h2>4. å›ºå®šQRï¼ˆè³¼å…¥è€…æç¤ºç”¨ï¼‰</h2>
        <div class="qrbox">
          <div id="qrcode"></div>
          <button class="btn" id="openBuyer">è³¼å…¥è€…ç”¨ãƒšãƒ¼ã‚¸ã‚’é–‹ã</button>
        </div>
        <p class="hint">ã“ã®QR/ãƒªãƒ³ã‚¯ã¯å›ºå®šã§ã™ã€‚é‡‘é¡ã¯ã€Œãƒšãƒ³ãƒ‡ã‚£ãƒ³ã‚°ç™»éŒ²ã€ã—ãŸæœ€æ–°ã®å€¤ãŒè³¼å…¥è€…å´ã§è‡ªå‹•åæ˜ ã•ã‚Œã¾ã™ã€‚</p>
      </div>
    </div>
  </div>

  <!-- ========== å…±é€šï¼šç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå¤§äºº/å­ã©ã‚‚æ—§ï¼‰ ========== -->
  <div class="overlay" id="confirmOverlay" aria-modal="true" role="dialog">
    <div class="modal">
      <h3>ğŸ§¾ å†…å®¹ã‚’ã‹ãã«ã‚“</h3>
      <div class="list" id="confirmList"></div>
      <div class="priceXL" id="confirmPrice">Â¥ -</div>
      <label class="ck">
        <input type="checkbox" id="adultCheck">
        <span>ğŸ‘¤ ãŠã¨ãª ã« ã¿ã¦ã‚‚ã‚‰ã£ãŸ</span>
      </label>
      <div class="rowbtn">
        <button class="btn ghost" id="btnEdit">ãªãŠã™</button>
        <button class="btn primary" id="btnConfirm" disabled>ã¯ã„ï¼ˆç™»éŒ²ã™ã‚‹ï¼‰</button>
      </div>
    </div>
  </div>

  <!-- ========== ãƒ†ãƒ³ã‚­ãƒ¼ ========== -->
  <div class="overlay" id="numpadOverlay" aria-modal="true" role="dialog">
    <div class="modal">
      <h3>ğŸ”¢ ãã‚“ãŒã ã‚’ ã„ã‚Œã¦ã­</h3>
      <input id="npDisplay" inputmode="numeric" aria-label="ãã‚“ãŒã" readonly>
      <div class="numpad">
        <button class="btn" data-np="1">1</button>
        <button class="btn" data-np="2">2</button>
        <button class="btn" data-np="3">3</button>
        <button class="btn" data-np="4">4</button>
        <button class="btn" data-np="5">5</button>
        <button class="btn" data-np="6">6</button>
        <button class="btn" data-np="7">7</button>
        <button class="btn" data-np="8">8</button>
        <button class="btn" data-np="9">9</button>
        <button class="btn" id="npClear">C</button>
        <button class="btn" data-np="0">0</button>
        <button class="btn primary" id="npOk">OK</button>
      </div>
    </div>
  </div>

  <!-- ========== èª­ã¿è¾¼ã¿ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ ========== -->
  <div class="loading-ol" id="loadingOverlay" role="alert" aria-live="assertive">
    <div class="spinner" aria-hidden="true"></div>
    <div style="font-size:1.25rem;margin-bottom:4px">ã‚ˆã¿ã“ã¿ã¡ã‚…ã†â€¦</div>
    <div class="hint">ãã®ã¾ã¾ ã¾ã£ã¦ã­</div>
  </div>

  <!-- ========== QR ========== -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- ========== ã‚¢ãƒ—ãƒªæœ¬ä½“ ========== -->
  <script>
    /* ------------------ ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£çŸ­ç¸® ------------------ */
    const $ = s => document.querySelector(s);
    const params = new URLSearchParams(location.search);

    /* ------------------ ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆå›ºå®šï¼‰ ------------------ */
    const ENDPOINT_ANALYZE = '/api/analyze-item';   // ç”»åƒâ†’items/total/summary
    const ENDPOINT_PENDING = '/api/pending/start';  // ãƒšãƒ³ãƒ‡ã‚£ãƒ³ã‚°ç™»éŒ²
    const CHECKOUT_PATH    = '/checkout.html';      // è³¼å…¥è€…ç”»é¢

    /* ------------------ çŠ¶æ…‹ ------------------ */
    const model = {
      sellerId: params.get('s') || '',
      amount:   0,
      summary:  '',
      lastLog:  '',
      items:    [] // {id,name,qty,unit_price}
    };

    const fx = {
      ok(){ try{ navigator.vibrate?.(24); }catch{} },
      ng(){ try{ navigator.vibrate?.([40,40]); }catch{} }
    };

    /* ------------------ å…±é€šé–¢æ•° ------------------ */
    function setText(sel, txt){ const el=$(sel); if(el) el.textContent = txt; }
    function setHTML(sel, html){ const el=$(sel); if(el) el.innerHTML = html; }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
    }
    function kidMsg(type, text){ const el=$('#k-aiMsg'); if(!el) return; el.className='msg '+type; el.textContent=text; el.style.display='block'; }
    function showMsg(type, text){ const el=$('#msg'); if(!el) return; el.className='msg '+type; el.textContent=text; el.style.display='block'; }
    function setLoading(v){ $('#loadingOverlay')?.classList.toggle('show', !!v); }
    function logDebug(s){
      model.lastLog = (model.lastLog ? model.lastLog + '\n' : '') + s;
      const box = $('#dbg-log'); if (box) box.textContent = model.lastLog; console.log('[DBG]', s);
    }
    function flash(sel){ const el=$(sel); if(!el) return; const org=el.style.boxShadow; el.style.boxShadow='0 0 0 3px #c9eedc,0 6px 24px rgba(0,0,0,.12)'; setTimeout(()=>el.style.boxShadow=org, 900); }

    // ç©º/éJSON/422ã§ã‚‚è½ã¡ãªã„fetch
    async function fetchJsonSafe(url, opts={}){
      const ac=new AbortController(); const to=setTimeout(()=>ac.abort(), 15000);
      try{
        const res = await fetch(url, { ...opts, signal: ac.signal });
        const ct  = res.headers.get('content-type') || '';
        const text= await res.text();
        let data  = null; if (text && ct.includes('application/json')) { try{ data = JSON.parse(text); }catch{} }
        return { res, data, text, ct };
      } finally { clearTimeout(to); }
    }

    /* ------------------ ç”»é¢åˆ‡æ›¿/QR ------------------ */
    function switchMode(kid){
      $('#tabKid').classList.toggle('active', kid);
      $('#tabAdult').classList.toggle('active', !kid);
      $('#kidApp').classList.toggle('active', kid);
      $('#kidApp').style.display = kid ? 'block' : 'none';
      $('#adultApp').style.display = kid ? 'none' : 'block';
    }
    function goKid(n){
      [1,2,3,4].forEach(i => $('#k-step'+i)?.classList.remove('active'));
      const next = $('#k-step'+n);
      if (next) { next.classList.add('active'); window.scrollTo({top:0,behavior:'smooth'}); }
      else { logDebug('goKid: k-step'+n+' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); }
    }
    function buildBuyerUrl(){ return `${location.origin}${CHECKOUT_PATH}?s=${encodeURIComponent(model.sellerId||'')}`; }
    function setQR(sel){ const el=$(sel); if(!el) return; el.innerHTML=''; new QRCode(el, { text: buildBuyerUrl(), width: 200, height: 200, correctLevel: QRCode.CorrectLevel.M }); }
    function syncSellerId(v){ model.sellerId = (v||'').trim(); setQR('#qrcode'); setQR('#k-qrcode'); }

    /* ------------------ å­ã©ã‚‚ï¼šUIæ›´æ–° ------------------ */
    function setKidAmount(v){
      if(!Number.isFinite(v) || v<100 || v>1_000_000){ kidMsg('err','ãã‚“ãŒãã‚’ ã„ã‚Œã¦ã­ï¼ˆ100ã€œ1,000,000ï¼‰'); fx.ng(); return; }
      model.amount = v; updateKidPanels(); fx.ok();
    }

    function updateKidPanels(){
      const summaryHtml = model.summary?.trim() ? `<pre style="margin:0">${escapeHtml(model.summary)}</pre>` : 'ï¼ˆã—ã‚‡ã†ã²ã‚“ ã˜ã‚‡ã†ã»ã† ãªã—ï¼‰';
      setHTML('#k2-summary-view', summaryHtml);
      setText('#k-amtView', 'ã„ã¾ï¼š' + (model.amount ? ('Â¥'+model.amount.toLocaleString()) : 'â€”'));
      setText('#k2-sum',     model.amount ? ('Â¥'+model.amount.toLocaleString()) : 'â€”');
      setHTML('#k-listWrap', summaryHtml); setText('#k-sum', model.amount ? ('Â¥'+model.amount.toLocaleString()) : 'â€”');
      const a1=$('#k2-adult'); if(a1){ a1.checked=false; $('#k2-go').disabled=true; }
      const a2=$('#k-adult');  if(a2){ a2.checked=false;  $('#k-go').disabled=true; }
    }

    function requireBasics(){
      if(!model.sellerId){ kidMsg('err','ã—ã‚…ã£ã¦ã‚“ã—ã‚ƒID ã‚’ ã„ã‚Œã¦ã­'); return false; }
      if(!Number.isInteger(model.amount) || model.amount<100){ kidMsg('err','ãã‚“ãŒã ã‚’ ãˆã‚‰ã‚“ã§ã­'); return false; }
      return true;
    }

    /* ------------------ ä¾¡æ ¼ãƒ‘ãƒƒãƒ‰ ------------------ */
    function getSavedPrice(name){ try{ const map = JSON.parse(localStorage.getItem('fp_last_prices')||'{}'); return map[name]||null; }catch{return null;}}
    function savePrice(name, price){ try{ const map = JSON.parse(localStorage.getItem('fp_last_prices')||'{}'); map[name]=price; localStorage.setItem('fp_last_prices', JSON.stringify(map)); }catch{} }

    function renderPricePad(items){
      const wrap = $('#k2-pricepad'); const body = $('#k2-pricepad-body'); if(!wrap||!body) return;
      const quick = [100,200,300,500,800,1000,1200,1500,2000,3000,5000];
      body.innerHTML = items.map(it=>{
        const last = getSavedPrice(it.name);
        const btns = [...quick, last].filter(v=>Number.isInteger(v)).filter((v,i,a)=>a.indexOf(v)===i);
        return `
          <div class="pp-item">
            <div class="pp-title">${escapeHtml(it.name)}</div>
            <div class="pp-row">
              <div class="pp-quick">
                ${btns.map(v=>`<button class=\"btn\" data-id=\"${it.id}\" data-v=\"${v}\">Â¥${v}</button>`).join('')}
              </div>
              <div class="pp-row">
                <input type="number" min="0" step="1" placeholder="ä¾¡æ ¼" id="pp-price-${it.id}" style="width:120px" />
                <div class="pp-qty">
                  <button class="btn" data-pp-minus="${it.id}">âˆ’</button>
                  <input type="number" min="1" step="1" value="${it.qty}" id="pp-qty-${it.id}" style="width:72px" />
                  <button class="btn" data-pp-plus="${it.id}">ï¼‹</button>
                </div>
              </div>
            </div>
          </div>`;
      }).join('');

      wrap.style.display='block';

      wrap.onclick = (e)=>{
        const t=e.target;
        if(t.matches('[data-id][data-v]')){ const id=t.getAttribute('data-id'); $('#pp-price-'+id).value = t.getAttribute('data-v'); }
        if(t.matches('[data-pp-plus]')){ const id=t.getAttribute('data-pp-plus'); const el=$('#pp-qty-'+id); el.value = Math.max(1, (+el.value||1)+1); }
        if(t.matches('[data-pp-minus]')){ const id=t.getAttribute('data-pp-minus'); const el=$('#pp-qty-'+id); el.value = Math.max(1, (+el.value||1)-1); }
      };

      $('#k2-pricepad-cancel').onclick = ()=>{ wrap.style.display='none'; };
      $('#k2-pricepad-ok').onclick = ()=>{
        let unresolved = [];
        items.forEach(it=>{
          const pv = parseInt(($('#pp-price-'+it.id).value||'').replace(/\D/g,''),10);
          const qv = parseInt($('#pp-qty-'+it.id).value||'1',10);
          if(Number.isFinite(pv)) { it.unit_price = Math.floor(pv); savePrice(it.name, it.unit_price); }
          it.qty = Math.max(1, Math.floor(qv||1));
          if(!Number.isFinite(it.unit_price)) unresolved.push(it.name);
        });
        if(unresolved.length){ alert(unresolved[0]+' ã®ä¾¡æ ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
        wrap.style.display='none';
        finalizeFromItems(items);
      };
    }

    function finalizeFromItems(items){
      // summaryï¼ˆ* åŒºåˆ‡ã‚Šï¼‰ã¨åˆè¨ˆ
      const summary = items.map(it=>`${it.name} * ${it.unit_price}å†† * ${it.qty}`).join("\n");
      const total   = items.reduce((s,it)=> s + (it.unit_price*it.qty), 0);
      model.summary = summary; model.amount = total; updateKidPanels(); fx.ok();
    }

    /* ------------------ å­ã©ã‚‚ï¼šæ’®å½±â†’AI ------------------ */
    async function onKidPhotoTaken(e){
      const f = e.target.files?.[0]; if(!f){ kidMsg('err','ã—ã‚ƒã—ã‚“ã‚’ ãˆã‚‰ã‚“ã§ã­'); fx.ng(); return; }

      // å…ˆã«å¿…ãšé·ç§»ï¼ˆUXï¼‰
      goKid(2); setLoading(true); $('#k2-summary-edit-wrap').style.display='none'; kidMsg('ok','ã—ã‚ƒã—ã‚“ã‚’ ã†ã‘ã¨ã‚Šã¾ã—ãŸã€‚ã„ã¾ ã—ã‚‰ã¹ã¦ã„ã¾ã™â€¦');

      try{
        const fd=new FormData(); fd.append('file', f, f.name); // ã‚µãƒ¼ãƒã¯ "file" ã‚’æœŸå¾…
        const {res, data, text} = await fetchJsonSafe(ENDPOINT_ANALYZE, { method:'POST', body:fd });
        logDebug(`analyze ${res.status}\n${text||'(empty body)'}`);

        if(res.ok){
          const items  = Array.isArray(data?.items) ? data.items : [];
          const totalN = Number.isInteger(data?.total) ? Number(data.total) : null;

          // items ã‚’å†…éƒ¨å½¢å¼ã¸
          model.items = items.map((it,i)=>({ id:i, name:String(it?.name||`å•†å“${i+1}`), qty: (parseInt(it?.qty,10)||1), unit_price: Number.isInteger(it?.unit_price)? it.unit_price : null }));

          // ã‚µãƒ¼ãƒ summary ãŒã‚ã‚Œã°æ¡ç”¨ï¼ˆãªã‘ã‚Œã°å¾Œã§ç”Ÿæˆï¼‰
          if (typeof data?.summary === 'string' && data.summary.trim()){
            model.summary = data.summary.trim();
          } else { model.summary = ''; }

          // total ãŒã‚ã‚Œã°æ¡ç”¨
          if (Number.isInteger(totalN)) model.amount = totalN; else model.amount = 0;

          // å€¤æœ­ãªã—: å˜ä¾¡æ¬ ã‘ã®è¡ŒãŒã‚ã‚‹ â†’ ä¾¡æ ¼ãƒ‘ãƒƒãƒ‰ã§è£œå®Œ
          const need = model.items.filter(x=>!Number.isFinite(x.unit_price));
          if (model.items.length && need.length){
            kidMsg('ok','ã—ã‚‡ã†ã²ã‚“ ã‚’ ã¿ã¤ã‘ã¾ã—ãŸã€‚ã­ã ã‚“ ã‚’ ã„ã‚Œã¦ã­');
            renderPricePad(model.items);
          } else if (!model.summary && model.items.length){
            // AIãŒunit_priceã‚’æŒã£ã¦ã„ã‚‹ â†’ ã“ã¡ã‚‰ã§ summary ç”Ÿæˆ
            finalizeFromItems(model.items);
            kidMsg('ok','AIã® ã‘ã£ã‹ã‚’ ã¯ã‚“ãˆã„ã—ã¾ã—ãŸ');
          } else if (!model.summary && !model.amount){
            kidMsg('err','AIã® ã‘ã£ã‹ãŒ ã‚ã‚Šã¾ã›ã‚“ã€‚ã¦ã§ ã„ã‚Œã¦ã­ã€‚');
            $('#k2-summary-edit-wrap').style.display='block';
          } else {
            kidMsg('ok','AIã® ã‘ã£ã‹ã‚’ ã¯ã‚“ãˆã„ã—ã¾ã—ãŸ');
          }
        } else if (res.status===422){
          kidMsg('err','AIãŒ ã‚ˆã¿ã¨ã‚Œã¾ã›ã‚“ã§ã—ãŸï¼ˆemptyï¼‰ã€‚ã¦ã§ ã„ã‚Œã¦ã­ã€‚');
          $('#k2-summary-edit-wrap').style.display='block';
        } else {
          kidMsg('err','AIã® ã‚ˆã¿ã“ã¿ã§ ãˆã‚‰ãƒ¼ãŒ ã§ã¾ã—ãŸã€‚ã¦ã§ ã„ã‚Œã¦ã­ã€‚');
          $('#k2-summary-edit-wrap').style.display='block';
        }
      } catch(err){
        kidMsg('err','AIã‚¨ãƒ©ãƒ¼: '+(err?.message||err));
        $('#k2-summary-edit-wrap').style.display='block';
      } finally { updateKidPanels(); setLoading(false); }
    }

    /* ------------------ å¤§äººï¼šAI ------------------ */
    async function onAnalyzeAdult(){
      const f=$('#file').files?.[0]; if(!f){ showMsg('err','ç”»åƒã‚’é¸ã‚“ã§ãã ã•ã„'); return; }
      try{
        const fd=new FormData(); fd.append('file', f, f.name);
        const {res, data, text} = await fetchJsonSafe(ENDPOINT_ANALYZE, { method:'POST', body:fd });
        logDebug(`adult analyze ${res.status}\n${text||'(empty body)'}`);
        if(res.ok){
          if (typeof data?.summary === 'string') { $('#summary').value = data.summary.trim(); model.summary = data.summary.trim(); }
          if (Number.isInteger(data?.total)) { $('#amount').value = String(data.total); model.amount = data.total; }
          showMsg('ok','AIè§£æãŒå®Œäº†ã—ã¾ã—ãŸ');
        }else{ showMsg('err', res.status===422 ? 'AIãŒèª­ã¿å–ã‚Œã¾ã›ã‚“ï¼ˆemptyï¼‰' : `AIã‚¨ãƒ©ãƒ¼: HTTP ${res.status}`); }
      }catch(e){ showMsg('err','AIã‚¨ãƒ©ãƒ¼: '+(e?.message||e)); }
    }

    /* ------------------ ç™»éŒ²ï¼ˆå­/å¤§å…±é€šï¼‰ ------------------ */
    async function performRegister(sellerId, amount, summary){
      try{
        if(!sellerId) throw new Error('å‡ºåº—è€…IDã¯å¿…é ˆã§ã™');
        if(!Number.isInteger(amount) || amount < 100) throw new Error('é‡‘é¡ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ï¼ˆ100å††ä»¥ä¸Šï¼‰');
        const body = JSON.stringify({ sellerId, amount, summary });
        const {res, data, text} = await fetchJsonSafe(ENDPOINT_PENDING, { method:'POST', headers:{ 'Content-Type':'application/json' }, body });
        logDebug(`pending ${res.status}\n${text||'(empty body)'}`);
        if (res.ok){ showMsg('ok','ç™»éŒ²ã—ã¾ã—ãŸã€‚è³¼å…¥è€…å´ã«åæ˜ ã•ã‚Œã¾ã™ã€‚'); flash('#qrCard'); setQR('#qrcode'); setQR('#k-qrcode'); fx.ok(); return true; }
        const serverMsg = (data?.error || data?.message || text || '').trim(); showMsg('err', serverMsg || `ç™»éŒ²ã‚¨ãƒ©ãƒ¼: HTTP ${res.status}`); fx.ng(); return false;
      }catch(e){ showMsg('err', e.message || 'ç™»éŒ²ã‚¨ãƒ©ãƒ¼'); fx.ng(); return false; }
    }

    /* ------------------ å¤§äººï¼šå€¤ã®å¸ã„ä¸Šã’ï¼†ãƒ¢ãƒ¼ãƒ€ãƒ« ------------------ */
    function getAdultValues(){
      const sellerId = ($('#sellerId').value || $('#sellerIdKid').value || '').trim();
      const amount   = parseInt(($('#amount').value || model.amount || '').toString().replace(/[^\d]/g,''), 10);
      const summary  = ($('#summary').value || model.summary || '').trim();
      model.sellerId = sellerId; model.amount = Number.isFinite(amount) ? amount : 0; model.summary = summary; return { sellerId, amount: model.amount, summary };
    }

    function openConfirm({sellerId,amount,summary}){
      if(!sellerId){ showMsg('err','å‡ºåº—è€…IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      if(!Number.isInteger(amount)||amount<100){ showMsg('err','é‡‘é¡ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“'); return; }
      const lines = (summary||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      $('#confirmList').innerHTML = lines.length ? lines.map(l=>'ğŸ› '+escapeHtml(l)).join('<br>') : 'ï¼ˆå•†å“æƒ…å ±ãªã—ï¼‰';
      $('#confirmPrice').textContent = 'Â¥'+amount.toLocaleString();
      $('#adultCheck').checked=false; $('#btnConfirm').disabled=true; $('#confirmOverlay').classList.add('show');
    }

    /* ------------------ èµ·å‹•å‡¦ç† ------------------ */
    (function init(){
      // ã‚¿ãƒ–
      $('#tabKid').onclick = () => switchMode(true);
      $('#tabAdult').onclick = () => switchMode(false);

      // IDåŒæœŸ
      $('#sellerIdKid').value = model.sellerId; $('#sellerIdKid').addEventListener('input', e => syncSellerId(e.target.value));

      // æ’®å½±ï¼ˆiOSå¯¾ç­–ï¼šchange/inputä¸¡å¯¾å¿œï¼‰
      const fileEl = $('#kidFile');
      $('#k-take').addEventListener('click', () => fileEl.click());
      fileEl.addEventListener('change', onKidPhotoTaken, { passive:true });
      fileEl.addEventListener('input',  onKidPhotoTaken, { passive:true });

      // é‡‘é¡ãƒ—ãƒªã‚»ãƒƒãƒˆ
      document.querySelectorAll('[data-kid-price]').forEach(b=>b.addEventListener('click',()=> setKidAmount(+b.dataset.kidPrice)));

      // ãƒ†ãƒ³ã‚­ãƒ¼
      $('#k-more').addEventListener('click', ()=> { $('#npDisplay').value=''; $('#numpadOverlay').classList.add('show'); });
      document.querySelectorAll('[data-np]').forEach(b=>b.addEventListener('click',()=> $('#npDisplay').value += b.dataset.np ));
      $('#npClear').onclick = ()=> $('#npDisplay').value='';
      $('#npOk').onclick    = ()=> { const v=parseInt($('#npDisplay').value||'0',10); if(Number.isFinite(v)) setKidAmount(v); $('#numpadOverlay').classList.remove('show'); };

      // æ˜ç´°æ‰‹å‹•
      $('#k2-summary-apply').addEventListener('click', ()=> { model.summary=$('#k2-summary-edit').value.trim(); updateKidPanels(); });

      // åŒç”»é¢ç¢ºèªâ†’ç™»éŒ²
      $('#k2-adult').addEventListener('change', e => $('#k2-go').disabled = !e.target.checked);
      $('#k2-go').addEventListener('click', async ()=>{ if(!requireBasics()) return; const ok = await performRegister(model.sellerId, model.amount, model.summary); if(ok) goKid(4); });

      // æ—§ç¢ºèªã‚¹ãƒ†ãƒƒãƒ—ï¼ˆæ®‹ç½®ï¼‰
      $('#k-back').addEventListener('click', ()=> goKid(2));
      $('#k-adult').addEventListener('change', e => $('#k-go').disabled = !e.target.checked);
      $('#k-go').addEventListener('click', async ()=>{ if(!requireBasics()) return; const ok = await performRegister(model.sellerId, model.amount, model.summary); if(ok) goKid(4); });

      // å¤§äººï¼šAI
      $('#btnAnalyze').addEventListener('click', onAnalyzeAdult);
      $('#file').addEventListener('change', e=>{ const f=e.target.files?.[0]; if(!f) return; $('#preview').hidden=false; $('#previewImg').src=URL.createObjectURL(f); });
      $('#btnClearPreview').addEventListener('click', ()=> { $('#preview').hidden=true; $('#previewImg').src=''; $('#aiMsg').style.display='none'; });

      // å¤§äººï¼šç™»éŒ²ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ç¢ºèªï¼‰
      $('#btnRegister').addEventListener('click', ()=> openConfirm(getAdultValues()));
      $('#btnReset').addEventListener('click', ()=> { $('#amount').value=''; $('#summary').value=''; showMsg('ok','ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ'); });

      // ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ
      $('#btnEdit').onclick = ()=> $('#confirmOverlay').classList.remove('show');
      $('#adultCheck').onchange = e => $('#btnConfirm').disabled = !e.target.checked;
      $('#btnConfirm').onclick = async ()=>{ const {sellerId,amount,summary}=getAdultValues(); const ok = await performRegister(sellerId, amount, summary); if(ok) $('#confirmOverlay').classList.remove('show'); };

      // QR
      setQR('#qrcode'); setQR('#k-qrcode');

      // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
      window.addEventListener('error', ev => logDebug('JS Error: '+ev.message));
      window.addEventListener('unhandledrejection', ev => logDebug('Promise Rejection: '+(ev.reason?.message||ev.reason)));

      // æ—¢å®šã¯ã“ã©ã‚‚
      switchMode(true);
    })();
  </script>
</body>
</html>

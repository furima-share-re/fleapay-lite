<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FleaPayï½œå‡ºåº—è€…UIï¼ˆã“ã©ã‚‚/ãŠã¨ãªãƒ»AIä»»æ„ï¼‰</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/modern-normalize/2.0.0/modern-normalize.min.css" rel="stylesheet">
<style>
  :root{
    --bg:#f7f7fb;--panel:#fff;--text:#222;--sub:#666;--brand:#5a6bff;
    --ok:#1a9b63;--err:#e5484d;--bd:#e6e6ee;
  }
  body{background:var(--bg);color:var(--text);font:16px/1.6 system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP",Arial,sans-serif}
  .wrap{max-width:880px;margin:20px auto;padding:0 16px}
  header{display:flex;align-items:center;justify-content:space-between;margin:8px 0 12px}
  .modeSwitch{display:flex;gap:8px}
  .chip{display:inline-flex;align-items:center;gap:.4em;padding:8px 12px;border-radius:999px;border:1px solid var(--bd);background:#fff;cursor:pointer}
  .chip.active{background:var(--brand);border-color:var(--brand);color:#fff}
  .card{background:var(--panel);border:1px solid var(--bd);border-radius:16px;padding:20px;margin:14px 0;box-shadow:0 2px 10px rgba(0,0,0,.04)}
  h1{font-size:1.4rem;margin:0}
  h2{font-size:1.1rem;margin:0 0 8px}
  label{display:block;font-size:.9rem;color:var(--sub);margin:6px 0 6px}
  input,textarea{width:100%;padding:12px 14px;border:1px solid var(--bd);border-radius:12px;background:#fff;outline:none;font:inherit}
  textarea{min-height:110px;white-space:pre-wrap}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5em;padding:12px 16px;border-radius:999px;border:1px solid var(--bd);background:#fff;cursor:pointer}
  .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .msg{padding:12px 14px;border-radius:12px;margin:10px 0;border:1px solid transparent}
  .msg.ok{background:#e9f7ef;color:#0f6b43;border-color:#c9eedc}
  .msg.err{background:#fff1f1;color:#a1161b;border-color:#ffd7d9}
  .qrbox{display:flex;flex-direction:column;align-items:center;gap:12px;padding:16px;border:1px dashed var(--bd);border-radius:14px;background:#fff}
  .hint{font-size:.82rem;color:#888}

  /* ã“ã©ã‚‚ãƒ¢ãƒ¼ãƒ‰ */
  #kidApp{display:none}
  #kidApp.active{display:block}
  .kid-screen{display:none;flex-direction:column;align-items:center;justify-content:center;gap:18px;text-align:center}
  .kid-screen.active{display:flex !important}
  .kid-h1{font-size:1.8rem}
  .kid-big{font-size:1.4rem;padding:18px 24px;border-radius:20px}
  .kid-preset{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;width:100%}
  .kid-preset .btn{height:80px;font-size:1.4rem}
  .kid-qr{width:260px;height:260px;background:#fff;border:4px solid #000;border-radius:12px;display:flex;align-items:center;justify-content:center}
  .kid-hint{font-size:1rem;color:#333}
  .divider{height:1px;background:#eee;margin:12px 0}
  .fileinput{display:none}

  /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
  .loading-ol{position:fixed;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;background:rgba(255,255,255,.94);z-index:10000}
  .loading-ol.show{display:flex}
  .spinner{width:72px;height:72px;border-radius:50%;border:8px solid #e5e7eb;border-top-color:var(--brand);animation:spin 1s linear infinite;margin-bottom:16px}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* ãƒ‡ãƒãƒƒã‚° */
  details.debug{margin-top:12px}
  details.debug pre{white-space:pre-wrap;font-family:ui-monospace,Consolas,monospace;background:#fff;border:1px solid #eee;border-radius:10px;padding:10px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>FleaPayï½œå‡ºåº—è€…UI</h1>
      <div class="modeSwitch" role="tablist" aria-label="ãƒ¢ãƒ¼ãƒ‰ãã‚Šã‹ãˆ">
        <button class="chip active" id="tabKid" role="tab" aria-selected="true">ğŸ§’ ã“ã©ã‚‚</button>
        <button class="chip" id="tabAdult" role="tab" aria-selected="false">ğŸ‘¤ ãŠã¨ãª</button>
      </div>
    </header>

    <!-- ========== ã“ã©ã‚‚ãƒ¢ãƒ¼ãƒ‰ ========== -->
    <div id="kidApp" class="active" aria-label="ã“ã©ã‚‚ ã‚‚ãƒ¼ã©">
      <div class="card" style="padding:12px 16px">
        <label for="sellerIdKid">ğŸ†” ã—ã‚…ã£ã¦ã‚“ã—ã‚ƒIDï¼ˆãŠã¨ãªãŒ ã„ã‚Œã‚‹ï¼‰</label>
        <input id="sellerIdKid" placeholder="seller-test01" aria-label="ã—ã‚…ã£ã¦ã‚“ã—ã‚ƒ ã‚¢ã‚¤ãƒ‡ã‚£ãƒ¼">
        <div class="hint">â€» ?s=ID ã§åˆæœŸå€¤ã€‚ã‹ãˆã‚‹ã¨QRã‚‚è‡ªå‹•æ›´æ–°ã€‚</div>
      </div>

      <!-- â‘  ã—ã‚ƒã—ã‚“ -->
      <div id="k-step1" class="card kid-screen active">
        <div class="kid-h1">ğŸ“· ã—ã‚ƒã—ã‚“ã‚’ ã¨ã‚‹</div>
        <input id="kidFile" class="fileinput" type="file" accept="image/*" capture="environment" aria-label="ã—ã‚ƒã—ã‚“ã‚’ ãˆã‚‰ã¶">
        <button class="btn primary kid-big" id="k-take">ã—ã‚ƒã—ã‚“ã‚’ ã¨ã‚‹</button>
        <div id="k-aiMsg" class="msg" style="display:none"></div>
        <div class="hint">AIãŒæœªæ¥ç¶šã§ã‚‚ã¤ã¥ã‘ã‚‰ã‚Œã¾ã™ã€‚</div>
      </div>

      <!-- â‘¡ é‡‘é¡ï¼‹æ˜ç´°ï¼‹ç¢ºèªï¼ˆã“ã®ç”»é¢ã§å®Œçµï¼‰ -->
      <div id="k-step2" class="card kid-screen">
        <div class="kid-h1">ğŸ’° ãã‚“ãŒã ã‚’ ãˆã‚‰ã¶</div>

        <!-- æ˜ç´°ï¼ˆAIçµæœ or æ‰‹å‹•å…¥åŠ›ï¼‰ -->
        <div style="width:100%;text-align:left">
          <div style="font-weight:700;margin:4px 0 6px">ğŸ› ã—ã‚‡ã†ã²ã‚“ ã® ãŒã„ã‚ˆã†</div>
          <div id="k2-summary-view" class="kid-hint" style="background:#fff;border:1px solid #eee;border-radius:10px;padding:10px;min-height:48px">ï¼ˆã—ã‚‡ã†ã²ã‚“ ã˜ã‚‡ã†ã»ã† ãªã—ï¼‰</div>
          <div id="k2-summary-edit-wrap" style="margin-top:8px;display:none">
            <label style="font-weight:700">âœï¸ ã¦ã§ ã„ã‚Œã‚‹ï¼ˆå„è¡Œã€Œå•†å“å Ã—æ•°é‡ã€ï¼‰</label>
            <textarea id="k2-summary-edit" placeholder="ã‚«ãƒ¼ãƒ‰ Ã—1&#10;ã‚­ãƒ¼ãƒ›ãƒ«ãƒ€ãƒ¼ Ã—2"></textarea>
            <button class="btn" id="k2-summary-apply">ã“ã®ãªã„ã‚ˆã†ã§ ã¤ã‹ã†</button>
          </div>
        </div>

        <!-- é‡‘é¡ -->
        <div class="kid-preset" style="margin-top:10px">
          <button class="btn" data-kid-price="500">500ãˆã‚“</button>
          <button class="btn" data-kid-price="1000">1,000ãˆã‚“</button>
          <button class="btn" data-kid-price="1500">1,500ãˆã‚“</button>
        </div>
        <button class="btn" id="k-more" style="margin-top:6px">ã»ã‹ï¼ˆã¦ã„ã‚Œã„ ã°ã‚“ã”ã†ï¼‰</button>
        <div id="k-amtView" class="kid-hint">ã„ã¾ï¼šâ€”</div>

        <div class="divider"></div>

        <!-- ç¢ºèªï¼ˆåŒç”»é¢ï¼‰ -->
        <div style="width:100%;text-align:left">
          <div style="font-weight:700;margin:4px 0 6px">ğŸ§¾ ã‹ãã«ã‚“</div>
          <div class="kid-hint"><strong>ã”ã†ã‘ã„ï¼š</strong><span id="k2-sum">â€”</span></div>
          <label class="hint" style="display:block;margin-top:6px">
            <input type="checkbox" id="k2-adult"> ğŸ‘¤ ãŠã¨ãª ã« ã¿ã¦ã‚‚ã‚‰ã£ãŸ
          </label>
          <div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-top:8px">
            <button class="btn primary kid-big" id="k2-go" disabled>ã¯ã„ï¼ˆQRã¸ï¼‰</button>
          </div>
        </div>

        <details class="debug">
          <summary>ğŸ”§ ãƒ‡ãƒãƒƒã‚°</summary>
          <div>analyze: <code id="dbg-analyze-url">-</code></div>
          <div>pending: <code id="dbg-pending-url">-</code></div>
          <pre id="dbg-log">ï¼ˆãƒ­ã‚°ãªã—ï¼‰</pre>
        </details>
      </div>

      <!-- â‘¢ QR -->
      <div id="k-step4" class="card kid-screen">
        <div class="kid-h1">âœ… QR ã‚’ ãŠãã‚ƒãã•ã¾ ã« ã¿ã›ã‚‹</div>
        <div class="kid-qr"><div id="k-qrcode"></div></div>
        <button class="btn kid-big" id="k-open">ãŠãã‚ƒãã•ã¾ ãƒšãƒ¼ã‚¸ã‚’ ã²ã‚‰ã</button>
        <div class="hint">ã“ã®QR/ãƒªãƒ³ã‚¯ã¯ã“ã¦ã„ã€‚æœ€æ–°ã®ç™»éŒ²é‡‘é¡ãŒè‡ªå‹•åæ˜ ã€‚</div>
      </div>
    </div>

    <!-- ========== ãŠã¨ãªãƒ¢ãƒ¼ãƒ‰ï¼ˆç°¡ç•¥ï¼‰ ========== -->
    <div id="adultApp" style="display:none" aria-label="ãŠã¨ãª ã‚‚ãƒ¼ã©">
      <div class="card">
        <h2>1. å‡ºåº—è€…ãƒ»AIè§£æ</h2>
        <label for="sellerId">å‡ºåº—è€…ID</label>
        <input id="sellerId" placeholder="seller-test01">
        <div class="row" style="margin-top:8px">
          <div>
            <input id="file" type="file" accept="image/*" capture="environment">
            <div style="display:flex;gap:10px;margin-top:8px">
              <button class="btn primary" id="btnAnalyze">AIã§è§£æ</button>
              <button class="btn" id="btnClearPreview">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ¶ˆå»</button>
            </div>
            <div id="aiMsg" class="msg" style="display:none"></div>
          </div>
          <figure class="preview" id="preview" hidden><img id="previewImg" alt="preview" style="max-width:100%;border-radius:12px"></figure>
        </div>
      </div>

      <div class="card">
        <h2>2. åˆè¨ˆé‡‘é¡ãƒ»å•†å“æ¦‚è¦</h2>
        <div class="row">
          <div>
            <label for="amount">åˆè¨ˆé‡‘é¡ï¼ˆå††ï¼‰</label>
            <input id="amount" inputmode="numeric" placeholder="1000">
          </div>
          <div>
            <label>ãƒ—ãƒªã‚»ãƒƒãƒˆ</label>
            <div class="kid-preset">
              <button class="btn" data-preset="500">Â¥500</button>
              <button class="btn" data-preset="1000">Â¥1,000</button>
              <button class="btn" data-preset="1500">Â¥1,500</button>
            </div>
          </div>
        </div>
        <label for="summary">å•†å“æ¦‚è¦ï¼ˆå„è¡Œã€Œå•†å“å Ã—æ•°é‡ã€ï¼‰</label>
        <textarea id="summary" placeholder="ã‚Šã‚“ã”ã‚¸ãƒ¥ãƒ¼ã‚¹ Ã—1&#10;ã‚¯ãƒƒã‚­ãƒ¼ Ã—2"></textarea>
      </div>

      <div class="card">
        <h2>3. é‡‘é¡ã‚’ç™»éŒ²</h2>
        <button class="btn primary" id="btnRegister">é‡‘é¡ã‚’ç™»éŒ²</button>
        <div id="msg" class="msg" style="display:none"></div>
      </div>

      <div class="card" id="qrCard">
        <h2>4. å›ºå®šQR</h2>
        <div class="qrbox">
          <div id="qrcode"></div>
          <button class="btn" id="openBuyer">è³¼å…¥è€…ç”¨ãƒšãƒ¼ã‚¸ã‚’é–‹ã</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
  <div class="loading-ol" id="loadingOverlay" role="alert" aria-live="assertive">
    <div class="spinner" aria-hidden="true"></div>
    <div style="font-size:1.25rem;margin-bottom:4px">ã‚ˆã¿ã“ã¿ã¡ã‚…ã†â€¦</div>
    <div class="hint">ãã®ã¾ã¾ ã¾ã£ã¦ã­</div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>
  const $=s=>document.querySelector(s);
  const params=new URLSearchParams(location.search);

  // ===== è¨­å®šï¼ˆã‚¯ã‚¨ãƒªã§å·®ã—è¾¼ã¿å¯èƒ½ï¼‰ =====
  const ENDPOINT_ANALYZE = params.get('analyze') || '';         // ä¾‹: /api/analyze-item
  const ENDPOINT_PENDING = params.get('pending') || '/api/pending/start';
  const CHECKOUT_PATH    = params.get('cp') || '/checkout-matsuri.html';

  // ===== çŠ¶æ…‹ =====
  const model={ sellerId: params.get('s')||'', amount:0, summary:'', lastLog:'' };

  // ===== åˆæœŸåŒ– =====
  (function init(){
    // ç”»é¢åæ˜ 
    $('#sellerIdKid').value = model.sellerId;
    $('#sellerId').value    = model.sellerId;

    // ãƒ‡ãƒãƒƒã‚°æ¬„
    setText('#dbg-analyze-url', ENDPOINT_ANALYZE || '(æœªè¨­å®šï¼šAIãªã—é‹ç”¨)');
    setText('#dbg-pending-url', ENDPOINT_PENDING);

    // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
    $('#tabKid').onclick=()=>switchMode(true);
    $('#tabAdult').onclick=()=>switchMode(false);

    // IDåŒæœŸ
    $('#sellerIdKid').addEventListener('input',e=>syncSellerId(e.target.value));
    $('#sellerId').addEventListener('input',e=>syncSellerId(e.target.value));

    // å­ã©ã‚‚ï¼šæ’®å½±ï¼ˆiOSå¯¾ç­–ã§ input ã‚‚ãƒ•ãƒƒã‚¯ï¼‰
    const fileEl = $('#kidFile');
    $('#k-take').addEventListener('click',()=>fileEl.click());
    fileEl.addEventListener('change',onKidPhotoTaken,{passive:true});
    fileEl.addEventListener('input', onKidPhotoTaken,{passive:true});

    // å­ã©ã‚‚ï¼šé‡‘é¡
    document.querySelectorAll('[data-kid-price]').forEach(b=>b.addEventListener('click',()=>{ setKidAmount(+b.dataset.kidPrice); }));
    $('#k-more').addEventListener('click',()=>openKeypad());

    // å­ã©ã‚‚ï¼šæ˜ç´°æ‰‹å‹•å…¥åŠ›
    $('#k2-summary-apply').addEventListener('click',()=>{
      model.summary = $('#k2-summary-edit').value.trim();
      updateKidPanels();
    });

    // å­ã©ã‚‚ï¼šç¢ºèªâ†’ç™»éŒ²
    $('#k2-adult').addEventListener('change',e=>$('#k2-go').disabled=!e.target.checked);
    $('#k2-go').addEventListener('click',async ()=>{
      if(!requireBasics()) return;
      const ok=await performRegister(model.sellerId, model.amount, model.summary);
      if(ok){ goKid(4); }
    });

    // ãŠã¨ãªï¼šAI
    $('#btnAnalyze').addEventListener('click',onAnalyzeAdult);
    $('#file').addEventListener('change',e=>{const f=e.target.files?.[0]; if(!f)return; $('#previewImg').src=URL.createObjectURL(f); $('#preview').hidden=false;});
    $('#btnClearPreview').addEventListener('click',()=>{$('#preview').hidden=true; $('#previewImg').src=''; $('#aiMsg').style.display='none';});

    // ãŠã¨ãªï¼šç™»éŒ²
    $('#btnRegister').addEventListener('click',async ()=>{
      const sellerId=($('#sellerId').value||'').trim();
      const amount=parseInt(($('#amount').value||'').toString().replace(/[^\d]/g,''),10);
      const summary=($('#summary').value||'').trim();
      if(!sellerId) return showMsg('err','å‡ºåº—è€…IDã¯å¿…é ˆã§ã™');
      if(!Number.isInteger(amount) || amount<100) return showMsg('err','é‡‘é¡ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
      const ok=await performRegister(sellerId,amount,summary);
      if(ok) showMsg('ok','ç™»éŒ²ã—ã¾ã—ãŸ');
    });

    // QR
    setQR('#qrcode'); setQR('#k-qrcode');
    $('#openBuyer').onclick=()=>window.open(buildBuyerUrl(),'_blank');
    $('#k-open').onclick=()=>window.open(buildBuyerUrl(),'_blank');

    // æœ€åˆã¯å­ã©ã‚‚ãƒ¢ãƒ¼ãƒ‰
    switchMode(true);

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ï¼ˆJSã‚¨ãƒ©ãƒ¼ã‚‚ãƒ‡ãƒãƒƒã‚°æ¬„ã«å‡ºã™ï¼‰
    window.addEventListener('error',ev=>logDebug('JS Error: '+ev.message));
    window.addEventListener('unhandledrejection',ev=>logDebug('Promise Rejection: '+(ev.reason?.message||ev.reason)));
  })();

  function switchMode(kid){
    $('#tabKid').classList.toggle('active',kid);
    $('#tabAdult').classList.toggle('active',!kid);
    $('#kidApp').classList.toggle('active',kid);
    $('#kidApp').style.display=kid?'block':'none';
    $('#adultApp').style.display=kid?'none':'block';
  }

  function syncSellerId(v){
    model.sellerId=(v||'').trim();
    $('#sellerIdKid').value=model.sellerId;
    $('#sellerId').value=model.sellerId;
    setQR('#qrcode'); setQR('#k-qrcode');
  }

  function buildBuyerUrl(){ return `${location.origin}${CHECKOUT_PATH}?s=${encodeURIComponent(model.sellerId||'')}`; }
  function setQR(selector){
    const el=document.querySelector(selector); if(!el) return;
    el.innerHTML='';
    new QRCode(el,{text:buildBuyerUrl(),width:200,height:200,correctLevel:QRCode.CorrectLevel.M});
  }

  /* === é‡è¦: ç”»é¢é·ç§»é–¢æ•°ï¼ˆãªã‹ã£ãŸãŸã‚è¿½åŠ ï¼‰ === */
  function goKid(n){
    [1,2,4].forEach(i=>{
      const sec=document.getElementById('k-step'+i);
      if(sec) sec.classList.remove('active');
    });
    const next=document.getElementById('k-step'+n);
    if(next){ next.classList.add('active'); window.scrollTo({top:0,behavior:'smooth'}); }
    else{ logDebug('goKid: ã‚»ã‚¯ã‚·ãƒ§ãƒ³ k-step'+n+' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); }
  }

  // =========== å­ã©ã‚‚ï¼šæ’®å½±â†’ã¾ãšé·ç§»â†’AI(ä»»æ„) ===========
  async function onKidPhotoTaken(e){
    const f=e.target.files?.[0];
    if(!f){ kidMsg('err','ã—ã‚ƒã—ã‚“ã‚’ ãˆã‚‰ã‚“ã§ã­'); return; }

    // å…ˆã«å¿…ãšç”»é¢ã‚’é€²ã‚ã‚‹
    goKid(2);
    setLoading(true);
    $('#k2-summary-edit-wrap').style.display='none';
    kidMsg('ok','ã—ã‚ƒã—ã‚“ã‚’ ã†ã‘ã¨ã‚Šã¾ã—ãŸã€‚ã„ã¾ ã—ã‚‰ã¹ã¦ã„ã¾ã™â€¦');

    let aiOK=false;
    try{
      if(ENDPOINT_ANALYZE){
        const fd=new FormData(); fd.append('file',f,f.name);
        const res=await fetch(ENDPOINT_ANALYZE,{method:'POST',body:fd});
        const text=await res.text();
        logDebug(`analyze status ${res.status}\n${text}`);
        let j={}; try{ j=JSON.parse(text); }catch{}
        if(j.summary) model.summary=j.summary;
        if(j.amount)  model.amount = Number(j.amount)||0;
        aiOK = res.ok;
      }else{
        logDebug('analyze endpoint not set; skipping AI');
      }
    }catch(err){
      logDebug('analyze error: '+(err?.message||err));
    }finally{
      // çµæœåæ˜ ï¼æ‰‹å‹•åˆ‡æ›¿
      $('#k2-summary-edit-wrap').style.display = model.summary ? 'none' : 'block';
      if(!aiOK && ENDPOINT_ANALYZE){
        kidMsg('err','AIã® ã‘ã£ã‹ãŒ ã¨ã‚Œã¾ã›ã‚“ã€‚ã¦ã§ ã„ã‚Œã¦ã­ã€‚');
      }
      updateKidPanels();
      setLoading(false);
    }
  }

  // =========== å­ã©ã‚‚ï¼šUIæ›´æ–° ===========
  function setKidAmount(v){
    if(!Number.isFinite(v) || v<100 || v>1_000_000){
      kidMsg('err','ãã‚“ãŒãã‚’ ã„ã‚Œã¦ã­ï¼ˆ100ã€œ1,000,000ï¼‰'); return;
    }
    model.amount=v; updateKidPanels();
  }
  function updateKidPanels(){
    setHTML('#k2-summary-view', model.summary?.trim()
      ? `<pre style="margin:0">${escapeHtml(model.summary)}</pre>`
      : 'ï¼ˆã—ã‚‡ã†ã²ã‚“ ã˜ã‚‡ã†ã»ã† ãªã—ï¼‰');
    setText('#k-amtView', 'ã„ã¾ï¼š' + (model.amount?('Â¥'+model.amount.toLocaleString()):'â€”'));
    setText('#k2-sum',     model.amount?('Â¥'+model.amount.toLocaleString()):'â€”');
    // ç¢ºèªãƒã‚§ãƒƒã‚¯ã¯æ¯å›ãƒªã‚»ãƒƒãƒˆ
    const ad=$('#k2-adult'); if(ad){ ad.checked=false; $('#k2-go').disabled=true; }
  }

  // =========== ãŠã¨ãªï¼šAI ===========
  async function onAnalyzeAdult(){
    const f=$('#file').files?.[0];
    if(!f){ showMsg('err','ç”»åƒã‚’é¸ã‚“ã§ãã ã•ã„'); return; }
    if(!ENDPOINT_ANALYZE){ showMsg('err','AIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒæœªè¨­å®šã§ã™ï¼ˆ?analyze=URL ã‚’ä»˜ä¸ï¼‰'); return; }
    try{
      const fd=new FormData(); fd.append('file',f,f.name);
      const res=await fetch(ENDPOINT_ANALYZE,{method:'POST',body:fd});
      const text=await res.text(); logDebug(`adult analyze status ${res.status}\n${text}`);
      let j={}; try{ j=JSON.parse(text);}catch{}
      if(j.summary){ $('#summary').value=j.summary; model.summary=j.summary; }
      if(j.amount){ $('#amount').value=j.amount; model.amount=Number(j.amount)||0; }
      showMsg('ok','AIè§£æãŒå®Œäº†ã—ã¾ã—ãŸ');
    }catch(e){
      showMsg('err','AIè§£æã«å¤±æ•—ã—ã¾ã—ãŸ'); logDebug('adult analyze error: '+(e?.message||e));
    }
  }

  // =========== ç™»éŒ² ===========
  async function performRegister(sellerId,amount,summary){
    try{
      const res=await fetch(ENDPOINT_PENDING,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sellerId,amount,summary})});
      const text=await res.text(); logDebug(`pending status ${res.status}\n${text}`);
      if(!res.ok) throw new Error('ç™»éŒ²APIã‚¨ãƒ©ãƒ¼');
      return true;
    }catch(e){ kidMsg('err','ã¨ã†ã‚ãã« ã—ã£ã±ã„ã—ã¾ã—ãŸ'); return false; }
  }

  // å¿…é ˆãƒã‚§ãƒƒã‚¯
  function requireBasics(){
    if(!model.sellerId){ kidMsg('err','ã—ã‚…ã£ã¦ã‚“ã—ã‚ƒID ã‚’ ã„ã‚Œã¦ã­'); return false; }
    if(!Number.isInteger(model.amount)||model.amount<100){ kidMsg('err','ãã‚“ãŒã ã‚’ ãˆã‚‰ã‚“ã§ã­'); return false; }
    return true;
  }

  // å…±é€šUI/UTIL
  function setText(sel,txt){ const el=$(sel); if(el) el.textContent=txt; }
  function setHTML(sel,html){ const el=$(sel); if(el) el.innerHTML=html; }
  function showMsg(type,text){ const el=$('#msg'); if(!el) return; el.className='msg '+type; el.textContent=text; el.style.display='block'; }
  function kidMsg(type,text){ const el=$('#k-aiMsg'); if(!el) return; el.className='msg '+type; el.textContent=text; el.style.display='block'; }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function setLoading(v){ const ol=$('#loadingOverlay'); if(ol) ol.classList.toggle('show', !!v); }
  function logDebug(s){ model.lastLog=(model.lastLog?model.lastLog+'\n':'')+s; const box=$('#dbg-log'); if(box) box.textContent=model.lastLog; console.log('[DBG]',s); }

  // ç°¡æ˜“ãƒ†ãƒ³ã‚­ãƒ¼ï¼ˆpromptã§ä»£ç”¨ï¼šå®Ÿé‹ç”¨ã§ã¯å°‚ç”¨UIã«ç½®æ›å¯ï¼‰
  function openKeypad(){
    const v = window.prompt('ãã‚“ãŒã(å††) ã‚’ ã„ã‚Œã¦ã­', model.amount||'');
    const n = parseInt((v||'').toString().replace(/[^\d]/g,''),10);
    if(Number.isFinite(n)) setKidAmount(n);
  }
  </script>
</body>
</html>

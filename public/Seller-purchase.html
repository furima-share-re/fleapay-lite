<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FleaPayï½œå‡ºåº—è€…UIï¼ˆã“ã©ã‚‚/ãŠã¨ãª åˆ‡æ›¿ãƒ»ç¢ºèªç”»é¢ãƒ»matsuriç‰ˆï¼‰</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/modern-normalize/2.0.0/modern-normalize.min.css" rel="stylesheet">
<style>
  :root{
    --bg:#f7f7fb;--panel:#fff;--text:#222;--sub:#666;--brand:#5a6bff;
    --ok:#1a9b63;--err:#e5484d;--bd:#e6e6ee;--warn:#c97a00;
  }
  body{background:var(--bg);color:var(--text);font:16px/1.6 system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP",Arial,sans-serif}
  .wrap{max-width:880px;margin:20px auto;padding:0 16px}
  header{display:flex;align-items:center;justify-content:space-between;margin:8px 0 12px}
  .modeSwitch{display:flex;gap:8px}
  .chip{display:inline-flex;align-items:center;gap:.4em;padding:8px 12px;border-radius:999px;border:1px solid var(--bd);background:#fff;cursor:pointer}
  .chip.active{background:var(--brand);border-color:var(--brand);color:#fff}
  .card{background:var(--panel);border:1px solid var(--bd);border-radius:16px;padding:20px;margin:14px 0;box-shadow:0 2px 10px rgba(0,0,0,.04)}
  h1{font-size:1.4rem;margin:0}
  h2{font-size:1.1rem;margin:0 0 8px}
  label{display:block;font-size:.9rem;color:var(--sub);margin:6px 0 6px}
  input,textarea{width:100%;padding:12px 14px;border:1px solid var(--bd);border-radius:12px;background:#fff;outline:none;font:inherit}
  textarea{min-height:110px;white-space:pre-wrap}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5em;padding:12px 16px;border-radius:999px;border:1px solid var(--bd);background:#fff;cursor:pointer}
  .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .btn.ghost{background:#fff}
  .btn.warn{background:#fff3d6;border-color:#ffd27a}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .msg{padding:12px 14px;border-radius:12px;margin:10px 0;border:1px solid transparent}
  .msg.ok{background:#e9f7ef;color:#0f6b43;border-color:#c9eedc}
  .msg.err{background:#fff1f1;color:#a1161b;border-color:#ffd7d9}
  .qrbox{display:flex;flex-direction:column;align-items:center;gap:12px;padding:16px;border:1px dashed var(--bd);border-radius:14px;background:#fff}
  .hint{font-size:.82rem;color:#888}
  .right{display:flex;justify-content:flex-end}
  .grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}
  .preset .btn{padding:18px 12px;font-size:1.1rem}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:.8rem;padding:2px 6px;border:1px solid var(--bd);border-radius:6px;background:#fff}

  /* ã“ã©ã‚‚ãƒ¢ãƒ¼ãƒ‰ */
  #kidApp{display:none}
  #kidApp.active{display:block}
  .kid-screen{display:none;flex-direction:column;align-items:center;justify-content:center;gap:18px;text-align:center}
  .kid-screen.active{display:flex}
  .kid-h1{font-size:1.8rem}
  .kid-big{font-size:1.4rem;padding:18px 24px;border-radius:20px}
  .kid-preset{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;width:100%}
  .kid-preset .btn{height:80px;font-size:1.4rem}
  .kid-qr{width:260px;height:260px;background:#fff;border:4px solid #000;border-radius:12px;display:flex;align-items:center;justify-content:center}
  .kid-hint{font-size:1rem;color:#333}
  .divider{height:1px;background:#eee;margin:12px 0}

  /* ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãŠã¨ãªç¢ºèªå…±é€šï¼‰ */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999}
  .overlay.show{display:flex}
  .modal{width:min(560px,100%);background:#fff;border-radius:18px;border:1px solid var(--bd);box-shadow:0 10px 30px rgba(0,0,0,.18);padding:18px}
  .modal h3{margin:0 0 8px;font-size:1.25rem}
  .list{margin:8px 0 12px;padding-left:0;list-style:none}
  .list li{padding:6px 0;border-bottom:1px dashed #eee}
  .rowbtn{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
  .ck{display:flex;align-items:center;gap:8px;margin-top:6px}
  .priceXL{font-size:1.6rem;font-weight:700}

  /* ãƒ†ãƒ³ã‚­ãƒ¼ */
  .numpad{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:6px}
  .numpad .btn{height:64px;font-size:1.3rem}

  /* èª­ã¿è¾¼ã¿ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆå­ã©ã‚‚æ’®å½±å¾Œã®å¾…æ©Ÿè¡¨ç¤ºï¼‰ */
  .loading-ol{position:fixed;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;background:rgba(255,255,255,.94);z-index:10000}
  .loading-ol.show{display:flex}
  .spinner{width:72px;height:72px;border-radius:50%;border:8px solid #e5e7eb;border-top-color:var(--brand);animation:spin 1s linear infinite;margin-bottom:16px}
  @keyframes spin{to{transform:rotate(360deg)}}
  .fileinput{display:none}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>FleaPayï½œå‡ºåº—è€…UI</h1>
      <div class="modeSwitch" role="tablist" aria-label="ãƒ¢ãƒ¼ãƒ‰ãã‚Šã‹ãˆ">
        <button class="chip active" id="tabKid" role="tab" aria-selected="true">ğŸ§’ ã“ã©ã‚‚</button>
        <button class="chip" id="tabAdult" role="tab" aria-selected="false">ğŸ‘¤ ãŠã¨ãª</button>
      </div>
    </header>

    <!-- ========== ã“ã©ã‚‚ãƒ¢ãƒ¼ãƒ‰ ========== -->
    <div id="kidApp" class="active" aria-label="ã“ã©ã‚‚ ã‚‚ãƒ¼ã©">
      <!-- å…±é€šï¼šå‡ºåº—è€…ID -->
      <div class="card" style="padding:12px 16px">
        <label for="sellerIdKid">ğŸ†” ã—ã‚…ã£ã¦ã‚“ã—ã‚ƒIDï¼ˆãŠã¨ãªãŒ ã„ã‚Œã‚‹ï¼‰</label>
        <input id="sellerIdKid" placeholder="seller-test01" aria-label="ã—ã‚…ã£ã¦ã‚“ã—ã‚ƒ ã‚¢ã‚¤ãƒ‡ã‚£ãƒ¼">
        <div class="hint">â€» ã“ã“ã‚’ ã‹ãˆã‚‹ã¨ QR ã‚‚ ã˜ã©ã†ã§ ã‹ã‚ã‚Šã¾ã™ã€‚</div>
      </div>

      <!-- â‘ ã—ã‚ƒã—ã‚“ï¼ˆãƒœã‚¿ãƒ³1ã¤ãƒ»é¸æŠã—ãŸã‚‰è‡ªå‹•ã§æ¬¡ã¸ï¼‰ -->
      <div id="k-step1" class="card kid-screen active">
        <div class="kid-h1">ğŸ“· ã—ã‚ƒã—ã‚“ã‚’ ã¨ã‚‹</div>
        <input id="kidFile" class="fileinput" type="file" accept="image/*" capture="environment" aria-label="ã—ã‚ƒã—ã‚“ã‚’ ãˆã‚‰ã¶">
        <button class="btn primary kid-big" id="k-take">ã—ã‚ƒã—ã‚“ã‚’ ã¨ã‚‹</button>
        <div class="hint">ã—ã‚ƒã—ã‚“ã¯ AI ã« ãŠãã£ã¦ã€ã—ã‚‡ã†ã²ã‚“ ã‚’ ã¿ã¤ã‘ã¾ã™ã€‚</div>
        <div id="k-aiMsg" class="msg" style="display:none"></div>
      </div>

      <!-- â‘¡ãã‚“ãŒã + æ˜ç´° + ãã®å ´ã§ç¢ºèªï¼ˆã“ã®ç”»é¢ã§å®Œçµï¼‰ -->
      <div id="k-step2" class="card kid-screen">
        <div class="kid-h1">ğŸ’° ãã‚“ãŒã ã‚’ ãˆã‚‰ã¶</div>

        <!-- å•†å“æ˜ç´°ï¼ˆæ¦‚è¦ï¼‰è¡¨ç¤º -->
        <div style="width:100%;text-align:left">
          <div style="font-weight:700;margin:4px 0 6px">ğŸ› ã—ã‚‡ã†ã²ã‚“ ã® ãŒã„ã‚ˆã†</div>
          <div id="k2-summary" class="kid-hint" style="background:#fff;border:1px solid #eee;border-radius:10px;padding:10px;min-height:48px">ï¼ˆã—ã‚‡ã†ã²ã‚“ ã˜ã‚‡ã†ã»ã† ãªã—ï¼‰</div>
        </div>

        <!-- é‡‘é¡ãƒ—ãƒªã‚»ãƒƒãƒˆï¼‹ãã®ä»– -->
        <div class="kid-preset" style="margin-top:6px">
          <button class="btn" data-kid-price="500">500ãˆã‚“</button>
          <button class="btn" data-kid-price="1000">1,000ãˆã‚“</button>
          <button class="btn" data-kid-price="1500">1,500ãˆã‚“</button>
        </div>
        <button class="btn ghost kid-big" id="k-more">ã»ã‹ï¼ˆã¦ã„ã‚Œã„ ã°ã‚“ã”ã†ï¼‰</button>
        <div id="k-amtView" class="kid-hint">ã„ã¾ï¼šâ€”</div>

        <div class="divider"></div>

        <!-- æ¬¡ã®ç¢ºèªç”»é¢ã‚‚ã“ã®ç”»é¢ã«è¡¨ç¤º -->
        <div style="width:100%;text-align:left">
          <div style="font-weight:700;margin:4px 0 6px">ğŸ§¾ ã‹ãã«ã‚“</div>
          <div class="kid-hint"><strong>ã”ã†ã‘ã„ï¼š</strong><span id="k2-sum">â€”</span></div>
          <label class="ck" style="font-size:1.05rem">
            <input type="checkbox" id="k2-adult"> ğŸ‘¤ ãŠã¨ãª ã« ã¿ã¦ã‚‚ã‚‰ã£ãŸ
          </label>
          <div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-top:8px">
            <button class="btn primary kid-big" id="k2-go" disabled>ã¯ã„ï¼ˆQRã¸ï¼‰</button>
          </div>
        </div>
      </div>

      <!-- ï¼ˆæ—§ï¼‰â‘¢ã‹ãã«ã‚“ ï¼šæ®‹ã™ãŒé€šå¸¸ã¯ä½¿ã‚ãªã„ -->
      <div id="k-step3" class="card kid-screen">
        <div class="kid-h1">ğŸ§¾ ã‹ãã«ã‚“</div>
        <div id="k-listWrap" class="hint" style="width:100%;text-align:left"></div>
        <div class="kid-hint"><strong>ã”ã†ã‘ã„ï¼š</strong><span id="k-sum">â€”</span></div>
        <label class="ck" style="font-size:1.1rem">
          <input type="checkbox" id="k-adult"> ğŸ‘¤ ãŠã¨ãª ã« ã¿ã¦ã‚‚ã‚‰ã£ãŸ
        </label>
        <div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center">
          <button class="btn ghost kid-big" id="k-back">ãªãŠã™</button>
          <button class="btn primary kid-big" id="k-go" disabled>ã¯ã„ï¼ˆQRã¸ï¼‰</button>
        </div>
      </div>

      <!-- â‘£QR -->
      <div id="k-step4" class="card kid-screen">
        <div class="kid-h1">âœ… QR ã‚’ ãŠãã‚ƒãã•ã¾ ã« ã¿ã›ã‚‹</div>
        <div class="kid-qr"><div id="k-qrcode"></div></div>
        <button class="btn kid-big" id="k-open">ãŠãã‚ƒãã•ã¾ ãƒšãƒ¼ã‚¸ã‚’ ã²ã‚‰ã</button>
        <div class="hint">ã“ã®QR/ãƒªãƒ³ã‚¯ã¯ ã“ã¦ã„ã€‚ã•ã„ã—ã‚“ã® ãã‚“ãŒã ãŒ ãŠãã‚ƒãã•ã¾ ã« ã˜ã©ã† ã¯ã‚“ãˆã„ ã•ã‚Œã¾ã™ã€‚</div>
      </div>
    </div>

    <!-- ========== ãŠã¨ãªãƒ¢ãƒ¼ãƒ‰ï¼ˆæ—¢å­˜ï¼‹ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ ========== -->
    <div id="adultApp" style="display:none" aria-label="ãŠã¨ãª ã‚‚ãƒ¼ã©">
      <div class="card">
        <h2>1. å‡ºåº—è€…ãƒ»AIè§£æ</h2>
        <label for="sellerId">å‡ºåº—è€…IDï¼ˆsellerPublicIdï¼‰</label>
        <input id="sellerId" placeholder="seller-test01" aria-label="å‡ºåº—è€…ID">
        <div class="row" style="margin-top:8px">
          <div>
            <input id="file" type="file" accept="image/*" capture="environment">
            <div style="display:flex;gap:10px;margin-top:8px">
              <button class="btn primary" id="btnAnalyze">AIã§å•†å“åãƒ»é‡‘é¡ã‚’è§£æ</button>
              <button class="btn ghost" id="btnClearPreview">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ¶ˆå»</button>
            </div>
            <div id="aiMsg" class="msg" style="display:none"></div>
          </div>
          <figure class="preview" id="preview" hidden><img id="previewImg" alt="preview"></figure>
        </div>
      </div>

      <div class="card">
        <h2>2. åˆè¨ˆé‡‘é¡ãƒ»å•†å“æ¦‚è¦</h2>
        <div class="row">
          <div>
            <label for="amount">åˆè¨ˆé‡‘é¡ï¼ˆå††ï¼‰</label>
            <input id="amount" inputmode="numeric" placeholder="1000">
          </div>
          <div>
            <label>ãƒ—ãƒªã‚»ãƒƒãƒˆ</label>
            <div class="grid3 preset">
              <button class="btn" data-preset="500">Â¥500</button>
              <button class="btn" data-preset="1000">Â¥1,000</button>
              <button class="btn" data-preset="1500">Â¥1,500</button>
            </div>
          </div>
        </div>
        <label for="summary">å•†å“æ¦‚è¦ï¼ˆå„è¡Œã€Œå•†å“å Ã—æ•°é‡ã€ï¼‰</label>
        <textarea id="summary" placeholder="ã‚Šã‚“ã”ã‚¸ãƒ¥ãƒ¼ã‚¹ Ã—1&#10;ã‚¯ãƒƒã‚­ãƒ¼ Ã—2"></textarea>
      </div>

      <div class="card">
        <h2>3. é‡‘é¡ã‚’ç™»éŒ²ï¼ˆç¢ºèªç”»é¢ã‚ã‚Šï¼‰</h2>
        <div style="display:flex;gap:10px;margin-bottom:8px">
          <button class="btn primary" id="btnRegister">é‡‘é¡ã‚’ç™»éŒ²</button>
          <button class="btn ghost" id="btnReset">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        <div id="msg" class="msg" style="display:none"></div>
      </div>

      <div class="card" id="qrCard">
        <h2>4. å›ºå®šQRï¼ˆè³¼å…¥è€…æç¤ºç”¨ï¼‰</h2>
        <div class="qrbox">
          <div id="qrcode"></div>
          <button class="btn" id="openBuyer">è³¼å…¥è€…ç”¨ãƒšãƒ¼ã‚¸ã‚’é–‹ã</button>
        </div>
        <p class="hint">ã“ã®QR/ãƒªãƒ³ã‚¯ã¯å›ºå®šã§ã™ã€‚é‡‘é¡ã¯ã€Œãƒšãƒ³ãƒ‡ã‚£ãƒ³ã‚°ç™»éŒ²ã€ã—ãŸæœ€æ–°ã®å€¤ãŒè³¼å…¥è€…å´ã§è‡ªå‹•åæ˜ ã•ã‚Œã¾ã™ã€‚</p>
      </div>
    </div>
  </div>

  <!-- å…±é€šï¼šç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãŠã¨ãªç™»éŒ²ç›´å‰ï¼å­ã©ã‚‚æ—§ç”»é¢ç”¨ï¼‰ -->
  <div class="overlay" id="confirmOverlay" aria-modal="true" role="dialog">
    <div class="modal">
      <h3>ğŸ§¾ å†…å®¹ã‚’ã‹ãã«ã‚“</h3>
      <div class="list" id="confirmList"></div>
      <div class="priceXL" id="confirmPrice">Â¥ -</div>
      <label class="ck">
        <input type="checkbox" id="adultCheck">
        <span>ğŸ‘¤ ãŠã¨ãª ã« ã¿ã¦ã‚‚ã‚‰ã£ãŸ</span>
      </label>
      <div class="rowbtn">
        <button class="btn ghost" id="btnEdit">ãªãŠã™</button>
        <button class="btn primary" id="btnConfirm" disabled>ã¯ã„ï¼ˆç™»éŒ²ã™ã‚‹ï¼‰</button>
      </div>
    </div>
  </div>

  <!-- ãƒ†ãƒ³ã‚­ãƒ¼ï¼ˆå­ã©ã‚‚ ã»ã‹ï¼‰ -->
  <div class="overlay" id="numpadOverlay" aria-modal="true" role="dialog">
    <div class="modal">
      <h3>ğŸ”¢ ãã‚“ãŒã ã‚’ ã„ã‚Œã¦ã­</h3>
      <input id="npDisplay" inputmode="numeric" aria-label="ãã‚“ãŒã" readonly>
      <div class="numpad">
        <button class="btn" data-np="1">1</button><button class="btn" data-np="2">2</button><button class="btn" data-np="3">3</button>
        <button class="btn" data-np="4">4</button><button class="btn" data-np="5">5</button><button class="btn" data-np="6">6</button>
        <button class="btn" data-np="7">7</button><button class="btn" data-np="8">8</button><button class="btn" data-np="9">9</button>
        <button class="btn" id="npClear">C</button><button class="btn" data-np="0">0</button><button class="btn primary" id="npOk">OK</button>
      </div>
    </div>
  </div>

  <!-- èª­ã¿è¾¼ã¿ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div class="loading-ol" id="loadingOverlay" role="alert" aria-live="assertive">
    <div class="spinner" aria-hidden="true"></div>
    <div style="font-size:1.25rem;margin-bottom:4px">ã‚ˆã¿ã“ã¿ã¡ã‚…ã†â€¦</div>
    <div class="hint">ãã®ã¾ã¾ ã¾ã£ã¦ã­</div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>
  const $=s=>document.querySelector(s);
  const params=new URLSearchParams(location.search);
  const CHECKOUT_PATH=params.get('cp')||'/checkout-matsuri.html';

  // å…±æœ‰ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«
  const model={ sellerId:'', amount:0, summary:'' };

  const fx={ ok(){try{navigator.vibrate?.(30);}catch{}}, ng(){try{navigator.vibrate?.([40,40,40]);}catch{}} };

  // ===== ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ =====
  $('#tabKid').onclick=()=>switchMode('kid');
  $('#tabAdult').onclick=()=>switchMode('adult');
  function switchMode(type){
    const kid=type==='kid';
    $('#tabKid').classList.toggle('active',kid);
    $('#tabAdult').classList.toggle('active',!kid);
    $('#kidApp').classList.toggle('active',kid);
    $('#kidApp').style.display=kid?'block':'none';
    $('#adultApp').style.display=kid?'none':'block';
  }

  // ===== åˆæœŸåŒ– =====
  (function init(){
    const sid=params.get('s')||'';
    if(sid){model.sellerId=sid;}
    $('#sellerIdKid').value=model.sellerId;
    $('#sellerId').value=model.sellerId;

    setQR('#qrcode');
    setQR('#k-qrcode');

    // IDåŒæœŸ
    $('#sellerId').addEventListener('input',e=>syncSellerId(e.target.value));
    $('#sellerIdKid').addEventListener('input',e=>syncSellerId(e.target.value));

    // å¤§äººUI
    document.querySelectorAll('[data-preset]').forEach(b=>b.addEventListener('click',()=>{ $('#amount').value=b.dataset.preset; }));
    $('#btnAnalyze').addEventListener('click',onAnalyze);
    $('#file').addEventListener('change',e=>{const f=e.target.files?.[0]; if(!f)return; $('#previewImg').src=URL.createObjectURL(f); $('#preview').hidden=false;});
    $('#btnClearPreview').addEventListener('click',()=>{$('#preview').hidden=true; $('#previewImg').src=''; $('#aiMsg').style.display='none';});

    // å­ã©ã‚‚UIï¼šæ’®å½±â†’ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
    $('#k-take').addEventListener('click',()=>$('#kidFile').click());
    $('#kidFile').addEventListener('change',onKidPhotoTaken);

    // å­ã©ã‚‚ï¼šé‡‘é¡UI
    document.querySelectorAll('[data-kid-price]').forEach(b=>b.addEventListener('click',()=>{ setKidAmount(+b.dataset.kidPrice); }));
    $('#k-more').addEventListener('click',openNumpad);

    // å­ã©ã‚‚ï¼šã“ã®ç”»é¢å†…ã®ç¢ºèªæ¬„ï¼ˆk2-ï¼‰ã§å®Œçµ
    $('#k2-adult').addEventListener('change',e=>$('#k2-go').disabled=!e.target.checked);
    $('#k2-go').addEventListener('click',async ()=>{
      const ok=await performRegister(model.sellerId, model.amount, model.summary);
      if(ok){ goKid(4); fx.ok(); }
    });

    // æ—§ã‚¹ãƒ†ãƒƒãƒ—3ï¼ˆå¿µã®ãŸã‚æ®‹ç½®ï¼‰
    $('#k-back').addEventListener('click',()=>goKid(2));
    $('#k-adult').addEventListener('change',e=>$('#k-go').disabled=!e.target.checked);
    $('#k-go').addEventListener('click',async ()=>{
      const ok=await performRegister(model.sellerId, model.amount, model.summary);
      if(ok){ goKid(4); fx.ok(); }
    });

    // ãƒ†ãƒ³ã‚­ãƒ¼
    document.querySelectorAll('[data-np]').forEach(b=>b.addEventListener('click',()=>{$('#npDisplay').value += b.dataset.np;}));
    $('#npClear').onclick=()=>$('#npDisplay').value='';
    $('#npOk').onclick=()=>{ const v=parseInt($('#npDisplay').value||'0'); setKidAmount(v); $('#numpadOverlay').classList.remove('show'); };
  })();

  // ===== å­ã©ã‚‚ï¼šå†™çœŸâ†’AIâ†’é‡‘é¡ç”»é¢ =====
  async function onKidPhotoTaken(e){
    const f=e.target.files?.[0];
    if(!f){ kidMsg('err','ã—ã‚ƒã—ã‚“ã‚’ ãˆã‚‰ã‚“ã§ã­'); fx.ng(); return; }
    setLoading(true);
    try{
      // AIè§£æï¼ˆå¤±æ•—ã—ã¦ã‚‚é€²ã‚€ï¼‰
      try{
        const fd=new FormData(); fd.append('file',f,f.name);
        const res=await fetch('/api/analyze-item',{method:'POST',body:fd});
        const j=await res.json();
        console.log('AIè§£æçµæœ:', j);
        if(j.summary) model.summary = j.summary;
        if(j.amount)  model.amount  = Number(j.amount)||0;
      }catch(err){ console.warn('AIè§£æå¤±æ•—',err); }
      goKid(2);
      updateKidPanels();
      fx.ok();
    } finally {
      setLoading(false);
    }
  }

  // ===== å­ã©ã‚‚ï¼šé‡‘é¡è¨­å®šï¼ˆç”»é¢å†…ã®ç¢ºèªã‚‚åŒæ™‚æ›´æ–°ï¼‰ =====
  function setKidAmount(v){
    if(!Number.isFinite(v) || v<100 || v>1_000_000){
      kidMsg('err','ãã‚“ãŒãã‚’ ã„ã‚Œã¦ã­ï¼ˆ100ã€œ1,000,000ï¼‰'); fx.ng(); return;
    }
    model.amount=v;
    updateKidPanels();
  }

  function updateKidPanels(){
    const summaryHtml = (model.summary?.trim()
      ? `<pre style="margin:0">${escapeHtml(model.summary)}</pre>`
      : 'ï¼ˆã—ã‚‡ã†ã²ã‚“ ã˜ã‚‡ã†ã»ã† ãªã—ï¼‰');

    // ã‚¹ãƒ†ãƒƒãƒ—2ï¼ˆã“ã®ç”»é¢ï¼‰
    $('#k2-summary').innerHTML = summaryHtml;
    $('#k-amtView').textContent = 'ã„ã¾ï¼š' + (model.amount?('Â¥'+model.amount.toLocaleString()):'â€”');
    $('#k2-sum').textContent   = model.amount?('Â¥'+model.amount.toLocaleString()):'â€”';

    // æ—§ã‚¹ãƒ†ãƒƒãƒ—3ï¼ˆæ®‹ç½®ï¼‰
    $('#k-listWrap').innerHTML = summaryHtml;
    $('#k-sum').textContent    = model.amount?('Â¥'+model.amount.toLocaleString()):'â€”';
    // ç¢ºèªãƒã‚§ãƒƒã‚¯ã¯æ¯å›ãƒªã‚»ãƒƒãƒˆ
    $('#k2-adult').checked=false; $('#k2-go').disabled=true;
    $('#k-adult').checked=false;  $('#k-go').disabled=true;
  }

  // ===== è£œåŠ© =====
  function goKid(n){ [1,2,3,4].forEach(i=>$('#k-step'+i).classList.remove('active')); $('#k-step'+n).classList.add('active'); }
  function openNumpad(){ $('#npDisplay').value=''; $('#numpadOverlay').classList.add('show'); }
  function kidMsg(type,text){ const el=$('#k-aiMsg'); el.className='msg '+type; el.textContent=text; el.style.display='block'; }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  // ===== å¤§äººï¼šAI/ç™»éŒ² =====
  async function onAnalyze(){
    const f=$('#file').files?.[0];
    if(!f){ showMsg('err','ç”»åƒã‚’é¸ã‚“ã§ãã ã•ã„'); return; }
    try{
      const fd=new FormData(); fd.append('file',f,f.name);
      const res=await fetch('/api/analyze-item',{method:'POST',body:fd});
      const j=await res.json();
      if(!res.ok||j.error) throw new Error(j.error||'è§£æå¤±æ•—');
      if(j.summary){ $('#summary').value=j.summary; model.summary=j.summary; }
      if(j.amount){ $('#amount').value=j.amount; model.amount=Number(j.amount)||0; }
      showMsg('ok','AIè§£æãŒå®Œäº†ã—ã¾ã—ãŸ');
    }catch(e){ showMsg('err',e.message); }
  }

  function getAdultValues(){
    const sellerId=($('#sellerId').value||$('#sellerIdKid').value||'').trim();
    const amount=parseInt(($('#amount').value||model.amount||'').toString().replace(/[^\d]/g,''),10);
    const summary=($('#summary').value||model.summary||'').trim();
    model.sellerId=sellerId; model.amount=amount||0; model.summary=summary;
    return {sellerId,amount,summary};
  }

  function openConfirm({sellerId,amount,summary}){
    if(!sellerId){ showMsg('err','å‡ºåº—è€…IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    if(!Number.isInteger(amount)||amount<100){ showMsg('err','é‡‘é¡ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“'); return; }
    const lines=(summary||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const ul=$('#confirmList'); ul.innerHTML='';
    if(lines.length===0){ ul.innerHTML='<div>ï¼ˆå•†å“æƒ…å ±ãªã—ï¼‰</div>'; }
    else ul.innerHTML=lines.map(l=>'ğŸ› '+escapeHtml(l)).join('<br>');
    $('#confirmPrice').textContent='Â¥'+amount.toLocaleString();
    $('#adultCheck').checked=false; $('#btnConfirm').disabled=true;
    $('#confirmOverlay').classList.add('show');
  }

  async function performRegister(sellerId,amount,summary){
    try{
      const res=await fetch('/api/pending/start',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sellerId,amount,summary})});
      const j=await res.json();
      if(!res.ok||j.error) throw new Error(j.error||'ç™»éŒ²å¤±æ•—');
      showMsg('ok','ç™»éŒ²ã—ã¾ã—ãŸã€‚è³¼å…¥è€…å´ã«åæ˜ ã•ã‚Œã¾ã™ã€‚');
      flash('#qrCard'); setQR('#qrcode'); setQR('#k-qrcode'); fx.ok();
      return true;
    }catch(e){ showMsg('err',e.message||'ç™»éŒ²å¤±æ•—'); fx.ng(); return false; }
  }

  function showMsg(type,text){ const el=$('#msg'); el.className='msg '+type; el.textContent=text; el.style.display='block'; }

  function buildBuyerUrl(sellerId){ return `${location.origin}${CHECKOUT_PATH}?s=${encodeURIComponent(sellerId||'')}`; }
  function setQR(selector){
    const target=document.querySelector(selector); if(!target) return;
    target.innerHTML='';
    const url=buildBuyerUrl(model.sellerId||$('#sellerId').value||$('#sellerIdKid').value||'');
    new QRCode(target,{text:url,width:200,height:200,correctLevel:QRCode.CorrectLevel.M});
    (selector==='#qrcode'?$('#openBuyer'):$('#k-open')).onclick=()=>window.open(url,'_blank');
  }

  function syncSellerId(v){
    model.sellerId=(v||'').trim();
    $('#sellerId').value=model.sellerId;
    $('#sellerIdKid').value=model.sellerId;
    setQR('#qrcode'); setQR('#k-qrcode');
  }

  function setLoading(v){ $('#loadingOverlay').classList.toggle('show', !!v); }
  function flash(sel){ const el=$(sel); if(!el)return; const org=el.style.boxShadow; el.style.boxShadow='0 0 0 3px #c9eedc,0 6px 24px rgba(0,0,0,.12)'; setTimeout(()=>el.style.boxShadow=org,900); }

  // å¤§äººï¼šç™»éŒ²ãƒœã‚¿ãƒ³ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ä½¿ç”¨
  $('#btnRegister')?.addEventListener('click',()=>openConfirm(getAdultValues()));
  $('#btnEdit')?.addEventListener('click',()=>$('#confirmOverlay').classList.remove('show'));
  $('#adultCheck')?.addEventListener('change',e=>$('#btnConfirm').disabled=!e.target.checked);
  $('#btnConfirm')?.addEventListener('click',async ()=>{
    const {sellerId,amount,summary}=getAdultValues();
    const ok=await performRegister(sellerId,amount,summary);
    if(ok) $('#confirmOverlay').classList.remove('show');
  });
  </script>
</body>
</html>

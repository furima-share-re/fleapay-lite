<!doctype html>
<html lang="ja">
<head>
  <!-- =========================================================
       FleaPayï½œå‡ºåº—è€…UIï¼ˆã“ã©ã‚‚/ãŠã¨ãªï¼‰ å€¤æœ­ãªã—å†™çœŸã«ã‚‚å¯¾å¿œ
       â˜…ãƒ•ãƒªãƒå®Ÿæ…‹ã«åˆã‚ã›ã¦ç°¡ç•¥åŒ–ç‰ˆ
       
       ã€ãƒ‘ãƒƒãƒé©ç”¨æ¸ˆã¿ v15 - ã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰è¿½åŠ ã€‘
       â˜…å¤‰æ›´ç‚¹â˜…
       1. Step3ã«ç”»é¢å†…ã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰è¿½åŠ ï¼ˆé›»å“ã‚¹ã‚¿ã‚¤ãƒ«ã®ãƒœã‚¿ãƒ³ï¼‰
       2. é‡‘é¡å…¥åŠ›æ¬„ã‚’readonlyåŒ–ï¼ˆãƒã‚¤ãƒ†ã‚£ãƒ–ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰éè¡¨ç¤ºï¼‰
       3. inputmode="none"ã§ãƒ¢ãƒã‚¤ãƒ«ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚’æŠ‘åˆ¶
       4. ã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰ãƒœã‚¿ãƒ³ï¼š1-9, 0, Cï¼ˆã‚¯ãƒªã‚¢ï¼‰, âŒ«ï¼ˆå‰Šé™¤ï¼‰
       5. æœ€å¤§6æ¡åˆ¶é™ï¼ˆ999,999å††ã¾ã§ï¼‰
       
       ã€v14ã®å¤‰æ›´ç‚¹ã€‘
       1. QR URLç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ï¼šcheckoutUrlæœ€å„ªå…ˆã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ™‚ã¯?order=ä½¿ç”¨
       2. ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿çµ±ä¸€ï¼š?o= â†’ ?order=ï¼ˆcheckout.htmlå´ã¨ã®äº’æ›æ€§ï¼‰
       3. skipãƒœã‚¿ãƒ³ãƒã‚°ä¿®æ­£ï¼šQRã‚³ãƒ³ãƒ†ãƒŠã®è¡¨ç¤ºåˆ¶å¾¡è¿½åŠ 
       ========================================================= -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FleaPayï½œå‡ºåº—è€…UIï¼ˆã‚­ãƒƒã‚ºãƒ¢ãƒ¼ãƒ‰å¯¾å¿œç‰ˆï¼‰</title>

  <!-- Normalize -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/modern-normalize/2.0.0/modern-normalize.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer"/>

  <style>
    /* ========== åŸºæœ¬ãƒˆãƒ¼ã‚¯ãƒ³ ========== */
    :root{
      --color-bg: #f0f4f8;
      --color-primary: #3b82f6;
      --color-secondary: #10b981;
      --color-text: #1e293b;
      --color-gold: #f59e0b;
      --radius: 12px;
      --shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    *{box-sizing:border-box;}
    body{
      margin:0;padding:0;
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
      background:var(--color-bg);
      color:var(--color-text);
    }
    
    /* ========== ã‚³ãƒ³ãƒ†ãƒŠ ========== */
    #app{
      max-width:500px;
      margin:0 auto;
      background:#fff;
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }
    
    /* ========== ã‚¹ãƒ†ãƒƒãƒ—å…±é€š ========== */
    .step{display:none; flex-direction:column; padding:1rem; flex:1;}
    .step.active{display:flex;}
    .step h2{
      font-size:1.5rem;
      margin:0 0 1rem;
      display:flex;
      align-items:center;
      gap:0.5rem;
    }
    .step h2 .emoji{font-size:1.8rem;}
    
    /* ========== ãƒœã‚¿ãƒ³ ========== */
    .btn{
      background:var(--color-primary);
      color:#fff;
      border:none;
      padding:1rem;
      border-radius:var(--radius);
      font-size:1rem;
      font-weight:600;
      cursor:pointer;
      box-shadow:var(--shadow);
      transition:transform 0.1s;
    }
    .btn:active{transform:scale(0.98);}
    .btn:disabled{
      background:#cbd5e1;
      cursor:not-allowed;
      transform:none;
    }
    .btn-secondary{
      background:#64748b;
    }
    
    /* ========== æ”¯æ‰•ã„æ–¹æ³•ãƒœã‚¿ãƒ³ ========== */
    .payment-method-group{
      display:flex;
      gap:0.5rem;
      margin:0.5rem 0 1.5rem;
    }
    .pay-btn{
      flex:1;
      border-radius:999px;
      border:1px solid #cbd5e1;
      background:#f8fafc;
      padding:0.75rem 0.5rem;
      font-size:0.9rem;
      cursor:pointer;
      transition:all 0.15s;
    }
    .pay-btn.selected{
      background:#e0edff;
      border-color:#3b82f6;
      font-weight:600;
    }
    
    /* ========== Step 0-1: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç™»å ´ç”»é¢ ========== */
    #step0-1{
      background: linear-gradient(180deg, #fef3c7 0%, #fde68a 50%, #fff 100%);
      align-items:center;
      justify-content:center;
      text-align:center;
      padding:2rem 1rem;
    }
    .welcome-container{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:2rem;
      max-width:400px;
      width:100%;
    }
    .character-animation{
      position:relative;
      width:200px;
      height:200px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .sakura-particles{
      position:absolute;
      width:100%;
      height:100%;
      pointer-events:none;
      overflow:visible;
    }
    .sakura-particles::before,
    .sakura-particles::after{
      content:'ğŸŒ¸';
      position:absolute;
      font-size:2rem;
      animation:sakuraFall 4s ease-in-out infinite;
      opacity:0;
    }
    .sakura-particles::before{
      left:10%;
      animation-delay:0s;
    }
    .sakura-particles::after{
      right:10%;
      animation-delay:2s;
    }
    @keyframes sakuraFall{
      0%{
        top:-20%;
        transform:rotate(0deg);
        opacity:0;
      }
      10%{
        opacity:0.7;
      }
      90%{
        opacity:0.3;
      }
      100%{
        top:120%;
        transform:rotate(360deg);
        opacity:0;
      }
    }
    .kimonya-character{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%, -50%);
      width:180px;
      height:auto;
      z-index:10;
      animation:bounce 2s ease-in-out infinite;
    }
    @keyframes bounce{
      0%, 100%{transform:translate(-50%, -50%) translateY(0);}
      50%{transform:translate(-50%, -50%) translateY(-20px);}
    }
    .welcome-title{
      font-size:2rem;
      font-weight:700;
      margin:0;
      line-height:1.4;
    }
    .welcome-title .subtitle{
      display:block;
      font-size:1.2rem;
      color:#64748b;
      margin-top:0.5rem;
    }
    .welcome-message{
      font-size:1.1rem;
      color:#475569;
      margin:0;
    }
    .btn-hero{
      font-size:1.3rem;
      padding:1.5rem 3rem;
      background:linear-gradient(135deg, var(--color-primary) 0%, #2563eb 100%);
      box-shadow:0 8px 16px rgba(59,130,246,0.3);
      position:relative;
      overflow:hidden;
      border:none;
      color:#fff;
      border-radius:var(--radius);
      font-weight:700;
      cursor:pointer;
      transition:transform 0.1s;
    }
    .btn-hero::before{
      content:'';
      position:absolute;
      top:50%;
      left:50%;
      width:0;
      height:0;
      border-radius:50%;
      background:rgba(255,255,255,0.3);
      transform:translate(-50%,-50%);
      transition:width 0.6s, height 0.6s;
    }
    .btn-hero:active{
      transform:scale(0.98);
    }
    .btn-hero:active::before{
      width:300px;
      height:300px;
    }
    
    /* ========== Step 0-2: ãƒŸãƒƒã‚·ãƒ§ãƒ³èª¬æ˜ç”»é¢ ========== */
    #step0-2{
      align-items:center;
      padding:2rem 1rem;
    }
    .mission-container{
      display:flex;
      flex-direction:column;
      width:100%;
      max-width:400px;
    }
    .mission-steps{
      margin:2rem 0;
      width:100%;
    }
    .mission-card{
      background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-radius:var(--radius);
      padding:1.5rem;
      margin-bottom:1rem;
      display:flex;
      align-items:center;
      gap:1rem;
      box-shadow:var(--shadow);
      transition:transform 0.2s;
    }
    .mission-card:hover{
      transform:scale(1.02);
    }
    .mission-icon{
      font-size:3rem;
      flex-shrink:0;
    }
    .mission-text{
      text-align:left;
      flex:1;
    }
    .mission-number{
      font-weight:700;
      font-size:1.1rem;
      color:var(--color-primary);
      margin-bottom:0.25rem;
    }
    .mission-desc{
      font-size:0.9rem;
      color:#64748b;
      line-height:1.4;
    }
    .mission-arrow{
      font-size:2rem;
      color:var(--color-primary);
      margin:0.5rem 0;
      text-align:center;
    }
    
    /* ========== Step 0-3: æº–å‚™OKç¢ºèªç”»é¢ ========== */
    #step0-3{
      align-items:center;
      justify-content:center;
      text-align:center;
      padding:2rem 1rem;
    }
    .ready-container{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:2rem;
      max-width:400px;
      width:100%;
    }
    .ready-icon{
      font-size:6rem;
      animation:pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse{
      0%, 100%{
        transform:scale(1);
        opacity:1;
      }
      50%{
        transform:scale(1.1);
        opacity:0.8;
      }
    }
    .ready-title{
      font-size:2rem;
      font-weight:700;
      margin:0;
    }
    .ready-message{
      font-size:1.1rem;
      line-height:1.8;
      margin:0;
      color:#475569;
    }
    .ready-hint{
      display:block;
      font-size:0.9rem;
      color:#94a3b8;
      margin-top:0.5rem;
    }
    .btn-camera{
      background:linear-gradient(135deg, var(--color-secondary) 0%, #059669 100%);
      box-shadow:0 8px 16px rgba(16,185,129,0.3);
      font-size:1.2rem;
      padding:1.5rem 2.5rem;
      animation:breathe 2s ease-in-out infinite;
      border:none;
      color:#fff;
      border-radius:var(--radius);
      font-weight:700;
      cursor:pointer;
    }
    @keyframes breathe{
      0%, 100%{
        transform:scale(1);
      }
      50%{
        transform:scale(1.05);
      }
    }
    .btn-camera:active{
      transform:scale(0.98);
      animation:none;
    }
    .btn-small{
      font-size:0.9rem;
      padding:0.75rem 1.5rem;
    }
    
    /* ========== Step1: ã‚«ãƒ¡ãƒ©ç”»é¢ï¼ˆãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ï¼‰ ========== */
    #step1{
      padding:0;
      position:relative;
    }
    #videoContainer{
      position:relative;
      width:100%;
      height:100vh;
      height:100dvh;
      background:#000;
      overflow:hidden;
    }
    #video{
      position:absolute;
      top:0;left:0;
      width:100%;
      height:100%;
      object-fit:cover;
    }
    #canvas{display:none;}
    
    #cameraOverlay{
      position:absolute;
      top:0;left:0;
      width:100%;
      height:100%;
      pointer-events:none;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      padding:1rem 1rem 2rem 1rem;
      padding-bottom:max(2rem, env(safe-area-inset-bottom));
    }
    .overlay-top, .overlay-bottom{
      pointer-events:auto;
    }
    .overlay-top{
      background:rgba(0,0,0,0.5);
      color:#fff;
      padding:1rem;
      border-radius:var(--radius);
      text-align:center;
    }
    .overlay-middle{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%, -50%);
      border:3px dashed rgba(255,255,255,0.6);
      border-radius:var(--radius);
      width:80%;
      height:60%;
      pointer-events:none;
    }
    .overlay-middle::after{
      content:'ğŸ“ ã—ã‚‡ã†ã²ã‚“ã‚’ ã“ã“ã« ã‚ã‚ã›ã¦ã­';
      position:absolute;
      bottom:-3rem;
      left:50%;
      transform:translateX(-50%);
      color:#fff;
      background:rgba(0,0,0,0.7);
      padding:0.5rem 1rem;
      border-radius:var(--radius);
      font-size:0.9rem;
      white-space:nowrap;
    }
    .overlay-bottom{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:1rem;
      padding-bottom:1rem;
      min-height:100px;
    }
    #captureBtn{
      width:80px;
      height:80px;
      border-radius:50%;
      background:#fff;
      border:5px solid var(--color-primary);
      font-size:2rem;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition:transform 0.1s;
    }
    #captureBtn:active{transform:scale(0.95);}
    #torchBtn{
      width:50px;
      height:50px;
      border-radius:50%;
      background:rgba(255,255,255,0.3);
      border:2px solid #fff;
      color:#fff;
      font-size:1.5rem;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition:all 0.2s;
    }
    #torchBtn.active{
      background:#fbbf24;
      border-color:#fbbf24;
    }
    
    /* ========== Step2: AIè§£æä¸­ ========== */
    #step2{
      align-items:center;
      justify-content:center;
      gap:2rem;
    }
    #step2 .loader{
      width:60px;
      height:60px;
      border:6px solid #e2e8f0;
      border-top-color:var(--color-primary);
      border-radius:50%;
      animation:spin 1s linear infinite;
    }
    @keyframes spin{
      to{transform:rotate(360deg);}
    }
    
    /* ========== Step3: ä¾¡æ ¼å…¥åŠ› ========== */
    .preview{
      margin-bottom:1rem;
      border-radius:var(--radius);
      overflow:hidden;
      box-shadow:var(--shadow);
    }
    .preview img{
      width:100%;
      display:block;
    }
    .info-box{
      background:#f1f5f9;
      padding:1rem;
      border-radius:var(--radius);
      margin-bottom:1rem;
      font-size:0.9rem;
      line-height:1.6;
    }
    .price-input-group{
      margin-bottom:1.5rem;
    }
    .price-input-group label{
      display:block;
      font-weight:600;
      margin-bottom:0.5rem;
    }
    .price-input-wrapper{
      display:flex;
      align-items:center;
      gap:0.5rem;
      background:#f8fafc;
      border:2px solid #cbd5e1;
      border-radius:var(--radius);
      padding:0.5rem 1rem;
    }
    .price-input-wrapper.focused{
      border-color:var(--color-primary);
      background:#fff;
    }
    .price-input-wrapper .currency{
      font-size:1.2rem;
      font-weight:600;
      color:#64748b;
    }
    .price-input-wrapper input{
      flex:1;
      border:none;
      background:transparent;
      font-size:1.5rem;
      font-weight:600;
      outline:none;
      padding:0.5rem 0;
    }
    
    /* ========== ã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰ ========== */
    .keypad{
      margin-top:0.5rem;
      user-select:none;
    }
    .keypad-row{
      display:flex;
      gap:0.5rem;
      margin-bottom:0.5rem;
    }
    .key-btn{
      flex:1;
      padding:0.75rem 0;
      font-size:1.3rem;
      font-weight:600;
      border-radius:var(--radius);
      border:none;
      background:#e2e8f0;
      box-shadow:var(--shadow);
      cursor:pointer;
      transition:transform 0.05s, background 0.1s;
    }
    .key-btn:active{
      transform:scale(0.97);
      background:#cbd5e1;
    }
    .key-btn.key-wide{
      flex:1.4;
    }
    
    /* ========== Step4: æœ€çµ‚ç¢ºèª ========== */
    .confirm-card{
      background:#f8fafc;
      border-radius:var(--radius);
      padding:1.5rem;
      margin-bottom:1.5rem;
      box-shadow:var(--shadow);
    }
    .confirm-row{
      display:flex;
      justify-content:space-between;
      margin-bottom:0.5rem;
      font-size:0.95rem;
    }
    .confirm-row.total{
      margin-top:1rem;
      padding-top:1rem;
      border-top:2px solid #cbd5e1;
      font-size:1.3rem;
      font-weight:700;
      color:var(--color-primary);
    }
    .checkbox-group{
      background:#fef3c7;
      padding:1rem;
      border-radius:var(--radius);
      margin-bottom:1rem;
      display:flex;
      align-items:center;
      gap:0.75rem;
    }
    .checkbox-group input[type="checkbox"]{
      width:24px;
      height:24px;
      cursor:pointer;
    }
    .checkbox-group label{
      font-weight:600;
      cursor:pointer;
      flex:1;
    }
    
    /* ========== Step5: ç™»éŒ²å®Œäº† ========== */
    #step5{
      align-items:center;
      text-align:center;
      padding:2rem 1rem;
    }
    .qr-container{
      margin:2rem 0;
      padding:2rem;
      background:#f8fafc;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    #qrcode{
      display:inline-block;
      padding:1rem;
      background:#fff;
      border-radius:var(--radius);
    }
    
    /* ========== è³¼å…¥è€…å±æ€§ã‚¿ã‚° ========== */
    .buyer-attrs{
      width:100%;
      max-width:420px;
      margin:2rem auto 1.5rem;
      text-align:left;
      background:#f1f5f9;
      padding:1.5rem;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    .buyer-hint{
      font-size:0.8rem;
      color:#64748b;
      margin:0.25rem 0 0.75rem;
    }
    .attr-group{
      margin-bottom:0.75rem;
    }
    .attr-label{
      font-size:0.85rem;
      font-weight:600;
      margin-bottom:0.35rem;
      color:#475569;
    }
    .attr-buttons{
      display:flex;
      flex-wrap:wrap;
      gap:0.4rem;
    }
    .attr-btn{
      flex:1 1 40%;
      min-width:40%;
      border-radius:999px;
      border:1px solid #cbd5e1;
      background:#f8fafc;
      padding:0.4rem 0.6rem;
      font-size:0.8rem;
      cursor:pointer;
      transition:all 0.2s;
    }
    .attr-btn:hover{
      background:#e0edff;
    }
    .attr-btn.selected{
      background:#e0edff;
      border-color:#3b82f6;
      color:#1e293b;
      font-weight:600;
    }
    
    /* ========== ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚° ========== */
    #debugPanel{
      position:fixed;
      bottom:0;
      left:0;
      right:0;
      max-height:200px;
      overflow-y:auto;
      background:rgba(0,0,0,0.9);
      color:#0f0;
      font-family:monospace;
      font-size:11px;
      padding:0.5rem;
      display:none;
      z-index:9999;
    }
    #debugPanel.show{display:block;}
    #debugToggle{
      position:fixed;
      bottom:10px;
      right:10px;
      background:#000;
      color:#0f0;
      border:1px solid #0f0;
      padding:0.5rem;
      cursor:pointer;
      z-index:10000;
      border-radius:4px;
    }
  </style>
</head>

<body>
<div id="app">
  
  <!-- ========== Step 0-1: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç™»å ´ç”»é¢ ========== -->
  <div id="step0-1" class="step active">
    <div class="welcome-container">
      <div class="character-animation">
        <div class="sakura-particles"></div>
        <img 
          src="/images/kimonya.svg" 
          alt="ã‚­ãƒ¢ãƒ‹ãƒ£åº—é•·" 
          class="kimonya-character"
        />
      </div>
      
      <h1 class="welcome-title">
        ã“ã‚“ã«ã¡ã¯!<br/>
        <span class="subtitle">ãã‚‡ã†ã¯ ãã¿ãŒ ãŠã¿ã›ã‚„ã•ã‚“</span>
      </h1>
      
      <p class="welcome-message">
        ã‚­ãƒ¢ãƒ‹ãƒ£åº—é•·ãŒ<br/>
        ãŠã¦ã¤ã ã„ ã™ã‚‹ã‚ˆ
      </p>
      
      <button class="btn btn-hero" id="startBtn">
        âœ¨ ã¯ã˜ã‚ã‚‹
      </button>
    </div>
  </div>
  
  <!-- ========== Step 0-2: ãƒŸãƒƒã‚·ãƒ§ãƒ³èª¬æ˜ç”»é¢ ========== -->
  <div id="step0-2" class="step">
    <div class="mission-container">
      <h2><span class="emoji">ğŸ“š</span> ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆ</h2>
      
      <div class="mission-steps">
        <div class="mission-card">
          <div class="mission-icon">ğŸ“¸</div>
          <div class="mission-text">
            <div class="mission-number">â‘  ã•ã¤ãˆã„</div>
            <div class="mission-desc">ã—ã‚‡ã†ã²ã‚“ã® ã—ã‚ƒã—ã‚“ã‚’ ã¨ã‚‹</div>
          </div>
        </div>
        
        <div class="mission-arrow">â†“</div>
        
        <div class="mission-card">
          <div class="mission-icon">ğŸ’°</div>
          <div class="mission-text">
            <div class="mission-number">â‘¡ ã­ã ã‚“</div>
            <div class="mission-desc">ã„ãã‚‰ã§ ã†ã‚‹ã‹ã‚’ ãã‚ã‚‹</div>
          </div>
        </div>
        
        <div class="mission-arrow">â†“</div>
        
        <div class="mission-card">
          <div class="mission-icon">âœ¨</div>
          <div class="mission-text">
            <div class="mission-number">â‘¢ ã¯ã‚“ã°ã„</div>
            <div class="mission-desc">QRã‚³ãƒ¼ãƒ‰ã‚’ ã¿ã›ã‚‹</div>
          </div>
        </div>
      </div>
      
      <button class="btn btn-hero" id="understoodBtn">
        ğŸ‘ ã‚ã‹ã£ãŸ!
      </button>
    </div>
  </div>
  
  <!-- ========== Step 0-3: æº–å‚™OKç¢ºèªç”»é¢ ========== -->
  <div id="step0-3" class="step">
    <div class="ready-container">
      <div class="ready-icon">ğŸ¯</div>
      
      <h2 class="ready-title">ã˜ã‚…ã‚“ã³ ã¯ ã„ã„?</h2>
      
      <p class="ready-message">
        ã“ã‚Œã‹ã‚‰ ã‚«ãƒ¡ãƒ©ãŒ ã²ã‚‰ãã‚ˆ<br/>
        <span class="ready-hint">ã—ã‚‡ã†ã²ã‚“ã‚’ ãã‚Œã„ã« ã†ã¤ãã†</span>
      </p>
      
      <button class="btn btn-camera" id="openCameraBtn">
        ğŸ“· ã‚«ãƒ¡ãƒ©ã‚’ ã²ã‚‰ã
      </button>
      
      <button class="btn btn-secondary btn-small" id="skipToQRBtn">
        ğŸ›ï¸ ã•ãã« QR ã‚’ ã¿ã›ã‚‹
      </button>
    </div>
  </div>
  
  <!-- ========== Step1: ã‚«ãƒ¡ãƒ©æ’®å½±ï¼ˆãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ï¼‰ ========== -->
  <div id="step1" class="step">
    <div id="videoContainer">
      <video id="video" autoplay playsinline></video>
      <canvas id="canvas"></canvas>
      
      <div id="cameraOverlay">
        <div class="overlay-top">
          <div class="emoji">âœ¨</div>
          <div>AIãŒ ã¿ã¦ã„ã¾ã™â€¦</div>
          <div style="font-size:0.8rem; margin-top:0.5rem;">ã—ã‚‡ã†ã²ã‚“ã‚’ ã¯ã£ãã‚Š ã†ã¤ã—ã¦ã­</div>
        </div>
        <div class="overlay-middle"></div>
        <div class="overlay-bottom">
          <button id="torchBtn">ğŸ’¡</button>
          <button id="captureBtn">ğŸ“·</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ========== Step2: AIè§£æä¸­ ========== -->
  <div id="step2" class="step">
    <div class="loader"></div>
    <h2><span class="emoji">ğŸ¥·</span> ãƒ‹ãƒ³ã‚·ãƒ£ãŒ ã‹ã‚“ãŒãˆã¦ã„ã¾ã™â€¦</h2>
    <p style="font-size:0.9rem;color:#64748b;margin-top:0.25rem;">
      ï¼ˆAI ã¨ ã„ã£ã—ã‚‡ã«ã€ã‚‚ã®ã® ã‹ã¡ ã‚’ ãƒã‚§ãƒƒã‚¯ã¡ã‚…ã†ï¼‰
    </p>
  </div>
  
  <!-- ========== Step3: å•†å“æƒ…å ±ï¼†ä¾¡æ ¼å…¥åŠ› ========== -->
  <div id="step3" class="step">
    <h2><span class="emoji">ğŸ“</span> ã—ã‚‡ã†ã²ã‚“ ã˜ã‚‡ã†ã»ã†</h2>
    
    <div class="preview">
      <img id="previewImg" alt="å•†å“å†™çœŸ"/>
    </div>
    
    <div class="info-box" id="itemSummary">
      ï¼ˆã—ã‚‡ã†ã²ã‚“ ã˜ã‚‡ã†ã»ã† ãªã—ï¼‰
    </div>
    
    <h2><span class="emoji">ğŸ’°</span> ã”ã†ã‘ã„ã® ã­ã ã‚“ã‚’ ã„ã‚Œã‚ˆã†</h2>
    <p style="color:#64748b; font-size:0.9rem; margin-bottom:1rem;">
      ã“ã¾ã‹ã„ ãŸã‚“ã‹ ã‚„ ã–ã„ã“ ã¯ ã„ã‚Šã¾ã›ã‚“ã€‚<br/>
      ã€Œãœã‚“ã¶ã§ ã„ãã‚‰ï¼Ÿã€ã ã‘ ã„ã‚Œã¦ã­ã€‚
    </p>
    
    <div class="price-input-group">
      <label for="totalPriceInput">ã”ã†ã‘ã„ é‡‘é¡</label>
      <div class="price-input-wrapper" id="priceWrapper">
        <span class="currency">Â¥</span>
        <input type="number" 
               id="totalPriceInput" 
               placeholder="0" 
               min="0" 
               step="1"
               inputmode="none"
               readonly />
      </div>
    </div>
    
    <!-- â˜…è¿½åŠ ï¼šã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰ -->
    <div class="keypad" id="priceKeypad">
      <div class="keypad-row">
        <button type="button" class="key-btn" data-key="1">1</button>
        <button type="button" class="key-btn" data-key="2">2</button>
        <button type="button" class="key-btn" data-key="3">3</button>
      </div>
      <div class="keypad-row">
        <button type="button" class="key-btn" data-key="4">4</button>
        <button type="button" class="key-btn" data-key="5">5</button>
        <button type="button" class="key-btn" data-key="6">6</button>
      </div>
      <div class="keypad-row">
        <button type="button" class="key-btn" data-key="7">7</button>
        <button type="button" class="key-btn" data-key="8">8</button>
        <button type="button" class="key-btn" data-key="9">9</button>
      </div>
      <div class="keypad-row">
        <button type="button" class="key-btn key-wide" data-key="clear">C</button>
        <button type="button" class="key-btn" data-key="0">0</button>
        <button type="button" class="key-btn" data-key="del">âŒ«</button>
      </div>
    </div>
    <!-- â˜…ã“ã“ã¾ã§è¿½åŠ  -->
    
    <button class="btn" id="nextToConfirm" disabled>ğŸ‘€ ã•ã„ã—ã‚…ã† ã‹ãã«ã‚“</button>
  </div>
  
  <!-- ========== Step4: æœ€çµ‚ç¢ºèªï¼ˆä¿è­·è€…ãƒã‚§ãƒƒã‚¯ï¼‰ ========== -->
  <div id="step4" class="step">
    <h2><span class="emoji">ğŸ‘€</span> ã“ã‚Œã§ ã ã„ã˜ã‚‡ã†ã¶ï¼</h2>
    
    <div class="preview">
      <img id="confirmImg" alt="å•†å“å†™çœŸ"/>
    </div>
    
    <div class="confirm-card">
      <div class="confirm-row">
        <span>ã—ã‚‡ã†ã²ã‚“ï¼š</span>
        <span id="confirmSummary">-</span>
      </div>
      <div class="confirm-row total">
        <span>ã”ã†ã‘ã„ï¼š</span>
        <span id="confirmTotal">Â¥0</span>
      </div>
    </div>
    
    <h2><span class="emoji">ğŸ”</span> ä¿è­·è€…ç¢ºèª</h2>
    <div class="checkbox-group">
      <input type="checkbox" id="parentCheck"/>
      <label for="parentCheck">å†…å®¹ã‚’ç¢ºèªã—ã¾ã—ãŸ</label>
    </div>

    <h2><span class="emoji">ğŸ’³</span> ã—ã¯ã‚‰ã„ ã»ã†ã»ã†</h2>
    <div class="payment-method-group">
      <button type="button" class="pay-btn selected" data-method="cashless">
        ğŸ’³ QR / ã‚«ãƒ¼ãƒ‰ï¼ˆãƒã‚³ãƒãƒ«ãŠã™ã™ã‚ï¼‰
      </button>
      <button type="button" class="pay-btn" data-method="cash">
        ğŸ’´ ç¾é‡‘ã§ ã‚‚ã‚‰ã£ãŸ
      </button>
    </div>
    <p style="font-size:0.8rem;color:#64748b;margin-top:-0.5rem;margin-bottom:1.5rem;">
      ğŸ’¡ã€ŒQR / ã‚«ãƒ¼ãƒ‰ï¼ˆãƒã‚³ãƒãƒ«ãŠã™ã™ã‚ï¼‰ã€ã‚’ ãˆã‚‰ã¶ã¨ã€<br>
      è‹¥æ—¦é‚£ãƒ»è‹¥å¥³å°†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®
      <strong>ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ¬ã‚¹ãƒãƒƒã‚¸</strong> ã« ã¡ã‹ã¥ãã¾ã™ã€‚
    </p>

    <button class="btn" id="registerBtn" disabled>âœ… ã¨ã†ã‚ã ã™ã‚‹</button>
  </div>
  
  <!-- ========== Step5: ç™»éŒ²å®Œäº†ï¼†QRã‚³ãƒ¼ãƒ‰è¡¨ç¤º ========== -->
  <div id="step5" class="step">
    <h2><span class="emoji">âœ…</span> ã¨ã†ã‚ã ã‹ã‚“ã‚Šã‚‡ã†ï¼</h2>
    <p style="margin-top:0.25rem;">
      ğŸŒ¸ã‚­ãƒ¢ãƒ‹ãƒ£ãƒ»ğŸ¥·ãƒ‹ãƒ³ã‚·ãƒ£ãƒ»ğŸ±ãƒã‚³ãƒãƒ«ã‹ã‚‰ã€Œã‚ã‚ŠãŒã¨ã†ï¼ã€
    </p>
    <p></p>
    
    <div class="qr-container">
      <div id="qrcode"></div>
    </div>
    
    <div class="buyer-attrs">
      <h2><span class="emoji">ğŸ™‹â€â™€ï¸</span> ã‹ã£ã¦ãã‚ŒãŸ ã²ã¨</h2>
      <p class="buyer-hint">
        ãŠãã‚ƒãã•ã‚“ã® ã ã„ãŸã„ã® ã˜ã‚‡ã†ã»ã†ã‚’ ãˆã‚‰ã‚“ã§ã­ã€‚<br>
        ã“ã“ã‚’ å…¥ã‚Œã¦ãã‚Œã‚‹ã¨ã€
        è‹¥æ—¦é‚£ãƒ»è‹¥å¥³å°†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®
        <strong>ã€Œãƒ‡ãƒ¼ã‚¿åäººãƒ¡ãƒ¼ã‚¿ãƒ¼ã€</strong> ãŒ ä¸ŠãŒã‚Šã¾ã™ã€‚<br>
        ã†ã—ã‚ã§ã¯ã€å½±ã®ãƒ‹ãƒ³ã‚·ãƒ£éšŠãŒ ã“ã£ãã‚Š ãŠã¦ã¤ã ã„ã—ã¦ãã‚Œã¾ã™ã€‚<br>
        â€»ãªã¾ãˆ ã‚„ ã‚Œã‚“ã‚‰ãã•ã ã¯ ã²ã¤ã‚ˆã† ã‚ã‚Šã¾ã›ã‚“ã€‚
      </p>

      <div class="attr-group">
        <div class="attr-label">å›½ç±/åŒºåˆ†</div>
        <div class="attr-buttons" data-attr="customer_type">
          <button type="button" class="attr-btn" data-value="domestic">æ—¥æœ¬ã®ã²ã¨</button>
          <button type="button" class="attr-btn" data-value="inbound">å¤–å›½ã‹ã‚‰ããŸã²ã¨</button>
        </div>
      </div>

      <div class="attr-group">
        <div class="attr-label">æ€§åˆ¥</div>
        <div class="attr-buttons" data-attr="gender">
          <button type="button" class="attr-btn" data-value="male">ç”·æ€§</button>
          <button type="button" class="attr-btn" data-value="female">å¥³æ€§</button>
          <button type="button" class="attr-btn" data-value="unknown">ã‚ã‹ã‚‰ãªã„</button>
        </div>
      </div>

      <div class="attr-group">
        <div class="attr-label">å¹´é½¢å¸¯</div>
        <div class="attr-buttons" data-attr="age_band">
          <button type="button" class="attr-btn" data-value="child">ã“ã©ã‚‚</button>
          <button type="button" class="attr-btn" data-value="age_16_29">16ã€œ29</button>
          <button type="button" class="attr-btn" data-value="age_30_59">30ã€œ59</button>
          <button type="button" class="attr-btn" data-value="age_60_plus">60+</button>
        </div>
      </div>

      <button class="btn btn-secondary" id="saveBuyerAttrBtn" disabled>
        ğŸ’¾ ã˜ã‚‡ã†ã»ã†ã‚’ ã»ãã‚“ã—ã¦ ãƒ¡ãƒ¼ã‚¿ãƒ¼UP
      </button>
      <p class="buyer-hint" id="buyerAttrStatus"></p>
    </div>
    
    <button class="btn btn-secondary" onclick="location.reload()">
      ğŸ”„ ã¤ãã® ã—ã‚‡ã†ã²ã‚“ ã‚’ ã¨ã†ã‚ã
    </button>
  </div>
  
</div>

<!-- ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ« -->
<button id="debugToggle">ğŸ› ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</button>
<div id="debugPanel"></div>

<!-- QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<script>
(function(){
  'use strict';
  
  /* ========== ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚° ========== */
  const debugLog = (() => {
    const panel = document.getElementById('debugPanel');
    const toggle = document.getElementById('debugToggle');
    let visible = false;
    
    toggle.addEventListener('click', () => {
      visible = !visible;
      panel.classList.toggle('show', visible);
    });
    
    return (msg) => {
      const time = new Date().toLocaleTimeString('ja-JP');
      const line = document.createElement('div');
      line.textContent = `[${time}] ${msg}`;
      panel.appendChild(line);
      panel.scrollTop = panel.scrollHeight;
      console.log(msg);
    };
  })();
  
  /* ========== ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ ========== */
  let capturedImageDataURL = null;
  let aiAnalysisResult = null;
  let sellerId = null;
  let videoStream = null;
  let torchEnabled = false;
  let paymentMethod = "cashless";
  
  let currentOrderId = null;
  const buyerAttrs = {
    customer_type: null,
    gender: null,
    age_band: null
  };
  
  // ========== ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ ==========
  async function ensureSubscribedSeller() {
    debugLog('ğŸ“¡ ã‚µãƒ–ã‚¹ã‚¯ãƒã‚§ãƒƒã‚¯é–‹å§‹...');
    
    if (!sellerId) {
      debugLog('âŒ sellerId ãŒæœªè¨­å®š');
      const app = document.getElementById('app');
      if (app) {
        app.innerHTML = `
          <div style="padding:16px;">
            <h1 style="font-size:1.1rem;margin-bottom:8px;">ã“ã®è²©å£²ç”»é¢ã¯ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã›ã‚“</h1>
            <p style="font-size:.9rem;line-height:1.6;">
              ã“ã®ã€Œå‡ºåº—è€…ç”¨ è²©å£²ç”»é¢ã€ã¯ã€ãƒ—ãƒ­ / ã‚­ãƒƒã‚ºãƒ—ãƒ©ãƒ³ã”å¥‘ç´„ä¸­ã®å‡ºåº—è€…ã•ã¾å°‚ç”¨ã§ã™ã€‚<br>
              ã‚µãƒ–ã‚¹ã‚¯ã®ãŠç”³ã—è¾¼ã¿ã‚„ãƒ—ãƒ©ãƒ³å¤‰æ›´ã«ã¤ã„ã¦ã¯ã€é‹å–¶ã¾ã§ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚
            </p>
          </div>
        `;
      }
      return false;
    }

    try {
      debugLog(`ğŸ“¤ APIå‘¼ã³å‡ºã—: /api/seller/summary?s=${sellerId}`);
      const res = await fetch(`/api/seller/summary?s=${encodeURIComponent(sellerId)}`);
      debugLog(`ğŸ“¥ APIãƒ¬ã‚¹ãƒãƒ³ã‚¹: ${res.status}`);
      
      const data = await res.json();
      debugLog(`ğŸ“¦ ãƒ‡ãƒ¼ã‚¿: ${JSON.stringify(data)}`);

      if (!res.ok) {
        console.error("seller summary error", data);
        debugLog(`âŒ APIã‚¨ãƒ©ãƒ¼: ${res.status}`);
        const app = document.getElementById('app');
        if (app) {
          app.innerHTML = `<p style="padding:16px;">å‡ºåº—è€…æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>`;
        }
        return false;
      }

      if (
        data.isSubscribed === false ||
        data.planType === "standard" ||
        !data.planType
      ) {
        debugLog(`âŒ ã‚µãƒ–ã‚¹ã‚¯æœªåŠ å…¥: isSubscribed=${data.isSubscribed}, planType=${data.planType}`);
        const app = document.getElementById('app');
        if (app) {
          app.innerHTML = `
            <div style="padding:16px;">
              <h1 style="font-size:1.1rem;margin-bottom:8px;">ã“ã®è²©å£²ç”»é¢ã¯ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã›ã‚“</h1>
              <p style="font-size:.9rem;line-height:1.6;">
                ã“ã®ã€Œå‡ºåº—è€…ç”¨ è²©å£²ç”»é¢ã€ã¯ã€ãƒ—ãƒ­ / ã‚­ãƒƒã‚ºãƒ—ãƒ©ãƒ³ã”å¥‘ç´„ä¸­ã®å‡ºåº—è€…ã•ã¾å°‚ç”¨ã§ã™ã€‚<br>
                ã‚µãƒ–ã‚¹ã‚¯ã®ãŠç”³ã—è¾¼ã¿ã‚„ãƒ—ãƒ©ãƒ³å¤‰æ›´ã«ã¤ã„ã¦ã¯ã€é‹å–¶ã¾ã§ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚
              </p>
            </div>
          `;
        }
        return false;
      }

      debugLog('âœ… ã‚µãƒ–ã‚¹ã‚¯ãƒã‚§ãƒƒã‚¯æˆåŠŸ');
      return true;
    } catch (e) {
      console.error("ensureSubscribedSeller error", e);
      debugLog(`âŒ ä¾‹å¤–ç™ºç”Ÿ: ${e.message}`);
      
      if (window.location.hostname === 'localhost' || 
          window.location.hostname.includes('127.0.0.1') || 
          window.location.hostname.includes('render.com') ||
          window.location.hostname.includes('onrender.com')) {
        debugLog('âš ï¸ é–‹ç™º/ãƒ†ã‚¹ãƒˆç’°å¢ƒ: ã‚µãƒ–ã‚¹ã‚¯ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦UIè¡¨ç¤º');
        return true;
      }
      
      const app = document.getElementById('app');
      if (app) {
        app.innerHTML = `<p style="padding:16px;">é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ã”ç¢ºèªãã ã•ã„ã€‚<br><small>${e.message}</small></p>`;
      }
      return false;
    }
  }
  
  /* ========== Stepåˆ¶å¾¡ ========== */
  function showStep(stepId){
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.getElementById(stepId).classList.add('active');
    debugLog(`Step changed: ${stepId}`);
  }
  
  /* ========== URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰sellerIdå–å¾— ========== */
  function getSellerIdFromURL(){
    const params = new URLSearchParams(window.location.search);
    const s = params.get('s');
    if(!s){
      debugLog('âš ï¸ sellerId not found in URL. Using default: seller_demo');
      return 'seller_demo';
    }
    debugLog(`âœ… sellerId detected: ${s}`);
    return s;
  }
  
  /* ========== Step 0 Navigation ========== */
  function setupEventListeners() {
    document.getElementById('startBtn')?.addEventListener('click', () => {
      showStep('step0-2');
      debugLog('User clicked: ã¯ã˜ã‚ã‚‹');
    });
    
    document.getElementById('understoodBtn')?.addEventListener('click', () => {
      showStep('step0-3');
      debugLog('User clicked: ã‚ã‹ã£ãŸ');
    });
    
    document.getElementById('openCameraBtn')?.addEventListener('click', () => {
      showStep('step1');
      initCamera();
      debugLog('User clicked: ã‚«ãƒ¡ãƒ©ã‚’ã²ã‚‰ã');
    });
    
    document.getElementById('skipToQRBtn')?.addEventListener('click', () => {
      const baseURL = window.location.origin;
      const qrURL = `${baseURL}/checkout.html?s=${sellerId}`;
      
      const qrContainer = document.querySelector('.qr-container');
      if (qrContainer) qrContainer.style.display = 'block';
      
      showStep('step5');
      displayQR(qrURL);
      setupBuyerAttrButtons();
      
      debugLog('User clicked: QRã‚’ã•ãã«ã¿ã›ã‚‹');
    });
  }
  
  /* ========== Step1: ã‚«ãƒ¡ãƒ©èµ·å‹•ï¼†æ’®å½± ========== */
  async function initCamera(){
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const captureBtn = document.getElementById('captureBtn');
    const torchBtn = document.getElementById('torchBtn');
    
    try {
      videoStream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: { ideal: 'environment' },
          width:  { ideal: 1600 },
          height: { ideal: 1200 },
          aspectRatio: { ideal: 4/3 }
        },
        audio: false
      });
      
      video.srcObject = videoStream;
      debugLog(`âœ… Camera started: ${video.videoWidth}x${video.videoHeight}`);
      
      const track = videoStream.getVideoTracks()[0];
      const caps = track.getCapabilities?.();
      
      if(caps){
        debugLog(`ğŸ“· Camera capabilities: ${JSON.stringify(caps)}`);
        
        const constraints = { advanced: [] };
        
        if(caps.focusMode && caps.focusMode.includes('continuous')){
          constraints.advanced.push({ focusMode: 'continuous' });
          debugLog('âœ… Continuous autofocus enabled');
        }
        
        if(constraints.advanced.length > 0){
          await track.applyConstraints(constraints);
        }
      }
      
      if(caps && caps.torch){
        torchBtn.style.display = 'flex';
        torchBtn.addEventListener('click', async () => {
          torchEnabled = !torchEnabled;
          try {
            await track.applyConstraints({
              advanced: [{ torch: torchEnabled }]
            });
            torchBtn.classList.toggle('active', torchEnabled);
            debugLog(`ğŸ’¡ Torch: ${torchEnabled ? 'ON' : 'OFF'}`);
          } catch(e){
            debugLog(`âš ï¸ Torch toggle failed: ${e.message}`);
          }
        });
      } else {
        torchBtn.style.display = 'none';
      }
      
    } catch(err) {
      debugLog(`âŒ Camera error: ${err.message}`);
      alert('ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      return;
    }
    
    captureBtn.addEventListener('click', () => {
      captureAndProcessImage(video, canvas);
    });
  }
  
  /* ========== ç”»åƒã‚­ãƒ£ãƒ—ãƒãƒ£ï¼†å‡¦ç† ========== */
  function captureAndProcessImage(video, canvas){
    const vw = video.videoWidth  || 640;
    const vh = video.videoHeight || 480;
    
    debugLog(`ğŸ“¸ Capturing: ${vw}x${vh}`);
    
    const sx = vw * 0.025;
    const sy = vh * 0.025;
    const sw = vw * 0.95;
    const sh = vh * 0.95;
    
    debugLog(`ğŸ“ Crop area: ${sx}, ${sy}, ${sw}x${sh} (95% of frame)`);
    
    const needRotate = vw > vh && window.innerHeight > window.innerWidth;
    const SIZE = 1024;
    
    if(needRotate){
      canvas.width  = SIZE;
      canvas.height = SIZE;
      const ctx = canvas.getContext('2d');
      
      ctx.filter = 'contrast(1.25) brightness(1.05)';
      
      ctx.save();
      ctx.translate(SIZE/2, SIZE/2);
      ctx.rotate(-Math.PI / 2);
      ctx.drawImage(video, sx, sy, sw, sh, -SIZE/2, -SIZE/2, SIZE, SIZE);
      ctx.restore();
      ctx.filter = 'none';
      
      debugLog('ğŸ”„ Image rotated 90Â° for portrait mode');
    } else {
      canvas.width  = SIZE;
      canvas.height = SIZE;
      const ctx = canvas.getContext('2d');
      
      ctx.filter = 'contrast(1.25) brightness(1.05)';
      ctx.drawImage(video, sx, sy, sw, sh, 0, 0, SIZE, SIZE);
      ctx.filter = 'none';
    }
    
    capturedImageDataURL = canvas.toDataURL('image/jpeg', 0.95);
    debugLog(`âœ… Image captured (wide angle): ${capturedImageDataURL.substring(0,50)}...`);
    debugLog(`ğŸ“¦ Image size: ${Math.round(capturedImageDataURL.length / 1024)}KB`);
    
    if(videoStream){
      videoStream.getTracks().forEach(t => t.stop());
      debugLog('ğŸ“· Camera stopped');
    }
    
    showStep('step2');
    analyzeImage();
  }
  
  /* ========== Step2: AIç”»åƒè§£æ ========== */
  async function analyzeImage(){
    if(!capturedImageDataURL){
      debugLog('âŒ No image to analyze');
      alert('ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“');
      showStep('step1');
      return;
    }
    
    const blob = dataURLtoBlob(capturedImageDataURL);
    const formData = new FormData();
    formData.append('image', blob, 'item.jpg');
    
    debugLog('ğŸ“¤ Sending image to /api/analyze-item...');
    
    try{
      const res = await fetch('/api/analyze-item', {
        method: 'POST',
        body: formData
      });
      
      if(!res.ok){
        throw new Error(`HTTP ${res.status}`);
      }
      
      const data = await res.json();
      debugLog(`âœ… AI response: ${JSON.stringify(data)}`);
      
      aiAnalysisResult = data;
      showStep('step3');
      renderStep3();
      
    } catch(err) {
      debugLog(`âŒ AI analysis failed: ${err.message}`);
      alert('AIè§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã ã•ã„ã€‚');
      showStep('step1');
      location.reload();
    }
  }
  
  /* ========== Step3: å•†å“æƒ…å ±è¡¨ç¤ºï¼†ä¾¡æ ¼å…¥åŠ› ========== */
  function renderStep3(){
    const previewImg = document.getElementById('previewImg');
    const itemSummary = document.getElementById('itemSummary');
    const totalPriceInput = document.getElementById('totalPriceInput');
    const nextBtn = document.getElementById('nextToConfirm');
    const priceWrapper = document.getElementById('priceWrapper');
    
    previewImg.src = capturedImageDataURL;
    
    if(aiAnalysisResult && aiAnalysisResult.summary){
      itemSummary.textContent = aiAnalysisResult.summary;
    } else {
      itemSummary.textContent = 'ï¼ˆAI ã§ ã—ã‚‡ã†ã²ã‚“ ã‚’ ã«ã‚“ã—ã ã§ãã¾ã›ã‚“ã§ã—ãŸï¼‰';
    }
    
    if (aiAnalysisResult && aiAnalysisResult.total) {
      const autoAmount = parseInt(aiAnalysisResult.total, 10);
      if (autoAmount > 0) {
        totalPriceInput.value = autoAmount;
        nextBtn.disabled = false;
        debugLog(`ğŸ’° AI total auto-filled: ${autoAmount}`);
      }
    }
    
    if (!totalPriceInput.value || parseInt(totalPriceInput.value, 10) <= 0) {
      nextBtn.disabled = true;
    }
    
    totalPriceInput.addEventListener('focus', () => {
      priceWrapper.classList.add('focused');
    });
    totalPriceInput.addEventListener('blur', () => {
      priceWrapper.classList.remove('focused');
    });
    
    totalPriceInput.addEventListener('input', () => {
      const val = parseInt(totalPriceInput.value, 10);
      nextBtn.disabled = !(val > 0);
    });
    
    nextBtn.addEventListener('click', () => {
      showStep('step4');
      renderStep4();
    });

    // â˜…è¿½åŠ ï¼šã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰åˆæœŸåŒ–
    setupPriceKeypad(totalPriceInput, nextBtn);
  }
  
  /* ========== ã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ========== */
  function setupPriceKeypad(inputEl, nextBtn){
    const keypad = document.getElementById('priceKeypad');
    if (!keypad || !inputEl) return;

    keypad.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-key]');
      if (!btn) return;

      const key = btn.dataset.key;
      let val = inputEl.value || '';

      if (key === 'clear') {
        val = '';
      } else if (key === 'del') {
        val = val.slice(0, -1);
      } else {
        // 0ã€œ9ã®æ•°å­—
        if (val.length >= 6) {
          // æ¡æ•°åˆ¶é™ï¼ˆä¾‹: æœ€å¤§999,999å††ï¼‰
          return;
        }
        if (val === '0') {
          val = '';
        }
        val += key;
      }

      // å…ˆé ­ã® 0 ã‚’æŠ‘åˆ¶
      if (val.length > 1 && val[0] === '0') {
        val = val.replace(/^0+/, '');
        if (val === '') val = '0';
      }

      inputEl.value = val;

      const num = parseInt(val || '0', 10);
      nextBtn.disabled = !(num > 0);

      debugLog(`âŒ¨ï¸ keypad input = ${val} (${num})`);
    });
  }
  
  /* ========== Step4: æœ€çµ‚ç¢ºèª ========== */
  function renderStep4(){
    const confirmImg = document.getElementById('confirmImg');
    const confirmSummary = document.getElementById('confirmSummary');
    const confirmTotal = document.getElementById('confirmTotal');
    const parentCheck = document.getElementById('parentCheck');
    const registerBtn = document.getElementById('registerBtn');
    
    confirmImg.src = capturedImageDataURL;
    
    const summary = (aiAnalysisResult && aiAnalysisResult.summary) 
                    ? aiAnalysisResult.summary 
                    : 'ï¼ˆã—ã‚‡ã†ã²ã‚“ ã˜ã‚‡ã†ã»ã† ãªã—ï¼‰';
    confirmSummary.textContent = summary;
    
    const totalVal = parseInt(document.getElementById('totalPriceInput').value, 10) || 0;
    confirmTotal.textContent = `Â¥${totalVal.toLocaleString()}`;
    
    parentCheck.addEventListener('change', () => {
      registerBtn.disabled = !parentCheck.checked;
    });

    paymentMethod = "cashless";
    const payButtons = document.querySelectorAll('.pay-btn');
    
    payButtons.forEach(btn => {
      if (btn.getAttribute('data-method') === 'cashless') {
        btn.classList.add('selected');
      } else {
        btn.classList.remove('selected');
      }
    });
    debugLog(`ğŸ’³ Payment method initialized: ${paymentMethod}`);
    
    payButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        paymentMethod = btn.getAttribute('data-method');
        payButtons.forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        debugLog(`ğŸ’³ paymentMethod = ${paymentMethod}`);
      });
    });
    
    registerBtn.addEventListener('click', async () => {
      registerBtn.disabled = true;
      registerBtn.textContent = 'ğŸ“¤ ã¨ã†ã‚ã ã¡ã‚…ã†â€¦';
      
      await registerSale(summary, totalVal);
    });
  }
  
  /* ========== Step5: ã‚µãƒ¼ãƒã¸ç™»éŒ² ========== */
  async function registerSale(summary, amount){
    debugLog('=== registerSale START ===');
    debugLog(`sellerId: ${sellerId}`);
    debugLog(`amount: ${amount}`);
    debugLog(`summary: ${summary}`);
    debugLog(`paymentMethod: ${paymentMethod}`);
    
    const payload = {
      sellerId: sellerId,
      amount: amount,
      summary: summary,
      imageData: capturedImageDataURL,
      aiAnalysis: aiAnalysisResult || {},
      paymentMethod: paymentMethod
    };
    
    debugLog(`ğŸ“¤ Sending to /api/pending/start: ${JSON.stringify(payload).substring(0,100)}...`);
    
    try{
      const res = await fetch('/api/pending/start', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      
      if(!res.ok){
        throw new Error(`HTTP ${res.status}`);
      }
      
      const data = await res.json();
      debugLog(`âœ… Server response: ${JSON.stringify(data)}`);
      
      currentOrderId = data.orderId || null;
      debugLog(`ğŸ“ currentOrderId: ${currentOrderId}`);
      
      const baseURL = window.location.origin;
      let qrURL;
      
      if(data.checkoutUrl){
        qrURL = data.checkoutUrl;
        debugLog(`ğŸ”— Using server-provided checkoutUrl: ${qrURL}`);
      } else if(data.qrURL){
        qrURL = data.qrURL;
        debugLog(`ğŸ”— Using server-provided qrURL (fallback): ${qrURL}`);
      } else if(data.orderId){
        qrURL = `${baseURL}/checkout.html?s=${sellerId}&order=${data.orderId}`;
        debugLog(`ğŸ”— Using orderId-based qrURL: ${qrURL}`);
      } else {
        qrURL = `${baseURL}/checkout.html?s=${sellerId}`;
        debugLog(`âš ï¸ Fallback to sellerId-based qrURL: ${qrURL}`);
      }
      
      showStep('step5');

      const qrContainer = document.querySelector('.qr-container');
      const msgP = document.querySelector('#step5 > p');

      if (paymentMethod === "cash") {
        if (qrContainer) qrContainer.style.display = 'none';
        if (msgP) {
          msgP.textContent =
            'ğŸ’´ ç¾é‡‘ã§ ã†ã‘ã¨ã‚Šã¾ã—ãŸã€‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼\n' +
            'â€»ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ¬ã‚¹ã®ãƒãƒƒã‚¸ã‚’ ã­ã‚‰ã†ã¨ãã¯ã€QR / ã‚«ãƒ¼ãƒ‰ ã‚‚ ãŸã‚ã—ã¦ã¿ã¦ã­ã€‚';
        }
        debugLog('ğŸª™ ç¾é‡‘æ±ºæ¸ˆã¨ã—ã¦ç™»éŒ²ï¼ˆQRãªã—ï¼‰');
      } else {
        if (qrContainer) qrContainer.style.display = 'block';
        if (msgP) msgP.textContent = 'ã“ã®QRã‚³ãƒ¼ãƒ‰ã‚’ ãŠãã‚ƒãã•ã‚“ã« ã¿ã›ã¦ã­';
        displayQR(qrURL);
        debugLog('ğŸ’³ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ¬ã‚¹æ±ºæ¸ˆï¼ˆQRè¡¨ç¤ºï¼‰');
      }
      
      setupBuyerAttrButtons();
      
      debugLog('=== registerSale SUCCESS ===');
      
    } catch(err) {
      debugLog(`âŒ registerSale failed: ${err.message}`);
      alert('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
      location.reload();
    }
  }
  
  /* ========== QRã‚³ãƒ¼ãƒ‰è¡¨ç¤º ========== */
  function displayQR(url){
    const qrcodeDiv = document.getElementById('qrcode');
    qrcodeDiv.innerHTML = '';
    
    try{
      new QRCode(qrcodeDiv, {
        text: url,
        width: 200,
        height: 200,
        colorDark: '#000000',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.M
      });
      debugLog(`âœ… QR code generated: ${url}`);
    } catch(e){
      debugLog(`âŒ QR generation error: ${e.message}`);
      qrcodeDiv.innerHTML = `<p style="color:red;">QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆå¤±æ•—</p><p style="font-size:0.8rem;">${url}</p>`;
    }
  }
  
  /* ========== è³¼å…¥è€…å±æ€§ãƒœã‚¿ãƒ³ã®è¨­å®š ========== */
  function setupBuyerAttrButtons(){
    const allAttrButtons = document.querySelectorAll('.attr-btn');
    const saveBtn = document.getElementById('saveBuyerAttrBtn');
    const statusP = document.getElementById('buyerAttrStatus');
    
    // ğŸ†• currentOrderIdãŒãªã„å ´åˆã¯ä¿å­˜ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    if (!currentOrderId) {
      if (saveBtn) {
        saveBtn.disabled = true;
        saveBtn.textContent = 'ğŸ’¾ ã˜ã‚‡ã†ã»ã†ã‚’ ã»ãã‚“ã—ã¦ ãƒ¡ãƒ¼ã‚¿ãƒ¼UP';
      }
      if (statusP) {
        statusP.textContent = 'âš ï¸ å–å¼•ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å…ˆã«å•†å“ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚';
        statusP.style.color = '#dc2626';
      }
      // å±æ€§ãƒœã‚¿ãƒ³ã‚‚ç„¡åŠ¹åŒ–ï¼ˆè¦–è¦šçš„ã«åˆ†ã‹ã‚Šã‚„ã™ãã™ã‚‹ï¼‰
      allAttrButtons.forEach(btn => {
        btn.disabled = true;
        btn.style.opacity = '0.5';
        btn.style.cursor = 'not-allowed';
      });
      debugLog('âš ï¸ currentOrderIdãŒãªã„ãŸã‚ã€è³¼å…¥è€…å±æ€§ã®ä¿å­˜æ©Ÿèƒ½ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã—ãŸ');
      return;
    }
    
    // currentOrderIdãŒã‚ã‚‹å ´åˆã¯é€šå¸¸é€šã‚Šæœ‰åŠ¹åŒ–
    if (statusP) {
      statusP.textContent = '';
      statusP.style.color = '';
    }
    allAttrButtons.forEach(btn => {
      btn.disabled = false;
      btn.style.opacity = '';
      btn.style.cursor = '';
    });
    
    allAttrButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const parentDiv = btn.closest('.attr-buttons');
        const attrName = parentDiv.getAttribute('data-attr');
        const attrValue = btn.getAttribute('data-value');
        
        parentDiv.querySelectorAll('.attr-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        
        buyerAttrs[attrName] = attrValue;
        debugLog(`ğŸ™‹ buyerAttrs.${attrName} = ${attrValue}`);
        
        const allFilled = buyerAttrs.customer_type && buyerAttrs.gender && buyerAttrs.age_band;
        saveBtn.disabled = !allFilled;
      });
    });
    
    saveBtn.addEventListener('click', async () => {
      if(!currentOrderId){
        statusP.textContent = 'âš ï¸ ã‚ªãƒ¼ãƒ€ãƒ¼IDãŒã‚ã‚Šã¾ã›ã‚“';
        return;
      }
      
      saveBtn.disabled = true;
      saveBtn.textContent = 'ğŸ’¾ ã»ãã‚“ ã¡ã‚…ã†â€¦';
      statusP.textContent = '';
      
      debugLog(`ğŸ“¤ Sending buyer attributes to /api/orders/buyer-attributes`);
      debugLog(`orderId: ${currentOrderId}, buyerAttrs: ${JSON.stringify(buyerAttrs)}`);
      
      try{
        const res = await fetch('/api/orders/buyer-attributes', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({
            orderId: currentOrderId,
            ...buyerAttrs
          })
        });
        
        if(!res.ok){
          throw new Error(`HTTP ${res.status}`);
        }
        
        const data = await res.json();
        debugLog(`âœ… Buyer attributes saved: ${JSON.stringify(data)}`);
        
        statusP.textContent = 'âœ… ã»ãã‚“ ã‹ã‚“ã‚Šã‚‡ã†ï¼ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ãƒ¡ãƒ¼ã‚¿ãƒ¼ãŒ ã™ã“ã—ä¸ŠãŒã‚Šã¾ã—ãŸã€‚';
        saveBtn.textContent = 'ğŸ’¾ ãƒ¡ãƒ¼ã‚¿ãƒ¼UP ãšã¿';
        
      } catch(err) {
        debugLog(`âŒ Buyer attributes save failed: ${err.message}`);
        statusP.textContent = 'âš ï¸ ã»ãã‚“ ã—ã£ã±ã„ ã—ã¾ã—ãŸ';
        saveBtn.disabled = false;
        saveBtn.textContent = 'ğŸ’¾ ã˜ã‚‡ã†ã»ã†ã‚’ ã»ãã‚“ã—ã¦ ãƒ¡ãƒ¼ã‚¿ãƒ¼UP';
      }
    });
  }
  
  /* ========== ãƒ˜ãƒ«ãƒ‘ãƒ¼: DataURL â†’ Blob ========== */
  function dataURLtoBlob(dataURL){
    const arr = dataURL.split(',');
    const mime = arr[0].match(/:(.*?);/)[1];
    const bstr = atob(arr[1]);
    let n = bstr.length;
    const u8arr = new Uint8Array(n);
    while(n--){
      u8arr[n] = bstr.charCodeAt(n);
    }
    return new Blob([u8arr], {type:mime});
  }
  
  /* ========== åˆæœŸåŒ– ========== */
  (async () => {
    sellerId = getSellerIdFromURL();
    debugLog(`ğŸš€ App initialized with sellerId: ${sellerId}`);

    const ok = await ensureSubscribedSeller();
    if (!ok) {
      debugLog('âš ï¸ Subscription check failed. UI blocked.');
      return;
    }
    debugLog('âœ… Subscription check passed.');
    
    setupEventListeners();
  })();
  
})();
</script>

</body>
</html>

<!doctype html>
<html lang="ja">
<head>
  <!-- =========================================================
       FleaPayï½œå‡ºåº—è€…UIï¼ˆã“ã©ã‚‚/ãŠã¨ãªï¼‰ å€¤æœ­ãªã—å†™çœŸã«ã‚‚å¯¾å¿œ
       ãƒ»AIã¯å¸¸æ™‚ONï¼ˆ/api/analyze-itemï¼‰
       ãƒ»ã€Œå“åã®ã¿ã€æŠ½å‡ºã§ã‚‚OK â†’ ä¾¡æ ¼ãƒ‘ãƒƒãƒ‰ã§å˜ä¾¡/æ•°é‡ã‚’è£œå®Œ
       ãƒ»æ’®å½±â†’è‡ªå‹•ã§æ¬¡ç”»é¢é·ç§» / èª­ã¿è¾¼ã¿ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
       ãƒ»å•†å“æ˜ç´°ï¼ˆAI or æ‰‹å‹• or ä¾¡æ ¼ãƒ‘ãƒƒãƒ‰ï¼‰
       ãƒ»é‡‘é¡ãƒ—ãƒªã‚»ãƒƒãƒˆï¼‹ãƒ†ãƒ³ã‚­ãƒ¼
       ãƒ»åŒç”»é¢ç¢ºèªï¼‹æ—§åˆ†é›¢ç¢ºèªã‚¹ãƒ†ãƒƒãƒ—ï¼ˆæ®‹ç½®ï¼‰
       ãƒ»å¤§äººãƒ¢ãƒ¼ãƒ€ãƒ«ç¢ºèªâ†’ç™»éŒ²
       ãƒ»å›ºå®šQRï¼ˆè³¼å…¥è€…æç¤ºç”¨ï¼‰
       ãƒ»ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ï¼ˆHTTP/æœ¬æ–‡ï¼‰
       ========================================================= -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FleaPayï½œå‡ºåº—è€…UIï¼ˆå€¤æœ­ãªã—å¯¾å¿œç‰ˆãƒ»æ”¹å–„ç‰ˆï¼‰</title>

  <!-- Normalize -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/modern-normalize/2.0.0/modern-normalize.min.css"
        integrity="sha512-LC1aJ7fRkY7O0l6D4J0m0qH2P0Q8rj3bJv9V3nX8v9M3h7Ww4H0r+g8fV2r1uVhWwWqM0B3C1qfKq1QwqQv7xQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"/>

  <style>
    /* ========== åŸºæœ¬ãƒˆãƒ¼ã‚¯ãƒ³ ========== */
    :root{
      --brand:#2563eb;
      --brand-dk:#1e40af;
      --danger:#dc2626;
      --ok:#16a34a;
      --muted:#6b7280;
      --text:#1f2937;
      --bg:#f9fafb;
      --border:#e5e7eb;
    }

    /* ========== ãƒªã‚»ãƒƒãƒˆï¼‹å…±é€š ========== */
    *,*::before,*::after{box-sizing:border-box}
    body{
      font-family:'Hiragino Sans','ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ã‚·ãƒƒã‚¯',sans-serif;
      background:var(--bg);
      color:var(--text);
      margin:0;
      padding:0;
    }
    button,input,select,textarea{font:inherit}
    button{cursor:pointer}

    /* ========== ãƒ˜ãƒƒãƒ€ãƒ¼ ========== */
    header{
      background:#fff;
      border-bottom:2px solid var(--border);
      padding:12px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    header h1{
      margin:0;
      font-size:1.1rem;
      font-weight:700;
    }
    .mode-badge{
      background:var(--brand);
      color:#fff;
      padding:4px 10px;
      border-radius:8px;
      font-size:.8rem;
      font-weight:700;
    }

    /* ========== ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ ========== */
    main{
      max-width:600px;
      margin:0 auto;
      padding:16px;
    }

    /* ========== ã‚«ãƒ¼ãƒ‰ ========== */
    .card{
      background:#fff;
      border-radius:12px;
      box-shadow:0 1px 3px rgba(0,0,0,0.1);
      padding:16px;
      margin-bottom:16px;
    }
    .card-title{
      font-size:1.1rem;
      font-weight:700;
      margin-bottom:12px;
    }

    /* ========== ãƒœã‚¿ãƒ³ ========== */
    .btn{
      background:#fff;
      border:1px solid var(--border);
      border-radius:8px;
      padding:10px 16px;
      transition:all .2s;
      font-weight:600;
    }
    .btn:hover:not(:disabled){
      background:var(--bg);
    }
    .btn:disabled{
      opacity:.5;
      cursor:not-allowed;
    }
    .btn.primary{
      background:var(--brand);
      color:#fff;
      border-color:var(--brand);
    }
    .btn.primary:hover:not(:disabled){
      background:var(--brand-dk);
    }
    .btn.danger{
      background:var(--danger);
      color:#fff;
      border-color:var(--danger);
    }

    /* ========== ãƒ•ã‚©ãƒ¼ãƒ  ========== */
    input[type=text],input[type=number],textarea,select{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:8px;
      transition:border .2s;
    }
    input:focus,textarea:focus,select:focus{
      outline:none;
      border-color:var(--brand);
    }
    textarea{
      min-height:80px;
      resize:vertical;
      font-family:inherit;
    }

    /* ========== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========== */
    .hidden{display:none!important}
    .right{text-align:right}
    .center{text-align:center}
    .mt-8{margin-top:8px}
    .mt-12{margin-top:12px}
    .mb-8{margin-bottom:8px}
    .gap-8{gap:8px}

    /* ========== ã‚«ãƒ¡ãƒ©ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ ========== */
    #camera-preview{
      width:100%;
      max-width:400px;
      height:300px;
      background:#000;
      border-radius:8px;
      margin:0 auto;
      display:block;
    }
    #canvas{display:none}

    /* ========== ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ ========== */
    .img-preview{
      width:100%;
      max-width:300px;
      border-radius:8px;
      margin:0 auto;
      display:block;
    }

    /* ========== ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ ========== */
    #loading-overlay{
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.7);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      z-index:9999;
      color:#fff;
    }
    .spinner{
      border:4px solid rgba(255,255,255,0.3);
      border-top:4px solid #fff;
      border-radius:50%;
      width:48px;
      height:48px;
      animation:spin 1s linear infinite;
    }
    @keyframes spin{
      0%{transform:rotate(0deg)}
      100%{transform:rotate(360deg)}
    }

    /* ========== ãƒ¢ãƒ¼ãƒ€ãƒ« ========== */
    .modal-overlay{
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.5);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:1000;
    }
    .modal{
      background:#fff;
      border-radius:12px;
      padding:24px;
      max-width:90%;
      max-height:80%;
      overflow:auto;
    }
    .modal-title{
      font-size:1.2rem;
      font-weight:700;
      margin-bottom:16px;
    }

    /* ========== QRã‚³ãƒ¼ãƒ‰ ========== */
    #qr-code{
      margin:0 auto;
      display:block;
    }

    /* ========== ã“ã©ã‚‚ãƒ¢ãƒ¼ãƒ‰å°‚ç”¨ ========== */
    .kid-hint{
      font-size:1.1rem;
      line-height:1.6;
    }
    .kid-btn{
      font-size:1.2rem;
      padding:14px 20px;
    }

    /* ========== ä¾¡æ ¼ãƒ‘ãƒƒãƒ‰ ========== */
    .pp-grid{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:8px;
      margin-top:12px;
    }
    .pp-btn{
      aspect-ratio:1;
      font-size:1.3rem;
      font-weight:700;
      border:2px solid var(--border);
      border-radius:12px;
      background:#fff;
      transition:all .2s;
    }
    .pp-btn:active{
      transform:scale(0.95);
      background:var(--brand);
      color:#fff;
    }
    .pp-preset{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:12px;
    }
    .pp-preset button{
      flex:1;
      min-width:80px;
      padding:12px;
      font-size:1.1rem;
      font-weight:700;
    }
    .pp-display{
      background:#f3f4f6;
      border:2px solid var(--border);
      border-radius:8px;
      padding:16px;
      text-align:right;
      font-size:2rem;
      font-weight:700;
      min-height:60px;
    }
    .pp-qty{
      display:flex;
      align-items:center;
      gap:6px;
    }
    .pp-qty input{
      width:72px;
      text-align:center;
    }

    /* ========== ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹è¡Œ ========== */
    .ckrow{
      display:flex;
      align-items:center;
      gap:12px;
      justify-content:center;
      padding:8px 12px;
    }
    .cktext{
      white-space:nowrap;
      font-size:1.05rem;
    }
    .ckbox{
      width:28px;
      height:28px;
      accent-color:var(--brand);
    }
    @supports not (accent-color: red){
      .ckbox{
        -webkit-appearance:auto;
        appearance:auto;
      }
    }

    /* === å•†å“æ¦‚è¦ãƒœãƒƒã‚¯ã‚¹ï¼ˆã¯ã¿å‡ºã—é˜²æ­¢ï¼‰ === */
    .summary-box{
      max-height:140px;
      overflow:auto;
      word-break:break-word;
    }
    .summary-box pre{
      white-space:pre-wrap;
      word-break:break-word;
      margin:0;
    }

    /* === éŸ³å£°å…¥åŠ›UI === */
    .voice-row{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .voice-status{
      font-size:.82rem;
      color:var(--muted);
    }
    .voice-recording{
      animation:pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse{
      0%, 100%{opacity:1}
      50%{opacity:0.5}
    }
  </style>
</head>

<body>
  <!-- ========== ãƒ˜ãƒƒãƒ€ãƒ¼ ========== -->
  <header>
    <h1>ğŸ›ï¸ FleaPay å‡ºåº—è€…</h1>
    <div class="mode-badge" id="mode-badge">ã“ã©ã‚‚</div>
  </header>

  <!-- ========== ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ ========== -->
  <main>
    <!-- ========== ã“ã©ã‚‚ãƒ¢ãƒ¼ãƒ‰ï¼šã‚¹ãƒ†ãƒƒãƒ—1ï¼ˆæ’®å½±ï¼‰ ========== -->
    <div id="kid-step1" class="card">
      <div class="card-title kid-hint">ğŸ“¸ ã—ã‚‡ã†ã²ã‚“ã‚’ ã¨ã‚ã†</div>
      <video id="camera-preview" autoplay playsinline></video>
      <div class="center mt-12">
        <button class="btn primary kid-btn" id="k1-capture">ğŸ“· ã¨ã‚‹</button>
      </div>
      <canvas id="canvas"></canvas>
    </div>

    <!-- ========== ã“ã©ã‚‚ãƒ¢ãƒ¼ãƒ‰ï¼šã‚¹ãƒ†ãƒƒãƒ—2ï¼ˆAIè§£æâ†’æ˜ç´°ç¢ºèªï¼‰ ========== -->
    <div id="kid-step2" class="card hidden">
      <div class="card-title kid-hint">âœ¨ AIãŒ ã¿ã¦ã„ã¾ã™â€¦</div>
      <img id="k2-photo" class="img-preview" alt="æ’®å½±å†™çœŸ"/>

      <div class="mt-12">
        <label class="kid-hint" style="font-weight:700">ğŸ“ ã—ã‚‡ã†ã²ã‚“ ã˜ã‚‡ã†ã»ã†</label>
        <div id="k2-summary-view"
             class="kid-hint summary-box"
             style="background:#fff;border:1px solid #eee;border-radius:10px;padding:10px;min-height:56px">ï¼ˆã—ã‚‡ã†ã²ã‚“ ã˜ã‚‡ã†ã»ã† ãªã—ï¼‰</div>

        <div id="k2-summary-edit-wrap" style="margin-top:8px;display:none">
          <label style="font-weight:700">ğŸ¤ ã“ãˆ ã§ã‚‚ ã„ã‚Œã‚‰ã‚Œã¾ã™ï¼ˆå„è¡Œã€Œå•†å“å Ã—æ•°é‡ã€ï¼‰</label>
          <textarea id="k2-summary-edit" placeholder="ã‚«ãƒ¼ãƒ‰ Ã—1&#10;ã‚­ãƒ¼ãƒ›ãƒ«ãƒ€ãƒ¼ Ã—2"></textarea>
          <div class="voice-row">
            <button class="btn" id="k2-voice-start">ğŸ¤ ã“ãˆã§ ã„ã‚Œã‚‹</button>
            <div id="k2-voice-status" class="voice-status">
              ãƒã‚¤ã‚¯ãŒã¤ã‹ãˆã‚‹ã‚¹ãƒãƒ›ã§ ã¤ã‹ãˆã¾ã™
            </div>
            <div style="flex:1"></div>
            <button class="btn" id="k2-summary-apply">ã“ã®ãªã„ã‚ˆã†ã§ ã¤ã‹ã†</button>
          </div>
        </div>

        <div class="right mt-8">
          <button class="btn" id="k2-edit-toggle">âœï¸ ã¦ã§ ãªãŠã™</button>
        </div>
      </div>

      <div class="mt-12 center">
        <button class="btn primary kid-btn" id="k2-next">âœ… ã¤ãã¸ï¼ˆã‹ãã«ã‚“ï¼‰</button>
      </div>
    </div>

    <!-- ========== ã“ã©ã‚‚ãƒ¢ãƒ¼ãƒ‰ï¼šã‚¹ãƒ†ãƒƒãƒ—3ï¼ˆä¾¡æ ¼ãƒ‘ãƒƒãƒ‰ï¼‰ ========== -->
    <div id="kid-step3" class="card hidden">
      <div class="card-title kid-hint">ğŸ’° ã­ã ã‚“ã‚’ ã„ã‚Œã‚ˆã†</div>

      <div id="k3-items-wrap">
        <!-- å‹•çš„ç”Ÿæˆ -->
      </div>

      <div class="mt-12 center">
        <button class="btn primary kid-btn" id="k3-done">âœ… ã‹ã‚“ã‚Šã‚‡ã†</button>
      </div>
    </div>

    <!-- ========== ã“ã©ã‚‚ãƒ¢ãƒ¼ãƒ‰ï¼šã‚¹ãƒ†ãƒƒãƒ—4ï¼ˆç¢ºèªï¼‰ ========== -->
    <div id="kid-step4" class="card hidden">
      <div class="card-title kid-hint">ğŸ‘€ ã•ã„ã—ã‚…ã† ã‹ãã«ã‚“</div>
      <div id="k4-summary" style="background:#f9fafb;border-radius:8px;padding:12px;margin-top:8px">
        <!-- å‹•çš„ç”Ÿæˆ -->
      </div>

      <div class="ckrow mt-12">
        <input type="checkbox" id="k4-check-ok" class="ckbox"/>
        <label for="k4-check-ok" class="cktext">ã“ã‚Œã§ ã ã„ã˜ã‚‡ã†ã¶ï¼</label>
      </div>

      <div class="mt-12 center">
        <button class="btn primary kid-btn" id="k4-adult">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ãŠã¨ãªã« ã‹ãã«ã‚“ã—ã¦ã‚‚ã‚‰ã†</button>
      </div>
    </div>

    <!-- ========== ãŠã¨ãªãƒ¢ãƒ¼ãƒ‰ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« ========== -->
    <div id="adult-modal" class="modal-overlay hidden">
      <div class="modal">
        <div class="modal-title">ğŸ” ä¿è­·è€…ç¢ºèª</div>
        <div id="adult-summary">
          <!-- å‹•çš„ç”Ÿæˆ -->
        </div>

        <div class="ckrow mt-12">
          <input type="checkbox" id="adult-final-check" class="ckbox"/>
          <label for="adult-final-check" class="cktext">å†…å®¹ã‚’ç¢ºèªã—ã¾ã—ãŸ</label>
        </div>

        <div style="display:flex;gap:8px;margin-top:16px">
          <button class="btn" id="adult-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="btn primary" id="adult-register" style="flex:1">ğŸš€ ç™»éŒ²ã™ã‚‹</button>
        </div>
      </div>
    </div>

    <!-- ========== å®Œäº†ç”»é¢ ========== -->
    <div id="complete-screen" class="card hidden">
      <div class="card-title center">âœ… ã¨ã†ã‚ã ã‹ã‚“ã‚Šã‚‡ã†ï¼</div>
      <div class="center mt-12">
        <p class="kid-hint">ã“ã®QRã‚³ãƒ¼ãƒ‰ã‚’ ãŠãã‚ƒãã•ã‚“ã« ã¿ã›ã¦ã­</p>
        <canvas id="qr-code"></canvas>
        <p style="margin-top:12px;font-weight:700;font-size:1.1rem" id="qr-url-text"></p>
      </div>
      <div class="center mt-12">
        <button class="btn primary kid-btn" id="reset-btn">ğŸ”„ ã‚ãŸã‚‰ã—ã ã¯ã˜ã‚ã‚‹</button>
      </div>
    </div>

    <!-- ========== ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚° ========== -->
    <div class="card">
      <details>
        <summary style="cursor:pointer;font-weight:700">ğŸ› ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</summary>
        <div id="debug-log" style="background:#f3f4f6;padding:12px;border-radius:8px;margin-top:8px;font-size:.85rem;max-height:300px;overflow:auto;font-family:monospace;white-space:pre-wrap">
        </div>
      </details>
    </div>
  </main>

  <!-- ========== ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ ========== -->
  <div id="loading-overlay" class="hidden">
    <div class="spinner"></div>
    <p style="margin-top:16px;font-size:1.1rem">ã—ã‚‡ã†ã²ã‚“ ã‚’ ã‹ã„ã›ã ã¡ã‚…ã†â€¦</p>
  </div>

  <!-- ========== QRCode.js ========== -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- ========== ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ ========== -->
  <script>
    'use strict';

    /* ========== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========== */
    const $  = (sel) => document.querySelector(sel);
    const $$ = (sel) => document.querySelectorAll(sel);

    function log(label, data){
      const t  = new Date().toLocaleTimeString('ja-JP');
      const msg = `[${t}] ${label}`;
      console.log(msg, data);
      const logEl = $('#debug-log');
      if(logEl){
        logEl.textContent += msg + '\n' + (typeof data==='object' ? JSON.stringify(data,null,2) : data) + '\n\n';
        logEl.scrollTop = logEl.scrollHeight;
      }
    }

    function escapeHtml(str){
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function showLoading(){
      $('#loading-overlay').classList.remove('hidden');
    }
    function hideLoading(){
      $('#loading-overlay').classList.add('hidden');
    }

    /* ========== ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ ========== */
    const fx = {
      ok(){ try{ navigator.vibrate?.(24); }catch{} },
      ng(){ try{ navigator.vibrate?.([40,40]); }catch{} }
    };

    /* ------------------ éŸ³å£°å…¥åŠ›ï¼ˆã“ã©ã‚‚ç”¨ï¼‰æ”¹å–„ç‰ˆ ------------------ */
    let voiceRec = null;
    let isVoiceRecording = false;

    function updateVoiceUI(state, msg){
      const st  = $('#k2-voice-status');
      const btn = $('#k2-voice-start');
      if(st && msg) st.textContent = msg;
      if(btn){
        const busy = state === 'on';
        btn.disabled = busy;
        if(busy){
          btn.classList.add('primary', 'voice-recording');
          btn.textContent = 'ğŸ”´ ã¯ãªã—ã¦ã„ã¾ã™...';
        }else{
          btn.classList.remove('primary', 'voice-recording');
          btn.textContent = 'ğŸ¤ ã“ãˆã§ ã„ã‚Œã‚‹';
        }
      }
    }

    // æ—¥æœ¬èªæ•°é‡è¡¨ç¾ã‚’æ•°å­—ã«å¤‰æ›
    function parseJapaneseQuantity(text){
      // æ¼¢æ•°å­—ãƒãƒƒãƒ—
      const kanjiNum = {
        'ä¸€':1, 'äºŒ':2, 'ä¸‰':3, 'å››':4, 'äº”':5,
        'å…­':6, 'ä¸ƒ':7, 'å…«':8, 'ä¹':9, 'å':10
      };
      
      // ã€Œ2ã¾ã„ã€ã€Œ3ã“ã€ãªã©ã‚’xæ•°å­—ã«å¤‰æ›
      text = text.replace(/(\d+)\s*(ã¾ã„|æš|ã“|å€‹|ã¤|æœ¬|ã»ã‚“)/gi, ' Ã—$1');
      
      // ã€ŒäºŒæšã€ã€Œä¸‰å€‹ã€ãªã©ã‚’xæ•°å­—ã«å¤‰æ›
      text = text.replace(/([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å])\s*(ã¾ã„|æš|ã“|å€‹|ã¤|æœ¬|ã»ã‚“)/gi, (m, num, unit) => {
        return ' Ã—' + (kanjiNum[num] || 1);
      });
      
      // æ—¢ã«ã€ŒÃ—æ•°å­—ã€å½¢å¼ãŒã‚ã‚‹å ´åˆã¯ãã®ã¾ã¾
      if(/Ã—\d+/.test(text)){
        return text.trim();
      }
      
      // æ•°é‡è¡¨ç¾ãŒãªã„å ´åˆã®ã¿ã€ŒÃ—1ã€ã‚’è¿½åŠ 
      return text.trim() + ' Ã—1';
    }

    function setupVoiceInput(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SR){
        updateVoiceUI('off','ã“ã®ã‚¹ãƒãƒ›ã§ã¯ ãŠã‚“ã›ã„ã«ã‚…ã†ã‚Šã‚‡ã ã¯ ã¤ã‹ãˆã¾ã›ã‚“');
        return;
      }
      
      voiceRec = new SR();
      voiceRec.lang = 'ja-JP';
      voiceRec.interimResults = false;
      voiceRec.continuous = false;
      voiceRec.maxAlternatives = 1;

      voiceRec.onstart = () =>{
        isVoiceRecording = true;
        updateVoiceUI('on','ãã„ã¦ã„ã¾ã™â€¦ã€Œã‚«ãƒ¼ãƒ‰ 2ã¾ã„ã€ãªã©ã¨ ã¯ãªã—ã¦ã­');
        fx.ok();
      };
      
      voiceRec.onend = () =>{
        isVoiceRecording = false;
        updateVoiceUI('off','ã‚‚ã†ã„ã¡ã© ã¯ãªã™ã¨ãã¯ã€ãƒœã‚¿ãƒ³ã‚’ ãŠã™');
      };
      
      voiceRec.onerror = (e) =>{
        isVoiceRecording = false;
        console.warn('voice error', e);
        let msg = 'ãƒã‚¤ã‚¯ã®ã‚¨ãƒ©ãƒ¼ ã§ã‚‚ ã¦ã§ ã¤ã¥ã‘ã‚‰ã‚Œã¾ã™';
        
        if(e.error === 'not-allowed'){
          msg = 'ãƒã‚¤ã‚¯ã®ãã‚‡ã‹ ãŒ ã²ã¤ã‚ˆã†ã§ã™';
        }else if(e.error === 'no-speech'){
          msg = 'ã“ãˆãŒ ãã“ãˆã¾ã›ã‚“ã§ã—ãŸ ã‚‚ã†ã„ã¡ã© ãŸã‚ã—ã¦ã­';
        }else if(e.error === 'audio-capture'){
          msg = 'ãƒã‚¤ã‚¯ãŒ ã¿ã¤ã‹ã‚Šã¾ã›ã‚“';
        }
        
        updateVoiceUI('off', msg);
        fx.ng();
      };
      
      voiceRec.onresult = (ev)=>{
        let text = '';
        for(let i=0; i<ev.results.length; i++){
          text += ev.results[i][0].transcript;
        }
        text = text.trim();
        if(!text) return;
        
        const ta = $('#k2-summary-edit');
        if(!ta) return;
        
        // å¥èª­ç‚¹ã‚’ç©ºç™½ã«ç½®æ›ã—ã¦ã€æ•°é‡èªè­˜ã‚’é©ç”¨
        text = text.replace(/[ã€‚ã€]/g, ' ');
        const line = parseJapaneseQuantity(text);
        
        ta.value = (ta.value ? ta.value + '\n' : '') + line;
        fx.ok();
        
        log('éŸ³å£°èªè­˜çµæœ', {original: text, parsed: line});
      };
    }

    // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    function cleanupVoice(){
      if(voiceRec && isVoiceRecording){
        try{
          voiceRec.stop();
        }catch(e){
          console.warn('voice cleanup error', e);
        }
      }
      voiceRec = null;
      isVoiceRecording = false;
    }
    window.addEventListener('beforeunload', cleanupVoice);

    /* ========== ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ« ========== */
    const model = {
      photo: null,        // Base64ç”»åƒ
      summary: '',        // å•†å“æ˜ç´°ãƒ†ã‚­ã‚¹ãƒˆ
      items: [],          // [{name, qty, price}]
      totalAmount: 0
    };

    /* ========== ã‚«ãƒ¡ãƒ©èµ·å‹• ========== */
    let stream = null;
    async function startCamera(){
      try{
        stream = await navigator.mediaDevices.getUserMedia({
          video:{ facingMode:'environment', width:1280, height:720 }
        });
        const video = $('#camera-preview');
        video.srcObject = stream;
        log('ã‚«ãƒ¡ãƒ©èµ·å‹•', 'OK');
      }catch(err){
        log('ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼', err.message);
        alert('ã‚«ãƒ¡ãƒ©ãŒä½¿ãˆã¾ã›ã‚“: '+err.message);
      }
    }

    /* ========== å†™çœŸæ’®å½± ========== */
    $('#k1-capture').addEventListener('click', ()=>{
      const video  = $('#camera-preview');
      const canvas = $('#canvas');
      canvas.width  = video.videoWidth  || 640;
      canvas.height = video.videoHeight || 480;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      model.photo = canvas.toDataURL('image/jpeg', 0.8);

      fx.ok();
      log('æ’®å½±å®Œäº†', `${canvas.width}x${canvas.height}`);

      // ã‚«ãƒ¡ãƒ©åœæ­¢
      if(stream){
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }

      // ã‚¹ãƒ†ãƒƒãƒ—2ã¸
      $('#kid-step1').classList.add('hidden');
      $('#kid-step2').classList.remove('hidden');
      $('#k2-photo').src = model.photo;

      // AIè§£æé–‹å§‹
      analyzePhoto();
    });

    /* ========== AIè§£æï¼ˆ/api/analyze-itemï¼‰ ========== */
    async function analyzePhoto(){
      showLoading();
      try{
        const blob = await (await fetch(model.photo)).blob();
        const fd = new FormData();
        fd.append('image', blob, 'capture.jpg');

        log('AIè§£æãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡', 'image/jpeg');

        const res = await fetch('/api/analyze-item', {
          method:'POST',
          body: fd
        });
        const json = await res.json();
        log('AIè§£æãƒ¬ã‚¹ãƒãƒ³ã‚¹', json);

        if(json.summary){
          model.summary = json.summary.trim();
        }else{
          model.summary = '';
        }

        updateKidPanels();
      }catch(err){
        log('AIè§£æã‚¨ãƒ©ãƒ¼', err.message);
        alert('AIè§£æã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      }finally{
        hideLoading();
      }
    }

    /* ========== ã“ã©ã‚‚ãƒ‘ãƒãƒ«æ›´æ–° ========== */
    function updateKidPanels(){
      // ã‚¹ãƒ†ãƒƒãƒ—2: å•†å“æ¦‚è¦è¡¨ç¤º
      const summaryHtml = model.summary?.trim()
        ? `<pre>${escapeHtml(model.summary)}</pre>`
        : 'ï¼ˆã—ã‚‡ã†ã²ã‚“ ã˜ã‚‡ã†ã»ã† ãªã—ï¼‰';
      $('#k2-summary-view').innerHTML = summaryHtml;
      $('#k2-summary-edit').value = model.summary || '';
    }

    /* ========== æ˜ç´°ç·¨é›†ãƒˆã‚°ãƒ« ========== */
    $('#k2-edit-toggle').addEventListener('click', ()=>{
      const wrap = $('#k2-summary-edit-wrap');
      if(wrap.style.display==='none'){
        wrap.style.display='block';
        $('#k2-edit-toggle').textContent='ğŸ”½ ã¨ã˜ã‚‹';
      }else{
        wrap.style.display='none';
        $('#k2-edit-toggle').textContent='âœï¸ ã¦ã§ ãªãŠã™';
      }
    });

    /* ========== æ˜ç´°æ‰‹å‹•é©ç”¨ ========== */
    $('#k2-summary-apply').addEventListener('click', ()=>{
      model.summary=$('#k2-summary-edit').value.trim();
      updateKidPanels();
      fx.ok();
    });

    /* ========== æ˜ç´°ï¼šéŸ³å£°å…¥åŠ› ========== */
    setupVoiceInput();
    const voiceBtn = $('#k2-voice-start');
    if(voiceBtn){
      voiceBtn.addEventListener('click', ()=>{
        if(!voiceRec){
          alert('ã“ã®ã‚¹ãƒãƒ›ã§ã¯ ãŠã‚“ã›ã„ã«ã‚…ã†ã‚Šã‚‡ã ãŒ ã¤ã‹ãˆã¾ã›ã‚“');
          return;
        }
        if(isVoiceRecording){
          return; // æ—¢ã«éŒ²éŸ³ä¸­
        }
        try{
          voiceRec.start();
        }catch(e){
          console.warn('voice start error', e);
          updateVoiceUI('off', 'ã‚‚ã†ã„ã¡ã© ãŸã‚ã—ã¦ãã ã•ã„');
        }
      });
    }

    /* ========== ã‚¹ãƒ†ãƒƒãƒ—2â†’3ï¼ˆä¾¡æ ¼ãƒ‘ãƒƒãƒ‰ã¸ï¼‰ ========== */
    $('#k2-next').addEventListener('click', ()=>{
      fx.ok();
      
      // æ˜ç´°ã‚’ãƒ‘ãƒ¼ã‚¹
      const lines = (model.summary||'').split('\n').map(l=>l.trim()).filter(l=>l);
      model.items = [];
      
      for(const line of lines){
        const m = line.match(/^(.+?)\s*[Ã—xX]\s*(\d+)/);
        if(m){
          model.items.push({
            name: m[1].trim(),
            qty: parseInt(m[2], 10),
            price: 0
          });
        }else{
          model.items.push({
            name: line,
            qty: 1,
            price: 0
          });
        }
      }

      if(model.items.length===0){
        alert('ã—ã‚‡ã†ã²ã‚“ ãŒ ã‚ã‚Šã¾ã›ã‚“ã€‚ã¦ã§ ã„ã‚Œã¦ãã ã•ã„ã€‚');
        return;
      }

      $('#kid-step2').classList.add('hidden');
      $('#kid-step3').classList.remove('hidden');
      renderPricePad();
    });

    /* ========== ä¾¡æ ¼ãƒ‘ãƒƒãƒ‰æç”» ========== */
    function renderPricePad(){
      const wrap = $('#k3-items-wrap');
      wrap.innerHTML = '';

      model.items.forEach((item, idx)=>{
        const box = document.createElement('div');
        box.style.cssText = 'background:#f9fafb;border-radius:8px;padding:12px;margin-bottom:12px';
        
        box.innerHTML = `
          <div style="font-weight:700;margin-bottom:8px">${escapeHtml(item.name)}</div>
          <div class="pp-qty">
            <label style="font-size:.9rem">ã‹ãš:</label>
            <input type="number" value="${item.qty}" min="1" data-idx="${idx}" class="qty-input"/>
            <label style="font-size:.9rem;margin-left:8px">ãŸã‚“ã‹:</label>
            <div style="flex:1;font-size:1.2rem;font-weight:700;text-align:right" data-idx="${idx}" class="price-display">Â¥0</div>
          </div>
          <div class="pp-preset">
            <button class="btn" data-idx="${idx}" data-val="50">Â¥50</button>
            <button class="btn" data-idx="${idx}" data-val="100">Â¥100</button>
            <button class="btn" data-idx="${idx}" data-val="200">Â¥200</button>
            <button class="btn" data-idx="${idx}" data-val="500">Â¥500</button>
          </div>
          <div class="pp-display price-input" data-idx="${idx}">0</div>
          <div class="pp-grid">
            <button class="btn pp-btn" data-idx="${idx}" data-key="1">1</button>
            <button class="btn pp-btn" data-idx="${idx}" data-key="2">2</button>
            <button class="btn pp-btn" data-idx="${idx}" data-key="3">3</button>
            <button class="btn pp-btn" data-idx="${idx}" data-key="4">4</button>
            <button class="btn pp-btn" data-idx="${idx}" data-key="5">5</button>
            <button class="btn pp-btn" data-idx="${idx}" data-key="6">6</button>
            <button class="btn pp-btn" data-idx="${idx}" data-key="7">7</button>
            <button class="btn pp-btn" data-idx="${idx}" data-key="8">8</button>
            <button class="btn pp-btn" data-idx="${idx}" data-key="9">9</button>
            <button class="btn pp-btn" data-idx="${idx}" data-key="C">C</button>
            <button class="btn pp-btn" data-idx="${idx}" data-key="0">0</button>
            <button class="btn pp-btn" data-idx="${idx}" data-key="OK">âœ“</button>
          </div>
        `;
        wrap.appendChild(box);

        // ã‚¤ãƒ™ãƒ³ãƒˆ
        box.querySelectorAll('.pp-btn').forEach(btn=>{
          btn.addEventListener('click', e=>{
            const i = parseInt(e.target.dataset.idx, 10);
            const k = e.target.dataset.key;
            handlePricePad(i, k);
          });
        });
        box.querySelectorAll('.pp-preset button').forEach(btn=>{
          btn.addEventListener('click', e=>{
            const i = parseInt(e.target.dataset.idx, 10);
            const v = parseInt(e.target.dataset.val, 10);
            model.items[i].price = v;
            updatePriceDisplay(i);
            fx.ok();
          });
        });
        box.querySelector('.qty-input').addEventListener('input', e=>{
          const i = parseInt(e.target.dataset.idx, 10);
          model.items[i].qty = parseInt(e.target.value, 10) || 1;
          updatePriceDisplay(i);
        });
      });

      model.items.forEach((_, i) => updatePriceDisplay(i));
    }

    function handlePricePad(idx, key){
      const disp = $$('.pp-display')[idx];
      let val = disp.textContent.replace(/[^\d]/g,'');

      if(key==='C'){
        val='0';
        fx.ng();
      }else if(key==='OK'){
        model.items[idx].price = parseInt(val,10)||0;
        updatePriceDisplay(idx);
        fx.ok();
        return;
      }else{
        if(val==='0') val='';
        val += key;
        fx.ok();
      }

      disp.textContent = val || '0';
    }

    function updatePriceDisplay(idx){
      const item = model.items[idx];
      const priceDisp = $$('.price-display')[idx];
      if(priceDisp){
        priceDisp.textContent = `Â¥${item.price}`;
      }
    }

    /* ========== ä¾¡æ ¼ãƒ‘ãƒƒãƒ‰å®Œäº†â†’ç¢ºèª ========== */
    $('#k3-done').addEventListener('click', ()=>{
      // æœªå…¥åŠ›ãƒã‚§ãƒƒã‚¯
      const hasZero = model.items.some(it => it.price===0);
      if(hasZero){
        if(!confirm('ã­ã ã‚“ ãŒ 0ãˆã‚“ ã® ã—ã‚‡ã†ã²ã‚“ ãŒ ã‚ã‚Šã¾ã™ã€‚ã“ã®ã¾ã¾ ã™ã™ã¿ã¾ã™ã‹ï¼Ÿ')){
          return;
        }
      }

      fx.ok();
      $('#kid-step3').classList.add('hidden');
      $('#kid-step4').classList.remove('hidden');
      renderKidConfirm();
    });

    /* ========== ã“ã©ã‚‚ç¢ºèªç”»é¢ ========== */
    function renderKidConfirm(){
      let html = '<table style="width:100%;border-collapse:collapse">';
      html += '<tr style="border-bottom:1px solid #ddd"><th>ã—ã‚‡ã†ã²ã‚“</th><th>ã‹ãš</th><th>ãŸã‚“ã‹</th><th>ã”ã†ã‘ã„</th></tr>';
      
      let total=0;
      model.items.forEach(it=>{
        const sub = it.qty * it.price;
        total += sub;
        html += `<tr style="border-bottom:1px solid #eee">
          <td>${escapeHtml(it.name)}</td>
          <td style="text-align:center">${it.qty}</td>
          <td style="text-align:right">Â¥${it.price}</td>
          <td style="text-align:right;font-weight:700">Â¥${sub}</td>
        </tr>`;
      });
      
      html += `<tr style="font-weight:700;font-size:1.1rem">
        <td colspan="3" style="text-align:right;padding-top:8px">ã”ã†ã‘ã„</td>
        <td style="text-align:right;padding-top:8px">Â¥${total}</td>
      </tr>`;
      html += '</table>';

      $('#k4-summary').innerHTML = html;
      model.totalAmount = total;
    }

    /* ========== ã“ã©ã‚‚â†’ãŠã¨ãªãƒ¢ãƒ¼ãƒ€ãƒ« ========== */
    $('#k4-adult').addEventListener('click', ()=>{
      const ck = $('#k4-check-ok');
      if(!ck.checked){
        alert('ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã« âœ“ ã‚’ ã„ã‚Œã¦ã­');
        fx.ng();
        return;
      }

      fx.ok();
      renderAdultModal();
      $('#adult-modal').classList.remove('hidden');
    });

    /* ========== ãŠã¨ãªãƒ¢ãƒ¼ãƒ€ãƒ«æç”» ========== */
    function renderAdultModal(){
      let html = '<table style="width:100%;border-collapse:collapse;font-size:.95rem">';
      html += '<tr style="border-bottom:1px solid #ddd;font-weight:700"><th>å•†å“</th><th>æ•°é‡</th><th>å˜ä¾¡</th><th>å°è¨ˆ</th></tr>';
      
      let total=0;
      model.items.forEach(it=>{
        const sub = it.qty * it.price;
        total += sub;
        html += `<tr style="border-bottom:1px solid #eee">
          <td>${escapeHtml(it.name)}</td>
          <td style="text-align:center">${it.qty}</td>
          <td style="text-align:right">Â¥${it.price}</td>
          <td style="text-align:right;font-weight:700">Â¥${sub}</td>
        </tr>`;
      });
      
      html += `<tr style="font-weight:700;font-size:1.05rem">
        <td colspan="3" style="text-align:right;padding-top:8px">åˆè¨ˆé‡‘é¡</td>
        <td style="text-align:right;padding-top:8px">Â¥${total}</td>
      </tr>`;
      html += '</table>';

      $('#adult-summary').innerHTML = html;
    }

    $('#adult-cancel').addEventListener('click', ()=>{
      $('#adult-modal').classList.add('hidden');
      $('#adult-final-check').checked = false;
    });

    /* ========== ç™»éŒ²å‡¦ç†ï¼ˆ/api/register-saleï¼‰ ========== */
    $('#adult-register').addEventListener('click', async ()=>{
      const ck = $('#adult-final-check');
      if(!ck.checked){
        alert('å†…å®¹ã‚’ç¢ºèªã—ã¦ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„');
        return;
      }

      showLoading();
      try{
        const payload = {
          photo: model.photo,
          items: model.items,
          totalAmount: model.totalAmount
        };

        log('ç™»éŒ²ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡', payload);

        const res = await fetch('/api/register-sale', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const json = await res.json();
        log('ç™»éŒ²ãƒ¬ã‚¹ãƒãƒ³ã‚¹', json);

        if(!json.ok){
          throw new Error(json.error || 'ç™»éŒ²å¤±æ•—');
        }

        // å®Œäº†ç”»é¢ã¸
        $('#adult-modal').classList.add('hidden');
        $('#kid-step4').classList.add('hidden');
        $('#complete-screen').classList.remove('hidden');

        // QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
        const qrUrl = json.purchaseUrl || 'https://example.com/pay/'+json.saleId;
        $('#qr-url-text').textContent = qrUrl;
        new QRCode($('#qr-code'), {
          text: qrUrl,
          width: 200,
          height: 200
        });

        fx.ok();
      }catch(err){
        log('ç™»éŒ²ã‚¨ãƒ©ãƒ¼', err.message);
        alert('ç™»éŒ²ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: '+err.message);
        fx.ng();
      }finally{
        hideLoading();
      }
    });

    /* ========== ãƒªã‚»ãƒƒãƒˆ ========== */
    $('#reset-btn').addEventListener('click', ()=>{
      location.reload();
    });

    /* ========== åˆæœŸåŒ– ========== */
    startCamera();
    log('ã‚¢ãƒ—ãƒªèµ·å‹•', 'v1.0-improved');
  </script>
</body>
</html>

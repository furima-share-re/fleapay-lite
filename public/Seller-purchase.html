<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>出店者 購入登録 & 決済QR</title>
  <style>
    :root{--gap:14px}
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;margin:0;background:#f6f7f9;color:#111}
    .wrap{max-width:720px;margin:5vh auto;padding:24px;background:#fff;border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.08)}
    h1{font-size:20px;margin:0 0 4px}
    h2{font-size:16px;margin:16px 0 8px;color:#333}
    .row{display:grid;gap:var(--gap)}
    label{font-size:12px;color:#666}
    input[type="text"],input[type="number"],input[type="password"],select,textarea{width:100%;padding:12px 14px;border:1px solid #e5e5e5;border-radius:12px;font-size:16px}
    textarea{min-height:80px;resize:vertical}
    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--gap)}
    .grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:var(--gap)}
    .btn{padding:12px 14px;border:0;border-radius:12px;background:#111;color:#fff;font-size:16px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .ghost{background:#fff;color:#111;border:1px solid #e5e5e5}
    .note{font-size:12px;color:#777}
    .error{background:#fff3f3;color:#a40000;border:1px solid #ffd6d6;padding:10px;border-radius:10px}
    .ok{background:#f0fff5;color:#0a7a2f;border:1px solid #b9f0cd;padding:10px;border-radius:10px}
    .qrwrap{display:grid;place-items:center;border:1px dashed #ddd;border-radius:12px;padding:16px}
    .hide{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>出店者 購入登録 & 決済QR</h1>
    <p class="note">フロー：①合計と内容を入力 → ②「登録して決済QRを作成」 → ③お客様にQR提示（Checkoutへ）</p>

    <div class="row">
      <h2>1. 出店者・決済情報</h2>
      <div class="grid2">
        <div>
          <label>出店者ID（sellerPublicId）</label>
          <input id="sellerId" type="text" placeholder="例: seller-abc123" />
        </div>
        <div>
          <label>APIトークン（x-seller-token）</label>
          <input id="token" type="password" placeholder="例: sk_seller_xxx" />
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>合計金額（円）<span class="note">＊必須</span></label>
          <input id="amount" type="number" min="100" max="1000000" step="100" value="1000" />
        </div>
        <div>
          <label>よく使う金額</label>
          <div class="grid3">
            <button class="ghost" data-preset="500" type="button">¥500</button>
            <button class="ghost" data-preset="1000" type="button">¥1,000</button>
            <button class="ghost" data-preset="1500" type="button">¥1,500</button>
          </div>
        </div>
      </div>

      <div>
        <label>商品概要（任意・領収書の説明欄に使用）</label>
        <textarea id="summary" placeholder="例）ポケカ未開封×2、スリーブ×1（合計3点）"></textarea>
      </div>

      <h2>2. 情報登録 → 決済QR 作成</h2>
      <div style="display:flex;gap:10px">
        <button id="register" class="btn">登録して決済QRを作成</button>
        <button id="reset" class="ghost btn" type="button">リセット</button>
      </div>

      <div id="msg" style="margin-top:8px"></div>

      <div id="qrbox" class="qrwrap hide">
        <div id="qrcode"></div>
        <p><a id="checkoutLink" target="_blank" rel="noopener">Stripe決済画面を開く</a></p>
        <p class="note">お客様がQRを読み取ると、Stripeの支払い画面に遷移します。</p>
      </div>

      <h2>参考：直近の候補金額</h2>
      <div class="grid2">
        <div>
          <label>TTL（分）</label>
          <div id="ttlMin" class="note">—</div>
        </div>
        <div>
          <label>上位3候補</label>
          <div id="latest" class="note">—</div>
        </div>
      </div>
    </div>
  </div>

  <!-- 最小QR（SVG生成） -->
  <script>
  (function(g){function r(a){this.mode=1;this.data=a}function x(a,b){this.typeNumber=a;this.errorCorrectLevel=b;this.modules=null;this.moduleCount=0;this.dataList=[]}x.prototype={addData:function(a){this.dataList.push(new r(a))},isDark:function(a,b){if(!this.modules)throw"not built";return this.modules[a][b]},getModuleCount:function(){return this.moduleCount},make:function(){var a=1;for(;a<=4;a++){this.typeNumber=a;this.moduleCount=4*a+17;this.modules=Array(this.moduleCount);for(var b=0;b<this.moduleCount;b++){this.modules[b]=Array(this.moduleCount);for(var c=0;c<this.moduleCount;c++)this.modules[b][c]=null}y(this);if(z(this))break}},createSvgTag:function(a){a=a||2;for(var b=this.getModuleCount(),c='<svg xmlns="http://www.w3.org/2000/svg" width="'+a*b+'" height="'+a*b+'" viewBox="0 0 '+b+' '+b+'">',d=0;d<b;d++)for(var e=0;e<b;e++)this.isDark(d,e)&&(c+='<rect x="'+e+'" y="'+d+'" width="1" height="1" />');return c+="</svg>"}};function y(a){for(var b=0;b<a.moduleCount;b++)for(var c=0;c<a.moduleCount;c++)a.modules[b][c]=(b+c)%3==0}function z(a){for(var b=0;b<a.moduleCount;b++)for(var c=0;c<a.moduleCount;c++)if(a.modules[b][c]===null){var d=(b*c+a.typeNumber)%2===0;a.modules[b][c]=d}return true}g.MinQR=x})(this);
  </script>

  <script type="module">
    const $ = (s)=>document.querySelector(s);
    const params = new URLSearchParams(location.search);

    // 初期値（URLパラメータ s= 出店者ID, token= APIトークン, acct= StripeアカウントID）
    $('#sellerId').value = params.get('s') || '';
    $('#token').value    = params.get('token') || '';
    if (params.get('amount')) $('#amount').value = Number(params.get('amount'));

    // よく使う金額プリセット
    document.querySelectorAll('[data-preset]').forEach(b=>{
      b.addEventListener('click', ()=> { $('#amount').value = b.dataset.preset; });
    });

    // 候補金額の取得（TTL と上位3つ）
    if ($('#sellerId').value) fetchOptions();

    // 登録→Checkout作成（サーバーの複合APIを1回呼ぶ）
    $('#register').addEventListener('click', onRegister);
    $('#reset').addEventListener('click', onReset);

    async function onRegister(){
      clearMsg();
      const sellerId = $('#sellerId').value.trim();
      const token = $('#token').value.trim();
      const amount = Number($('#amount').value);
      const description = ($('#summary').value || '').slice(0,200);
      const sellerAccountId = params.get('acct') || '';

      if (!sellerId) return showErr('出店者IDを入力してください。');
      if (!token) return showErr('APIトークンを入力してください。');
      if (!Number.isInteger(amount) || amount < 100 || amount > 1_000_000)
        return showErr('合計金額は 100〜1,000,000 の整数で入力してください。');

      toggleUI(true);
      try{
        const res = await fetch("/api/register-and-create-qr", {
          method: "POST",
          headers: { "Content-Type": "application/json", "x-seller-token": token },
          body: JSON.stringify({ sellerId, amount, description, sellerAccountId })
        });
        const json = await res.json();
        if (!res.ok || json.error || !json.url) throw new Error(json.error || `HTTP ${res.status}`);

        const url = json.url;
        $("#checkoutLink").href = url;
        $("#checkoutLink").textContent = "Stripe決済画面を開く";
        drawQR(url);
        $("#qrbox").classList.remove("hide");
        showOk("登録しました。QRをお客様に読み取ってもらってください。");
      }catch(e){
        showErr("登録/決済QRの作成に失敗しました：" + (e.message || e));
      }finally{
        toggleUI(false);
      }
    }

    function onReset(){
      ['amount','summary'].forEach(id=>{
        const el = $('#'+id);
        if (el.tagName === 'INPUT') el.value = (el.type==='number'? '1000' : '');
        else el.value = '';
      });
      $('#qrbox').classList.add('hide');
      $('#qrcode').innerHTML='';
      clearMsg();
    }

    async function fetchOptions(){
      try{
        const s = $('#sellerId').value.trim();
        if (!s) return;
        const res = await fetch(`/api/purchase/options?s=${encodeURIComponent(s)}`);
        const json = await res.json();
        const { pending = [], ttl_min } = json;
        $('#ttlMin').textContent = ttl_min ?? '—';
        const list = [...new Set(pending)].slice(0,3);
        $('#latest').textContent = list.length ? list.map(n=>'¥'+Number(n).toLocaleString()).join(' / ') : '（候補なし）';
      }catch{}
    }

    function drawQR(text){
      const q = new MinQR(2, 'L');
      q.addData(text);
      q.make();
      const svg = q.createSvgTag(4);
      const box = document.getElementById('qrcode');
      box.innerHTML = svg;
      const s = box.querySelector('svg');
      s.style.maxWidth = '280px';
      s.style.height = 'auto';
    }

    function toggleUI(disabled){
      ['register','reset'].forEach(id=>{ const el=$('#'+id); if(el) el.disabled = disabled; });
    }
    function clearMsg(){ const m=$('#msg'); m.className=''; m.textContent=''; }
    function showErr(t){ const m=$('#msg'); m.className='error'; m.textContent=t; }
    function showOk(t){ const m=$('#msg'); m.className='ok'; m.textContent=t; }
  </script>
</body>
</html>

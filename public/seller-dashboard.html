<!doctype html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ecoichibaï½œå‡ºåº—è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>

  <!-- Chart.js ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --edo-indigo: #1b365d;
      --edo-red: #e63946;
      --kinari: #fbf7f0;
      --kintsugi: #b8902e;
      --bg: var(--kinari);
      --panel: #fffdf8;
      --border: #e4dccd;
      --text: #2b2b2b;
      --sub: #5f5b55;
      --muted: #7a746b;
      --brand: var(--edo-indigo);
      --accent: var(--edo-red);
      --ok: #1a8c5c;
      --warn: #c88a20;
      --danger: #c5313a;
      --badge: #f4efe6;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Noto Sans JP", system-ui, -apple-system, "Segoe UI", "Hiragino Sans", sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
    }

    .wrap {
      max-width: 720px;
      margin: 0 auto;
      padding: 12px 12px 64px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      padding: 8px 4px 12px;
      border-bottom: 1px solid rgba(184, 144, 46, 0.18);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .brand-logo {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #fff 0, #fff 38%, var(--edo-indigo) 100%);
      border: 1px solid rgba(184, 144, 46, 0.4);
    }

    .brand-title {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 700;
      letter-spacing: .03em;
      color: var(--edo-indigo);
    }

    .brand-sub {
      font-size: .75rem;
      color: var(--kintsugi);
    }

    .user-chip {
      font-size: .8rem;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fffaf1;
      color: var(--sub);
      max-width: 50%;
      text-overflow: ellipsis;
      white-space: nowrap;
      overflow: hidden;
    }

    .mode-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px;
      border-radius: 999px;
      border: 1px solid rgba(27, 54, 93, 0.15);
      background: #fff;
      font-size: .72rem;
      color: var(--muted);
    }

    .mode-pill {
      padding: 3px 8px;
      border-radius: 999px;
      font-weight: 600;
      color: var(--muted);
    }

    .mode-pill.active {
      background: var(--edo-indigo);
      color: #fff;
    }

    .mode-on .mode-off-only {
      display: none !important;
    }

    .mode-off .mode-on-only {
      display: none !important;
    }

    .mode-label {
      display: inline-flex;
      gap: 6px;
      align-items: baseline;
    }

    .mode-label .label-on {
      display: none;
    }

    .mode-on .mode-label .label-on {
      display: inline;
    }

    .mode-on .mode-label .label-off {
      display: none;
    }

    .mode-off .mode-label .label-on {
      display: none;
    }

    .mode-off .mode-label .label-off {
      display: inline;
    }

    .mission-card {
      background: #fff5e9;
      border: 1px solid rgba(184, 144, 46, 0.35);
    }

    .mission-title {
      font-size: 1rem;
      font-weight: 700;
      color: var(--edo-indigo);
    }

    .mission-progress {
      margin-top: 6px;
      font-size: .85rem;
      color: var(--sub);
    }

    .mission-list {
      list-style: none;
      padding: 0;
      margin: 10px 0 0;
      display: grid;
      gap: 8px;
    }

    .mission-item {
      display: flex;
      gap: 8px;
      align-items: flex-start;
      font-size: .85rem;
    }

    .mission-check {
      width: 18px;
      height: 18px;
      border-radius: 5px;
      border: 2px solid var(--border);
      background: #fff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: .8rem;
      color: var(--ok);
    }

    .reward-card {
      background: #fffdf3;
      border: 1px solid rgba(184, 144, 46, 0.35);
    }

    .reward-bar {
      margin-top: 8px;
      height: 10px;
      border-radius: 999px;
      background: #f5efe6;
      overflow: hidden;
    }

    .reward-bar-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #e63946, #b8902e);
      transition: width .3s ease;
    }

    .card {
      background: var(--panel);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 14px 14px 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(27, 54, 93, .06);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: .98rem;
      font-weight: 700;
      color: var(--edo-indigo);
    }

    .card-sub {
      font-size: .8rem;
      color: var(--muted);
    }

    .pill {
      font-size: .75rem;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fffaf1;
      color: var(--sub);
      cursor: pointer;
    }

    /* å…¥åŠ›ã¾ã¡ãƒ•ã‚£ãƒ«ã‚¿ ON æ™‚ã®è¦‹ãŸç›® */
    .pill-toggle-active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    .kpi-row {
      display: flex;
      gap: 8px;
      margin-top: 6px;
    }

    .kpi {
      flex: 1;
      padding: 10px 10px;
      border-radius: 12px;
      background: #fff8e8;
      border: 1px solid rgba(184, 144, 46, 0.2);
    }

    .kpi-label {
      font-size: .75rem;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .kpi-value {
      font-size: 1.2rem;
      font-weight: 750;
    }

    .kpi-note {
      font-size: .75rem;
      color: var(--muted);
      margin-top: 2px;
    }

    .hint {
      font-size: .78rem;
      color: var(--muted);
      margin-top: 4px;
    }

    .list {
      margin: 6px 0 0;
      padding: 0;
      list-style: none;
    }

    .tx-item {
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f5;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: flex-start;
      cursor: pointer;
    }

    /* QR / ã‚«ãƒ¼ãƒ‰æ±ºæ¸ˆã®å–å¼•ã‚’ã‚„ã‚„å¼·èª¿ */
    .tx-item.tx-cashless {
      background: #f0f9ff;
      border-radius: 8px;
      padding: 10px;
    }

    /* ç¾é‡‘å–å¼•ã¯ãƒ•ãƒ©ãƒƒãƒˆãªè¦‹ãŸç›® */
    .tx-item.tx-cash {
      background: #f9fafb;
      border-radius: 8px;
      padding: 8px;
    }

    .tx-badge-cashless {
      margin-left: 4px;
      background: #e0f2fe;
      color: #0369a1;
      border-color: #bae6fd;
    }

    .tx-badge-cash {
      margin-left: 4px;
      background: #f3f4f6;
      color: #4b5563;
      border-color: #d1d5db;
    }

    .tx-item:last-child {
      border-bottom: none;
    }

    .tx-main {
      flex: 1;
    }

    .tx-top {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 2px;
      flex-wrap: wrap;
    }

    .tx-time {
      font-size: .8rem;
      color: var(--muted);
    }

    .tx-title {
      font-size: .9rem;
    }

    .tx-sub {
      font-size: .78rem;
      color: var(--muted);
    }

    .tx-amt {
      font-size: .95rem;
      font-weight: 700;
      text-align: right;
      white-space: nowrap;
    }

    .badge {
      font-size: .7rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: var(--badge);
      color: var(--sub);
      border: 1px solid rgba(27, 54, 93, 0.15);
    }

    .badge-ok {
      background: #e9f4ef;
      color: var(--ok);
      border-color: #b7dfc7;
    }

    .badge-refund {
      background: #f3f4f6;
      color: #4b5563;
      border-color: #d1d5db;
    }

    .badge-cb-pending {
      background: #fff1d6;
      color: #8b5b12;
      border-color: #e2b65d;
    }

    .badge-cb-lost {
      background: #fef2f2;
      color: #b91c1c;
      border-color: #fecaca;
    }

    /* å…¥åŠ›ã¾ã¡ãƒãƒƒã‚¸ */
    .badge-need-input {
      background: #fdeec8;
      color: #8b5b12;
      border-color: #e2b65d;
    }

    /* æ±ºæ¸ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ */
    .badge-payment-completed {
      background: #e9f4ef;
      color: #0d6741;
      border-color: #b7dfc7;
    }

    .badge-payment-pending {
      background: #fff1d6;
      color: #a16100;
      border-color: #e2b65d;
    }

    .tx-sub-warn {
      font-size: .75rem;
      color: var(--warn);
    }

    .tx-detail {
      margin-top: 4px;
      font-size: .78rem;
      color: var(--muted);
      display: none;
    }

    .tx-item.expanded .tx-detail {
      display: block;
    }

    .notice-item {
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: #fff;
      margin-bottom: 8px;
    }

    .notice-title {
      font-size: .9rem;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .notice-meta {
      font-size: .78rem;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .notice-body {
      font-size: .82rem;
      line-height: 1.5;
    }

    .notice-important {
      border-left: 4px solid var(--kintsugi);
      padding-left: 8px;
      background: linear-gradient(to right, rgba(184, 144, 46, 0.08), transparent);
    }

    .field {
      margin-bottom: 10px;
    }

    .field-label {
      font-size: .8rem;
      color: var(--sub);
      margin-bottom: 4px;
    }

    .field-value {
      font-size: .9rem;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #f9fafb;
    }

    /* è²©å£²ç”»é¢ãƒªãƒ³ã‚¯ï¼†QRè¡¨ç¤º */
    .qr-box {
      margin-top: 6px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px dashed rgba(27, 54, 93, 0.2);
      background: #fffaf1;
      text-align: center;
    }

    .qr-img {
      width: 160px;
      max-width: 60%;
      margin: 6px auto 4px;
      display: block;
    }

    .qr-url {
      font-size: .78rem;
      word-break: break-all;
      color: var(--sub);
      text-decoration: none;
    }

    .qr-url-btn {
      margin-top: 6px;
      font-size: .78rem;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      cursor: pointer;
    }

    .nav {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      border-top: 1px solid rgba(27, 54, 93, 0.15);
      background: #fffaf1;
      display: flex;
      justify-content: space-around;
      padding: 6px 0 4px;
      z-index: 100;
    }

    .nav-btn {
      flex: 1;
      text-align: center;
      font-size: .72rem;
      padding: 4px 0;
      color: var(--sub);
      background: none;
      border: none;
      cursor: pointer;
    }

    .nav-btn span {
      display: block;
      margin-top: 2px;
    }

    .nav-btn.active {
      color: var(--edo-indigo);
      font-weight: 700;
    }

    .nav-icon {
      font-size: 1.1rem;
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    button:focus-visible,
    .nav-btn:focus-visible {
      outline: 2px solid var(--brand);
      outline-offset: 2px;
      border-radius: 999px;
    }

    /* ğŸ†• ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨CSS */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 300;
    }

    .modal {
      width: 100%;
      max-width: 420px;
      max-height: 90vh;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(15, 23, 42, 0.35);
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 14px;
      border-bottom: 1px solid #e5e7eb;
    }

    .modal-body {
      padding: 10px 14px 4px;
      overflow-y: auto;
    }

    .modal-footer {
      padding: 10px 14px 12px;
      border-top: 1px solid #e5e7eb;
      text-align: right;
    }

    #modal-close-btn {
      border: none;
      background: transparent;
      font-size: 1rem;
      cursor: pointer;
    }

    .modal-image-wrap {
      text-align: center;
      margin-bottom: 8px;
    }

    #order-image {
      max-width: 100%;
      max-height: 180px;
      border-radius: 12px;
      object-fit: contain;
      background: #f3f4f6;
    }

    .field-select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: .85rem;
    }

    .btn-primary {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      background: var(--edo-red);
      color: #fff;
      font-size: .85rem;
      cursor: pointer;
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .btn-secondary {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--sub);
      font-size: .85rem;
      cursor: pointer;
    }

    .btn-secondary:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .btn-danger {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      background: var(--danger);
      color: #fff;
      font-size: .85rem;
      cursor: pointer;
    }

    /* ğŸ“Š ã‚°ãƒ©ãƒ•ã‚«ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .chart-card {
      background: var(--panel);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 14px 14px 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, .04);
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .chart-title {
      font-size: .98rem;
      font-weight: 700;
      color: var(--text);
    }

    .chart-period-toggle {
      display: flex;
      gap: 4px;
      background: #f7efe2;
      border-radius: 999px;
      padding: 2px;
    }

    .period-btn {
      font-size: .75rem;
      padding: 4px 12px;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: var(--sub);
      cursor: pointer;
      transition: all 0.2s;
    }

    .period-btn.active {
      background: var(--edo-indigo);
      color: #ffffff;
      font-weight: 600;
    }

    .chart-container {
      position: relative;
      height: 280px;
      width: 100%;
    }

    .chart-loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 280px;
      color: var(--muted);
      font-size: .9rem;
    }

    .chart-legend {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
      font-size: .8rem;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 2px;
    }

    .chart-hint {
      font-size: .78rem;
      color: var(--muted);
      margin-top: 8px;
      text-align: center;
    }

    /* ğŸ†• ç›´è¿‘1ãƒ¶æœˆä¼ç”»ã‚«ãƒ¼ãƒ‰ */
    .plans-card {
      background: linear-gradient(135deg, #1b365d 0%, #b8902e 100%);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, .1);
    }

    .plans-title {
      font-size: 1.2rem;
      color: #fff;
      text-align: center;
      margin-bottom: 16px;
      font-weight: 700;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
    }

    .plan-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 12px;
    }

    .plan-item {
      background: white;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(27, 54, 93, 0.08);
      border: 1px solid rgba(184, 144, 46, 0.2);
    }

    .plan-week {
      font-size: 0.8rem;
      color: var(--edo-indigo);
      font-weight: 600;
      margin-bottom: 6px;
    }

    .plan-title {
      font-size: 1.1rem;
      color: var(--edo-indigo);
      margin-bottom: 8px;
      font-weight: 700;
    }

    .plan-description {
      font-size: 0.9rem;
      line-height: 1.6;
      color: var(--text);
      margin-bottom: 12px;
    }

    .plan-metrics {
      display: flex;
      justify-content: space-between;
      padding-top: 12px;
      border-top: 2px dashed var(--border);
    }

    .metric {
      text-align: center;
    }

    .metric-label {
      font-size: 0.75rem;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .metric-value {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--edo-indigo);
    }

    .improvement-badge {
      display: inline-block;
      background: linear-gradient(135deg, #b8902e 0%, #e9d69a 100%);
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      margin-left: 5px;
      font-weight: 600;
    }

    .rank-badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-left: 8px;
    }

    .rank-s {
      background-color: #fff3cd;
      color: #856404;
    }

    .rank-a {
      background-color: #d1ecf1;
      color: #0c5460;
    }

    .rank-b {
      background-color: #d4edda;
      color: #155724;
    }

    .rank-c {
      background-color: #f8d7da;
      color: #721c24;
    }

    .btn-danger:disabled {
      opacity: 0.5;
      cursor: default;
    }

    @media (min-width:768px) {
      .wrap {
        padding: 16px 16px 72px;
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="brand-logo" aria-hidden="true"></div>
        <div>
          <p class="brand-title">ecoichiba</p>
          <p class="brand-sub">å‡ºåº—è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</p>
        </div>
      </div>
      <div class="user-chip" id="shop-name">å‡ºåº—è€…</div>
    </header>
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; padding:4px 4px 12px;">
      <div class="mode-toggle" aria-label="è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰">
        <span class="mode-pill active" data-mode="on">ã‚„ã•ã—ã„</span>
        <span class="mode-pill" data-mode="off">ãµã¤ã†</span>
      </div>
      <div style="font-size:.72rem; color:var(--muted);">è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã¯å‡ºåº—è€…ã«åˆã‚ã›ã¦åˆ‡æ›¿</div>
    </div>

    <!-- ãƒ›ãƒ¼ãƒ  -->
    <section id="sec-home" class="section active">
      <div class="card mission-card mode-on-only">
        <div class="card-header">
          <div class="mission-title">ãã‚‡ã†ã® ãƒŸãƒƒã‚·ãƒ§ãƒ³</div>
          <div class="pill">ã‚„ã£ã¦ã¿ã‚ˆã†</div>
        </div>
        <div class="mission-progress" id="mission-progress">0 / 3 ã§ããŸã‚‰ 100ã¦ã‚“ï¼</div>
        <ul class="mission-list">
          <li class="mission-item">
            <span class="mission-check">âœ“</span>
            <span>ãŠãã‚ƒãã•ã‚“ã«ã€Œã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›ï¼ã€ã¨ ã„ãˆãŸ</span>
          </li>
          <li class="mission-item">
            <span class="mission-check">âœ“</span>
            <span>QR / ã‚«ãƒ¼ãƒ‰ ã§ 1å› ã†ã£ã¦ã¿ãŸ</span>
          </li>
          <li class="mission-item">
            <span class="mission-check">âœ“</span>
            <span>ã‹ã£ã¦ãã‚ŒãŸ ã²ã¨ã® ã˜ã‚‡ã†ã»ã†ã‚’ ã„ã‚Œã¦ã¿ãŸ</span>
          </li>
        </ul>
      </div>

      <div class="card reward-card mode-on-only">
        <div class="card-header">
          <div class="card-title">ã”ã»ã†ã³</div>
          <div class="pill">ãã‚‡ã†ã® ãã‚ã</div>
        </div>
        <div class="kpi-value" id="reward-message">ãã‚‡ã†ã® ã†ã‚Šã‚ã’ãŒ ãŸã¾ã£ã¦ããŸã‚ˆ</div>
        <div class="reward-bar">
          <div class="reward-bar-fill" id="reward-bar-fill"></div>
        </div>
        <div class="hint" id="reward-hint">ã¾ãšã¯ 1ã‘ã‚“ ã†ã£ã¦ã¿ã‚ˆã†</div>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">ãã‚‡ã†ã® ã†ã‚Šã‚ã’</div>
            <div class="card-sub" id="today-label">ãã‚‡ã† ã® ã†ã‚Šã‚ã’</div>
          </div>
          <div class="pill">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°</div>
        </div>

        <div class="kpi-row">
          <div class="kpi">
            <div class="kpi-label mode-label">
              <span class="label-on">ãœã‚“ã¶ã® ã†ã‚Šã‚ã’</span>
              <span class="label-off">å£²ä¸Šåˆè¨ˆ(è¿”é‡‘ãƒ»ãƒãƒ£ãƒ¼ã‚¸ãƒãƒƒã‚¯åæ˜ å¾Œ)</span>
            </div>
            <div class="kpi-value" id="kpi-total">Â¥â€”</div>
            <div class="kpi-note mode-label">
              <span class="label-on">ãœã‚“ã¶ã® ãã‚ã</span>
              <span class="label-off">ç´”å£²ä¸Š</span>
            </div>
          </div>
        </div>

        <!-- ğŸŸ¦ ğŸ†• ä»•å…¥é¡ -->
        <div class="kpi-row">
          <div class="kpi">
            <div class="kpi-label mode-label">
              <span class="label-on">ãã‚‡ã†ã® ã—ã‚…ã†ã«ã‚…ã†ã® ã–ã„ã‚Šã‚‡ã†</span>
              <span class="label-off">ãã‚‡ã†ã® ä»•å…¥é¡</span>
            </div>
            <div class="kpi-value" id="kpi-cost">Â¥â€”</div>
          </div>
        </div>

        <!-- ğŸŸ© ğŸ†• åˆ©ç›Š -->
        <div class="kpi-row">
          <div class="kpi">
            <div class="kpi-label mode-label">
              <span class="label-on">ãã‚‡ã†ã® ã‚‚ã†ã‘</span>
              <span class="label-off">ãã‚‡ã†ã® åˆ©ç›Š</span>
            </div>
            <div class="kpi-value" id="kpi-profit">Â¥â€”</div>
            <div class="kpi-note mode-label">
              <span class="label-on">ã†ã‚Šã‚ã’ ï¼ ã—ã‚…ã†ã«ã‚…ã†</span>
              <span class="label-off">ç´”å£²ä¸Š âˆ’ ä»•å…¥é¡</span>
            </div>
          </div>
        </div>

        <div class="kpi-row">
          <div class="kpi">
            <div class="kpi-label mode-label">
              <span class="label-on">ãã‚‡ã†ã® ã‘ã£ã•ã„ ã™ã†</span>
              <span class="label-off">æ±ºæ¸ˆå›æ•°</span>
            </div>
            <div class="kpi-value" id="kpi-count">â€”ä»¶</div>
          </div>
          <div class="kpi">
            <div class="kpi-label mode-label">
              <span class="label-on">ãŠãã‚ƒãã•ã‚“ ã²ã¨ã‚Š ã‚ãŸã‚Š</span>
              <span class="label-off">å¹³å‡å®¢å˜ä¾¡</span>
            </div>
            <div class="kpi-value" id="kpi-avg">Â¥â€”</div>
          </div>
        </div>

        <div class="hint" id="home-hint">
          å‡ºåº—è€…IDã‹ã‚‰ã€ãã‚‡ã†ã® ã†ã‚Šã‚ã’ ã‚’ ã˜ã£ã•ã„ã® ãƒ‡ãƒ¼ã‚¿ã§ ã²ã‚‡ã†ã˜ã—ã¾ã™ã€‚
        </div>
      </div>

      <!-- ğŸ“Š å£²ä¸Šãƒ»åˆ©ç›Šã‚°ãƒ©ãƒ•ã‚«ãƒ¼ãƒ‰ -->
      <div class="chart-card mode-off-only">
        <div class="chart-header">
          <div class="chart-title">å£²ä¸Šãƒ»åˆ©ç›Šã®æ¨ç§»</div>
          <div class="chart-period-toggle">
            <button class="period-btn active" data-period="daily">æ—¥æ¯</button>
            <button class="period-btn" data-period="weekly">é€±æ¯</button>
          </div>
        </div>

        <div id="chart-loading" class="chart-loading" style="display: none;">
          ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...
        </div>

        <div class="chart-container">
          <canvas id="sales-profit-chart"></canvas>
        </div>

        <div class="chart-legend">
          <div class="legend-item">
            <div class="legend-color" style="background: #1b365d;"></div>
            <span>å£²ä¸Š</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #b8902e;"></div>
            <span>ä»•å…¥é¡</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #1a8c5c;"></div>
            <span>åˆ©ç›Š</span>
          </div>
        </div>

        <div class="chart-hint">
          ç›´è¿‘30æ—¥é–“ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™
        </div>
      </div>

      <!-- ğŸ†• ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯æ¯”è¼ƒã‚°ãƒ©ãƒ•ã‚«ãƒ¼ãƒ‰ -->
      <div class="chart-card mode-off-only">
        <div class="chart-header">
          <div class="chart-title">ğŸ“Š å®Ÿç¸¾ vs ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯</div>
          <div class="chart-period-toggle">
            <button class="period-btn active" data-period-benchmark="monthly">æœˆæ¬¡</button>
            <button class="period-btn" data-period-benchmark="weekly">é€±æ¬¡</button>
          </div>
        </div>

        <div id="chart-benchmark-loading" class="chart-loading" style="display: none;">
          ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...
        </div>

        <div class="chart-container">
          <canvas id="benchmark-chart"></canvas>
        </div>

        <div class="chart-legend">
          <div class="legend-item">
            <div class="legend-color" style="background: #1b365d;"></div>
            <span>å®Ÿç¸¾å£²ä¸Š</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #b8902e;"></div>
            <span>ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ï¼ˆç›®æ¨™ï¼‰</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #e63946;"></div>
            <span>ä¼ç”»å¾Œäºˆæƒ³</span>
          </div>
        </div>

        <div class="chart-hint">
          â€» ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã¯å­£ç¯€å¤‰å‹•ã¨éå»ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç®—å‡ºã—ãŸæ¨™æº–å€¤ã§ã™
        </div>
      </div>

      <!-- ğŸ†• ç›´è¿‘1ãƒ¶æœˆã®é©åˆ‡ãªä¼ç”» -->
      <div class="plans-card mode-off-only">
        <h2 class="plans-title">ğŸ¯ ç›´è¿‘1ãƒ¶æœˆã®é©åˆ‡ãªä¼ç”»</h2>
        <div class="plan-grid" id="upcoming-plans-grid">
          <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
        </div>
      </div>

      <!-- ğŸŸ¦ (A) ãƒ‡ãƒ¼ã‚¿ç²¾åº¦ã‚¹ã‚³ã‚¢ ã‚«ãƒ¼ãƒ‰ -->
      <div class="card mode-off-only">
        <div class="card-header">
          <div>
            <div class="card-title">ãƒ‡ãƒ¼ã‚¿ç²¾åº¦ã‚¹ã‚³ã‚¢</div>
            <div class="card-sub">QRæ±ºæ¸ˆã‚’ä½¿ã†ã»ã©æ­£ç¢ºã«ãªã‚Šã¾ã™</div>
          </div>
        </div>
        <div class="kpi-value" id="data-score">â€”%</div>
        <div class="hint">
          è³¼å…¥è€…ã®å±æ€§æƒ…å ±ãŒå…¥åŠ›ã•ã‚ŒãŸå–å¼•ã®å‰²åˆã§ã™ã€‚QRæ±ºæ¸ˆã‚’ä½¿ã†ã¨è‡ªå‹•ã§è¨˜éŒ²ã•ã‚Œã¾ã™ã€‚
        </div>
      </div>

      <!-- ğŸ†• Tierï¼ˆãƒ©ãƒ³ã‚¯ï¼‰æƒ…å ± ã‚«ãƒ¼ãƒ‰ -->
      <div class="card mode-off-only" id="tier-card" style="display: none;">
        <div class="card-header">
          <div>
            <div class="card-title">ç¾åœ¨ã®ãƒ©ãƒ³ã‚¯</div>
            <div class="card-sub">QRæ±ºæ¸ˆå›æ•°ã«å¿œã˜ã¦æ‰‹æ•°æ–™ãŒå¤‰ã‚ã‚Šã¾ã™</div>
          </div>
        </div>
        <div style="margin: 16px 0;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <div style="font-size: 2rem; font-weight: 700; color: #5a6bff;" id="tier-number">â€”</div>
            <div>
              <div style="font-size: 1.2rem; font-weight: 600; color: var(--text);" id="tier-name">â€”</div>
              <div style="font-size: 0.9rem; color: var(--muted);" id="tier-fee-rate">æ‰‹æ•°æ–™: â€”%</div>
            </div>
          </div>
          <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
            <div style="font-size: 0.85rem; color: var(--muted); margin-bottom: 4px;">ä»Šæœˆã®QRæ±ºæ¸ˆå›æ•°</div>
            <div style="font-size: 1.1rem; font-weight: 600; color: var(--text);" id="tier-transaction-count">â€”å›</div>
            <div style="font-size: 0.75rem; color: var(--muted); margin-top: 4px;" id="tier-range">ç¯„å›²: â€”</div>
          </div>
          <div id="tier-next-info" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; border-radius: 8px; font-size: 0.9rem; line-height: 1.6;">
            <div id="tier-message">â€”</div>
          </div>
        </div>
        <div class="hint" id="tier-hint">
          QRæ±ºæ¸ˆã‚’å¢—ã‚„ã™ã¨ãƒ©ãƒ³ã‚¯ãŒä¸ŠãŒã‚Šã€æ‰‹æ•°æ–™ãŒä¸‹ãŒã‚Šã¾ã™ã€‚
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">ã•ã„ãã‚“ã® ã‘ã£ã•ã„</div>
          <div class="card-sub">3ä»¶ã ã‘ ã²ã‚‡ã†ã˜</div>
        </div>
        <ul class="list" id="recent-list">
          <!-- JSã§å·®ã—è¾¼ã¿ -->
        </ul>
        <div class="hint" id="recent-hint">
          Stripe æ±ºæ¸ˆã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ ã•ã„ã—ã‚“ã® ã‘ã£ã•ã„ ã‚’ ã²ã‚‡ã†ã˜ã—ã¾ã™ã€‚
        </div>
      </div>
    </section>

    <!-- å–å¼•å±¥æ­´ -->
    <section id="sec-tx" class="section">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">å–å¼•å±¥æ­´</div>
            <div class="card-sub">ãã‚‡ã† ï¼‹ éå»90æ—¥åˆ†</div>
          </div>
          <button type="button" class="pill" id="tx-filter-need-input">
            å…¥åŠ›ã¾ã¡ã ã‘
          </button>
        </div>
        <ul class="list" id="tx-list">
          <!-- JSã§å·®ã—è¾¼ã¿ -->
        </ul>
      </div>
    </section>

    <!-- ãŠã—ã‚‰ã›ï¼ˆãƒ€ãƒŸãƒ¼æ–‡è¨€ã®ã¾ã¾ï¼‰ -->
    <section id="sec-notice" class="section">
      <div class="card">
        <div class="card-header">
          <div class="card-title">ãŠã—ã‚‰ã›</div>
          <div class="card-sub">è¿”é‡‘ãƒ»ãƒãƒ£ãƒ¼ã‚¸ãƒãƒƒã‚¯ãªã©</div>
        </div>

        <div class="notice-item notice-important">
          <div class="notice-title">é‡è¦:ãƒãƒ£ãƒ¼ã‚¸ãƒãƒƒã‚¯å¯¾å¿œã¯ Fleapay ãŒ ãŠã“ãªã„ã¾ã™ã€‚</div>
          <div class="notice-meta">å‡ºåº—è€…ã•ã¾ã® æ“ä½œã¯ä¸è¦ã§ã™ã€‚</div>
          <div class="notice-body">
            ã‚«ãƒ¼ãƒ‰ä¼šç¤¾ã‹ã‚‰ã® è¿”é‡‘ãƒ»ãƒãƒ£ãƒ¼ã‚¸ãƒãƒƒã‚¯ã« ã¤ã„ã¦ã¯ã€Fleapayé‹å–¶å´ã§ ã„ã£ã‹ã¤ ã§ å¯¾å¿œã—ã¾ã™ã€‚<br>
            å‡ºåº—è€…ã•ã¾å´ã§ã® ãƒœã‚¿ãƒ³æ“ä½œã‚„ã€ã‚€ãšã‹ã—ã„ ã¦ã¤ã¥ã ã¯ ã‚ã‚Šã¾ã›ã‚“ã€‚
          </div>
        </div>

        <div class="hint">
          è¿”é‡‘ã‚„ãƒãƒ£ãƒ¼ã‚¸ãƒãƒƒã‚¯ãŒç™ºç”Ÿã—ãŸã¨ãã¯ã€ã“ã®ç”»é¢ã‚„ãƒ¡ãƒ¼ãƒ«ãªã©ã§ã€Œçµæœã ã‘ã€ã‚’ãŠçŸ¥ã‚‰ã›ã™ã‚‹è¨­è¨ˆã§ã™ã€‚
        </div>
      </div>
    </section>

    <!-- ãŠåº—æƒ…å ±ï¼ˆå›ºå®šæ–‡è¨€ã®ã¾ã¾ãƒ»ã‚ã¨ã§APIé€£æºã—ã¦ã‚‚OKï¼‰ -->
    <section id="sec-shop" class="section">
      <div class="card">
        <div class="card-header">
          <div class="card-title">ãŠåº—ã® ã˜ã‚‡ã†ã»ã†</div>
          <div class="card-sub">ã‹ã‚“ãŸã‚“ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</div>
        </div>

        <div class="field">
          <div class="field-label">ãŠåº—ã®åå‰</div>
          <div class="field-value" id="shop-display">ï¼ˆã‚ã¨ã§è¨­å®šäºˆå®šï¼‰</div>
        </div>

        <div class="field">
          <div class="field-label">ãƒ¬ã‚·ãƒ¼ãƒˆã® ã²ã‚‡ã†ã˜ ã’ã‚“ã”</div>
          <div class="field-value">è‡ªå‹•ï¼ˆãŠã™ã™ã‚ï¼‰</div>
        </div>

        <div class="field">
          <div class="field-label">è²©å£²ç”»é¢ï¼ˆåº—å“¡ã•ã‚“ç”¨ï¼‰</div>
          <div class="field-value">
            <div class="qr-box">
              <img id="purchase-qr" class="qr-img" alt="è²©å£²ç”»é¢QRã‚³ãƒ¼ãƒ‰" />
              <a id="purchase-url" class="qr-url" href="#" target="_blank" rel="noopener">
                è²©å£²ç”»é¢URL ã‚’ã‚ˆã¿ã“ã¿ä¸­â€¦
              </a>
              <button type="button" class="qr-url-btn" id="copy-purchase-url">
                URLã‚’ã‚³ãƒ”ãƒ¼
              </button>
            </div>
            <div class="hint">
              ã“ã®QRã¯ã€Œè²©å£²ç”»é¢ï¼ˆseller-purchase-standard.htmlï¼‰ã€ã¸ã®ãƒªãƒ³ã‚¯ã§ã™ã€‚<br>
              åº—å“¡ã•ã‚“å°‚ç”¨ã¨ã—ã¦ã€ãƒ¬ã‚¸ç”¨ã‚¹ãƒãƒ›ãªã©ã§èª­ã¿å–ã£ã¦ãã ã•ã„ã€‚
            </div>
          </div>
        </div>

        <div class="hint">
          ãã‚ã—ã„è¨­å®šã‚„ è¿”é‡‘ãƒ»ãƒãƒ£ãƒ¼ã‚¸ãƒãƒƒã‚¯ã®å‡¦ç†ã¯ã€ã™ã¹ã¦Fleapayé‹å–¶ãŒ è¡Œã„ã¾ã™ã€‚
        </div>
      </div>
    </section>
  </div>

  <!-- ãƒœãƒˆãƒ ãƒŠãƒ“ -->
  <nav class="nav" aria-label="ç”»é¢ãã‚Šã‹ãˆ">
    <button class="nav-btn active" data-target="sec-home">
      <div class="nav-icon">ğŸ </div>
      <span>ãƒ›ãƒ¼ãƒ </span>
    </button>
    <button class="nav-btn" data-target="sec-tx">
      <div class="nav-icon">ğŸ“œ</div>
      <span>å–å¼•</span>
    </button>
    <button class="nav-btn" data-target="sec-notice">
      <div class="nav-icon">ğŸ””</div>
      <span>ãŠã—ã‚‰ã›</span>
    </button>
    <button class="nav-btn" data-target="sec-shop">
      <div class="nav-icon">ğŸª</div>
      <span>ãŠåº—</span>
    </button>
  </nav>

  <!-- ğŸ†• å–å¼•ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="order-detail-modal" class="modal-backdrop" style="display:none;">
    <div class="modal">
      <div class="modal-header">
        <span id="modal-title">å–å¼•ã®ç·¨é›†</span>
        <button type="button" id="modal-close-btn">âœ•</button>
      </div>

      <div class="modal-body">
        <div class="modal-image-wrap" id="order-image-wrapper">
          <img id="order-image" alt="å•†å“å†™çœŸ" />
        </div>

        <div class="field">
          <div class="field-label">å•†å“ãƒ¡ãƒ¢</div>
          <!-- ç·¨é›†å¯èƒ½ã«ã™ã‚‹ãŸã‚ textarea ã«å¤‰æ›´ -->
          <textarea id="modal-summary" class="field-select" rows="2" style="resize:vertical;"></textarea>
        </div>

        <div class="field">
          <div class="field-label">é‡‘é¡</div>
          <div class="field-value" id="modal-amount"></div>
        </div>

        <div class="field">
          <div class="field-label">ä»•å…¥é¡</div>
          <input id="modal-cost" class="field-select" type="number" min="0" step="1" inputmode="numeric"
            placeholder="ä¾‹: 200" />
        </div>

        <hr />

        <div class="field">
          <div class="field-label">è³¼å…¥è€…ã‚¿ã‚¤ãƒ—</div>
          <select id="modal-customer-type" class="field-select">
            <option value="">ï¼ˆæœªé¸æŠï¼‰</option>
            <option value="domestic">æ—¥æœ¬ã®ã²ã¨</option>
            <option value="inbound">å¤–å›½ã®ã²ã¨</option>
          </select>
        </div>

        <div class="field">
          <div class="field-label">æ€§åˆ¥</div>
          <select id="modal-gender" class="field-select">
            <option value="">ï¼ˆæœªé¸æŠï¼‰</option>
            <option value="male">ç”·æ€§</option>
            <option value="female">å¥³æ€§</option>
            <option value="unknown">ã‚ã‹ã‚‰ãªã„</option>
          </select>
        </div>

        <div class="field">
          <div class="field-label">å¹´é½¢å¸¯</div>
          <select id="modal-age" class="field-select">
            <option value="">ï¼ˆæœªé¸æŠï¼‰</option>
            <option value="child">ã“ã©ã‚‚</option>
            <option value="age_16_29">16ã€œ29</option>
            <option value="age_30_59">30ã€œ59</option>
            <option value="age_60_plus">60+</option>
          </select>
        </div>

        <div class="field">
          <div class="field-label">å•†å“ã‚«ãƒ†ã‚´ãƒª</div>
          <select id="modal-category" class="field-select">
            <option value="">ï¼ˆæœªé¸æŠï¼‰</option>
            <option value="toy">ãŠã‚‚ã¡ã‚ƒ</option>
            <option value="card">ã‚«ãƒ¼ãƒ‰ãƒ»ãƒˆãƒ¬ã‚«</option>
            <option value="clothes">ãµã</option>
            <option value="book">æœ¬</option>
            <option value="handmade">ãƒãƒ³ãƒ‰ãƒ¡ã‚¤ãƒ‰</option>
            <option value="other">ãã®ãŸ</option>
          </select>
        </div>

        <div class="field">
          <div class="field-label">è³¼å…¥è€…ã®ã“ã¨ã°</div>
          <select id="modal-language" class="field-select">
            <option value="">ï¼ˆæœªé¸æŠï¼‰</option>
            <option value="ja">æ—¥æœ¬èª</option>
            <option value="en">è‹±èª</option>
            <option value="zh">ä¸­å›½èª</option>
            <option value="ko">éŸ“å›½èª</option>
            <option value="other">ãã®ä»–</option>
          </select>
        </div>

      </div>

      <div class="modal-footer">
        <!-- ğŸ†• å‰Šé™¤ãƒœã‚¿ãƒ³ -->
        <button type="button" id="modal-delete-btn" class="btn-danger" style="margin-right:auto;">
          å‰Šé™¤ã™ã‚‹
        </button>

        <!-- ğŸ†• ä¸–ç•Œç›¸å ´å–å¾—ãƒœã‚¿ãƒ³ -->
        <button type="button" id="modal-world-btn" class="btn-secondary" style="margin-right:8px;">
          ä¸–ç•Œç›¸å ´(å‚è€ƒ)ã‚’å–å¾—
        </button>

        <button type="button" id="modal-save-btn" class="btn-primary">
          ä¿å­˜ã™ã‚‹
        </button>
      </div>
    </div>
  </div>

  <script>
    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    const navButtons = document.querySelectorAll('.nav-btn');
    const sections = document.querySelectorAll('.section');

    navButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const targetId = btn.getAttribute('data-target');
        sections.forEach(sec => {
          sec.classList.toggle('active', sec.id === targetId);
        });
        navButtons.forEach(b => b.classList.toggle('active', b === btn));
        window.scrollTo({ top: 0, behavior: 'instant' });
      });
    });

    // ====== ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”¨APIé€£æº (/api/seller/summary?s=publicId) ======
    (function () {
      const $ = s => document.querySelector(s);
      const params = new URLSearchParams(location.search);
      const sellerId = params.get("s") || "";
      const modeToggle = document.querySelector(".mode-toggle");
      const modePills = document.querySelectorAll(".mode-pill[data-mode]");
      const bodyEl = document.body;

      const shopNameEl = $("#shop-name");
      const shopDisplayEl = $("#shop-display");
      const todayLabelEl = $("#today-label");
      const kpiTotalEl = $("#kpi-total");
      const kpiCountEl = $("#kpi-count");
      const kpiAvgEl = $("#kpi-avg");
      const homeHintEl = $("#home-hint");
      const recentListEl = $("#recent-list");
      const recentHintEl = $("#recent-hint");
      const txListEl = $("#tx-list");
      const purchaseUrlEl = $("#purchase-url");
      const purchaseQrEl = $("#purchase-qr");
      const copyBtnEl = $("#copy-purchase-url");
      const missionProgressEl = $("#mission-progress");
      const rewardMessageEl = $("#reward-message");
      const rewardHintEl = $("#reward-hint");
      const rewardBarFillEl = $("#reward-bar-fill");

      function setMode(nextMode) {
        if (!bodyEl) return;
        const isOn = nextMode === "on";
        bodyEl.classList.toggle("mode-on", isOn);
        bodyEl.classList.toggle("mode-off", !isOn);
        modePills.forEach(pill => {
          pill.classList.toggle("active", pill.getAttribute("data-mode") === nextMode);
        });
      }

      if (modeToggle) {
        modeToggle.addEventListener("click", (event) => {
          const target = event.target;
          if (!(target instanceof HTMLElement)) return;
          const mode = target.getAttribute("data-mode");
          if (mode === "on" || mode === "off") {
            setMode(mode);
          }
        });
      }

      setMode("on");

      // ğŸŸ¦ (A) ãƒ‡ãƒ¼ã‚¿ç²¾åº¦ã‚¹ã‚³ã‚¢ç”¨ã®è¦ç´ 
      const dataScoreEl = $("#data-score");

      // å–å¼•ãƒªã‚¹ãƒˆã®ãƒ•ã‚£ãƒ«ã‚¿çŠ¶æ…‹
      const txFilterBtn = document.getElementById("tx-filter-need-input");
      let txFilterNeedInputOnly = false;
      let latestTxList = [];

      // ã‚µãƒ–ã‚¹ã‚¯æœªåŠ å…¥æ™‚ã«ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹å…±é€šé–¢æ•°
      function blockForNonSubscriber() {
        if (homeHintEl) {
          homeHintEl.textContent = "ã“ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¯ã€ãƒ—ãƒ­ / ã‚­ãƒƒã‚ºãƒ—ãƒ©ãƒ³ã”å¥‘ç´„ä¸­ã®å‡ºåº—è€…ã•ã¾å°‚ç”¨ã§ã™ã€‚";
        }
        if (kpiTotalEl) kpiTotalEl.textContent = "â€“";
        if (kpiCountEl) kpiCountEl.textContent = "â€“";
        if (kpiAvgEl) kpiAvgEl.textContent = "â€“";
        if (recentListEl) {
          recentListEl.innerHTML = "";
        }
        if (recentHintEl) {
          recentHintEl.textContent = "ã‚µãƒ–ã‚¹ã‚¯ã«ã”åŠ å…¥ã„ãŸã ãã¨ã€å£²ä¸Šã®ãã‚ã—ã„åˆ†æãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚";
        }
        if (purchaseUrlEl) {
          purchaseUrlEl.textContent = "ã‚µãƒ–ã‚¹ã‚¯ã”å¥‘ç´„ã§è²©å£²ç”¨URLãŒè¡¨ç¤ºã•ã‚Œã¾ã™";
          purchaseUrlEl.removeAttribute("href");
        }
      }

      function formatYen(n) {
        if (!Number.isFinite(n)) return "Â¥â€”";
        return "Â¥" + n.toLocaleString("ja-JP");
      }

      function formatTime(date) {
        return date.toLocaleTimeString("ja-JP", { hour: "2-digit", minute: "2-digit" });
      }

      function formatDateJp(date) {
        const w = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"][date.getDay()];
        return `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥ï¼ˆ${w}ï¼‰`;
      }

      // è³¼å…¥è€…å±æ€§ãƒ©ãƒ™ãƒ«ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
      function formatBuyerLabel(tx) {
        // ç¾é‡‘ï¼‹ã‚«ãƒ†ã‚´ãƒªæœªè¨­å®šã®å ´åˆã®ç‰¹åˆ¥è¡¨ç¤º
        if ((tx.isCash || tx.is_cash) && !(tx.rawCategory || tx.raw_category)) {
          return "ï¼ˆç¾é‡‘ï¼šè¿½åŠ æƒ…å ±æœªå…¥åŠ›ï¼‰";
        }

        const customerType = tx.customerType ?? tx.customer_type ?? tx.buyer?.customer_type ?? null;
        const gender = tx.gender ?? tx.buyer?.gender ?? null;
        const ageBand = tx.ageBand ?? tx.age_band ?? tx.buyer?.age_band ?? null;

        // nullã€undefinedã€ç©ºæ–‡å­—åˆ—ã®å ´åˆã¯æœªå…¥åŠ›
        if ((!customerType || customerType === "") && (!gender || gender === "") && (!ageBand || ageBand === "")) {
          return "è³¼å…¥è€…æƒ…å ±ï¼šæœªå…¥åŠ›";
        }

        const typeLabel =
          customerType === "inbound" ? "å¤–å›½ã®ã²ã¨" :
            customerType === "domestic" ? "æ—¥æœ¬ã®ã²ã¨" : "";

        const genderLabel =
          gender === "male" ? "ç”·æ€§" :
            gender === "female" ? "å¥³æ€§" :
              gender === "unknown" ? "æ€§åˆ¥ ä¸æ˜" : "";

        const ageLabel =
          ageBand === "child" ? "ã“ã©ã‚‚" :
            ageBand === "age_16_29" ? "16ã€œ29" :
              ageBand === "age_30_59" ? "30ã€œ59" :
                ageBand === "age_60_plus" ? "60+" : "";

        // å…¨ã¦ã®æƒ…å ±ãŒæƒã£ã¦ã„ã‚‹å ´åˆã®ã¿è¡¨ç¤º
        if (typeLabel && genderLabel && ageLabel) {
          return `${typeLabel} / ${genderLabel} / ${ageLabel}`;
        }
        // ä¸€éƒ¨ã ã‘å…¥åŠ›ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€Œè³¼å…¥è€…æƒ…å ±ï¼šæœªå…¥åŠ›ã€ã‚’è¿”ã™
        return "è³¼å…¥è€…æƒ…å ±ï¼šæœªå…¥åŠ›";
      }

      // ã€Œå…¥åŠ›ã¾ã¡ã€ã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹é–¢æ•°
      function isNeedInputTx(tx) {
        const customerType =
          tx.customerType ?? tx.customer_type ?? tx.buyer?.customer_type ?? null;
        const gender =
          tx.gender ?? tx.buyer?.gender ?? null;
        const ageBand =
          tx.ageBand ?? tx.age_band ?? tx.buyer?.age_band ?? null;
        // nullã€undefinedã€ç©ºæ–‡å­—åˆ—ã®ã¿ã‚’æœªå…¥åŠ›ã¨ã—ã¦æ‰±ã†ï¼ˆ"unknown"ã¯æœ‰åŠ¹ãªå…¥åŠ›å€¤ï¼‰
        const hasBuyerAll = !!(
          customerType != null && customerType !== "" &&
          gender != null && gender !== "" &&
          ageBand != null && ageBand !== ""
        );

        const hasCategory = !!(tx.rawCategory || tx.raw_category);
        const costVal =
          typeof tx.costAmount === "number" ? tx.costAmount : null;
        const hasCost = costVal !== null && costVal > 0;

        return !hasCost || !hasCategory || !hasBuyerAll;
      }

      // ğŸŒ ä¸–ç•Œç›¸å ´AIã®ç°¡æ˜“ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆLiteï¼‰ï¼šæ¨å¥¨ä¾¡æ ¼å¸¯ã¨ä¿¡é ¼åº¦ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆ
      function buildWorldPriceAdviceText(tx) {
        const worldLow = typeof tx.worldLow === "number" ? tx.worldLow : null;
        const median = tx.worldMedian || null;

        // â‘  ã€Œä»®ã®è½æœ­ç›¸å ´ï¼ˆSoldç›¸å½“ï¼‰ã€ã‚’ä¸–ç•Œæœ€å®‰å€¤ã‹ã‚‰é€†ç®—
        let soldLike = null;
        if (worldLow && worldLow > 0) {
          // ä¸–ç•Œæœ€å®‰å€¤ï¼ˆActiveï¼‰ã¯ Sold ã‚ˆã‚Š 20ã€œ30% é«˜ããªã‚Šã‚„ã™ã„ã®ã§ã€
          // ãŠãŠã‚ˆã 0.8 å€ã—ã¦ã€Œè½æœ­ç›¸å ´ã£ã½ã„å€¤ã€ã«ã™ã‚‹
          soldLike = Math.round(worldLow * 0.8);
        } else if (median && median > 0) {
          // æœ€å®‰å€¤ãŒç„¡ã„ã¨ãã ã‘ã€ä¸­å¤®å€¤ã‹ã‚‰é€†ç®—ï¼ˆä¿é™ºï¼‰
          soldLike = Math.round(median * 0.8);
        }

        if (!soldLike || soldLike <= 0) return "";

        const sample = tx.worldSampleCount || 0;
        const amount = tx.net_amount ?? tx.amount ?? null;
        const rawCategory = (tx.rawCategory || tx.raw_category || "").toLowerCase();

        let levelLabel = "ãµã¤ã†";  // ä¿¡é ¼åº¦ãƒ©ãƒ™ãƒ«ï¼ˆé«˜ã„ / ãµã¤ã† / ã²ãã‚â€¦ï¼‰

        const isCard = ["card", "ã‚«ãƒ¼ãƒ‰", "ãƒã‚±ã‚«", "ãƒˆãƒ¬ã‚«", "pokemon", "ãƒã‚±ãƒ¢ãƒ³"]
          .some((kw) => rawCategory.includes(kw));
        const isFigureOrToy = ["figure", "ãƒ•ã‚£ã‚®ãƒ¥ã‚¢", "ã¬ã„ãã‚‹ã¿", "toy", "ãŠã‚‚ã¡ã‚ƒ", "ãƒ©ãƒ–ãƒ–", "ã“ã‘ã—"]
          .some((kw) => rawCategory.includes(kw));
        const isFashion = ["æœ", "å¸½å­", "bag", "ãƒãƒƒã‚°", "å¤ç€", "shoes", "ã‚¹ãƒ‹ãƒ¼ã‚«ãƒ¼"]
          .some((kw) => rawCategory.includes(kw));
        const isVintage = ["éª¨ã¨ã†", "éª¨è‘£", "ãƒ“ãƒ³ãƒ†ãƒ¼ã‚¸", "ã‚¢ãƒ³ãƒ†ã‚£ãƒ¼ã‚¯"]
          .some((kw) => rawCategory.includes(kw));

        // â‘¡ ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«ã€Œä¿¡é ¼åº¦ã€ã ã‘èª¿æ•´ï¼ˆå€ç‡ã¯å…±é€šï¼‰
        if (isCard) {
          if (sample >= 15) {
            levelLabel = "é«˜ã„";
          } else if (sample >= 8) {
            levelLabel = "ãµã¤ã†";
          } else {
            levelLabel = "ã²ãã‚";
          }
        } else if (isFigureOrToy || isFashion) {
          if (sample >= 10) {
            levelLabel = "ãµã¤ã†";
          } else {
            levelLabel = "ã²ãã‚";
          }
        } else if (isVintage) {
          levelLabel = "ã‹ãªã‚Šã²ãã‚";
        } else {
          levelLabel = "ã²ãã‚";
        }

        // â‘¢ ã€Œæœˆã®å£²ä¸Šæœ€å¤§åŒ–ä¾¡æ ¼ã€ã€Œæœˆã®åˆ©ç›Šæœ€å¤§åŒ–ä¾¡æ ¼ã€ã‚’è¨ˆç®—
        const priceGMV = Math.round(soldLike * 1.15);   // å£²ä¸Šæœ€å¤§åŒ–ï¼ˆGMVæœ€å¤§ï¼‰
        const priceProfit = Math.round(soldLike * 1.35); // åˆ©ç›Šæœ€å¤§åŒ–

        // â‘£ ä»Šã®ä¾¡æ ¼ãŒ 2ã¤ã®ä¸­é–“å€¤ã¨æ¯”ã¹ã¦ã©ã†ã‹
        let pos = "";
        const base = Math.round((priceGMV + priceProfit) / 2);
        if (amount && base) {
          const diffRatio = (amount - base) / base;
          if (diffRatio <= -0.3) {
            pos = "ï¼ˆä»Šã®ä¾¡æ ¼ï¼šãŠã™ã™ã‚ã‚ˆã‚Š ã‹ãªã‚Šå®‰ã‚ï¼‰";
          } else if (diffRatio <= -0.15) {
            pos = "ï¼ˆä»Šã®ä¾¡æ ¼ï¼šãŠã™ã™ã‚ã‚ˆã‚Š ã‚„ã‚„å®‰ã‚ï¼‰";
          } else if (diffRatio < 0.15) {
            pos = "ï¼ˆä»Šã®ä¾¡æ ¼ï¼šãŠã™ã™ã‚ã¨ ã ã„ãŸã„åŒã˜ï¼‰";
          } else if (diffRatio < 0.4) {
            pos = "ï¼ˆä»Šã®ä¾¡æ ¼ï¼šãŠã™ã™ã‚ã‚ˆã‚Š ã‚„ã‚„é«˜ã‚ï¼‰";
          } else {
            pos = "ï¼ˆä»Šã®ä¾¡æ ¼ï¼šãŠã™ã™ã‚ã‚ˆã‚Š ã‹ãªã‚Šé«˜ã‚ï¼‰";
          }
        }

        return `å£²ä¸Šæœ€å¤§åŒ–ä¾¡æ ¼  ${formatYen(priceGMV)} / åˆ©ç›Šæœ€å¤§åŒ–ä¾¡æ ¼  ${formatYen(priceProfit)} / ä¿¡é ¼åº¦: ${levelLabel}${pos}`;
      }

      // â˜… ä¿®æ­£1: ä¸€è¦§ç”Ÿæˆæ™‚ã«å¿…ãšorderIdã‚’dataå±æ€§ã«ä¿å­˜
      function createTransactionItem(tx) {
        const li = document.createElement("li");
        li.className = "tx-item";

        // â˜… å¿…é ˆ: orderIdã‚’dataå±æ€§ã«ä¿å­˜
        li.dataset.orderId = tx.orderId || "";

        // æ”¯æ‰•ã„æ–¹æ³•ã®åˆ¤å®šï¼ˆisCash/is_cashã‚’æœ€å„ªå…ˆã§ä½¿ç”¨ï¼‰
        // âš ï¸ paymentMethodã¯DBã«ä¿å­˜ã•ã‚Œã¦ã„ãªã„è¨ˆç®—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãŸã‚ã€isCashã‚’å„ªå…ˆ
        // isCashãŒtrueã®å ´åˆã®ã¿ç¾é‡‘ã¨ã—ã¦æ‰±ã†ï¼ˆnull/undefined/falseã¯å…¨ã¦éç¾é‡‘ï¼‰
        const isCash = tx.isCash === true || tx.is_cash === true;
        // paymentMethodã¯äº’æ›æ€§ã®ãŸã‚æ®‹ã™ãŒã€åˆ¤å®šã«ã¯ä½¿ç”¨ã—ãªã„
        const paymentMethod = tx.paymentMethod || tx.payment_method || '';
        // isCashãŒtrueã®å ´åˆã®ã¿ç¾é‡‘ã¨ã—ã¦æ‰±ã†
        const isActuallyCash = isCash;
        li.classList.add(isActuallyCash ? "tx-cash" : "tx-cashless");

        // created(ç§’) or createdAt(ISOæ–‡å­—åˆ—) ã®ã©ã¡ã‚‰ã§ã‚‚OKã«ã™ã‚‹
        let created = null;
        if (typeof tx.created === "number") {
          created = new Date(tx.created * 1000);
        } else if (tx.createdAt) {
          created = new Date(tx.createdAt);
        }

        const timeStr = created ? formatTime(created) : "";
        const dateStr = created
          ? `${created.getFullYear()}-${String(created.getMonth() + 1).padStart(2, "0")}-${String(created.getDate()).padStart(2, "0")}`
          : "";

        // summary / memo ã©ã¡ã‚‰ã§ã‚‚
        const summary = (tx.summary || tx.memo || "å•†å“ã®ãŠã‹ã„ã‚‚ã®").split("\n")[0];

        // ğŸŸ¦ (B) æœªåˆ†é¡ãƒ•ã‚©ãƒ«ãƒ€è¡¨ç¤º
        const isUncategorized =
          isActuallyCash &&
          !(tx.rawCategory || tx.raw_category);
        const uncategorizedBadge = isUncategorized
          ? '<span class="badge badge-cb-pending">æœªåˆ†é¡</span>'
          : '';

        // æ”¯æ‰•ã„æ–¹æ³•ãƒãƒƒã‚¸ï¼ˆQR / ç¾é‡‘ï¼‰
        // isActuallyCashã¯ä¸Šã§æ—¢ã«åˆ¤å®šæ¸ˆã¿
        const paymentBadge = isActuallyCash
          ? '<span class="badge tx-badge-cash">ç¾é‡‘</span>'
          : '<span class="badge tx-badge-cashless">QR / ã‚«ãƒ¼ãƒ‰</span>';

        // è³¼å…¥è€…å±æ€§ã®ãƒ©ãƒ™ãƒ«ã‚’ç”Ÿæˆ
        const buyerLabel = formatBuyerLabel(tx);

        // ğŸ”¶ å…¥åŠ›ã¾ã¡åˆ¤å®š
        // "unknown"ã¯æœ‰åŠ¹ãªå…¥åŠ›å€¤ã¨ã—ã¦æ‰±ã†ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã§ã€Œã‚ã‹ã‚‰ãªã„ã€ãŒé¸æŠå¯èƒ½ãªãŸã‚ï¼‰
        // nullã€undefinedã€ç©ºæ–‡å­—åˆ—ã®ã¿ã‚’æœªå…¥åŠ›ã¨ã—ã¦æ‰±ã†
        const customerType =
          tx.customerType ?? tx.customer_type ?? tx.buyer?.customer_type ?? null;
        const gender =
          tx.gender ?? tx.buyer?.gender ?? null;
        const ageBand =
          tx.ageBand ?? tx.age_band ?? tx.buyer?.age_band ?? null;
        // nullã€undefinedã€ç©ºæ–‡å­—åˆ—ã®ã¿ã‚’æœªå…¥åŠ›ã¨ã—ã¦æ‰±ã†ï¼ˆ"unknown"ã¯æœ‰åŠ¹ãªå…¥åŠ›å€¤ï¼‰
        const hasBuyerAll = !!(
          customerType != null && customerType !== "" &&
          gender != null && gender !== "" &&
          ageBand != null && ageBand !== ""
        );

        const hasCategory = !!(tx.rawCategory || tx.raw_category);
        const costVal =
          typeof tx.costAmount === "number" ? tx.costAmount : null;
        // costAmount > 0 ã‚’ã€Œå…¥åŠ›æ¸ˆã¿ã€ã¨ã¿ãªã™ï¼ˆ0/ç©º/null ã¯æœªå…¥åŠ›æ‰±ã„ï¼‰
        const hasCost = costVal !== null && costVal > 0;

        const missing = [];
        if (!hasCost) missing.push("ä»•å…¥é¡");
        if (!hasCategory) missing.push("ã‚«ãƒ†ã‚´ãƒª");
        if (!hasBuyerAll) missing.push("è³¼å…¥è€…æƒ…å ±");

        const needInput = missing.length > 0;

        const needInputBadge = needInput
          ? '<span class="badge badge-need-input">å…¥åŠ›ã¾ã¡</span>'
          : '';

        const needInputSub = needInput
          ? `<div class="tx-sub tx-sub-warn">å…¥åŠ›ã¾ã¡ï¼š${missing.join("ãƒ»")}ï¼ˆã‚¿ãƒƒãƒ—ã—ã¦å…¥åŠ›ï¼‰</div>`
          : "";

        // æ±ºæ¸ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®åˆ¤å®šã¨ãƒãƒƒã‚¸ç”Ÿæˆ
        const isPaid = tx.isPaid === true || 
                      tx.orderStatus === 'paid' || 
                      tx.paymentStatus === 'succeeded';
        const paymentStatusBadge = !isActuallyCash ? (
          isPaid 
            ? '<span class="badge badge-payment-completed">æ±ºæ¸ˆå®Œäº†</span>'
            : '<span class="badge badge-payment-pending">æ±ºæ¸ˆæœªå®Œäº†</span>'
        ) : '';

        // statusãƒãƒƒã‚¸ã¯isCashã‚’ç›´æ¥ç¢ºèªï¼ˆAPIã®statusãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ä¾å­˜ã—ãªã„ï¼‰
        const statusBadge = isActuallyCash ? "ç¾é‡‘" : (tx.status || "é€šå¸¸");
        
        li.innerHTML = `
          <div class="tx-main">
            <div class="tx-top">
              <span class="badge badge-ok">${statusBadge}</span>
              ${uncategorizedBadge}
              ${paymentBadge}
              ${paymentStatusBadge}
              ${needInputBadge}
              <span class="tx-time">${timeStr}${dateStr ? " / " + dateStr : ""}</span>
            </div>
            <div class="tx-title">${summary}</div>
            <div class="tx-sub">${buyerLabel}</div>
            ${needInputSub}
            <div class="tx-detail">
              ${tx.summary ? tx.summary.replace(/\n/g, "<br>") : ""}
            </div>
          </div>
          <div class="tx-amt">${formatYen(tx.net_amount ?? tx.amount)}</div>
        `;

        // ğŸŒ ä¸–ç•Œç›¸å ´ï¼ˆå‚è€ƒï¼‰è¡Œã‚’è¿½åŠ ï¼ˆworldMedian ãŒå…¥ã£ã¦ã„ã‚‹ã¨ãã ã‘ï¼‰
        if (typeof tx.worldMedian === "number" && tx.worldMedian > 0) {
          const worldRow = document.createElement("div");
          worldRow.className = "tx-sub";

          const parts = [];
          // ğŸ”¹ ä¸–ç•Œæœ€å®‰å€¤ï¼ˆé€æ–™è¾¼ã¿ï¼‰ã®ã¿ã‚’è¡¨ç¤º
          if (typeof tx.worldLow === "number" && tx.worldLow > 0) {
            parts.push(`ä¸–ç•Œæœ€å®‰å€¤ï¼ˆé€æ–™è¾¼ã¿ï¼‰ ${formatYen(tx.worldLow)}`);
          } else {
            parts.push("ä¸–ç•Œæœ€å®‰å€¤ï¼ˆé€æ–™è¾¼ã¿ï¼‰ Â¥â€”");
          }

          // ğŸ”¹ ä»¶æ•°ãƒ©ãƒ™ãƒ«ï¼ˆå‡ºå“ä¸­â—¯ä»¶ã‹ã‚‰é›†è¨ˆï¼‰
          if (typeof tx.worldSampleCount === "number" && tx.worldSampleCount > 0) {
            parts.push(`å‡ºå“ä¸­${tx.worldSampleCount}ä»¶ã‹ã‚‰é›†è¨ˆ`);
          }

          const adviceText = buildWorldPriceAdviceText(tx);
          if (adviceText) {
            // 1è¡Œç›®: ä¸–ç•Œæœ€å®‰å€¤ / 2è¡Œç›®: AIã®ãŠã™ã™ã‚ä¾¡æ ¼å¸¯
            worldRow.innerHTML = `${parts.join(" / ")}<br>${adviceText}`;
          } else {
            worldRow.textContent = parts.join(" / ");
          }

          const main = li.querySelector(".tx-main");
          if (main) main.appendChild(worldRow);
        }

        // â˜… ä¿®æ­£2: ã‚¯ãƒªãƒƒã‚¯æ™‚ã«dataå±æ€§ã‹ã‚‰orderIdã‚’å–å¾—ã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        li.addEventListener("click", () => {
          const orderId = li.dataset.orderId;
          if (orderId) {
            openOrderDetail(orderId);
          } else {
            // orderIdãŒãªã„å ´åˆã¯å¾“æ¥ã®å±•é–‹å‹•ä½œ
            li.classList.toggle("expanded");
          }
        });

        return li;
      }

      // å–å¼•ãƒªã‚¹ãƒˆæç”»ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ä»˜ãï¼‰
      function renderTxList() {
        console.log("[seller-dashboard] renderTxList()å‘¼ã³å‡ºã—");
        console.log("[seller-dashboard] txListEl:", !!txListEl);
        console.log("[seller-dashboard] latestTxList:", latestTxList?.length || 0, "ä»¶");
        if (!txListEl) {
          console.warn("[seller-dashboard] txListElãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
          return;
        }
        txListEl.innerHTML = "";

        const source = latestTxList || [];
        let list = source;
        console.log("[seller-dashboard] ãƒ•ã‚£ãƒ«ã‚¿å‰:", source.length, "ä»¶, ãƒ•ã‚£ãƒ«ã‚¿å¾Œ:", list.length, "ä»¶");

        if (txFilterNeedInputOnly) {
          list = source.filter(isNeedInputTx);
        }

        if (!list.length) {
          const li = document.createElement("li");
          li.className = "tx-item";
          li.innerHTML = `
            <div class="tx-main">
              <div class="tx-title">${txFilterNeedInputOnly
              ? "å…¥åŠ›ã¾ã¡ã® å–å¼•ã¯ ã‚ã‚Šã¾ã›ã‚“"
              : "ã¾ã  å–å¼•ãŒã‚ã‚Šã¾ã›ã‚“"
            }</div>
              <div class="tx-sub">${txFilterNeedInputOnly
              ? "ä»•å…¥é¡ãƒ»ã‚«ãƒ†ã‚´ãƒªãƒ»è³¼å…¥è€…æƒ…å ±ãŒ ãã‚ã£ã¦ã„ãªã„å–å¼•ã ã‘ã‚’ ã²ã‚‡ã†ã˜ã—ã¾ã™ã€‚"
              : "ãã‚‡ã†ã®æ±ºæ¸ˆã‚„ ã•ã„ãã‚“ã®æ±ºæ¸ˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚"
            }</div>
            </div>
          `;
          txListEl.appendChild(li);
          return;
        }

        let txIndex = 0;
        for (const tx of list) {
          try {
            // ãƒ‡ãƒãƒƒã‚°: æœ€åˆã®5ä»¶ã®ãƒ­ã‚°å‡ºåŠ›ï¼ˆå…¥åŠ›ã¾ã¡åˆ¤å®šã«å¿…è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è©³ç´°ã«ï¼‰
            if (txIndex < 5) {
              const customerType = tx.customerType ?? tx.customer_type ?? tx.buyer?.customer_type ?? null;
              const gender = tx.gender ?? tx.buyer?.gender ?? null;
              const ageBand = tx.ageBand ?? tx.age_band ?? tx.buyer?.age_band ?? null;
              const hasCategory = !!(tx.rawCategory || tx.raw_category);
              const costVal = typeof tx.costAmount === "number" ? tx.costAmount : null;
              const hasCost = costVal !== null && costVal > 0;
              const hasBuyerAll = !!(
                customerType != null && customerType !== "" &&
                gender != null && gender !== "" &&
                ageBand != null && ageBand !== ""
              );

              console.log(`[seller-dashboard] å–å¼•${txIndex} å…¥åŠ›ã¾ã¡åˆ¤å®š:`, {
                orderId: tx.orderId || tx.order_id,
                customerType: customerType,
                gender: gender,
                ageBand: ageBand,
                rawCategory: tx.rawCategory || tx.raw_category,
                costAmount: tx.costAmount,
                hasBuyerAll,
                hasCategory,
                hasCost,
                needInput: !hasCost || !hasCategory || !hasBuyerAll,
              });
            }
            const item = createTransactionItem(tx);
            if (item) {
              txListEl.appendChild(item);
            } else {
              console.warn("[seller-dashboard] createTransactionItemãŒnullã‚’è¿”ã—ã¾ã—ãŸ:", tx);
            }
          } catch (itemError) {
            console.error("[seller-dashboard] createTransactionItemã‚¨ãƒ©ãƒ¼:", itemError, tx);
          }
          txIndex++;
        }
        console.log("[seller-dashboard] renderTxList()å®Œäº†: ", list.length, "ä»¶ã‚’è¡¨ç¤º");
      }

      // QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆã®å…±é€šé–¢æ•°ï¼ˆsellerIdã‚’å‹•çš„ã«å«ã‚ã‚‹ï¼‰
      function generateQRCode() {
        // sellerIdã‚’å«ã‚€å‹•çš„URL: seller-purchase-standard.html?s=sellerId
        const baseUrl = `${location.origin.replace(/\/$/, "")}/seller-purchase-standard.html`;
        const purchaseUrl = sellerId
          ? `${baseUrl}?s=${encodeURIComponent(sellerId)}`
          : baseUrl;

        // URLãƒªãƒ³ã‚¯
        const urlEl = document.getElementById("purchase-url");
        if (urlEl) {
          urlEl.textContent = purchaseUrl;
          urlEl.href = purchaseUrl;
        } else {
          console.warn("generateQRCode: purchase-url element not found");
        }

        // QRç”Ÿæˆï¼ˆè¦ç´ ã‚’å†å–å¾—ã—ã¦ç¢ºèªï¼‰
        const qrEl = document.getElementById("purchase-qr");
        if (qrEl) {
          const qrApi = "https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=";
          qrEl.src = qrApi + encodeURIComponent(purchaseUrl);
          qrEl.alt = "è²©å£²ç”»é¢QRã‚³ãƒ¼ãƒ‰";
          console.log("QR code generated (dynamic URL with sellerId):", qrEl.src);
        } else {
          console.error("generateQRCode: purchase-qr element not found in DOM");
        }

        // ã‚³ãƒ”ãƒ¼ ãƒœã‚¿ãƒ³
        const copyBtn = document.getElementById("copy-purchase-url");
        if (copyBtn) {
          copyBtn.onclick = () => {
            navigator.clipboard?.writeText(purchaseUrl).then(() => {
              alert("è²©å£²ç”»é¢ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
            }).catch(() => {
              alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚");
            });
          };
        }
      }

      async function loadSummary() {
        // ğŸ†• sellerIdã‚’å«ã‚€å‹•çš„URLã®QRã‚³ãƒ¼ãƒ‰ã‚’å³åº§ã«ç”Ÿæˆ
        generateQRCode();

        if (!sellerId) {
          if (homeHintEl) homeHintEl.textContent = "URLã« ?s=å‡ºåº—è€…ID ãŒ ã²ã¤ã‚ˆã†ã§ã™ã€‚";
          return;
        }

        try {
          const res = await fetch(`/api/seller/summary?s=${encodeURIComponent(sellerId)}`);
          const data = await res.json();

          if (!res.ok) {
            console.error("summary error", data);
            if (homeHintEl) homeHintEl.textContent = "å£²ä¸Šãƒ‡ãƒ¼ã‚¿å–å¾—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚QRã‚³ãƒ¼ãƒ‰ã¯è¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚";
            // ğŸ†• APIã‚¨ãƒ©ãƒ¼æ™‚ã§ã‚‚QRã‚³ãƒ¼ãƒ‰ã¯æ—¢ã«ç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ã“ã“ã§return
            return;
          }

          // ãƒ‡ãƒãƒƒã‚°: APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æœ€åˆã®3ä»¶ã‚’ãƒ­ã‚°å‡ºåŠ›
          if (data.recent && data.recent.length > 0) {
            console.log("[seller-dashboard] APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ (æœ€åˆã®3ä»¶):", data.recent.slice(0, 3).map((tx) => ({
              orderId: tx.orderId || tx.order_id,
              customerType: tx.customerType ?? tx.customer_type ?? tx.buyer?.customer_type,
              gender: tx.gender ?? tx.buyer?.gender,
              ageBand: tx.ageBand ?? tx.age_band ?? tx.buyer?.age_band,
              rawCategory: tx.rawCategory || tx.raw_category,
              costAmount: tx.costAmount,
            })));
          }

          // ã‚µãƒ–ã‚¹ã‚¯æœªåŠ å…¥ï¼ˆstandard ã¾ãŸã¯ isSubscribed=falseï¼‰ã®å ´åˆã§ã‚‚ã€åŸºæœ¬çš„ãªå–å¼•å±¥æ­´ã¯è¡¨ç¤ºã™ã‚‹
          // planType ãŒ "pro" ã¾ãŸã¯ "kids" ä»¥å¤–ã®å ´åˆã¯ã€ä¸€éƒ¨æ©Ÿèƒ½ã‚’ãƒ–ãƒ­ãƒƒã‚¯
          const isStandardPlan = data && data.planType && data.planType === "standard";
          const isNotSubscribed = data && data.isSubscribed === false;

          if (isStandardPlan || isNotSubscribed) {
            // ã‚µãƒ–ã‚¹ã‚¯æœªåŠ å…¥ã®å ´åˆã¯ã€ä¸€éƒ¨ã®æ©Ÿèƒ½ã‚’ãƒ–ãƒ­ãƒƒã‚¯
            // ãŸã ã—ã€åŸºæœ¬çš„ãªå–å¼•å±¥æ­´ã¯è¡¨ç¤ºã™ã‚‹
            if (homeHintEl) {
              homeHintEl.textContent = "ã“ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ä¸€éƒ¨æ©Ÿèƒ½ã¯ã€ãƒ—ãƒ­ / ã‚­ãƒƒã‚ºãƒ—ãƒ©ãƒ³ã”å¥‘ç´„ä¸­ã®å‡ºåº—è€…ã•ã¾å°‚ç”¨ã§ã™ã€‚";
            }
            if (kpiTotalEl) kpiTotalEl.textContent = "â€“";
            if (kpiCountEl) kpiCountEl.textContent = "â€“";
            if (kpiAvgEl) kpiAvgEl.textContent = "â€“";
            if (recentListEl) {
              recentListEl.innerHTML = "";
            }
            if (recentHintEl) {
              recentHintEl.textContent = "ã‚µãƒ–ã‚¹ã‚¯ã«ã”åŠ å…¥ã„ãŸã ãã¨ã€å£²ä¸Šã®ãã‚ã—ã„åˆ†æãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚";
            }
            if (purchaseUrlEl) {
              purchaseUrlEl.textContent = "ã‚µãƒ–ã‚¹ã‚¯ã”å¥‘ç´„ã§è²©å£²ç”¨URLãŒè¡¨ç¤ºã•ã‚Œã¾ã™";
              purchaseUrlEl.removeAttribute("href");
            }
            // æ³¨æ„: returnã—ãªã„ - å–å¼•å±¥æ­´ã¯è¡¨ç¤ºã™ã‚‹
          }

          // åº—å
          if (shopNameEl) shopNameEl.textContent = data.displayName || data.sellerId || "å‡ºåº—è€…";
          if (shopDisplayEl) shopDisplayEl.textContent = data.displayName || data.sellerId || "å‡ºåº—è€…";

          // ãã‚‡ã†ã®æ—¥ä»˜ï¼ˆJSTï¼‰ã€‚UTC ã« +9æ™‚é–“ã—ã¦ã‹ã‚‰ã€Œæ—¥ä»˜ã€ã‚’æ±ºã‚ã‚‹
          const now = new Date();
          const nowJst = new Date(now.getTime() + 9 * 60 * 60 * 1000);
          if (todayLabelEl) {
            todayLabelEl.textContent = formatDateJp(nowJst) + " ã® ã†ã‚Šã‚ã’";
          }

          // KPIï¼ˆç´”å£²ä¸Šï¼‰

          // 1. ãã‚‡ã†ã®æ—¥ä»˜ï¼ˆJSTï¼‰ã‚’ YYYY-MM-DD æ–‡å­—åˆ—ã«
          //   toISOString() ã¯ UTC ãªã®ã§ä½¿ã‚ãšã€UTCãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç›´æ¥å–ã‚Šå‡ºã™
          const todayStr =
            `${nowJst.getUTCFullYear()}-` +
            `${String(nowJst.getUTCMonth() + 1).padStart(2, "0")}-` +
            `${String(nowJst.getUTCDate()).padStart(2, "0")}`;

          let todayNet = 0;  // ãã‚‡ã†ã®ç´”å£²ä¸Š
          let countToday = 0;  // ãã‚‡ã†ã®ä»¶æ•°
          let avgToday = 0;  // ãã‚‡ã†ã®å¹³å‡å®¢å˜ä¾¡

          // 2. ã¾ãš API ãŒ salesToday ã‚’æŒã£ã¦ã„ã‚Œã°ãã‚Œã‚’å„ªå…ˆã—ã¦ä½¿ã†
          if (data.salesToday && typeof data.salesToday.net === "number" && data.salesToday.net > 0) {
            todayNet = data.salesToday.net;
            countToday = typeof data.salesToday.count === "number"
              ? data.salesToday.count
              : (typeof data.countToday === "number" ? data.countToday : 0);
            avgToday = typeof data.salesToday.avgNet === "number"
              ? data.salesToday.avgNet
              : (typeof data.avgToday === "number" ? data.avgToday : (countToday > 0 ? Math.round(todayNet / countToday) : 0));
          } else {
            // 3. salesToday ãŒç„¡ã„ / 0 ã®ã¨ãã¯ recent ã‹ã‚‰ "ãã‚‡ã†ã®åˆ†ã ã‘" åˆè¨ˆã‚’å‡ºã™
            (data.recent || []).forEach(tx => {

              // created(ç§’) or createdAt(ISOæ–‡å­—åˆ—) ã‹ã‚‰ Date ã‚’ç”Ÿæˆ
              let created = null;
              if (typeof tx.created === "number") {
                created = new Date(tx.created * 1000);
              } else if (tx.createdAt) {
                created = new Date(tx.createdAt);
              }
              if (!created || isNaN(created.getTime())) return;

              // JST ã«ãã‚ãˆã¦æ—¥ä»˜æ¯”è¼ƒï¼ˆUTCã«+9æ™‚é–“ã—ã¦ã‹ã‚‰æ—¥ä»˜ã‚’å‡ºã™ï¼‰
              const jst = new Date(created.getTime() + 9 * 60 * 60 * 1000);
              const dStr =
                `${jst.getUTCFullYear()}-` +
                `${String(jst.getUTCMonth() + 1).padStart(2, "0")}-` +
                `${String(jst.getUTCDate()).padStart(2, "0")}`;
              if (dStr !== todayStr) return; // ãã‚‡ã†ä»¥å¤–ã¯ç„¡è¦–

              const amt = Number(tx.amount || tx.net_amount || 0);
              if (!Number.isFinite(amt)) return;

              todayNet += amt;
              countToday += 1;
            });

            if (countToday > 0) {
              avgToday = Math.round(todayNet / countToday);
            }
          }

          // 4. ç”»é¢ã«åæ˜ 
          if (kpiTotalEl) kpiTotalEl.textContent = formatYen(todayNet);
          if (kpiCountEl) kpiCountEl.textContent = `${countToday}ä»¶`;
          if (kpiAvgEl) kpiAvgEl.textContent = formatYen(avgToday || 0);

          if (missionProgressEl) {
            const progress = Math.min(3, countToday);
            missionProgressEl.textContent = `${progress} / 3 ã§ããŸã‚‰ 100ã¦ã‚“ï¼`;
          }

          if (rewardMessageEl) {
            rewardMessageEl.textContent = countToday > 0
              ? "ã™ã”ã„ï¼ ãã‚‡ã†ã‚‚ ã†ã‚ŒãŸã‚ˆ"
              : "ãã‚‡ã†ã® ã†ã‚Šã‚ã’ãŒ ãŸã¾ã£ã¦ããŸã‚ˆ";
          }
          if (rewardHintEl) {
            rewardHintEl.textContent = countToday > 0
              ? "ã‚‚ã£ã¨ ã†ã£ã¦ã¿ã‚ˆã†"
              : "ã¾ãšã¯ 1ã‘ã‚“ ã†ã£ã¦ã¿ã‚ˆã†";
          }
          if (rewardBarFillEl) {
            const percent = Math.min(100, Math.round((countToday / 5) * 100));
            rewardBarFillEl.style.width = `${percent}%`;
          }

          // ğŸŸ¦ ä»•å…¥é¡ãƒ»åˆ©ç›Šã®è¡¨ç¤º
          const costToday = data.salesToday?.cost ?? 0;
          const profitToday = data.salesToday?.profit ?? (todayNet - costToday);

          // DOMã¸æç”»
          const kpiCostEl = document.querySelector("#kpi-cost");
          const kpiProfitEl = document.querySelector("#kpi-profit");
          if (kpiCostEl) kpiCostEl.textContent = formatYen(costToday);
          if (kpiProfitEl) kpiProfitEl.textContent = formatYen(profitToday);

          // ğŸŸ¦ (A) ãƒ‡ãƒ¼ã‚¿ç²¾åº¦ã‚¹ã‚³ã‚¢ã®è¡¨ç¤º
          if (dataScoreEl) {
            const score = data.dataScore !== undefined && data.dataScore !== null
              ? data.dataScore
              : 0;
            dataScoreEl.textContent = score + "%";
          }

          if (homeHintEl) {
            if (countToday === 0) {
              homeHintEl.textContent = "ãã‚‡ã†ã® ã‘ã£ã•ã„ ã¯ ã¾ã  ã‚ã‚Šã¾ã›ã‚“ã€‚ã•ã„ã—ã‚‡ã® 1ä»¶ã‚’ ãŠå¾…ã¡ã—ã¦ã„ã¾ã™ã€‚";
            } else {
              homeHintEl.textContent = "ãã‚‡ã†ã® ã†ã‚Šã‚ã’ ã‚’ Stripe ã® ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ ã²ã‚‡ã†ã˜ä¸­ã§ã™ã€‚";
            }
          }

          // ã•ã„ãã‚“ã®æ±ºæ¸ˆï¼ˆ3ä»¶ã¾ã§ï¼‰
          const recent = (data.recent || []).slice(0, 3);
          if (recentListEl) {
            recentListEl.innerHTML = "";
            if (recent.length === 0) {
              const li = document.createElement("li");
              li.className = "tx-item";
              li.innerHTML = `
                <div class="tx-main">
                  <div class="tx-title">ã¾ã  ã‘ã£ã•ã„ ã¯ ã‚ã‚Šã¾ã›ã‚“</div>
                  <div class="tx-sub">ãƒ†ã‚¹ãƒˆæ±ºæ¸ˆãŒã‚ã‚‹ã¨ ã“ã“ã« ã²ã‚‡ã†ã˜ã•ã‚Œã¾ã™ã€‚</div>
                </div>
              `;
              recentListEl.appendChild(li);
            } else {
              for (const tx of recent) {
                recentListEl.appendChild(createTransactionItem(tx));
              }
            }
          }

          if (recentHintEl) {
            recentHintEl.textContent = "Stripe ã®ãƒ†ã‚¹ãƒˆæ±ºæ¸ˆãŒ ã•ã„ã—ã‚“3ä»¶ã¾ã§ ã²ã‚‡ã†ã˜ã•ã‚Œã¾ã™ã€‚";
          }

          // å–å¼•å±¥æ­´ï¼ˆéå»30æ—¥åˆ†ï¼‰ã‚’ä¿æŒï¼†æç”»
          console.log("[seller-dashboard] APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ data.recent:", data.recent);
          console.log("[seller-dashboard] data.recentã®å‹:", typeof data.recent);
          console.log("[seller-dashboard] data.recentã¯é…åˆ—ã‹:", Array.isArray(data.recent));
          latestTxList = data.recent || [];
          console.log("[seller-dashboard] latestTxListè¨­å®š:", latestTxList.length, "ä»¶");
          console.log("[seller-dashboard] latestTxList[0]ã®ã‚µãƒ³ãƒ—ãƒ«:", latestTxList[0]);
          console.log("[seller-dashboard] txListElå­˜åœ¨ç¢ºèª:", !!txListEl);
          if (!txListEl) {
            console.error("[seller-dashboard] ã‚¨ãƒ©ãƒ¼: txListElãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼");
          } else {
            renderTxList();
            console.log("[seller-dashboard] renderTxList()å®Ÿè¡Œå®Œäº†");
          }

        } catch (e) {
          console.error("loadSummary error", e);
          if (homeHintEl) homeHintEl.textContent = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
        }
      }

      // ğŸ†• Tieræƒ…å ±ã‚’å–å¾—ãƒ»è¡¨ç¤º
      async function loadTierStatus() {
        if (!sellerId) return;

        try {
          const res = await fetch(`/api/seller/tier-status?s=${encodeURIComponent(sellerId)}`);
          const data = await res.json();

          if (!res.ok || !data.success) {
            console.error("tier-status error", data);
            // Tieræƒ…å ±ãŒå–å¾—ã§ããªã„å ´åˆã¯éè¡¨ç¤ºã«ã™ã‚‹
            const tierCard = document.getElementById("tier-card");
            if (tierCard) tierCard.style.display = "none";
            return;
          }

          const tierData = data.data;
          const tierCard = document.getElementById("tier-card");
          const tierNumberEl = document.getElementById("tier-number");
          const tierNameEl = document.getElementById("tier-name");
          const tierFeeRateEl = document.getElementById("tier-fee-rate");
          const tierTransactionCountEl = document.getElementById("tier-transaction-count");
          const tierRangeEl = document.getElementById("tier-range");
          const tierMessageEl = document.getElementById("tier-message");

          if (tierCard) tierCard.style.display = "block";

          // Tierç•ªå·ã¨åå‰
          if (tierNumberEl) tierNumberEl.textContent = `Tier ${tierData.tier.number}`;
          if (tierNameEl) tierNameEl.textContent = tierData.tier.name;
          if (tierFeeRateEl) {
            tierFeeRateEl.textContent = `æ‰‹æ•°æ–™: ${tierData.tier.currentFeeRatePercent}%`;
          }

          // æœˆé–“QRæ±ºæ¸ˆå›æ•°
          if (tierTransactionCountEl) {
            tierTransactionCountEl.textContent = `${tierData.transactionCount.current}å›`;
          }
          if (tierRangeEl) {
            const range = tierData.transactionCount.range;
            if (range.max === null) {
              tierRangeEl.textContent = `ç¯„å›²: ${range.min}å›ä»¥ä¸Š`;
            } else {
              tierRangeEl.textContent = `ç¯„å›²: ${range.min}ã€œ${range.max}å›`;
            }
          }

          // æ¬¡ã®ãƒ©ãƒ³ã‚¯ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          if (tierMessageEl && tierData.tier.feeRateMessage) {
            tierMessageEl.textContent = tierData.tier.feeRateMessage;
          }
        } catch (e) {
          console.error("loadTierStatus error", e);
          const tierCard = document.getElementById("tier-card");
          if (tierCard) tierCard.style.display = "none";
        }
      }

      // åˆå›èª­ã¿è¾¼ã¿: sellerIdã‚’å«ã‚€å‹•çš„URLã®QRã‚³ãƒ¼ãƒ‰ã‚’å³åº§ã«ç”Ÿæˆ
      // DOMContentLoadedã‚’å¾…ã£ã¦ã‹ã‚‰å®Ÿè¡Œï¼ˆDOMè¦ç´ ãŒç¢ºå®Ÿã«å­˜åœ¨ã™ã‚‹ã‚ˆã†ã«ï¼‰
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          generateQRCode();
          loadSummary();
          loadTierStatus(); // ğŸ†• Tieræƒ…å ±ã‚‚èª­ã¿è¾¼ã‚€
        });
      } else {
        // DOMãŒæ—¢ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯å³åº§ã«å®Ÿè¡Œ
        generateQRCode();
        loadSummary();
        loadTierStatus(); // ğŸ†• Tieræƒ…å ±ã‚‚èª­ã¿è¾¼ã‚€
      }

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«å…¬é–‹ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ä¿å­˜æ™‚ã®å†èª­ã¿è¾¼ã¿ç”¨ï¼‰
      window.loadSummary = loadSummary;
      window.generateQRCode = generateQRCode;
    })();

    // ====== å–å¼•ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ ======
    document.addEventListener("DOMContentLoaded", () => {
      const btn = document.getElementById("tx-filter-need-input");
      if (btn) {
        btn.addEventListener("click", () => {
          txFilterNeedInputOnly = !txFilterNeedInputOnly;
          if (txFilterNeedInputOnly) {
            btn.classList.add("pill-toggle-active");
            btn.textContent = "å…¥åŠ›ã¾ã¡ã®ã¿è¡¨ç¤ºä¸­";
          } else {
            btn.classList.remove("pill-toggle-active");
            btn.textContent = "å…¥åŠ›ã¾ã¡ã ã‘";
          }
          if (typeof renderTxList === "function") {
            renderTxList();
          }
        });
      }
    });

    // ====== ğŸ†• æ³¨æ–‡è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« ======
    let currentDetailOrderId = null;

    // ğŸŸ© ä¿®æ­£3: ã‚µãƒ¼ãƒãƒ¼ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ§‹é€ ã«åˆã‚ã›ã¦ä¿®æ­£
    async function openOrderDetail(orderId) {
      const modal = document.getElementById("order-detail-modal");
      if (!modal) return;
      currentDetailOrderId = orderId;

      try {
        const params = new URLSearchParams(location.search);
        const sellerId = params.get("s") || "";

        // ç”»åƒã‚„å±æ€§ã‚’å«ã‚€å°‚ç”¨APIã‚’å‘¼ã¶
        const res = await fetch(
          `/api/seller/order-detail-full?s=${encodeURIComponent(sellerId)}&orderId=${encodeURIComponent(orderId)}`
        );
        const data = await res.json();

        if (!res.ok) {
          alert("å–å¼•ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
          console.error("order-detail error", data);
          return;
        }

        // è¦ç´ å–å¾—
        const imgEl = document.getElementById("order-image");
        const imgWrapper = document.getElementById("order-image-wrapper");
        const sumEl = document.getElementById("modal-summary");
        const amtEl = document.getElementById("modal-amount");
        const costEl = document.getElementById("modal-cost");
        const typeEl = document.getElementById("modal-customer-type");
        const genEl = document.getElementById("modal-gender");
        const ageEl = document.getElementById("modal-age");
        const catEl = document.getElementById("modal-category");
        const langEl = document.getElementById("modal-language");

        // ğŸŸ© ç”»åƒã®è¡¨ç¤ºåˆ¶å¾¡ï¼ˆã‚µãƒ¼ãƒãƒ¼ã¯ imageUrl ã‚’ç›´æ¥è¿”ã™ï¼‰
        if (data.imageUrl) {
          if (imgEl) {
            imgEl.src = data.imageUrl;
            imgEl.alt = "å•†å“å†™çœŸ";
          }
          if (imgWrapper) {
            imgWrapper.style.display = "";
          }
        } else {
          if (imgEl) {
            imgEl.src = "";
          }
          if (imgWrapper) {
            imgWrapper.style.display = "none";
          }
        }

        // ğŸŸ© å•†å“ãƒ¡ãƒ¢ï¼ˆã‚µãƒ¼ãƒãƒ¼ã¯ memo ã‚’è¿”ã™ï¼‰â€» textarea ã« value ã§ã‚»ãƒƒãƒˆ
        if (sumEl) sumEl.value = data.memo || "";

        // ğŸŸ© é‡‘é¡ï¼ˆã‚µãƒ¼ãƒãƒ¼ã¯ amount ã‚’è¿”ã™ï¼‰
        if (amtEl) amtEl.textContent = "Â¥" + (data.amount || 0).toLocaleString("ja-JP");

        // ğŸŸ© ä»•å…¥é¡
        if (costEl) {
          const c = typeof data.costAmount === "number" ? data.costAmount : 0;
          costEl.value = c > 0 ? String(c) : "";
        }

        // ğŸŸ© è³¼å…¥è€…å±æ€§ï¼ˆã‚µãƒ¼ãƒãƒ¼ã¯ buyer ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ãªãç›´æ¥è¿”ã™ï¼‰
        if (typeEl) typeEl.value = data.customerType || "";
        if (genEl) genEl.value = data.gender || "";
        if (ageEl) ageEl.value = data.ageBand || "";

        // ğŸŸ© ã‚«ãƒ†ã‚´ãƒª / è¨€èªï¼ˆã‚µãƒ¼ãƒãƒ¼ã¯ metadata ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ãªãç›´æ¥è¿”ã™ï¼‰
        if (catEl) catEl.value = data.itemCategory || "";
        if (langEl) langEl.value = data.buyerLanguage || "";

        modal.style.display = "flex";

      } catch (e) {
        console.error("openOrderDetail error", e);
        alert("å–å¼•ã®èª­ã¿è¾¼ã¿ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
      }
    }

    function closeOrderDetail() {
      const modal = document.getElementById("order-detail-modal");
      if (modal) modal.style.display = "none";
      currentDetailOrderId = null;
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
    document.addEventListener("DOMContentLoaded", () => {
      const modal = document.getElementById("order-detail-modal");
      if (!modal) return;

      const closeBtn = document.getElementById("modal-close-btn");
      if (closeBtn) closeBtn.onclick = closeOrderDetail;

      const saveBtn = document.getElementById("modal-save-btn");
      if (saveBtn) {
        saveBtn.onclick = async () => {
          if (!currentDetailOrderId) return;

          const params = new URLSearchParams(location.search);
          const sellerId = params.get("s") || "";

          const sumEl = document.getElementById("modal-summary");
          const typeEl = document.getElementById("modal-customer-type");
          const genEl = document.getElementById("modal-gender");
          const ageEl = document.getElementById("modal-age");
          const catEl = document.getElementById("modal-category");
          const langEl = document.getElementById("modal-language");
          const costEl = document.getElementById("modal-cost");

          const summary = sumEl?.value || "";
          const customer_type = typeEl?.value || "";
          const gender = genEl?.value || "";
          const age_band = ageEl?.value || "";
          const category = catEl?.value || "";
          const buyer_language = langEl?.value || "";
          const cost_raw = costEl?.value || "";
          const costAmount = cost_raw ? Number(cost_raw) : 0;

          try {
            saveBtn.disabled = true;
            saveBtn.textContent = "ä¿å­˜ä¸­â€¦";

            // 1) è³¼å…¥è€…å±æ€§ã‚’ä¿å­˜
            if (customer_type && gender && age_band) {
              await fetch("/api/orders/buyer-attributes", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  orderId: currentDetailOrderId,
                  customer_type,
                  gender,
                  age_band
                })
              });
            }

            // 2) ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚«ãƒ†ã‚´ãƒªãƒ»è¨€èªï¼‰ã‚’ä¿å­˜
            await fetch("/api/orders/metadata", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                orderId: currentDetailOrderId,
                category,
                buyer_language,
                // is_cash ã¯ä»Šå›ã¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç·¨é›†ã§ã¯å¤‰æ›´ã—ãªã„ã®ã§é€ã‚‰ãªãã¦ã‚‚OK
              })
            });

            // 3) å•†å“ãƒ¡ãƒ¢(summary) ã‚’ä¿å­˜
            await fetch("/api/orders/update-summary", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                orderId: currentDetailOrderId,
                summary
              })
            });

            // 4) ä»•å…¥é¡(cost_amount) ã‚’ä¿å­˜ï¼ˆ0ä»¥ä¸Šã®ã¨ãã ã‘ï¼‰
            if (cost_raw !== "") {
              await fetch("/api/orders/update-cost", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  orderId: currentDetailOrderId,
                  costAmount: costAmount
                })
              });
            }

            alert("ä¿å­˜ã—ã¾ã—ãŸ");
            closeOrderDetail();
            // æœ€æ–°ã®ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
            if (window.loadSummary) {
              window.loadSummary();
            }
          } catch (e) {
            console.error("save detail error", e);
            alert("ä¿å­˜ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
          } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = "ä¿å­˜ã™ã‚‹";
          }
        };
      }

      // ğŸ†• å‰Šé™¤ãƒœã‚¿ãƒ³
      const deleteBtn = document.getElementById("modal-delete-btn");
      if (deleteBtn) {
        deleteBtn.onclick = async () => {
          if (!currentDetailOrderId) return;

          // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
          if (!confirm("ã“ã®å–å¼•ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚")) {
            return;
          }

          const params = new URLSearchParams(location.search);
          const sellerId = params.get("s") || "";

          try {
            deleteBtn.disabled = true;
            deleteBtn.textContent = "å‰Šé™¤ä¸­â€¦";

            const res = await fetch(`/api/seller/orders/${encodeURIComponent(currentDetailOrderId)}?s=${encodeURIComponent(sellerId)}`, {
              method: "DELETE",
              headers: { "Content-Type": "application/json" }
            });

            const data = await res.json().catch(() => ({}));

            if (!res.ok) {
              // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã® message ãŒã‚ã‚Œã°å„ªå…ˆçš„ã«è¡¨ç¤º
              if (data && data.message) {
                alert(data.message);
              } else {
                alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
              }
              return;
            }

            alert("å–å¼•ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
            closeOrderDetail();
            // æœ€æ–°ã®ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
            if (window.loadSummary) {
              window.loadSummary();
            }
          } catch (e) {
            console.error("delete order error", e);
            alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
          } finally {
            deleteBtn.disabled = false;
            deleteBtn.textContent = "å‰Šé™¤ã™ã‚‹";
          }
        };
      }

      // ğŸ†• ä¸–ç•Œç›¸å ´(å‚è€ƒ)ã‚’å–å¾—ãƒœã‚¿ãƒ³
      const worldBtn = document.getElementById("modal-world-btn");
      if (worldBtn) {
        worldBtn.onclick = async () => {
          if (!currentDetailOrderId) return;

          const params = new URLSearchParams(location.search);
          const sellerId = params.get("s") || "";

          try {
            worldBtn.disabled = true;
            worldBtn.textContent = "å–å¾—ä¸­â€¦";

            const res = await fetch("/api/orders/update-world-price", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                orderId: currentDetailOrderId,
                sellerId
              })
            });

            const data = await res.json().catch(() => ({}));

            if (!res.ok || !data.ok) {
              // ğŸ†• ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã® message ãŒã‚ã‚Œã°å„ªå…ˆçš„ã«è¡¨ç¤º
              if (data && data.message) {
                alert(data.message);
              } else {
                alert("ä¸–ç•Œç›¸å ´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚ã¨ã§ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
              }
              return;
            }

            // ã“ã“ã§ã¯ã€Œã‚­ãƒ¥ãƒ¼ã«ä¹—ã›ãŸã ã‘ã€ã€‚é‡ã„å‡¦ç†ã¯ã‚µãƒ¼ãƒãƒ¼å´ã§ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å®Ÿè¡Œã€‚
            alert("ä¸–ç•Œç›¸å ´ã®å–å¾—ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚æ•°åç§’å¾Œã«ç”»é¢ã‚’æ›´æ–°ã™ã‚‹ã¨åæ˜ ã•ã‚Œã¾ã™ã€‚");

            // æ•°ç§’å¾Œã«ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’å†å–å¾—(ã™ãçµ‚ã‚ã‚‹å ´åˆç”¨ã®è»½ã„ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥)
            if (window.loadSummary) {
              setTimeout(() => {
                window.loadSummary();
              }, 3000);
            }
          } catch (e) {
            console.error("world price button error", e);
            alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
          } finally {
            worldBtn.disabled = false;
            worldBtn.textContent = "ä¸–ç•Œç›¸å ´(å‚è€ƒ)ã‚’å–å¾—";
          }
        };
      }
    });

    // ====================================
    // ğŸ“Š ã‚°ãƒ©ãƒ•è¡¨ç¤ºã‚¹ã‚¯ãƒªãƒ—ãƒˆ
    // ====================================
    (function () {
      try {
        const canvas = document.getElementById('sales-profit-chart');
        const loadingEl = document.getElementById('chart-loading');
        const periodBtns = document.querySelectorAll('.period-btn');

        if (!canvas) return; // ã‚°ãƒ©ãƒ•è¦ç´ ãŒãªã„å ´åˆã¯çµ‚äº†

        // Chart.jsãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
        if (typeof Chart === 'undefined') {
          console.error('Chart.jsãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
          if (loadingEl) {
            loadingEl.textContent = 'ã‚°ãƒ©ãƒ•ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
            loadingEl.style.display = 'flex';
          }
          return;
        }

        let chartInstance = null;
        let currentPeriod = 'daily';

        // ã‚°ãƒ©ãƒ•ã®åˆæœŸåŒ–
        function initChart(labels, salesData, costData, profitData) {
          try {
            const ctx = canvas.getContext('2d');

            // æ—¢å­˜ã®ã‚°ãƒ©ãƒ•ã‚’ç ´æ£„
            if (chartInstance) {
              chartInstance.destroy();
            }

            // Chart.jsã®è¨­å®š
            chartInstance = new Chart(ctx, {
              type: 'bar',
              data: {
                labels: labels,
                datasets: [
                  {
                    label: 'å£²ä¸Š',
                    data: salesData,
                    backgroundColor: 'rgba(27, 54, 93, 0.7)',
                    borderColor: 'rgba(27, 54, 93, 1)',
                    borderWidth: 1,
                    order: 3
                  },
                  {
                    label: 'ä»•å…¥é¡',
                    data: costData,
                    backgroundColor: 'rgba(184, 144, 46, 0.7)',
                    borderColor: 'rgba(184, 144, 46, 1)',
                    borderWidth: 1,
                    order: 2
                  },
                  {
                    label: 'åˆ©ç›Š',
                    data: profitData,
                    backgroundColor: 'rgba(26, 140, 92, 0.8)',
                    borderColor: 'rgba(26, 140, 92, 1)',
                    borderWidth: 2,
                    type: 'line',
                    fill: false,
                    tension: 0.3,
                    order: 1
                  }
                ]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                  mode: 'index',
                  intersect: false,
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    ticks: {
                      callback: function (value) {
                        return 'Â¥' + value.toLocaleString('ja-JP');
                      },
                      font: {
                        size: 10
                      }
                    },
                    grid: {
                      color: 'rgba(0, 0, 0, 0.05)'
                    }
                  },
                  x: {
                    ticks: {
                      font: {
                        size: 9
                      },
                      maxRotation: 45,
                      minRotation: 45
                    },
                    grid: {
                      display: false
                    }
                  }
                },
                plugins: {
                  legend: {
                    display: false // ã‚«ã‚¹ã‚¿ãƒ å‡¡ä¾‹ã‚’ä½¿ç”¨
                  },
                  tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: {
                      size: 13
                    },
                    bodyFont: {
                      size: 12
                    },
                    callbacks: {
                      label: function (context) {
                        let label = context.dataset.label || '';
                        if (label) {
                          label += ': ';
                        }
                        label += 'Â¥' + context.parsed.y.toLocaleString('ja-JP');
                        return label;
                      }
                    }
                  }
                }
              }
            });
          } catch (chartError) {
            console.error('ã‚°ãƒ©ãƒ•ã®åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', chartError);
            if (loadingEl) {
              loadingEl.textContent = 'ã‚°ãƒ©ãƒ•ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ';
              loadingEl.style.display = 'flex';
            }
          }
        }

        // APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
        async function loadChartData(period = 'daily') {
          const params = new URLSearchParams(location.search);
          const sellerId = params.get('s') || '';

          if (!sellerId) {
            console.warn('å‡ºåº—è€…IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
            return;
          }

          try {
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            if (loadingEl) {
              loadingEl.style.display = 'flex';
            }
            canvas.style.opacity = '0.3';

            const days = period === 'daily' ? 30 : 28; // é€±æ¯ã®å ´åˆã¯4é€±é–“
            const response = await fetch(
              `/api/seller/analytics?s=${encodeURIComponent(sellerId)}&period=${period}&days=${days}`
            );

            if (!response.ok) {
              throw new Error('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }

            const result = await response.json();

            if (!result.ok || !result.data) {
              throw new Error('ãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ã§ã™');
            }

            // ãƒ‡ãƒ¼ã‚¿ã®æ•´å½¢
            const labels = [];
            const salesData = [];
            const costData = [];
            const profitData = [];

            result.data.forEach(item => {
              // æ—¥ä»˜ãƒ©ãƒ™ãƒ«ã®æ•´å½¢
              let label;
              if (period === 'daily') {
                const date = new Date(item.date);
                label = `${date.getMonth() + 1}/${date.getDate()}`;
              } else {
                const date = new Date(item.weekStart);
                label = `${date.getMonth() + 1}/${date.getDate()}é€±`;
              }

              labels.push(label);
              salesData.push(item.grossSales);
              costData.push(item.totalCost);
              profitData.push(item.profit);
            });

            // ã‚°ãƒ©ãƒ•ã‚’æç”»
            initChart(labels, salesData, costData, profitData);

            // ãƒ’ãƒ³ãƒˆãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
            const hintEl = document.querySelector('.chart-hint');
            if (hintEl) {
              hintEl.textContent = period === 'daily'
                ? 'ç›´è¿‘30æ—¥é–“ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™'
                : 'ç›´è¿‘4é€±é–“ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™';
            }

          } catch (error) {
            console.error('ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            alert('ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
          } finally {
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º
            if (loadingEl) {
              loadingEl.style.display = 'none';
            }
            canvas.style.opacity = '1';
          }
        }

        // æœŸé–“åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
        periodBtns.forEach(btn => {
          btn.addEventListener('click', () => {
            const period = btn.getAttribute('data-period');

            // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
            periodBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
            currentPeriod = period;
            loadChartData(period);
          });
        });

        // åˆå›ãƒ­ãƒ¼ãƒ‰
        loadChartData(currentPeriod);

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«å…¬é–‹ï¼ˆä»–ã®éƒ¨åˆ†ã‹ã‚‰å†èª­ã¿è¾¼ã¿ã§ãã‚‹ã‚ˆã†ã«ï¼‰
        window.reloadChart = function () {
          loadChartData(currentPeriod);
        };
      } catch (graphError) {
        console.error('ã‚°ãƒ©ãƒ•ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', graphError);
      }
    })();

    // ====================================
    // ğŸ“Š ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚°ãƒ©ãƒ•è¡¨ç¤ºã‚¹ã‚¯ãƒªãƒ—ãƒˆ
    // ====================================
    (function () {
      try {
        const canvas = document.getElementById('benchmark-chart');
        const loadingEl = document.getElementById('chart-benchmark-loading');
        const periodBtns = document.querySelectorAll('[data-period-benchmark]');

        if (!canvas) return; // ã‚°ãƒ©ãƒ•è¦ç´ ãŒãªã„å ´åˆã¯çµ‚äº†

        // Chart.jsãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
        if (typeof Chart === 'undefined') {
          console.error('Chart.jsãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚°ãƒ©ãƒ•ï¼‰');
          if (loadingEl) {
            loadingEl.textContent = 'ã‚°ãƒ©ãƒ•ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
            loadingEl.style.display = 'flex';
          }
          return;
        }

        let chartInstance = null;
        let currentPeriod = 'monthly';
        let benchmarkData = [];

        // ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        async function loadBenchmarkData() {
          try {
            const response = await fetch('/api/benchmark/data');
            if (!response.ok) {
              throw new Error('ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
            const result = await response.json();
            if (result.ok && result.data) {
              benchmarkData = result.data;
            }
          } catch (error) {
            console.error('ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
          }
        }

        // ã‚°ãƒ©ãƒ•ã®åˆæœŸåŒ–
        function initBenchmarkChart(labels, actualData, benchmarkData, improvedData) {
          try {
            const ctx = canvas.getContext('2d');

            if (chartInstance) {
              chartInstance.destroy();
            }

            chartInstance = new Chart(ctx, {
              type: 'bar',
              data: {
                labels: labels,
                datasets: [
                  {
                    label: 'å®Ÿç¸¾å£²ä¸Š',
                    data: actualData,
                    backgroundColor: 'rgba(27, 54, 93, 0.7)',
                    borderColor: 'rgba(27, 54, 93, 1)',
                    borderWidth: 2,
                    order: 3
                  },
                  {
                    label: 'ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ï¼ˆç›®æ¨™ï¼‰',
                    data: benchmarkData,
                    backgroundColor: 'rgba(184, 144, 46, 0.45)',
                    borderColor: 'rgba(184, 144, 46, 1)',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    type: 'line',
                    fill: false,
                    tension: 0.3,
                    pointStyle: 'circle',
                    pointRadius: 6,
                    order: 1
                  },
                  {
                    label: 'ä¼ç”»å¾Œäºˆæƒ³',
                    data: improvedData,
                    backgroundColor: 'rgba(230, 57, 70, 0.75)',
                    borderColor: 'rgba(230, 57, 70, 1)',
                    borderWidth: 2,
                    type: 'line',
                    fill: false,
                    tension: 0.3,
                    pointStyle: 'rectRot',
                    pointRadius: 5,
                    order: 2
                  }
                ]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                  mode: 'index',
                  intersect: false,
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    ticks: {
                      callback: function (value) {
                        return value;
                      },
                      font: {
                        size: 10
                      }
                    },
                    grid: {
                      color: 'rgba(0, 0, 0, 0.05)'
                    }
                  },
                  x: {
                    ticks: {
                      font: {
                        size: 9
                      },
                      maxRotation: 45,
                      minRotation: 45
                    },
                    grid: {
                      display: false
                    }
                  }
                },
                plugins: {
                  legend: {
                    display: false
                  },
                  tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: {
                      size: 13
                    },
                    bodyFont: {
                      size: 12
                    },
                    callbacks: {
                      label: function (context) {
                        let label = context.dataset.label || '';
                        if (label) {
                          label += ': ';
                        }
                        label += context.parsed.y;

                        if (context.datasetIndex === 0) {
                          const benchmark = benchmarkData[context.dataIndex];
                          if (benchmark) {
                            const achievement = ((context.parsed.y / benchmark) * 100).toFixed(1);
                            label += ` (é”æˆç‡: ${achievement}%)`;
                          }
                        }

                        return label;
                      }
                    }
                  }
                }
              }
            });
          } catch (benchmarkChartError) {
            console.error('ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚°ãƒ©ãƒ•ã®åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', benchmarkChartError);
            if (loadingEl) {
              loadingEl.textContent = 'ã‚°ãƒ©ãƒ•ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ';
              loadingEl.style.display = 'flex';
            }
          }
        }

        // APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
        async function loadBenchmarkChartData(period = 'monthly') {
          const params = new URLSearchParams(location.search);
          const sellerId = params.get('s') || '';

          if (!sellerId) {
            console.warn('å‡ºåº—è€…IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
            return;
          }

          try {
            if (loadingEl) {
              loadingEl.style.display = 'flex';
            }
            if (canvas) {
              canvas.style.opacity = '0.3';
            }

            // å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
            const days = period === 'monthly' ? 90 : 28;
            const response = await fetch(
              `/api/seller/analytics?s=${encodeURIComponent(sellerId)}&period=${period === 'monthly' ? 'daily' : 'weekly'}&days=${days}`
            );

            if (!response.ok) {
              throw new Error('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }

            const result = await response.json();

            if (!result.ok || !result.data) {
              throw new Error('ãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ã§ã™');
            }

            // ãƒ‡ãƒ¼ã‚¿ã®æ•´å½¢
            let labels = [];
            let actualData = [];
            let benchmarkValues = [];
            let improvedValues = [];

            // å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã‚’å£²ä¸ŠæŒ‡æ•°ã«å¤‰æ›ï¼ˆ10æœˆå¹³å‡é€±=100ã‚’åŸºæº–ï¼‰
            const octoberAvg = 110; // 10æœˆã®å¹³å‡å€¤ï¼ˆãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‹ã‚‰è¨ˆç®—ï¼‰
            const normalizeToIndex = (sales) => {
              // å®Ÿç¸¾å£²ä¸Šã‚’æŒ‡æ•°ã«å¤‰æ›ï¼ˆç°¡æ˜“ç‰ˆï¼šå®Ÿéš›ã®è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã«åˆã‚ã›ã¦èª¿æ•´ï¼‰
              return Math.round((sales / (octoberAvg * 1000)) * 100); // ä»®ã®æ›ç®—ç‡
            };

            if (period === 'monthly') {
              // æœˆæ¬¡ãƒ‡ãƒ¼ã‚¿
              const months = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
              labels = months;

              months.forEach(month => {
                const monthBenchmark = benchmarkData.filter(d => d.month === month);
                const avgBenchmark = monthBenchmark.length > 0
                  ? monthBenchmark.reduce((sum, d) => sum + d.base, 0) / monthBenchmark.length
                  : 0;
                const avgImproved = monthBenchmark.length > 0
                  ? monthBenchmark.reduce((sum, d) => sum + d.improvement, 0) / monthBenchmark.length
                  : 0;

                // å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã¯æœˆã”ã¨ã«é›†è¨ˆ
                // å®Ÿéš›ã®å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æœˆã”ã¨ã®å¹³å‡å£²ä¸Šã‚’è¨ˆç®—
                const monthActualSales = result.data
                  .filter(item => {
                    if (!item.date) return false;
                    const date = new Date(item.date);
                    const monthNames = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
                    return monthNames[date.getMonth()] === month;
                  })
                  .reduce((sum, item) => sum + item.grossSales, 0);

                // å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ãŒå°‘ãªã„å ´åˆã¯ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã®90%ã‚’ä½¿ç”¨
                const monthActual = monthActualSales > 0
                  ? normalizeToIndex(monthActualSales)
                  : Math.round(avgBenchmark * 0.9);

                actualData.push(monthActual);
                benchmarkValues.push(Math.round(avgBenchmark));
                improvedValues.push(Math.round(avgImproved));
              });
            } else {
              // é€±æ¬¡ãƒ‡ãƒ¼ã‚¿ï¼ˆç›´è¿‘4é€±ï¼‰
              const now = new Date();
              const yearStart = new Date(now.getFullYear(), 0, 1);
              const daysSinceStart = Math.floor((now - yearStart) / (1000 * 60 * 60 * 24));
              const currentWeek = Math.min(Math.floor(daysSinceStart / 7) + 1, 47);
              const startWeek = Math.max(1, currentWeek - 3);
              const endWeek = currentWeek;

              for (let i = startWeek; i <= endWeek; i++) {
                const weekData = benchmarkData.find(d => d.week === i);
                if (weekData) {
                  labels.push(`W${i} (${weekData.period})`);

                  // å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è©²å½“é€±ã®å£²ä¸Šã‚’å–å¾—ï¼ˆç°¡æ˜“ç‰ˆï¼‰
                  const weekActual = Math.round(weekData.base * 0.9); // ãƒ‡ãƒ¢ç”¨ï¼šå®Ÿéš›ã¯DBã‹ã‚‰å–å¾—

                  actualData.push(weekActual);
                  benchmarkValues.push(weekData.base);
                  improvedValues.push(weekData.improvement);
                }
              }
            }

            initBenchmarkChart(labels, actualData, benchmarkValues, improvedValues);

          } catch (error) {
            console.error('ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚°ãƒ©ãƒ•ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
          } finally {
            if (loadingEl) {
              loadingEl.style.display = 'none';
            }
            if (canvas) {
              canvas.style.opacity = '1';
            }
          }
        }

        // æœŸé–“åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
        periodBtns.forEach(btn => {
          btn.addEventListener('click', () => {
            const period = btn.getAttribute('data-period-benchmark');

            periodBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            currentPeriod = period;
            loadBenchmarkChartData(period);
          });
        });

        // åˆæœŸåŒ–
        loadBenchmarkData().then(() => {
          loadBenchmarkChartData(currentPeriod);
        }).catch((error) => {
          console.error('ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        });
      } catch (benchmarkError) {
        console.error('ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚°ãƒ©ãƒ•ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', benchmarkError);
      }
    })();

    // ====================================
    // ğŸ¯ ç›´è¿‘1ãƒ¶æœˆã®ä¼ç”»ææ¡ˆã‚’ç”Ÿæˆ
    // ====================================
    (function () {
      try {
        async function generateUpcomingPlans() {
          const grid = document.getElementById('upcoming-plans-grid');
          if (!grid) return;

          try {
            const response = await fetch('/api/benchmark/data');
            if (!response.ok) {
              throw new Error('ä¼ç”»ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }

            const result = await response.json();
            if (!result.ok || !result.data) {
              throw new Error('ãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ã§ã™');
            }

            const benchmarkData = result.data;

            // ç¾åœ¨ã®é€±ã‚’è¨ˆç®—ï¼ˆç°¡æ˜“ç‰ˆï¼š1æœˆ1é€±ã‚’åŸºæº–ã«ï¼‰
            const now = new Date();
            const yearStart = new Date(now.getFullYear(), 0, 1);
            const daysSinceStart = Math.floor((now - yearStart) / (1000 * 60 * 60 * 24));
            const currentWeek = Math.min(Math.floor(daysSinceStart / 7) + 1, 47);

            const startWeek = currentWeek;
            const endWeek = Math.min(currentWeek + 3, benchmarkData.length);

            grid.innerHTML = '';

            for (let i = startWeek; i <= endWeek; i++) {
              const data = benchmarkData[i - 1];
              if (!data) continue;

              const improvement = data.improvement - data.base;

              const planItem = document.createElement('div');
              planItem.className = 'plan-item';
              planItem.innerHTML = `
              <div class="plan-week">ç¬¬${data.week}é€±</div>
              <div class="plan-title">
                ${data.period}
                <span class="rank-badge rank-${data.rank.toLowerCase()}">${data.rank}ãƒ©ãƒ³ã‚¯</span>
              </div>
              <div class="plan-description">
                <strong>ä¼ç”»:</strong> ${data.plan}
              </div>
              <div class="plan-metrics">
                <div class="metric">
                  <div class="metric-label">åŸºæœ¬å£²ä¸Š</div>
                  <div class="metric-value">${data.base}</div>
                </div>
                <div class="metric">
                  <div class="metric-label">æ”¹å–„å¾Œ</div>
                  <div class="metric-value">
                    ${data.improvement}
                    <span class="improvement-badge">+${improvement}</span>
                  </div>
                </div>
              </div>
            `;

              grid.appendChild(planItem);
            }
          } catch (error) {
            console.error('ä¼ç”»ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            const grid = document.getElementById('upcoming-plans-grid');
            if (grid) {
              grid.innerHTML = '<p style="text-align:center;color:#fff;">ä¼ç”»ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
            }
          }
        }

        // åˆæœŸåŒ–
        generateUpcomingPlans();
      } catch (planError) {
        console.error('ä¼ç”»ææ¡ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã®åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', planError);
      }
    })();

    // é€±ç•ªå·ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    Date.prototype.getWeek = function () {
      const d = new Date(Date.UTC(this.getFullYear(), this.getMonth(), this.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    };
  </script>
</body>

</html>
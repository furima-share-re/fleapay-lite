<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fleapayï½œå‡ºåº—è€…ç”¨ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>

  <style>
    :root {
      --bg:#f7f7fb;
      --panel:#ffffff;
      --border:#e3e3ef;
      --text:#222222;
      --sub:#555555;
      --muted:#777777;
      --brand:#5a6bff;
      --ok:#1a9b63;
      --warn:#f59e0b;
      --danger:#e11d48;
      --badge:#eef0ff;
    }

    * { box-sizing:border-box; }

    body {
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI","Hiragino Sans","Noto Sans JP",sans-serif;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
    }

    .wrap {
      max-width:720px;
      margin:0 auto;
      padding:12px 12px 64px;
    }

    header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      padding:8px 4px 12px;
    }

    .brand {
      display:flex;
      align-items:center;
      gap:8px;
    }

    .brand-logo {
      width:28px;
      height:28px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 30%, #fff 0, #fff 35%, #5a6bff 100%);
    }

    .brand-title {
      margin:0;
      font-size:1.1rem;
      font-weight:700;
      letter-spacing:.03em;
    }

    .brand-sub {
      font-size:.75rem;
      color:var(--sub);
    }

    .user-chip {
      font-size:.8rem;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      color:var(--sub);
      max-width:50%;
      text-overflow:ellipsis;
      white-space:nowrap;
      overflow:hidden;
    }

    .card {
      background:var(--panel);
      border-radius:16px;
      border:1px solid var(--border);
      padding:14px 14px 16px;
      margin-bottom:12px;
      box-shadow:0 2px 8px rgba(0,0,0,.04);
    }

    .card-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }

    .card-title {
      font-size:.98rem;
      font-weight:700;
    }

    .card-sub {
      font-size:.8rem;
      color:var(--muted);
    }

    .pill {
      font-size:.75rem;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#f9fafb;
      color:var(--sub);
    }

    .kpi-row {
      display:flex;
      gap:8px;
      margin-top:6px;
    }

    .kpi {
      flex:1;
      padding:10px 10px;
      border-radius:12px;
      background:#f9f9ff;
      border:1px solid #e4e6ff;
    }

    .kpi-label {
      font-size:.75rem;
      color:var(--muted);
      margin-bottom:4px;
    }

    .kpi-value {
      font-size:1.2rem;
      font-weight:750;
    }

    .kpi-note {
      font-size:.75rem;
      color:var(--muted);
      margin-top:2px;
    }

    .hint {
      font-size:.78rem;
      color:var(--muted);
      margin-top:4px;
    }

    .list {
      margin:6px 0 0;
      padding:0;
      list-style:none;
    }

    .tx-item {
      padding:8px 0;
      border-bottom:1px solid #f0f0f5;
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:flex-start;
      cursor:pointer;
    }

    .tx-item:last-child {
      border-bottom:none;
    }

    .tx-main {
      flex:1;
    }

    .tx-top {
      display:flex;
      align-items:center;
      gap:6px;
      margin-bottom:2px;
      flex-wrap:wrap;
    }

    .tx-time {
      font-size:.8rem;
      color:var(--muted);
    }

    .tx-title {
      font-size:.9rem;
    }

    .tx-sub {
      font-size:.78rem;
      color:var(--muted);
    }

    .tx-amt {
      font-size:.95rem;
      font-weight:700;
      text-align:right;
      white-space:nowrap;
    }

    .badge {
      font-size:.7rem;
      padding:2px 6px;
      border-radius:999px;
      background:var(--badge);
      color:var(--sub);
      border:1px solid rgba(90,107,255,0.15);
    }

    .badge-ok {
      background:#e6f7f0;
      color:var(--ok);
      border-color:#b6e3c9;
    }

    .badge-refund {
      background:#f3f4f6;
      color:#4b5563;
      border-color:#d1d5db;
    }

    .badge-cb-pending {
      background:#fffbeb;
      color:#92400e;
      border-color:#fbbf24;
    }

    .badge-cb-lost {
      background:#fef2f2;
      color:#b91c1c;
      border-color:#fecaca;
    }

    .tx-detail {
      margin-top:4px;
      font-size:.78rem;
      color:var(--muted);
      display:none;
    }
    .tx-item.expanded .tx-detail { display:block; }

    .notice-item {
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      margin-bottom:8px;
    }

    .notice-title {
      font-size:.9rem;
      font-weight:700;
      margin-bottom:4px;
    }

    .notice-meta {
      font-size:.78rem;
      color:var(--muted);
      margin-bottom:4px;
    }

    .notice-body {
      font-size:.82rem;
      line-height:1.5;
    }

    .notice-important {
      border-left:4px solid var(--warn);
      padding-left:8px;
      background:linear-gradient(to right, rgba(245,158,11,0.05), transparent);
    }

    .field {
      margin-bottom:10px;
    }

    .field-label {
      font-size:.8rem;
      color:var(--sub);
      margin-bottom:4px;
    }

    .field-value {
      font-size:.9rem;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#f9fafb;
    }

    /* è²©å£²ç”»é¢ãƒªãƒ³ã‚¯ï¼†QRè¡¨ç¤º */
    .qr-box{
      margin-top:6px;
      padding:8px 10px;
      border-radius:10px;
      border:1px dashed var(--border);
      background:#f9fafb;
      text-align:center;
    }
    .qr-img{
      width:160px;
      max-width:60%;
      margin:6px auto 4px;
      display:block;
    }
    .qr-url{
      font-size:.78rem;
      word-break:break-all;
      color:var(--sub);
      text-decoration:none;
    }
    .qr-url-btn{
      margin-top:6px;
      font-size:.78rem;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
    }

    .nav {
      position:fixed;
      left:0;
      right:0;
      bottom:0;
      border-top:1px solid #ddddee;
      background:#ffffff;
      display:flex;
      justify-content:space-around;
      padding:6px 0 4px;
      z-index:100;
    }

    .nav-btn {
      flex:1;
      text-align:center;
      font-size:.72rem;
      padding:4px 0;
      color:var(--sub);
      background:none;
      border:none;
      cursor:pointer;
    }

    .nav-btn span {
      display:block;
      margin-top:2px;
    }

    .nav-btn.active {
      color:var(--brand);
      font-weight:700;
    }

    .nav-icon {
      font-size:1.1rem;
    }

    .section {
      display:none;
    }
    .section.active {
      display:block;
    }

    button:focus-visible,
    .nav-btn:focus-visible {
      outline:2px solid var(--brand);
      outline-offset:2px;
      border-radius:999px;
    }

    @media (min-width:768px){
      .wrap { padding:16px 16px 72px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="brand-logo" aria-hidden="true"></div>
        <div>
          <p class="brand-title">Fleapay</p>
          <p class="brand-sub">å‡ºåº—è€…ç”¨ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</p>
        </div>
      </div>
      <div class="user-chip" id="shop-name">å‡ºåº—è€…</div>
    </header>

    <!-- ãƒ›ãƒ¼ãƒ  -->
    <section id="sec-home" class="section active">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">ãã‚‡ã†ã® ã†ã‚Šã‚ã’</div>
            <div class="card-sub" id="today-label">ãã‚‡ã† ã® ã†ã‚Šã‚ã’</div>
          </div>
          <div class="pill">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°</div>
        </div>

        <div class="kpi-row">
          <div class="kpi">
            <div class="kpi-label">å£²ä¸Šåˆè¨ˆï¼ˆè¿”é‡‘ãƒ»ãƒãƒ£ãƒ¼ã‚¸ãƒãƒƒã‚¯åæ˜ å¾Œï¼‰</div>
            <div class="kpi-value" id="kpi-total">Â¥â€”</div>
            <div class="kpi-note">ç´”å£²ä¸Š</div>
          </div>
        </div>

        <div class="kpi-row">
          <div class="kpi">
            <div class="kpi-label">æ±ºæ¸ˆå›æ•°</div>
            <div class="kpi-value" id="kpi-count">â€”ä»¶</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">å¹³å‡å®¢å˜ä¾¡</div>
            <div class="kpi-value" id="kpi-avg">Â¥â€”</div>
          </div>
        </div>

        <div class="hint" id="home-hint">
          å‡ºåº—è€…IDã‹ã‚‰ã€ãã‚‡ã†ã® ã†ã‚Šã‚ã’ ã‚’ ã˜ã£ã•ã„ã® ãƒ‡ãƒ¼ã‚¿ã§ ã²ã‚‡ã†ã˜ã—ã¾ã™ã€‚
        </div>
      </div>

      <!-- ğŸŸ¦ (A) ãƒ‡ãƒ¼ã‚¿ç²¾åº¦ã‚¹ã‚³ã‚¢ ã‚«ãƒ¼ãƒ‰ -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">ãƒ‡ãƒ¼ã‚¿ç²¾åº¦ã‚¹ã‚³ã‚¢</div>
            <div class="card-sub">QRæ±ºæ¸ˆã‚’ä½¿ã†ã»ã©æ­£ç¢ºã«ãªã‚Šã¾ã™</div>
          </div>
        </div>
        <div class="kpi-value" id="data-score">â€”%</div>
        <div class="hint">
          è³¼å…¥è€…ã®å±æ€§æƒ…å ±ãŒå…¥åŠ›ã•ã‚ŒãŸå–å¼•ã®å‰²åˆã§ã™ã€‚QRæ±ºæ¸ˆã‚’ä½¿ã†ã¨è‡ªå‹•ã§è¨˜éŒ²ã•ã‚Œã¾ã™ã€‚
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">ã•ã„ãã‚“ã® ã‘ã£ã•ã„</div>
          <div class="card-sub">3ä»¶ã ã‘ ã²ã‚‡ã†ã˜</div>
        </div>
        <ul class="list" id="recent-list">
          <!-- JSã§å·®ã—è¾¼ã¿ -->
        </ul>
        <div class="hint" id="recent-hint">
          Stripe æ±ºæ¸ˆã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ ã•ã„ã—ã‚“ã® ã‘ã£ã•ã„ ã‚’ ã²ã‚‡ã†ã˜ã—ã¾ã™ã€‚
        </div>
      </div>
    </section>

    <!-- å–å¼•å±¥æ­´ -->
    <section id="sec-tx" class="section">
      <div class="card">
        <div class="card-header">
          <div class="card-title">å–å¼•å±¥æ­´</div>
          <div class="card-sub">ãã‚‡ã† ï¼‹ ã•ã„ãã‚“</div>
        </div>
        <ul class="list" id="tx-list">
          <!-- JSã§å·®ã—è¾¼ã¿ -->
        </ul>
      </div>
    </section>

    <!-- ãŠã—ã‚‰ã›ï¼ˆãƒ€ãƒŸãƒ¼æ–‡è¨€ã®ã¾ã¾ï¼‰ -->
    <section id="sec-notice" class="section">
      <div class="card">
        <div class="card-header">
          <div class="card-title">ãŠã—ã‚‰ã›</div>
          <div class="card-sub">è¿”é‡‘ãƒ»ãƒãƒ£ãƒ¼ã‚¸ãƒãƒƒã‚¯ãªã©</div>
        </div>

        <div class="notice-item notice-important">
          <div class="notice-title">é‡è¦ï¼šãƒãƒ£ãƒ¼ã‚¸ãƒãƒƒã‚¯å¯¾å¿œã¯ Fleapay ãŒ ãŠã“ãªã„ã¾ã™ã€‚</div>
          <div class="notice-meta">å‡ºåº—è€…ã•ã¾ã® æ“ä½œã¯ä¸è¦ã§ã™ã€‚</div>
          <div class="notice-body">
            ã‚«ãƒ¼ãƒ‰ä¼šç¤¾ã‹ã‚‰ã® è¿”é‡‘ãƒ»ãƒãƒ£ãƒ¼ã‚¸ãƒãƒƒã‚¯ã« ã¤ã„ã¦ã¯ã€Fleapayé‹å–¶å´ã§ ã„ã£ã‹ã¤ ã§ å¯¾å¿œã—ã¾ã™ã€‚<br>
            å‡ºåº—è€…ã•ã¾å´ã§ã® ãƒœã‚¿ãƒ³æ“ä½œã‚„ã€ã‚€ãšã‹ã—ã„ ã¦ã¤ã¥ã ã¯ ã‚ã‚Šã¾ã›ã‚“ã€‚
          </div>
        </div>

        <div class="hint">
          è¿”é‡‘ã‚„ãƒãƒ£ãƒ¼ã‚¸ãƒãƒƒã‚¯ãŒç™ºç”Ÿã—ãŸã¨ãã¯ã€ã“ã®ç”»é¢ã‚„ãƒ¡ãƒ¼ãƒ«ãªã©ã§ã€Œçµæœã ã‘ã€ã‚’ãŠçŸ¥ã‚‰ã›ã™ã‚‹è¨­è¨ˆã§ã™ã€‚
        </div>
      </div>
    </section>

    <!-- ãŠåº—æƒ…å ±ï¼ˆå›ºå®šæ–‡è¨€ã®ã¾ã¾ãƒ»ã‚ã¨ã§APIé€£æºã—ã¦ã‚‚OKï¼‰ -->
    <section id="sec-shop" class="section">
      <div class="card">
        <div class="card-header">
          <div class="card-title">ãŠåº—ã® ã˜ã‚‡ã†ã»ã†</div>
          <div class="card-sub">ã‹ã‚“ãŸã‚“ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</div>
        </div>

        <div class="field">
          <div class="field-label">ãŠåº—ã®åå‰</div>
          <div class="field-value" id="shop-display">ï¼ˆã‚ã¨ã§è¨­å®šäºˆå®šï¼‰</div>
        </div>

        <div class="field">
          <div class="field-label">ãƒ¬ã‚·ãƒ¼ãƒˆã® ã²ã‚‡ã†ã˜ ã’ã‚“ã”</div>
          <div class="field-value">è‡ªå‹•ï¼ˆãŠã™ã™ã‚ï¼‰</div>
        </div>

        <div class="field">
          <div class="field-label">è²©å£²ç”»é¢ï¼ˆåº—å“¡ã•ã‚“ç”¨ï¼‰</div>
          <div class="field-value">
            <div class="qr-box">
              <img id="purchase-qr" class="qr-img" alt="è²©å£²ç”»é¢QRã‚³ãƒ¼ãƒ‰" />
              <a id="purchase-url" class="qr-url" href="#" target="_blank" rel="noopener">
                è²©å£²ç”»é¢URL ã‚’ã‚ˆã¿ã“ã¿ä¸­â€¦
              </a>
              <button type="button" class="qr-url-btn" id="copy-purchase-url">
                URLã‚’ã‚³ãƒ”ãƒ¼
              </button>
            </div>
            <div class="hint">
              ã“ã®QRã¯ã€Œè²©å£²ç”»é¢ï¼ˆseller-purchase.htmlï¼‰ã€ã¸ã®å›ºå®šãƒªãƒ³ã‚¯ã§ã™ã€‚<br>
              åº—å“¡ã•ã‚“å°‚ç”¨ã¨ã—ã¦ã€ãƒ¬ã‚¸ç”¨ã‚¹ãƒãƒ›ãªã©ã§èª­ã¿å–ã£ã¦ãã ã•ã„ã€‚
            </div>
          </div>
        </div>

        <div class="hint">
          ãã‚ã—ã„è¨­å®šã‚„ è¿”é‡‘ãƒ»ãƒãƒ£ãƒ¼ã‚¸ãƒãƒƒã‚¯ã®å‡¦ç†ã¯ã€ã™ã¹ã¦Fleapayé‹å–¶ãŒ è¡Œã„ã¾ã™ã€‚
        </div>
      </div>
    </section>
  </div>

  <!-- ãƒœãƒˆãƒ ãƒŠãƒ“ -->
  <nav class="nav" aria-label="ç”»é¢ãã‚Šã‹ãˆ">
    <button class="nav-btn active" data-target="sec-home">
      <div class="nav-icon">ğŸ </div>
      <span>ãƒ›ãƒ¼ãƒ </span>
    </button>
    <button class="nav-btn" data-target="sec-tx">
      <div class="nav-icon">ğŸ“œ</div>
      <span>å–å¼•</span>
    </button>
    <button class="nav-btn" data-target="sec-notice">
      <div class="nav-icon">ğŸ””</div>
      <span>ãŠã—ã‚‰ã›</span>
    </button>
    <button class="nav-btn" data-target="sec-shop">
      <div class="nav-icon">ğŸª</div>
      <span>ãŠåº—</span>
    </button>
  </nav>

  <script>
    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    const navButtons = document.querySelectorAll('.nav-btn');
    const sections   = document.querySelectorAll('.section');

    navButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const targetId = btn.getAttribute('data-target');
        sections.forEach(sec => {
          sec.classList.toggle('active', sec.id === targetId);
        });
        navButtons.forEach(b => b.classList.toggle('active', b === btn));
        window.scrollTo({ top:0, behavior:'instant' });
      });
    });

    // ====== ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”¨APIé€£æº (/api/seller/summary?s=publicId) ======
    (function(){
      const $ = s => document.querySelector(s);
      const params = new URLSearchParams(location.search);
      const sellerId = params.get("s") || "";

      const shopNameEl   = $("#shop-name");
      const shopDisplayEl= $("#shop-display");
      const todayLabelEl = $("#today-label");
      const kpiTotalEl   = $("#kpi-total");
      const kpiCountEl   = $("#kpi-count");
      const kpiAvgEl     = $("#kpi-avg");
      const homeHintEl   = $("#home-hint");
      const recentListEl = $("#recent-list");
      const recentHintEl = $("#recent-hint");
      const txListEl     = $("#tx-list");
      const purchaseUrlEl = $("#purchase-url");
      const purchaseQrEl  = $("#purchase-qr");
      const copyBtnEl     = $("#copy-purchase-url");
      
      // ğŸŸ¦ (A) ãƒ‡ãƒ¼ã‚¿ç²¾åº¦ã‚¹ã‚³ã‚¢ç”¨ã®è¦ç´ 
      const dataScoreEl  = $("#data-score");

      function formatYen(n){
        if (!Number.isFinite(n)) return "Â¥â€”";
        return "Â¥" + n.toLocaleString("ja-JP");
      }

      function formatTime(date){
        return date.toLocaleTimeString("ja-JP",{ hour:"2-digit", minute:"2-digit" });
      }

      function formatDateJp(date){
        const w = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"][date.getDay()];
        return `${date.getFullYear()}å¹´${date.getMonth()+1}æœˆ${date.getDate()}æ—¥ï¼ˆ${w}ï¼‰`;
      }

      // è³¼å…¥è€…å±æ€§ãƒ©ãƒ™ãƒ«ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
      function formatBuyerLabel(tx){
        const buyer = tx.buyer;
        
        // ğŸŸ¦ (C) ç¾é‡‘ã§å±æ€§æœªå…¥åŠ›ã®å ´åˆ
        if (tx.is_cash && !tx.raw_category) {
          return "ï¼ˆç¾é‡‘ï¼šè¿½åŠ æƒ…å ±æœªå…¥åŠ›ï¼‰";
        }
        
        if (!buyer) return "è³¼å…¥è€…æƒ…å ±ï¼šæœªå…¥åŠ›";

        const typeLabel =
          buyer.customer_type === "inbound" ? "å¤–å›½ã®ã²ã¨" :
          buyer.customer_type === "domestic" ? "æ—¥æœ¬ã®ã²ã¨" :
          "";
        const genderLabel =
          buyer.gender === "male" ? "ç”·æ€§" :
          buyer.gender === "female" ? "å¥³æ€§" :
          "æ€§åˆ¥ ä¸æ˜";
        const ageLabel =
          buyer.age_band === "child" ? "ã“ã©ã‚‚" :
          buyer.age_band === "age_16_29" ? "16ã€œ29" :
          buyer.age_band === "age_30_59" ? "30ã€œ59" :
          buyer.age_band === "age_60_plus" ? "60+" :
          "å¹´é½¢ ä¸æ˜";

        if (typeLabel){
          return `${typeLabel} / ${genderLabel} / ${ageLabel}`;
        }
        return "è³¼å…¥è€…æƒ…å ±ï¼šæœªå…¥åŠ›";
      }

      async function loadSummary(){
        if (!sellerId){
          if (homeHintEl) homeHintEl.textContent = "URLã« ?s=å‡ºåº—è€…ID ãŒ ã²ã¤ã‚ˆã†ã§ã™ã€‚";
          return;
        }

        try{
          const res = await fetch(`/api/seller/summary?s=${encodeURIComponent(sellerId)}`);
          const data = await res.json();

          if (!res.ok){
            console.error("summary error", data);
            if (homeHintEl) homeHintEl.textContent = "å£²ä¸Šãƒ‡ãƒ¼ã‚¿å–å¾—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
            return;
          }

          // è²©å£²ç”»é¢URLï¼ˆå®Ÿãƒ•ã‚¡ã‚¤ãƒ«ã«åˆã‚ã›ã¦ä¿®æ­£ï¼‰
          const baseUrl = `${location.origin.replace(/\/$/,"")}/seller-purchase.html`;

          // æœ«å°¾ã® ?s=ID ã‚’ä»˜ã‘ã‚‹
          const purchaseUrl = sellerId
            ? `${baseUrl}?s=${encodeURIComponent(sellerId)}`
            : baseUrl;

          // URLãƒªãƒ³ã‚¯
          if (purchaseUrlEl){
            purchaseUrlEl.textContent = purchaseUrl;
            purchaseUrlEl.href = purchaseUrl;
          }

          // QRç”Ÿæˆ
          if (purchaseQrEl){
            const qrApi = "https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=";
            purchaseQrEl.src = qrApi + encodeURIComponent(purchaseUrl);
          }

          // ã‚³ãƒ”ãƒ¼ ãƒœã‚¿ãƒ³
          if (copyBtnEl){
            copyBtnEl.onclick = () => {
              navigator.clipboard?.writeText(purchaseUrl).then(()=>{
                alert("è²©å£²ç”»é¢ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
              }).catch(()=>{
                alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚");
              });
            };
          }

          // åº—å
          if (shopNameEl)   shopNameEl.textContent   = data.displayName || data.sellerId || "å‡ºåº—è€…";
          if (shopDisplayEl)shopDisplayEl.textContent= data.displayName || data.sellerId || "å‡ºåº—è€…";

          // ãã‚‡ã†ã®æ—¥ä»˜
          const nowJst = new Date(new Date().toLocaleString("en-US",{ timeZone:"Asia/Tokyo" }));
          if (todayLabelEl) todayLabelEl.textContent = formatDateJp(nowJst) + " ã® ã†ã‚Šã‚ã’";

          // KPIï¼ˆç´”å£²ä¸Šï¼‰
          const total = Number(data.salesToday || 0);
          const count = Number(data.countToday || 0);
          const avg   = Number(data.avgToday || 0);
          if (kpiTotalEl) kpiTotalEl.textContent = formatYen(total);
          if (kpiCountEl) kpiCountEl.textContent = `${count}ä»¶`;
          if (kpiAvgEl)   kpiAvgEl.textContent   = formatYen(avg || 0);

          // ğŸŸ¦ (A) ãƒ‡ãƒ¼ã‚¿ç²¾åº¦ã‚¹ã‚³ã‚¢ã®è¡¨ç¤º
          if (dataScoreEl && data.dataScore !== undefined) {
            dataScoreEl.textContent = data.dataScore + "%";
          }

          if (homeHintEl) {
            if (count === 0) {
              homeHintEl.textContent = "ãã‚‡ã†ã® ã‘ã£ã•ã„ ã¯ ã¾ã  ã‚ã‚Šã¾ã›ã‚“ã€‚ã•ã„ã—ã‚‡ã® 1ä»¶ã‚’ ãŠå¾…ã¡ã—ã¦ã„ã¾ã™ã€‚";
            } else {
              homeHintEl.textContent = "ãã‚‡ã†ã® ã†ã‚Šã‚ã’ ã‚’ Stripe ã® ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ ã²ã‚‡ã†ã˜ä¸­ã§ã™ã€‚";
            }
          }

          // ã•ã„ãã‚“ã®æ±ºæ¸ˆï¼ˆ3ä»¶ã¾ã§ï¼‰
          const recent = (data.recent || []).slice(0,3);
          if (recentListEl){
            recentListEl.innerHTML = "";
            if (recent.length === 0){
              const li = document.createElement("li");
              li.className = "tx-item";
              li.innerHTML = `
                <div class="tx-main">
                  <div class="tx-title">ã¾ã  ã‘ã£ã•ã„ ã¯ ã‚ã‚Šã¾ã›ã‚“</div>
                  <div class="tx-sub">ãƒ†ã‚¹ãƒˆæ±ºæ¸ˆãŒã‚ã‚‹ã¨ ã“ã“ã« ã²ã‚‡ã†ã˜ã•ã‚Œã¾ã™ã€‚</div>
                </div>
              `;
              recentListEl.appendChild(li);
            } else {
              for (const tx of recent){
                const li = document.createElement("li");
                li.className = "tx-item";
                const created = tx.created ? new Date(tx.created * 1000) : null;
                const timeStr = created ? formatTime(created) : "";
                const summary = (tx.summary || "å•†å“ã®ãŠã‹ã„ã‚‚ã®").split("\n")[0];

                // ğŸŸ¦ (B) æœªåˆ†é¡ãƒ•ã‚©ãƒ«ãƒ€è¡¨ç¤º
                const isUncategorized = tx.is_cash && !tx.raw_category;
                const uncategorizedBadge = isUncategorized
                  ? '<span class="badge badge-cb-pending">æœªåˆ†é¡</span>'
                  : '';

                // è³¼å…¥è€…å±æ€§ã®ãƒ©ãƒ™ãƒ«ã‚’ç”Ÿæˆ
                const buyerLabel = formatBuyerLabel(tx);

                li.innerHTML = `
                  <div class="tx-main">
                    <div class="tx-top">
                      <span class="badge badge-ok">é€šå¸¸</span>
                      ${uncategorizedBadge}
                      <span class="tx-time">${timeStr}</span>
                    </div>
                    <div class="tx-title">${summary}</div>
                    <div class="tx-sub">${buyerLabel}</div>
                    <div class="tx-detail">
                      ${tx.summary ? tx.summary.replace(/\n/g,"<br>") : ""}
                    </div>
                  </div>
                  <div class="tx-amt">${formatYen(tx.net_amount ?? tx.amount)}</div>
                `;
                li.addEventListener("click", () => {
                  li.classList.toggle("expanded");
                });
                recentListEl.appendChild(li);
              }
            }
          }

          if (recentHintEl) {
            recentHintEl.textContent = "Stripe ã®ãƒ†ã‚¹ãƒˆæ±ºæ¸ˆãŒ ã•ã„ã—ã‚“3ä»¶ã¾ã§ ã²ã‚‡ã†ã˜ã•ã‚Œã¾ã™ã€‚";
          }

          // å–å¼•å±¥æ­´ï¼ˆæœ€å¤§20ä»¶ï¼‰
          if (txListEl){
            txListEl.innerHTML = "";
            const list = data.recent || [];
            if (!list.length){
              const li = document.createElement("li");
              li.className = "tx-item";
              li.innerHTML = `
                <div class="tx-main">
                  <div class="tx-title">ã¾ã  å–å¼•ãŒã‚ã‚Šã¾ã›ã‚“</div>
                  <div class="tx-sub">ãã‚‡ã†ã®æ±ºæ¸ˆã‚„ ã•ã„ãã‚“ã®æ±ºæ¸ˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
                </div>
              `;
              txListEl.appendChild(li);
            } else {
              for (const tx of list){
                const li = document.createElement("li");
                li.className = "tx-item";
                const created = tx.created ? new Date(tx.created * 1000) : null;
                const timeStr = created ? formatTime(created) : "";
                const dateStr = created
                  ? `${created.getFullYear()}-${String(created.getMonth()+1).padStart(2,"0")}-${String(created.getDate()).padStart(2,"0")}`
                  : "";
                const summary = (tx.summary || "å•†å“ã®ãŠã‹ã„ã‚‚ã®").replace(/\n/g," / ");

                // ğŸŸ¦ (B) æœªåˆ†é¡ãƒ•ã‚©ãƒ«ãƒ€è¡¨ç¤º
                const isUncategorized = tx.is_cash && !tx.raw_category;
                const uncategorizedBadge = isUncategorized
                  ? '<span class="badge badge-cb-pending">æœªåˆ†é¡</span>'
                  : '';

                // è³¼å…¥è€…å±æ€§ã®ãƒ©ãƒ™ãƒ«ã‚’ç”Ÿæˆ
                const buyerLabel = formatBuyerLabel(tx);

                li.innerHTML = `
                  <div class="tx-main">
                    <div class="tx-top">
                      <span class="badge badge-ok">${tx.status || "é€šå¸¸"}</span>
                      ${uncategorizedBadge}
                      <span class="tx-time">${timeStr} / ${dateStr}</span>
                    </div>
                    <div class="tx-title">${summary}</div>
                    <div class="tx-sub">${buyerLabel}</div>
                    <div class="tx-detail">
                      é‡‘é¡ï¼š${formatYen(tx.amount)} / ç´”å£²ä¸Šï¼š${formatYen(tx.net_amount)}<br>
                      ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼š${tx.status}
                    </div>
                  </div>
                  <div class="tx-amt">${formatYen(tx.net_amount ?? tx.amount)}</div>
                `;
                li.addEventListener("click", () => {
                  li.classList.toggle("expanded");
                });
                txListEl.appendChild(li);
              }
            }
          }

        } catch (e){
          console.error("loadSummary error", e);
          if (homeHintEl) homeHintEl.textContent = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
        }
      }

      loadSummary();
    })();
  </script>
</body>
</html>
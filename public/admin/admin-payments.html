<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>æ±ºæ¸ˆãƒ»ãƒãƒ£ãƒ¼ã‚¸ãƒãƒƒã‚¯ç®¡ç† | Fleapay Admin</title>
  
  <meta name="robots" content="noindex,nofollow">
  <meta http-equiv="Cache-Control" content="no-store">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
  
  <link rel="stylesheet" href="common/admin-base.css">
  <script src="common/admin-utils.js"></script>
  
  <!-- ğŸŸ¢ èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³åˆæœŸåŒ– -->
  <script>
    (function() {
      const token = localStorage.getItem("ADMIN_TOKEN");
      const tokenExpiry = localStorage.getItem("ADMIN_TOKEN_EXPIRY");
      
      if (!token || (tokenExpiry && Date.now() > parseInt(tokenExpiry))) {
        localStorage.removeItem("ADMIN_TOKEN");
        localStorage.removeItem("ADMIN_TOKEN_EXPIRY");
        console.warn('âš ï¸ ADMIN_TOKEN ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚é–‹ç™ºç’°å¢ƒã§ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚');
        window.ADMIN_TOKEN = 'admin-devtoken';
      } else {
        window.ADMIN_TOKEN = token;
      }
    })();
  </script>
  
  <style>
    .payment-status {
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }
    
    .payment-normal { background: #f0f9f4; color: var(--success-green); }
    .payment-refunded { background: #f0f2f5; color: var(--fleapay-gray); }
    .payment-disputed { background: #fef9e7; color: var(--warning-amber); }
    .payment-lost { background: #fef2f2; color: var(--error-maroon); }
    
    .deadline-urgent {
      color: var(--error-maroon);
      font-weight: 600;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    .error-banner {
      background: #fef2f2;
      border-left: 4px solid var(--error-maroon);
      padding: 12px 16px;
      margin: 16px 0;
      border-radius: 8px;
      display: none;
    }
    
    .error-banner.show {
      display: block;
    }
  </style>
</head>
<body>
  <header class="admin-header">
    <div class="admin-logo">
      ğŸª¶ Fleapay Admin
      <span class="env-badge">ENV</span>
    </div>
    <div style="font-size: 13px; color: var(--fleapay-gray);">
      <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="cdaca9a0a4a38daba1a8acbdacb4e3a7bd">[email&#160;protected]</a> â–¼
    </div>
  </header>

  <div class="admin-container">
    <nav class="admin-sidebar">
      <ul class="nav-menu">
        <li><a href="admin-dashboard.html" class="nav-item">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a></li>
        <li><a href="admin-sellers.html" class="nav-item">ğŸ‘¥ å‡ºåº—è€…</a></li>
        <li><a href="admin-frames.html" class="nav-item">ğŸ¨ AIãƒ•ãƒ¬ãƒ¼ãƒ </a></li>
        <li><a href="admin-payments.html" class="nav-item active">ğŸ’³ æ±ºæ¸ˆãƒ»CBç®¡ç†</a></li>
      </ul>
    </nav>

    <main class="admin-content">
      <div id="errorBanner" class="error-banner">
        <strong>âš ï¸ ã‚¨ãƒ©ãƒ¼:</strong> <span id="errorMessage"></span>
      </div>
      
      <section>
        <div class="sec-title-row">
          <h1>æ±ºæ¸ˆãƒ»ãƒãƒ£ãƒ¼ã‚¸ãƒãƒƒã‚¯ç®¡ç†</h1>
          <button id="syncPaymentsBtn" class="ghost">ğŸ”„ StripeåŒæœŸ</button>
        </div>
        
        <div class="flex flex-wrap" style="margin-bottom: 20px; gap: 12px;">
          <select id="periodFilter" style="max-width: 120px; padding: 8px; border-radius: 8px;">
            <option value="today">ä»Šæ—¥</option>
            <option value="week">ä»Šé€±</option>
            <option value="month">ä»Šæœˆ</option>
            <option value="all">å…¨æœŸé–“</option>
          </select>
          <select id="typeFilter" style="max-width: 150px; padding: 8px; border-radius: 8px;">
            <option value="">å…¨ç¨®åˆ¥</option>
            <option value="succeeded">é€šå¸¸æ±ºæ¸ˆ</option>
            <option value="refunded">è¿”é‡‘</option>
            <option value="disputed">ãƒãƒ£ãƒ¼ã‚¸ãƒãƒƒã‚¯</option>
          </select>
          <input type="text" id="searchInput" placeholder="Stripe IDãƒ»é‡‘é¡ã§æ¤œç´¢" 
                 style="max-width: 200px; padding: 8px; border-radius: 8px;">
          <button id="searchBtn" class="ghost">ğŸ” æ¤œç´¢</button>
        </div>
      </section>

      <!-- âœ… ä¿®æ­£: ç·æ±ºæ¸ˆé¡ã‚’è¿½åŠ  -->
      <div class="grid grid-3">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">ä»Šæ—¥ã®æ±ºæ¸ˆ</h3>
          </div>
          <div class="card-metric">
            <span id="todayPayments">0</span><span class="card-metric-small">ä»¶</span>
          </div>
          <p class="card-subtitle">
            ç·æ±ºæ¸ˆé¡: <span id="todayGross">Â¥0</span><br>
            ç´”å£²ä¸Š: <span id="todayRevenue">Â¥0</span>
          </p>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">ãƒãƒ£ãƒ¼ã‚¸ãƒãƒƒã‚¯</h3>
          </div>
          <div class="card-metric" style="color: var(--warning-amber);">
            <span id="activeDisputes">0</span><span class="card-metric-small">ä»¶</span>
          </div>
          <p class="card-subtitle">
            æœŸé™é–“è¿‘: <span id="urgentDisputes" class="deadline-urgent">0ä»¶</span>
          </p>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">è¿”é‡‘</h3>
          </div>
          <div class="card-metric" style="color: var(--fleapay-gray);">
            <span id="refundCount">0</span><span class="card-metric-small">ä»¶</span>
          </div>
          <p class="card-subtitle">
            è¿”é‡‘é¡: <span id="refundAmount">Â¥0</span>
          </p>
        </div>
      </div>

      <section>
        <div class="sec-title-row">
          <h2>æ±ºæ¸ˆå±¥æ­´</h2>
          <span class="pill" id="totalCount">0ä»¶</span>
        </div>
        
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>æ—¥æ™‚</th>
                <th>å‡ºåº—è€…</th>
                <th>é‡‘é¡</th>
                <th>çŠ¶æ…‹</th>
                <th>Stripe ID</th>
                <th>æœŸé™</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="paymentsTableBody">
              <tr>
                <td colspan="7" class="empty-state">èª­ã¿è¾¼ã¿ä¸­...</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div id="loadingIndicator" class="loading-indicator" style="display: none;">
          èª­ã¿è¾¼ã¿ä¸­...
        </div>
      </section>

      <!-- âœ… ä¿®æ­£: é‡‘é¡è©³ç´°ã‚’è¿½åŠ  -->
      <div id="paymentModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
          <div class="modal-header">
            <h2 id="modalTitle">å–å¼•è©³ç´°</h2>
            <button id="closeModal" class="modal-close">Ã—</button>
          </div>
          
          <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px;">
            <div>
              <div class="card" style="margin-bottom: 16px;">
                <h3>åŸºæœ¬æƒ…å ±</h3>
                <div class="grid">
                  <div>
                    <strong>æ—¥æ™‚:</strong>
                    <p id="paymentDate">-</p>
                  </div>
                  <div>
                    <strong>å‡ºåº—è€…:</strong>
                    <p id="paymentSeller">-</p>
                  </div>
                </div>
                <div class="grid">
                  <div>
                    <strong>ç¾åœ¨ã®çŠ¶æ…‹:</strong>
                    <p id="paymentStatus">-</p>
                  </div>
                </div>
              </div>

              <div class="card" style="margin-bottom: 16px;">
                <h3>é‡‘é¡è©³ç´°</h3>
                <div class="grid">
                  <div>
                    <strong>ç·é¡:</strong>
                    <p id="amountGross" style="font-weight: 600;">-</p>
                  </div>
                  <div>
                    <strong>æ‰‹æ•°æ–™:</strong>
                    <p id="amountFee">-</p>
                  </div>
                  <div>
                    <strong>ç´”å£²ä¸Š:</strong>
                    <p id="amountNet" style="font-weight: 600; color: var(--fleapay-blue);">-</p>
                  </div>
                </div>
              </div>

              <div class="card" style="margin-bottom: 16px;">
                <h3>Stripeæƒ…å ±</h3>
                <div class="grid">
                  <div>
                    <strong>PaymentIntent:</strong>
                    <p id="paymentIntentId" style="font-family: monospace; font-size: 12px;">-</p>
                  </div>
                  <div>
                    <strong>Charge:</strong>
                    <p id="chargeId" style="font-family: monospace; font-size: 12px;">-</p>
                  </div>
                </div>
                <button id="openStripeBtn" class="small ghost" style="margin-top: 8px;">
                  Stripeãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§é–‹ã
                </button>
              </div>

              <div class="card" style="margin-bottom: 16px;">
                <h3>å¯¾å¿œãƒ¡ãƒ¢ï¼ˆé‹å–¶å†…éƒ¨ç”¨ï¼‰</h3>
                <textarea id="internalMemo" rows="4" placeholder="å¯¾å¿œå†…å®¹ãƒ»ãƒ¡ãƒ¢ã‚’å…¥åŠ›..." 
                          style="width: 100%; padding: 8px; border-radius: 8px;"></textarea>
                <button id="saveMemoBtn" class="small" style="margin-top: 8px;">ãƒ¡ãƒ¢ã‚’ä¿å­˜</button>
              </div>
            </div>
            
            <div>
              <div class="card" style="margin-bottom: 16px;">
                <h3>æ“ä½œ</h3>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                  <button id="refundBtn" class="warning" style="border-radius: 8px;">
                    è¿”é‡‘å‡¦ç†
                  </button>
                  <button id="generateEvidenceBtn" class="ghost" style="border-radius: 8px;">
                    ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹è‡ªå‹•ç”Ÿæˆ
                  </button>
                  <button id="submitEvidenceBtn" class="ghost" style="border-radius: 8px;">
                    ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹é€ä¿¡æ¸ˆã¿ã«ã™ã‚‹
                  </button>
                  <hr style="margin: 12px 0; border: none; border-top: 1px solid #e5e7eb;">
                  <button id="deleteOrderBtn" class="ghost" style="border-radius: 8px; color: var(--error-maroon); border-color: var(--error-maroon);">
                    ğŸ—‘ï¸ å–å¼•ã‚’å‰Šé™¤
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <div id="modalMessage" style="display: none; margin-top: 16px;"></div>
        </div>
      </div>
    </main>
  </div>

  <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="js/admin-payments.js"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const currentPage = window.location.pathname.split('/').pop();
      document.querySelectorAll('.nav-item').forEach(item => {
        if (item.getAttribute('href') === currentPage) {
          item.classList.add('active');
        }
      });
    });
  </script>
</body>
</html>

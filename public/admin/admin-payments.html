<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>æ±ºæ¸ˆãƒ»ãƒãƒ£ãƒ¼ã‚¸ãƒãƒƒã‚¯ç®¡ç† | Fleapay Admin</title>
  
  <meta name="robots" content="noindex,nofollow">
  <meta http-equiv="Cache-Control" content="no-store">
  <meta http-equiv="X-Frame-Options" content="DENY">
  
  <link rel="stylesheet" href="common/admin-base.css">
  <script src="common/admin-utils.js"></script>
  
  <style>
    .payment-status {
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }
    
    .payment-normal { background: #f0f9f4; color: var(--success-green); }
    .payment-refunded { background: #f0f2f5; color: var(--fleapay-gray); }
    .payment-disputed { background: #fef9e7; color: var(--warning-amber); }
    .payment-lost { background: #fef2f2; color: var(--error-maroon); }
    
    .deadline-urgent {
      color: var(--error-maroon);
      font-weight: 600;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
  </style>
</head>
<body>
  <header class="admin-header">
    <div class="admin-logo">
      ğŸª¶ Fleapay Admin
      <span class="env-badge">ENV</span>
    </div>
    <div style="font-size: 13px; color: var(--fleapay-gray);">
      <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="5c3d383135321c3a30393d2c3d2572362c">[email&#160;protected]</a> â–¼
    </div>
  </header>

  <div class="admin-container">
    <nav class="admin-sidebar">
      <ul class="nav-menu">
        <li><a href="admin-dashboard.html" class="nav-item" data-page="dashboard">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a></li>
        <li><a href="admin-sellers.html" class="nav-item" data-page="sellers">ğŸ‘¥ å‡ºåº—è€…</a></li>
        <li><a href="admin-frames.html" class="nav-item" data-page="frames">ğŸ¨ AIãƒ•ãƒ¬ãƒ¼ãƒ </a></li>
        <li><a href="admin-payments.html" class="nav-item" data-page="payments">ğŸ’³ æ±ºæ¸ˆãƒ»CBç®¡ç†</a></li>
      </ul>
    </nav>

    <main class="admin-content">
      <section>
        <div class="sec-title-row">
          <h1>æ±ºæ¸ˆãƒ»ãƒãƒ£ãƒ¼ã‚¸ãƒãƒƒã‚¯ç®¡ç†</h1>
          <button id="syncPaymentsBtn" class="ghost">ğŸ”„ StripeåŒæœŸ</button>
        </div>
        
        <div class="flex flex-wrap" style="margin-bottom: 20px;">
          <select id="periodFilter" style="max-width: 120px;">
            <option value="today">ä»Šæ—¥</option>
            <option value="week">ä»Šé€±</option>
            <option value="month">ä»Šæœˆ</option>
            <option value="all">å…¨æœŸé–“</option>
          </select>
          <select id="typeFilter" style="max-width: 150px;">
            <option value="">å…¨ç¨®åˆ¥</option>
            <option value="payment">é€šå¸¸æ±ºæ¸ˆ</option>
            <option value="refund">è¿”é‡‘</option>
            <option value="dispute">ãƒãƒ£ãƒ¼ã‚¸ãƒãƒƒã‚¯</option>
          </select>
          <input type="text" id="searchInput" placeholder="Stripe IDãƒ»é‡‘é¡ã§æ¤œç´¢" style="max-width: 200px;">
          <button id="searchBtn" class="ghost">ğŸ” æ¤œç´¢</button>
        </div>
      </section>

      <!-- ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ -->
      <div class="grid grid-3">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">ä»Šæ—¥ã®æ±ºæ¸ˆ</h3>
          </div>
          <div class="card-metric">
            <span id="todayPayments">0</span><span class="card-metric-small">ä»¶</span>
          </div>
          <p class="card-subtitle">
            ç´”å£²ä¸Š: <span id="todayRevenue">Â¥0</span>
          </p>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">ãƒãƒ£ãƒ¼ã‚¸ãƒãƒƒã‚¯</h3>
          </div>
          <div class="card-metric" style="color: var(--warning-amber);">
            <span id="activeDisputes">0</span><span class="card-metric-small">ä»¶</span>
          </div>
          <p class="card-subtitle">
            æœŸé™é–“è¿‘: <span id="urgentDisputes" class="deadline-urgent">0ä»¶</span>
          </p>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">è¿”é‡‘</h3>
          </div>
          <div class="card-metric" style="color: var(--fleapay-gray);">
            <span id="refundCount">0</span><span class="card-metric-small">ä»¶</span>
          </div>
          <p class="card-subtitle">
            è¿”é‡‘é¡: <span id="refundAmount">Â¥0</span>
          </p>
        </div>
      </div>

      <!-- ä»Šæ—¥ã®æ±ºæ¸ˆ -->
      <section>
        <p>
          <span>ä»Šæ—¥ã®æ±ºæ¸ˆ</span>
          <span data-field="today-payments-count">0ä»¶</span>
        </p>

        <p>
          <span>ç´”å£²ä¸Š:</span>
          <span data-field="today-net-sales">Â¥0</span>
        </p>

        <!-- ãƒãƒ£ãƒ¼ã‚¸ãƒãƒƒã‚¯ -->
        <p>
          <span>ãƒãƒ£ãƒ¼ã‚¸ãƒãƒƒã‚¯</span>
          <span data-field="dispute-count">0ä»¶</span>
        </p>

        <!-- è¿”é‡‘ -->
        <p>
          <span>è¿”é‡‘</span>
          <span data-field="refund-count">0ä»¶</span><br>
          <span>è¿”é‡‘é¡:</span>
          <span data-field="refund-amount">Â¥0</span>
        </p>

        <!-- StripeåŒæœŸãƒœã‚¿ãƒ³ -->
        <button type="button" class="btn btn-primary" data-action="stripe-sync">
          StripeåŒæœŸ
        </button>
      </section>

      <!-- æ±ºæ¸ˆä¸€è¦§ -->
      <section>
        <div class="sec-title-row">
          <h2>æ±ºæ¸ˆå±¥æ­´</h2>
          <span class="pill" id="totalCount">0ä»¶</span>
        </div>
        
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>æ—¥æ™‚</th>
                <th>å‡ºåº—è€…</th>
                <th>é‡‘é¡</th>
                <th>çŠ¶æ…‹</th>
                <th>Stripe ID</th>
                <th>æœŸé™</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="paymentsTableBody">
              <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
            </tbody>
          </table>
        </div>
        
        <div id="loadingIndicator" class="loading-indicator" style="display: none;">
          èª­ã¿è¾¼ã¿ä¸­...
        </div>
      </section>

      <!-- æ±ºæ¸ˆè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
      <div id="paymentModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
          <div class="modal-header">
            <h2 id="modalTitle">å–å¼•è©³ç´°</h2>
            <button id="closeModal" class="modal-close">Ã—</button>
          </div>
          
          <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px;">
            <!-- å·¦å´ï¼šè©³ç´°æƒ…å ± -->
            <div>
              <div class="card" style="margin-bottom: 16px;">
                <h3>åŸºæœ¬æƒ…å ±</h3>
                <div class="grid">
                  <div>
                    <strong>æ—¥æ™‚:</strong>
                    <p id="paymentDate">-</p>
                  </div>
                  <div>
                    <strong>é‡‘é¡:</strong>
                    <p id="paymentAmount" style="font-weight: 600; color: var(--fleapay-blue);">-</p>
                  </div>
                </div>
                <div class="grid">
                  <div>
                    <strong>å‡ºåº—è€…:</strong>
                    <p id="paymentSeller">-</p>
                  </div>
                  <div>
                    <strong>ç¾åœ¨ã®çŠ¶æ…‹:</strong>
                    <p id="paymentStatus">-</p>
                  </div>
                </div>
              </div>

              <div class="card" style="margin-bottom: 16px;">
                <h3>Stripeæƒ…å ±</h3>
                <div class="grid">
                  <div>
                    <strong>PaymentIntent:</strong>
                    <p id="paymentIntentId" style="font-family: monospace; font-size: 12px;">-</p>
                  </div>
                  <div>
                    <strong>Charge:</strong>
                    <p id="chargeId" style="font-family: monospace; font-size: 12px;">-</p>
                  </div>
                </div>
                <button id="openStripeBtn" class="small ghost" style="margin-top: 8px;">
                  Stripeãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§é–‹ã
                </button>
              </div>

              <div class="card" style="margin-bottom: 16px;">
                <h3>å¯¾å¿œãƒ¡ãƒ¢ï¼ˆé‹å–¶å†…éƒ¨ç”¨ï¼‰</h3>
                <textarea id="internalMemo" rows="4" placeholder="å¯¾å¿œå†…å®¹ãƒ»ãƒ¡ãƒ¢ã‚’å…¥åŠ›..." style="width: 100%;"></textarea>
                <button id="saveMemoBtn" class="small" style="margin-top: 8px;">ãƒ¡ãƒ¢ã‚’ä¿å­˜</button>
              </div>
            </div>
            
            <!-- å³å´ï¼šæ“ä½œãƒ‘ãƒãƒ« -->
            <div>
              <div class="card" style="margin-bottom: 16px;">
                <h3>æ“ä½œ</h3>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                  <button id="refundBtn" class="warning" style="border-radius: 8px;">
                    è¿”é‡‘å‡¦ç†
                  </button>
                  <button id="generateEvidenceBtn" class="ghost" style="border-radius: 8px;">
                    ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹è‡ªå‹•ç”Ÿæˆ
                  </button>
                  <button id="submitEvidenceBtn" class="ghost" style="border-radius: 8px;">
                    ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹é€ä¿¡æ¸ˆã¿ã«ã™ã‚‹
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <div id="modalMessage" style="display: none; margin-top: 16px;"></div>
        </div>
      </div>
    </main>
  </div>

  <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
    let payments = [];
    let currentPayment = null;
    let currentFilters = {};

    document.addEventListener('DOMContentLoaded', async () => {
      await loadPayments();
      setupEventListeners();
      handleHashNavigation();
    });

    async function loadPayments(filters = {}) {
      const loadingIndicator = document.getElementById('loadingIndicator');
      loadingIndicator.style.display = 'block';
      
      try {
        const queryParams = new URLSearchParams(filters).toString();
        const data = await adminAPI.request(`/admin/payments${queryParams ? '?' + queryParams : ''}`);
        
        payments = data.payments || [];
        currentFilters = filters;
        updateSummary(data.summary || {});
        renderPaymentsTable();
      } catch (error) {
        adminUI.showToast('æ±ºæ¸ˆãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        loadMockPayments(); // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      } finally {
        loadingIndicator.style.display = 'none';
      }
    }

    function loadMockPayments() {
      const mockData = {
        payments: [
          {
            id: 'pi_3P1234567890123456',
            created: '2025-11-13T12:03:00Z',
            amount: 1500,
            status: 'succeeded',
            seller: { publicId: 'seller-abc123', displayName: 'èŠ±å­å•†åº—' },
            stripeIds: {
              paymentIntent: 'pi_3P1234567890123456',
              charge: 'ch_3P1234567890123456'
            },
            type: 'payment'
          }
        ],
        summary: {
          todayPayments: 45,
          todayRevenue: 125000,
          activeDisputes: 2,
          urgentDisputes: 1,
          refundCount: 3,
          refundAmount: 8500
        }
      };
      
      payments = mockData.payments;
      updateSummary(mockData.summary);
      renderPaymentsTable();
    }

    function updateSummary(summary) {
      document.getElementById('todayPayments').textContent = adminUI.formatNumber(summary.todayPayments || 0);
      document.getElementById('todayRevenue').textContent = adminUI.formatCurrency(summary.todayRevenue || 0);
      document.getElementById('activeDisputes').textContent = adminUI.formatNumber(summary.activeDisputes || 0);
      document.getElementById('urgentDisputes').textContent = adminUI.formatNumber(summary.urgentDisputes || 0) + 'ä»¶';
      document.getElementById('refundCount').textContent = adminUI.formatNumber(summary.refundCount || 0);
      document.getElementById('refundAmount').textContent = adminUI.formatCurrency(summary.refundAmount || 0);
    }

    function renderPaymentsTable() {
      const tbody = document.getElementById('paymentsTableBody');
      document.getElementById('totalCount').textContent = `${payments.length}ä»¶`;
      
      if (payments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty-state">æ±ºæ¸ˆãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</td></tr>';
        return;
      }
      
      tbody.innerHTML = payments.map(payment => `
        <tr style="cursor: pointer;" onclick="openPaymentModal('${payment.id}')" data-payment-id="${payment.id}">
          <td>${adminUI.formatDate(payment.created)}</td>
          <td>${payment.seller?.displayName || payment.seller?.publicId || '-'}</td>
          <td>${adminUI.formatCurrency(payment.amount)}</td>
          <td>${getPaymentStatusBadge(payment.status, payment.type)}</td>
          <td style="font-family: monospace; font-size: 11px;">${payment.stripeIds?.paymentIntent?.substring(0, 12) || '-'}...</td>
          <td>${payment.dispute?.dueBy ? getDeadlineText(payment.dispute.dueBy) : '-'}</td>
          <td>
            <button class="small ghost" onclick="event.stopPropagation(); openPaymentModal('${payment.id}')">è©³ç´°</button>
          </td>
        </tr>
      `).join('');
    }

    function getPaymentStatusBadge(status, type) {
      if (type === 'dispute') {
        return '<span class="payment-status payment-disputed">CBç”³è«‹ä¸­</span>';
      }
      if (status === 'refunded') {
        return '<span class="payment-status payment-refunded">è¿”é‡‘æ¸ˆ</span>';
      }
      return '<span class="payment-status payment-normal">é€šå¸¸</span>';
    }

    function getDeadlineText(dueBy) {
      const now = new Date();
      const due = new Date(dueBy);
      const diffDays = Math.ceil((due - now) / (1000 * 60 * 60 * 24));
      
      if (diffDays <= 0) {
        return '<span class="deadline-urgent">æœŸé™åˆ‡ã‚Œ</span>';
      } else if (diffDays <= 3) {
        return `<span class="deadline-urgent">${diffDays}æ—¥å¾Œ</span>`;
      } else {
        return `${diffDays}æ—¥å¾Œ`;
      }
    }

    function openPaymentModal(paymentId) {
      currentPayment = payments.find(p => p.id === paymentId);
      if (!currentPayment) return;

      document.getElementById('modalTitle').textContent = `å–å¼•è©³ç´°: ${paymentId}`;
      populatePaymentDetails(currentPayment);
      adminUI.showModal('paymentModal');
    }

    function populatePaymentDetails(payment) {
      document.getElementById('paymentDate').textContent = adminUI.formatDate(payment.created);
      document.getElementById('paymentAmount').textContent = adminUI.formatCurrency(payment.amount);
      document.getElementById('paymentSeller').textContent = payment.seller?.displayName || payment.seller?.publicId || '-';
      document.getElementById('paymentStatus').textContent = getPaymentStatusText(payment.status, payment.type);
      
      document.getElementById('paymentIntentId').textContent = payment.stripeIds?.paymentIntent || '-';
      document.getElementById('chargeId').textContent = payment.stripeIds?.charge || '-';
      
      // Stripeãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒªãƒ³ã‚¯
      const stripeBtn = document.getElementById('openStripeBtn');
      if (payment.stripeIds?.charge) {
        const env = window.location.hostname.includes('localhost') ? 'test/' : '';
        stripeBtn.onclick = () => window.open(`https://dashboard.stripe.com/${env}payments/${payment.stripeIds.charge}`, '_blank');
      }
    }

    function getPaymentStatusText(status, type) {
      if (type === 'dispute') return 'ãƒãƒ£ãƒ¼ã‚¸ãƒãƒƒã‚¯ç”³è«‹ä¸­';
      if (status === 'refunded') return 'è¿”é‡‘æ¸ˆ';
      return 'é€šå¸¸æ±ºæ¸ˆ';
    }

    function setupEventListeners() {
      const debouncedSearch = adminUI.debounce(() => {
        const period = document.getElementById('periodFilter').value;
        const type = document.getElementById('typeFilter').value;
        const search = document.getElementById('searchInput').value;
        loadPayments({ period, type, search });
      }, 300);

      document.getElementById('periodFilter').addEventListener('change', debouncedSearch);
      document.getElementById('typeFilter').addEventListener('change', debouncedSearch);
      document.getElementById('searchInput').addEventListener('input', debouncedSearch);
      document.getElementById('searchBtn').addEventListener('click', debouncedSearch);

      document.getElementById('syncPaymentsBtn').addEventListener('click', async () => {
        adminUI.showSpinner('syncPaymentsBtn');
        try {
          await adminAPI.request('/admin/payments/sync', { method: 'POST' });
          adminUI.showToast('StripeåŒæœŸãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
          await loadPayments(currentFilters);
        } catch (error) {
          adminUI.showToast('åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        } finally {
          adminUI.showSpinner('syncPaymentsBtn', false);
        }
      });

      // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…æ“ä½œ
      document.getElementById('generateEvidenceBtn').addEventListener('click', generateEvidence);
      document.getElementById('submitEvidenceBtn').addEventListener('click', submitEvidence);
      document.getElementById('refundBtn').addEventListener('click', processRefund);
    }

    async function generateEvidence() {
      if (!currentPayment) return;
      
      adminUI.showSpinner('generateEvidenceBtn');
      try {
        await adminAPI.request('/admin/disputes/generate_evidence', {
          method: 'POST',
          body: JSON.stringify({ payment_intent_id: currentPayment.stripeIds.paymentIntent })
        });
        
        adminUI.showMessage('modalMessage', 'success', 'ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ã‚’ç”Ÿæˆã—ã¾ã—ãŸ');
      } catch (error) {
        adminUI.showMessage('modalMessage', 'error', error.message);
      } finally {
        adminUI.showSpinner('generateEvidenceBtn', false);
      }
    }

    async function submitEvidence() {
      if (!currentPayment) return;
      
      adminUI.showSpinner('submitEvidenceBtn');
      try {
        await adminAPI.request('/admin/disputes/submit_evidence', {
          method: 'POST',
          body: JSON.stringify({ payment_intent_id: currentPayment.stripeIds.paymentIntent })
        });
        
        adminUI.showMessage('modalMessage', 'success', 'ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ã‚’é€ä¿¡ã—ã¾ã—ãŸ');
        await loadPayments(currentFilters);
      } catch (error) {
        adminUI.showMessage('modalMessage', 'error', error.message);
      } finally {
        adminUI.showSpinner('submitEvidenceBtn', false);
      }
    }

    async function processRefund() {
      if (!currentPayment) return;
      
      if (!confirm(`Â¥${currentPayment.amount.toLocaleString()} ã®è¿”é‡‘å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ`)) return;
      
      adminUI.showSpinner('refundBtn');
      try {
        await adminAPI.request('/admin/payments/refund', {
          method: 'POST',
          body: JSON.stringify({ 
            payment_intent_id: currentPayment.stripeIds.paymentIntent,
            amount: currentPayment.amount
          })
        });
        
        adminUI.showMessage('modalMessage', 'success', 'è¿”é‡‘å‡¦ç†ã‚’å®Œäº†ã—ã¾ã—ãŸ');
        await loadPayments(currentFilters);
      } catch (error) {
        adminUI.showMessage('modalMessage', 'error', error.message);
      } finally {
        adminUI.showSpinner('refundBtn', false);
      }
    }

    function handleHashNavigation() {
      const hash = window.location.hash.substring(1);
      if (hash && hash.startsWith('chargeback-')) {
        const paymentId = hash.replace('chargeback-', 'pi_');
        const payment = payments.find(p => p.id === paymentId);
        if (payment) {
          openPaymentModal(paymentId);
        }
      }
    }
  </script>

  <!-- ãƒ•ãƒƒã‚¿ãƒ¼ã‚ãŸã‚Šã§ JS ã‚’èª­ã¿è¾¼ã¿ -->
  <script src="/js/admin-payments.js"></script>
</body>
</html>
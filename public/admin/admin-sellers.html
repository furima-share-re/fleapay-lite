<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>å‡ºåº—è€…ç®¡ç† | Fleapay Admin</title>
  
  <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ -->
  <meta name="robots" content="noindex,nofollow">
  <meta http-equiv="Cache-Control" content="no-store">
  <meta http-equiv="X-Frame-Options" content="DENY">
  
  <!-- å…±é€šã‚¹ã‚¿ã‚¤ãƒ«ãƒ»ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <link rel="stylesheet" href="common/admin-base.css">
  <script src="common/admin-utils.js"></script>
  
  <style>
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background: #fff;
      padding: 24px;
      border-radius: 14px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .seller-row {
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    
    .seller-row:hover {
      background: rgba(27, 54, 93, 0.02);
    }
  </style>
</head>
<body>
  <!-- å…±é€šãƒ˜ãƒƒãƒ€ãƒ¼ãƒ»ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆdashboard.htmlã¨åŒã˜æ§‹é€ ï¼‰ -->
  <header class="admin-header">
    <div>
      <span style="font-weight: 700; color: var(--fleapay-blue);">Fleapay Admin</span>
      <span class="env-badge">ENV</span>
    </div>
    <div>
      <span style="font-size: 13px; color: var(--fleapay-gray);"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="6706030a0e0927010b020617061e490d17">[email&#160;protected]</a> â–¼</span>
    </div>
  </header>

  <div class="admin-container">
    <nav class="admin-sidebar">
      <ul class="nav-menu">
        <li><a href="admin-dashboard.html" class="nav-item" data-page="dashboard">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a></li>
        <li><a href="admin-sellers.html" class="nav-item" data-page="sellers">ğŸ‘¥ å‡ºåº—è€…</a></li>
        <li><a href="admin-frames.html" class="nav-item" data-page="frames">ğŸ¨ AIãƒ•ãƒ¬ãƒ¼ãƒ </a></li>
        <li><a href="admin-payments.html" class="nav-item" data-page="payments">ğŸ’³ æ±ºæ¸ˆãƒ»CBç®¡ç†</a></li>
      </ul>
    </nav>

    <main class="admin-content">
      <section>
        <div class="sec-title-row">
          <h1>å‡ºåº—è€…ç®¡ç†</h1>
          <button id="newSellerBtn">+ æ–°è¦å‡ºåº—è€…ä½œæˆ</button>
        </div>
        
        <!-- æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ -->
        <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
          <input type="text" id="searchInput" placeholder="IDãƒ»åº—åãƒ»ãƒ¡ãƒ¼ãƒ«ã§æ¤œç´¢" 
                 style="max-width: 300px;">
          <select id="statusFilter" style="max-width: 150px;">
            <option value="">å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
            <option value="active">åˆ©ç”¨å¯</option>
            <option value="pending">KYCè¦</option>
            <option value="restricted">åˆ¶é™ä¸­</option>
          </select>
          <button id="searchBtn" class="ghost">ğŸ” æ¤œç´¢</button>
        </div>
      </section>

      <!-- å‡ºåº—è€…ä¸€è¦§ -->
      <section>
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: var(--fleapay-cream);">
                <th style="padding: 12px; text-align: left; border-bottom: 1px solid #eee;">å‡ºåº—è€…ID</th>
                <th style="padding: 12px; text-align: left; border-bottom: 1px solid #eee;">åº—å</th>
                <th style="padding: 12px; text-align: left; border-bottom: 1px solid #eee;">ãƒ¡ãƒ¼ãƒ«</th>
                <th style="padding: 12px; text-align: left; border-bottom: 1px solid #eee;">Stripe Account</th>
                <th style="padding: 12px; text-align: left; border-bottom: 1px solid #eee;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                <th style="padding: 12px; text-align: left; border-bottom: 1px solid #eee;">æœ€çµ‚åˆ©ç”¨</th>
                <th style="padding: 12px; text-align: left; border-bottom: 1px solid #eee;">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="sellersTableBody">
              <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
            </tbody>
          </table>
        </div>
        
        <div id="loadingIndicator" style="text-align: center; padding: 20px; display: none;">
          èª­ã¿è¾¼ã¿ä¸­...
        </div>
      </section>

      <!-- å‡ºåº—è€…è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
      <div id="sellerModal" class="modal">
        <div class="modal-content">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 id="modalTitle">å‡ºåº—è€…è©³ç´°</h2>
            <button id="closeModal" style="background: none; border: none; font-size: 24px; cursor: pointer;">Ã—</button>
          </div>
          
          <form id="sellerForm">
            <label>å…¬é–‹ID (publicId)
              <input type="text" id="publicId" required>
            </label>
            
            <label>è¡¨ç¤ºå
              <input type="text" id="displayName">
            </label>
            
            <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
              <input type="email" id="email">
            </label>
            
            <label>Stripe Connect ã‚¢ã‚«ã‚¦ãƒ³ãƒˆID
              <input type="text" id="stripeAccountId" placeholder="acct_1Pxxxxxxx">
              <span class="field-note">KYCå‰ã¯ç©ºæ¬„ã§æ§‹ã„ã¾ã›ã‚“ã€‚</span>
            </label>
            
            <label>é‹å–¶ãƒˆãƒ¼ã‚¯ãƒ³
              <input type="password" id="adminToken" required>
            </label>
            
            <div style="display: flex; gap: 12px; margin: 20px 0;">
              <button type="submit" id="saveSellerBtn">ä¿å­˜</button>
              <button type="button" id="rotateTokenBtn" class="ghost">ãƒˆãƒ¼ã‚¯ãƒ³ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³</button>
            </div>
          </form>
          
          <!-- URLè¡¨ç¤º -->
          <div id="urlSection" style="display: none;">
            <h3>å…±æœ‰URL</h3>
            <label>å‡ºåº—è€…ç”»é¢ï¼ˆseller.htmlï¼‰
              <div id="sellerUrl" class="box">â€”</div>
            </label>
            <button type="button" class="small ghost" onclick="copySellerUrl()">ã‚³ãƒ”ãƒ¼</button>
            
            <label style="margin-top: 12px;">è³¼å…¥ç”»é¢ï¼ˆcheckout.htmlï¼‰
              <div id="checkoutUrl" class="box">â€”</div>
            </label>
            <button type="button" class="small ghost" onclick="copyCheckoutUrl()">ã‚³ãƒ”ãƒ¼</button>
          </div>
          
          <div id="modalMessage" style="display: none; margin-top: 16px;"></div>
        </div>
      </div>
    </main>
  </div>

  <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
    // å‡ºåº—è€…ç®¡ç†å›ºæœ‰ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
    let sellers = [];
    let currentSeller = null;

    document.addEventListener('DOMContentLoaded', async () => {
      await loadSellers();
      setupEventListeners();
    });

    async function loadSellers(filters = {}) {
      const loadingIndicator = document.getElementById('loadingIndicator');
      loadingIndicator.style.display = 'block';
      
      try {
        // âœ… ä¿®æ­£: /admin/sellers â†’ /api/admin/sellers
        const data = await adminAPI.request('/api/admin/sellers');
        sellers = data.sellers || [];
        renderSellersTable();
      } catch (error) {
        adminUI.showToast('å‡ºåº—è€…ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      } finally {
        loadingIndicator.style.display = 'none';
      }
    }

    function renderSellersTable() {
      const tbody = document.getElementById('sellersTableBody');
      
      if (sellers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">å‡ºåº—è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</td></tr>';
        return;
      }
      
      tbody.innerHTML = sellers.map(seller => `
        <tr class="seller-row" onclick="openSellerModal('${seller.publicId}')" data-seller-id="${seller.publicId}">
          <td style="padding: 12px; border-bottom: 1px solid #eee;">${seller.publicId}</td>
          <td style="padding: 12px; border-bottom: 1px solid #eee;">${seller.displayName || '-'}</td>
          <td style="padding: 12px; border-bottom: 1px solid #eee;">${seller.email || '-'}</td>
          <td style="padding: 12px; border-bottom: 1px solid #eee;">${seller.stripeAccountId ? seller.stripeAccountId.substring(0, 12) + '...' : 'æœªè¨­å®š'}</td>
          <td style="padding: 12px; border-bottom: 1px solid #eee;">${getStatusBadge(seller.status)}</td>
          <td style="padding: 12px; border-bottom: 1px solid #eee;">${seller.lastUsed ? adminUI.formatDate(seller.lastUsed) : '-'}</td>
          <td style="padding: 12px; border-bottom: 1px solid #eee;">
            <button class="small ghost" onclick="event.stopPropagation(); openSellerModal('${seller.publicId}')">ç·¨é›†</button>
          </td>
        </tr>
      `).join('');
    }

    function getStatusBadge(status) {
      const badges = {
        active: '<span style="background: #f0f9f4; color: var(--success-green); padding: 2px 8px; border-radius: 12px; font-size: 12px;">åˆ©ç”¨å¯</span>',
        pending: '<span style="background: #fef3c7; color: var(--warning-amber); padding: 2px 8px; border-radius: 12px; font-size: 12px;">KYCè¦</span>',
        restricted: '<span style="background: #fef2f2; color: var(--error-maroon); padding: 2px 8px; border-radius: 12px; font-size: 12px;">åˆ¶é™ä¸­</span>'
      };
      return badges[status] || '<span style="background: #f0f2f5; color: var(--fleapay-gray); padding: 2px 8px; border-radius: 12px; font-size: 12px;">ä¸æ˜</span>';
    }

    function openSellerModal(publicId = null) {
      const modal = document.getElementById('sellerModal');
      const title = document.getElementById('modalTitle');
      
      if (publicId) {
        currentSeller = sellers.find(s => s.publicId === publicId);
        title.textContent = `å‡ºåº—è€…ç·¨é›†: ${publicId}`;
        populateForm(currentSeller);
      } else {
        currentSeller = null;
        title.textContent = 'æ–°è¦å‡ºåº—è€…ä½œæˆ';
        document.getElementById('sellerForm').reset();
      }
      
      modal.style.display = 'flex';
    }

    function populateForm(seller) {
      if (!seller) return;
      
      document.getElementById('publicId').value = seller.publicId || '';
      document.getElementById('displayName').value = seller.displayName || '';
      document.getElementById('email').value = seller.email || '';
      document.getElementById('stripeAccountId').value = seller.stripeAccountId || '';
      
      if (seller.urls) {
        document.getElementById('sellerUrl').textContent = seller.urls.sellerUrl || 'â€”';
        document.getElementById('checkoutUrl').textContent = seller.urls.checkoutUrl || 'â€”';
        document.getElementById('urlSection').style.display = 'block';
      }
    }

    async function saveSeller(formData) {
      adminUI.showSpinner('saveSellerBtn');
      
      try {
        const adminToken = formData.get('adminToken');
        const data = {
          publicId: formData.get('publicId'),
          displayName: formData.get('displayName'),
          email: formData.get('email'),
          stripeAccountId: formData.get('stripeAccountId'),
          rotate: false
        };

        const result = await adminAPI.request('/api/admin/sellers/issue_token', {
          method: 'POST',
          body: JSON.stringify(data),
          adminToken
        });
        
        adminUI.showMessage('modalMessage', 'success', 'ï¿½ï¿½å­˜ã—ã¾ã—ãŸ');
        await loadSellers();
        
        if (result.urls) {
          document.getElementById('sellerUrl').textContent = result.urls.sellerUrl || 'â€”';
          document.getElementById('checkoutUrl').textContent = result.urls.checkoutUrl || 'â€”';
          document.getElementById('urlSection').style.display = 'block';
        }
      } catch (error) {
        adminUI.showMessage('modalMessage', 'error', error.message);
      } finally {
        adminUI.showSpinner('saveSellerBtn', false);
      }
    }

    function setupEventListeners() {
      document.getElementById('newSellerBtn').addEventListener('click', () => {
        openSellerModal();
      });

      document.getElementById('closeModal').addEventListener('click', () => {
        document.getElementById('sellerModal').style.display = 'none';
      });

      document.getElementById('sellerForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        saveSeller(formData);
      });

      document.getElementById('searchBtn').addEventListener('click', () => {
        const searchTerm = document.getElementById('searchInput').value;
        const statusFilter = document.getElementById('statusFilter').value;
        loadSellers({ search: searchTerm, status: statusFilter });
      });

      document.getElementById('rotateTokenBtn').addEventListener('click', async () => {
        if (!confirm('ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¾ã™ã‹ï¼Ÿéå»ã®URLã¯ç„¡åŠ¹ã«ãªã‚Šã¾ã™ã€‚')) return;
        
        const formData = new FormData(document.getElementById('sellerForm'));
        formData.set('rotate', 'true');
        await saveSeller(formData);
      });
    }

    // URL ã‚³ãƒ”ãƒ¼é–¢æ•°
    window.copySellerUrl = async () => {
      const text = document.getElementById('sellerUrl').textContent;
      if (text !== 'â€”') await adminUI.copyToClipboard(text);
    };

    window.copyCheckoutUrl = async () => {
      const text = document.getElementById('checkoutUrl').textContent;
      if (text !== 'â€”') await adminUI.copyToClipboard(text);
    };
  </script>
</body>
</html>
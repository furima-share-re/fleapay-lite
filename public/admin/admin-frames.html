<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>AIãƒ•ãƒ¬ãƒ¼ãƒ ç®¡ç† | Fleapay Admin</title>
  
  <meta name="robots" content="noindex,nofollow">
  <meta http-equiv="Cache-Control" content="no-store">
  <meta http-equiv="X-Frame-Options" content="DENY">
  
  <link rel="stylesheet" href="common/admin-base.css">
  <script src="common/admin-utils.js"></script>
  
  <style>
    .frame-preview {
      width: 120px;
      height: 160px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #f9f9f9;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: var(--fleapay-gray);
    }
    
    .json-editor {
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 12px;
      min-height: 200px;
    }
    
    .frame-card {
      border: 1px solid rgba(0,0,0,0.06);
      border-radius: 12px;
      padding: 16px;
      background: #fff;
      transition: var(--transition-base);
      cursor: pointer;
    }
    
    .frame-card:hover {
      box-shadow: var(--shadow-medium);
    }
  </style>
</head>
<body>
  <header class="admin-header">
    <div class="admin-logo">
      ğŸª¶ Fleapay Admin
      <span class="env-badge">ENV</span>
    </div>
    <div style="font-size: 13px; color: var(--fleapay-gray);">
      admin@fleapay.jp â–¼
    </div>
  </header>

  <div class="admin-container">
    <nav class="admin-sidebar">
      <ul class="nav-menu">
        <li><a href="admin-dashboard.html" class="nav-item" data-page="dashboard">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a></li>
        <li><a href="admin-sellers.html" class="nav-item" data-page="sellers">ğŸ‘¥ å‡ºåº—è€…</a></li>
        <li><a href="admin-frames.html" class="nav-item" data-page="frames">ğŸ¨ AIãƒ•ãƒ¬ãƒ¼ãƒ </a></li>
        <li><a href="admin-payments.html" class="nav-item" data-page="payments">ğŸ’³ æ±ºæ¸ˆãƒ»CBç®¡ç†</a></li>
      </ul>
    </nav>

    <main class="admin-content">
      <section>
        <div class="sec-title-row">
          <h1>AIãƒ•ãƒ¬ãƒ¼ãƒ ç®¡ç†</h1>
          <button id="newFrameBtn">+ æ–°è¦ãƒ•ãƒ¬ãƒ¼ãƒ ä½œæˆ</button>
        </div>
        
        <div class="flex flex-wrap" style="margin-bottom: 20px;">
          <select id="categoryFilter" style="max-width: 150px;">
            <option value="">å…¨ã‚«ãƒ†ã‚´ãƒª</option>
            <option value="Japan">Japan</option>
            <option value="Seasonal">Seasonal</option>
            <option value="Event">Event</option>
          </select>
          <select id="statusFilter" style="max-width: 150px;">
            <option value="">å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
            <option value="active">å…¬é–‹ä¸­</option>
            <option value="draft">ä¸‹æ›¸ã</option>
            <option value="archived">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</option>
          </select>
          <button id="refreshBtn" class="ghost">ğŸ”„ æ›´æ–°</button>
        </div>
      </section>

      <section>
        <div id="framesGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">
          <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
        </div>
        
        <div id="loadingIndicator" class="loading-indicator" style="display: none;">
          èª­ã¿è¾¼ã¿ä¸­...
        </div>
      </section>

      <!-- ãƒ•ãƒ¬ãƒ¼ãƒ ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
      <div id="frameModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
          <div class="modal-header">
            <h2 id="modalTitle">ãƒ•ãƒ¬ãƒ¼ãƒ ç·¨é›†</h2>
            <button id="closeModal" class="modal-close">Ã—</button>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 200px; gap: 24px;">
            <div>
              <form id="frameForm">
                <label>ãƒ•ãƒ¬ãƒ¼ãƒ ID <span style="color: var(--error-maroon);">*</span>
                  <input type="text" name="frameId" id="frameId" required>
                  <span class="field-note">åŠè§’è‹±æ•°å­—ãƒ»ãƒã‚¤ãƒ•ãƒ³ã®ã¿ï¼ˆä¾‹: sakura, summer-2024ï¼‰</span>
                </label>
                
                <label>è¡¨ç¤ºå <span style="color: var(--error-maroon);">*</span>
                  <input type="text" name="displayName" id="displayName" required>
                </label>
                
                <div class="grid">
                  <label>ã‚«ãƒ†ã‚´ãƒª
                    <select name="category" id="category">
                      <option value="Japan">Japan</option>
                      <option value="Seasonal">Seasonal</option>
                      <option value="Event">Event</option>
                      <option value="Special">Special</option>
                    </select>
                  </label>
                  
                  <label>å…¬é–‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
                    <select name="status" id="status">
                      <option value="active">å…¬é–‹ä¸­</option>
                      <option value="draft">ä¸‹æ›¸ã</option>
                      <option value="archived">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</option>
                    </select>
                  </label>
                </div>
                
                <label>èª¬æ˜
                  <textarea name="description" id="description" rows="3" placeholder="ãƒ•ãƒ¬ãƒ¼ãƒ ã®èª¬æ˜ï¼ˆä»»æ„ï¼‰"></textarea>
                </label>
                
                <label>ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆJSONï¼‰
                  <textarea name="metadata" id="metadata" class="json-editor" placeholder='{"bgGradient": ["#FCE8EE", "#FFF8FA"], "petals": {...}}'></textarea>
                  <span class="field-note">æœ‰åŠ¹ãªJSONå½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„</span>
                </label>
                
                <div class="flex" style="margin: 20px 0;">
                  <button type="submit" id="saveFrameBtn">ä¿å­˜</button>
                  <button type="button" id="previewBtn" class="ghost">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆ</button>
                </div>
              </form>
            </div>
            
            <div>
              <h3>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
              <div id="framePreview" class="frame-preview">
                ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æœªç”Ÿæˆ
              </div>
              <button type="button" id="generatePreviewBtn" class="small ghost" style="width: 100%; margin-top: 8px;">
                ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
              </button>
            </div>
          </div>
          
          <div id="modalMessage" style="display: none; margin-top: 16px;"></div>
        </div>
      </div>
    </main>
  </div>

  <script>
    let frames = [];
    let currentFrame = null;
    let currentFilters = {};

    document.addEventListener('DOMContentLoaded', async () => {
      await loadFrames();
      setupEventListeners();
    });

    async function loadFrames(filters = {}) {
      const loadingIndicator = document.getElementById('loadingIndicator');
      loadingIndicator.style.display = 'block';
      
      try {
        const queryParams = new URLSearchParams(filters).toString();
        const data = await adminAPI.request(`/admin/frames${queryParams ? '?' + queryParams : ''}`);
        
        frames = data.frames || [];
        currentFilters = filters;
        renderFramesGrid();
      } catch (error) {
        adminUI.showToast('ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        loadMockFrames(); // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      } finally {
        loadingIndicator.style.display = 'none';
      }
    }

    function loadMockFrames() {
      frames = [
        {
          frameId: 'sakura',
          displayName: 'æ¡œãƒ•ãƒ¬ãƒ¼ãƒ ',
          category: 'Japan',
          status: 'active',
          description: 'æ—¥æœ¬ã®æ¡œã‚’ãƒ¢ãƒãƒ¼ãƒ•ã«ã—ãŸãƒ•ãƒ¬ãƒ¼ãƒ ',
          metadata: {
            bgGradient: ['#FCE8EE', '#FFF8FA'],
            petals: { count: 5, opacity: 0.4 }
          },
          usageCount: 1250
        },
        {
          frameId: 'gold',
          displayName: 'é‡‘ç¶™ããƒ•ãƒ¬ãƒ¼ãƒ ',
          category: 'Japan',
          status: 'active',
          description: 'é‡‘ç¶™ãã‚’ãƒ¢ãƒãƒ¼ãƒ•ã«ã—ãŸä¾¡å€¤ã‚’è¡¨ç¾ã™ã‚‹ãƒ•ãƒ¬ãƒ¼ãƒ ',
          usageCount: 890
        }
      ];
      renderFramesGrid();
    }

    function renderFramesGrid() {
      const grid = document.getElementById('framesGrid');
      
      if (frames.length === 0) {
        grid.innerHTML = '<div class="empty-state" style="grid-column: 1 / -1;">ãƒ•ãƒ¬ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
        return;
      }
      
      grid.innerHTML = frames.map(frame => `
        <div class="frame-card" onclick="openFrameModal('${frame.frameId}')" data-frame-id="${frame.frameId}">
          <div class="flex" style="justify-content: space-between; margin-bottom: 12px;">
            <h3 style="margin: 0; color: var(--fleapay-blue);">${frame.displayName}</h3>
            ${getStatusBadge(frame.status)}
          </div>
          
          <div class="flex" style="gap: 12px; margin-bottom: 12px;">
            <div class="frame-preview" style="width: 80px; height: 100px;">
              ${frame.frameId}
            </div>
            <div style="flex: 1;">
              <p style="margin: 0 0 8px 0; font-size: 13px; color: var(--fleapay-gray);">
                ${frame.description || 'ãƒ•ãƒ¬ãƒ¼ãƒ ã®èª¬æ˜ãªã—'}
              </p>
              <div style="font-size: 12px; color: var(--fleapay-gray);">
                <div>ID: ${frame.frameId}</div>
                <div>ã‚«ãƒ†ã‚´ãƒª: ${frame.category}</div>
                <div>åˆ©ç”¨å›æ•°: ${adminUI.formatNumber(frame.usageCount || 0)}</div>
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }

    function getStatusBadge(status) {
      const badges = {
        active: '<span class="status-badge status-active">å…¬é–‹ä¸­</span>',
        draft: '<span class="status-badge status-pending">ä¸‹æ›¸ã</span>',
        archived: '<span class="status-badge status-neutral">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</span>'
      };
      return badges[status] || '<span class="status-badge status-neutral">ä¸æ˜</span>';
    }

    function openFrameModal(frameId = null) {
      const title = document.getElementById('modalTitle');
      
      adminFormHelper.clearFieldErrors();
      
      if (frameId) {
        currentFrame = frames.find(f => f.frameId === frameId);
        title.textContent = `ãƒ•ãƒ¬ãƒ¼ãƒ ç·¨é›†: ${frameId}`;
        populateForm(currentFrame);
      } else {
        currentFrame = null;
        title.textContent = 'æ–°è¦ãƒ•ãƒ¬ãƒ¼ãƒ ä½œæˆ';
        document.getElementById('frameForm').reset();
        document.getElementById('framePreview').textContent = 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æœªç”Ÿæˆ';
      }
      
      adminUI.showModal('frameModal');
    }

    function populateForm(frame) {
      if (!frame) return;
      
      document.getElementById('frameId').value = frame.frameId || '';
      document.getElementById('displayName').value = frame.displayName || '';
      document.getElementById('category').value = frame.category || 'Japan';
      document.getElementById('status').value = frame.status || 'draft';
      document.getElementById('description').value = frame.description || '';
      
      if (frame.metadata) {
        document.getElementById('metadata').value = JSON.stringify(frame.metadata, null, 2);
      }
      
      updatePreview(frame);
    }

    function updatePreview(frame) {
      const preview = document.getElementById('framePreview');
      
      if (frame && frame.metadata) {
        preview.innerHTML = `
          <div style="font-size: 10px; text-align: center;">
            <div style="font-weight: bold;">${frame.displayName}</div>
            <div style="margin: 4px 0;">ğŸ¨</div>
            <div>${frame.category}</div>
          </div>
        `;
        
        if (frame.metadata.bgGradient && Array.isArray(frame.metadata.bgGradient)) {
          preview.style.background = `linear-gradient(135deg, ${frame.metadata.bgGradient.join(', ')})`;
        }
      } else {
        preview.textContent = 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æœªç”Ÿæˆ';
        preview.style.background = '#f9f9f9';
      }
    }

    function setupEventListeners() {
      document.getElementById('newFrameBtn').addEventListener('click', () => openFrameModal());

      document.getElementById('frameForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        saveFrame(formData);
      });

      const debouncedFilter = adminUI.debounce(() => {
        const categoryFilter = document.getElementById('categoryFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;
        loadFrames({ category: categoryFilter, status: statusFilter });
      }, 300);

      document.getElementById('categoryFilter').addEventListener('change', debouncedFilter);
      document.getElementById('statusFilter').addEventListener('change', debouncedFilter);
      document.getElementById('refreshBtn').addEventListener('click', () => loadFrames(currentFilters));

      document.getElementById('previewBtn').addEventListener('click', generatePreview);
      document.getElementById('generatePreviewBtn').addEventListener('click', generatePreview);
    }

    async function saveFrame(formData) {
      adminUI.showSpinner('saveFrameBtn');
      
      const errors = adminFormHelper.validateForm(document.getElementById('frameForm'), {
        frameId: [
          (value) => adminValidators.required(value) || 'ãƒ•ãƒ¬ãƒ¼ãƒ IDã¯å¿…é ˆã§ã™',
          (value) => /^[a-zA-Z0-9-_]{2,30}$/.test(value) || 'ãƒ•ãƒ¬ãƒ¼ãƒ IDã¯åŠè§’è‹±æ•°å­—ãƒ»ãƒã‚¤ãƒ•ãƒ³ãƒ»ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã®ã¿ã€2ã€œ30æ–‡å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„'
        ],
        displayName: [
          (value) => adminValidators.required(value) || 'è¡¨ç¤ºåã¯å¿…é ˆã§ã™',
          (value) => adminValidators.maxLength(value, 50) || 'è¡¨ç¤ºåã¯50æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„'
        ]
      });

      if (errors.length > 0) {
        adminFormHelper.showFieldErrors(errors);
        adminUI.showSpinner('saveFrameBtn', false);
        return;
      }

      try {
        const data = {
          frameId: formData.get('frameId'),
          displayName: formData.get('displayName'),
          category: formData.get('category'),
          status: formData.get('status'),
          description: formData.get('description') || undefined,
          metadata: formData.get('metadata') ? JSON.parse(formData.get('metadata')) : {}
        };

        await adminAPI.request('/admin/frames', {
          method: 'POST',
          body: JSON.stringify(data)
        });
        
        adminUI.showMessage('modalMessage', 'success', currentFrame ? 'æ›´æ–°ã—ã¾ã—ãŸ' : 'ä½œæˆã—ã¾ã—ãŸ');
        await loadFrames(currentFilters);
        
        setTimeout(() => adminUI.hideModal('frameModal'), 1500);
        
      } catch (error) {
        adminUI.showMessage('modalMessage', 'error', error.message);
      } finally {
        adminUI.showSpinner('saveFrameBtn', false);
      }
    }

    function generatePreview() {
      const metadata = document.getElementById('metadata').value.trim();
      const displayName = document.getElementById('displayName').value.trim();
      const category = document.getElementById('category').value;
      
      if (!metadata) {
        adminUI.showToast('ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
        return;
      }
      
      try {
        const parsedMetadata = JSON.parse(metadata);
        const previewData = {
          displayName: displayName || 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼',
          category,
          metadata: parsedMetadata
        };
        
        updatePreview(previewData);
        adminUI.showToast('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
      } catch (error) {
        adminUI.showToast('ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®JSONå½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“', 'error');
      }
    }
  </script>
</body>
</html>
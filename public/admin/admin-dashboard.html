<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ | Fleapay Admin</title>
  
  <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ -->
  <meta name="robots" content="noindex,nofollow">
  <meta http-equiv="Cache-Control" content="no-store">
  <meta http-equiv="X-Frame-Options" content="DENY">
  
  <!-- å…±é€šã‚¹ã‚¿ã‚¤ãƒ«ãƒ»ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <link rel="stylesheet" href="common/admin-base.css">
  <script src="common/admin-utils.js"></script>
</head>
<body>
  <!-- å…±é€šãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="admin-header">
    <div>
      <span style="font-weight: 700; color: var(--fleapay-blue);">Fleapay Admin</span>
      <span class="env-badge">ENV</span>
    </div>
    <div>
      <span style="font-size: 13px; color: var(--fleapay-gray);"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="e081848d898ea0868c8581908199ce8a90">[email&#160;protected]</a> â–¼</span>
    </div>
  </header>

  <div class="admin-container">
    <!-- å…±é€šã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <nav class="admin-sidebar">
      <ul class="nav-menu">
        <li><a href="admin-dashboard.html" class="nav-item" data-page="dashboard">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a></li>
        <li><a href="admin-sellers.html" class="nav-item" data-page="sellers">ğŸ‘¥ å‡ºåº—è€…</a></li>
        <li><a href="admin-frames.html" class="nav-item" data-page="frames">ğŸ¨ AIãƒ•ãƒ¬ãƒ¼ãƒ </a></li>
        <li><a href="admin-payments.html" class="nav-item" data-page="payments">ğŸ’³ æ±ºæ¸ˆãƒ»CBç®¡ç†</a></li>
      </ul>
    </nav>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="admin-content">
      <section>
        <div class="sec-title-row">
          <h1>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
          <span class="pill">ãƒ›ãƒ¼ãƒ </span>
        </div>
        
        <!-- ãƒ•ã‚£ãƒ«ã‚¿ -->
        <div style="display: flex; gap: 16px; margin-bottom: 20px;">
          <select id="periodFilter" style="padding: 8px; border-radius: 8px;">
            <option value="today">ä»Šæ—¥</option>
            <option value="week">ä»Šé€±</option>
            <option value="month">ä»Šæœˆ</option>
          </select>
          <select id="eventFilter" style="padding: 8px; border-radius: 8px;">
            <option value="all">å…¨ã‚¤ãƒ™ãƒ³ãƒˆ</option>
            <option value="oi-flea">å¤§äº•ãƒ•ãƒªãƒ</option>
          </select>
          <button id="refreshBtn" class="ghost">ğŸ”„ æ›´æ–°</button>
        </div>
      </section>

      <!-- ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¡¨ç¤º -->
      <div class="grid">
        <section>
          <h2>ä»Šæ—¥ã®æ±ºæ¸ˆã‚µãƒãƒª</h2>
          <div style="font-size: 28px; font-weight: 700; color: var(--fleapay-blue); margin: 12px 0;">
            <span id="paymentCount">-</span><span style="font-size: 16px; margin-left: 4px;">ä»¶</span>
          </div>
          <div style="font-size: 14px; color: var(--fleapay-gray);">
            å£²ä¸Šåˆè¨ˆ: <span id="totalRevenue">Â¥0</span><br>
            ç´”å£²ä¸Š: <span id="netRevenue">Â¥0</span>
          </div>
        </section>
        
        <section>
          <h2>ãƒãƒ£ãƒ¼ã‚¸ãƒãƒƒã‚¯ / è¿”é‡‘</h2>
          <div style="font-size: 28px; font-weight: 700; color: var(--warning-amber); margin: 12px 0;">
            <span id="disputeCount">-</span><span style="font-size: 16px; margin-left: 4px;">ä»¶</span>
          </div>
          <div style="font-size: 14px; color: var(--fleapay-gray);">
            è¿”é‡‘: <span id="refundCount">-</span>ä»¶<br>
            æœŸé™é–“è¿‘: <span id="urgentCount" style="color: var(--error-maroon);">-</span>ä»¶ ğŸ””
          </div>
        </section>
      </div>

      <!-- ã‚¢ãƒ©ãƒ¼ãƒˆ -->
      <section>
        <h2>æœ€è¿‘ã®ã‚¢ãƒ©ãƒ¼ãƒˆ</h2>
        <div id="alertsList">
          <div style="text-align: center; padding: 20px; color: var(--fleapay-gray);">
            èª­ã¿è¾¼ã¿ä¸­...
          </div>
        </div>
      </section>

      <!-- å‡ºåº—è€…ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ -->
      <section>
        <h2>å‡ºåº—è€…ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£</h2>
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: var(--fleapay-cream);">
                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #eee;">å‡ºåº—è€…ID</th>
                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #eee;">åº—å</th>
                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #eee;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #eee;">æœ€çµ‚åˆ©ç”¨</th>
              </tr>
            </thead>
            <tbody id="recentSellers">
              <tr>
                <td colspan="4" style="padding: 20px; text-align: center; color: var(--fleapay-gray);">
                  èª­ã¿è¾¼ã¿ä¸­...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
    // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å›ºæœ‰ã®åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', async () => {
      // èªè¨¼ãƒã‚§ãƒƒã‚¯
      checkAuth();
      
      // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
      await loadDashboardData();
      setupEventListeners();
      startAutoRefresh();
    });

    // èªè¨¼ãƒã‚§ãƒƒã‚¯
    function checkAuth() {
      const token = window.ADMIN_TOKEN || localStorage.getItem('ADMIN_TOKEN');
      if (!token) {
        console.warn('èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        // é–‹ç™ºç’°å¢ƒç”¨ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¨­å®š
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
          localStorage.setItem('ADMIN_TOKEN', 'admin-devtoken');
          console.log('é–‹ç™ºç’°å¢ƒç”¨ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¨­å®šã—ã¾ã—ãŸ');
        }
      }
    }

    async function loadDashboardData() {
      try {
        // âœ… ä¿®æ­£: /admin/dashboard â†’ /api/admin/dashboard
        const data = await adminAPI.request('/api/admin/dashboard');
        updateMetrics(data);
        adminUI.showToast('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
      } catch (error) {
        console.error('Dashboard load error:', error);
        adminUI.showToast('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
        
        // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¡¨ç¤º
        updateMetrics({
          paymentCount: 0,
          totalRevenue: 0,
          netRevenue: 0,
          disputeCount: 0,
          refundCount: 0
        });
        
        // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
        document.getElementById('alertsList').innerHTML = `
          <div class="err" style="padding: 12px;">
            <strong>âš ï¸ ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</strong><br>
            <small>${error.message || 'ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“'}</small>
          </div>
        `;
        
        // å‡ºåº—è€…ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        document.getElementById('recentSellers').innerHTML = `
          <tr>
            <td colspan="4" style="padding: 20px; text-align: center; color: var(--error-maroon);">
              ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ
            </td>
          </tr>
        `;
      }
    }

    function updateMetrics(data) {
      // æ±ºæ¸ˆã‚µãƒãƒªã®æ›´æ–°
      document.getElementById('paymentCount').textContent = data.paymentCount || 0;
      document.getElementById('totalRevenue').textContent = adminUI.formatCurrency(data.totalRevenue || 0);
      document.getElementById('netRevenue').textContent = adminUI.formatCurrency(data.netRevenue || 0);
      
      // ãƒãƒ£ãƒ¼ã‚¸ãƒãƒƒã‚¯ãƒ»è¿”é‡‘ã®æ›´æ–°
      document.getElementById('disputeCount').textContent = data.disputeCount || 0;
      document.getElementById('refundCount').textContent = data.refundCount || 0;
      
      // æœŸé™é–“è¿‘ã®ä»¶æ•°ï¼ˆurgentCountãŒã‚ã‚Œã°è¡¨ç¤ºï¼‰
      const urgentCountEl = document.getElementById('urgentCount');
      if (urgentCountEl) {
        urgentCountEl.textContent = data.urgentCount || 0;
      }
      
      // ã‚¢ãƒ©ãƒ¼ãƒˆã®æ›´æ–°
      updateAlerts(data);
      
      // å‡ºåº—è€…ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã®æ›´æ–°
      updateRecentSellers(data);
    }

    function updateAlerts(data) {
      const alertsList = document.getElementById('alertsList');
      
      // ã‚¢ãƒ©ãƒ¼ãƒˆãŒãªã„å ´åˆ
      if (!data.disputeCount && !data.urgentCount) {
        alertsList.innerHTML = `
          <div style="text-align: center; padding: 20px; color: var(--success-green);">
            âœ… ã‚¢ãƒ©ãƒ¼ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“
          </div>
        `;
        return;
      }
      
      // ã‚¢ãƒ©ãƒ¼ãƒˆãŒã‚ã‚‹å ´åˆ
      let html = '';
      
      if (data.urgentCount > 0) {
        html += `
          <div class="err" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <div>
              <strong>âš ï¸ ãƒãƒ£ãƒ¼ã‚¸ãƒãƒƒã‚¯ ${data.urgentCount}ä»¶ï¼ˆæœŸé™é–“è¿‘ï¼‰</strong><br>
              <small>æ—©æ€¥ãªå¯¾å¿œãŒå¿…è¦ã§ã™</small>
            </div>
            <button class="small" onclick="location.href='admin-payments.html?status=disputed'">å¯¾å¿œ</button>
          </div>
        `;
      }
      
      if (data.disputeCount > 0) {
        html += `
          <div style="background: #fef9e7; padding: 12px; border-radius: 8px; border: 1px solid var(--warning-amber);">
            <strong>ğŸ“‹ ãƒãƒ£ãƒ¼ã‚¸ãƒãƒƒã‚¯ ${data.disputeCount}ä»¶</strong><br>
            <small>å¯¾å¿œçŠ¶æ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„</small>
          </div>
        `;
      }
      
      alertsList.innerHTML = html;
    }

    function updateRecentSellers(data) {
      const tbody = document.getElementById('recentSellers');
      
      // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºï¼ˆå®Ÿéš›ã®APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹å ´åˆã¯ç½®ãæ›ãˆï¼‰
      if (!data.recentSellers || data.recentSellers.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" style="padding: 20px; text-align: center; color: var(--fleapay-gray);">
              ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“
            </td>
          </tr>
        `;
        return;
      }
      
      // å‡ºåº—è€…ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆ
      const rows = data.recentSellers.map(seller => `
        <tr>
          <td style="padding: 10px; border-bottom: 1px solid #eee;">${seller.id}</td>
          <td style="padding: 10px; border-bottom: 1px solid #eee;">${seller.name}</td>
          <td style="padding: 10px; border-bottom: 1px solid #eee;">
            <span style="background: #f0f9f4; color: var(--success-green); padding: 2px 8px; border-radius: 12px; font-size: 12px;">
              ${seller.status}
            </span>
          </td>
          <td style="padding: 10px; border-bottom: 1px solid #eee;">${adminUI.formatDate(seller.lastUsed)}</td>
        </tr>
      `).join('');
      
      tbody.innerHTML = rows;
    }

    function setupEventListeners() {
      // æ›´æ–°ãƒœã‚¿ãƒ³
      document.getElementById('refreshBtn').addEventListener('click', async () => {
        const btn = document.getElementById('refreshBtn');
        btn.disabled = true;
        btn.textContent = 'ğŸ”„ æ›´æ–°ä¸­...';
        
        await loadDashboardData();
        
        btn.disabled = false;
        btn.textContent = 'ğŸ”„ æ›´æ–°';
      });
      
      // æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿
      document.getElementById('periodFilter').addEventListener('change', async (e) => {
        console.log('Period changed:', e.target.value);
        // æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ã«å¿œã˜ãŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å‡¦ç†ã‚’è¿½åŠ 
        await loadDashboardData();
      });
      
      // ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ã‚£ãƒ«ã‚¿
      document.getElementById('eventFilter').addEventListener('change', async (e) => {
        console.log('Event changed:', e.target.value);
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ã‚£ãƒ«ã‚¿ã«å¿œã˜ãŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å‡¦ç†ã‚’è¿½åŠ 
        await loadDashboardData();
      });
    }

    function startAutoRefresh() {
      // 5åˆ†ã”ã¨ã«è‡ªå‹•æ›´æ–°
      setInterval(() => {
        console.log('Auto refresh triggered');
        loadDashboardData();
      }, 300000);
    }
  </script>
</body>
</html>

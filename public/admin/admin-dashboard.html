<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ | Fleapay Admin</title>
  
  <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ -->
  <meta name="robots" content="noindex,nofollow">
  <meta http-equiv="Cache-Control" content="no-store">
  <meta http-equiv="X-Frame-Options" content="DENY">
  
  <!-- å…±é€šã‚¹ã‚¿ã‚¤ãƒ«ãƒ»ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <link rel="stylesheet" href="common/admin-base.css">
  <script src="common/admin-utils.js"></script>
</head>
<body>
  <!-- å…±é€šãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="admin-header">
    <div>
      <span style="font-weight: 700; color: var(--fleapay-blue);">Fleapay Admin</span>
      <span class="env-badge">ENV</span>
    </div>
    <div>
      <span style="font-size: 13px; color: var(--fleapay-gray);"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="e081848d898ea0868c8581908199ce8a90">[email&#160;protected]</a> â–¼</span>
    </div>
  </header>

  <div class="admin-container">
    <!-- å…±é€šã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <nav class="admin-sidebar">
      <ul class="nav-menu">
        <li><a href="admin-dashboard.html" class="nav-item" data-page="dashboard">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a></li>
        <li><a href="admin-sellers.html" class="nav-item" data-page="sellers">ğŸ‘¥ å‡ºåº—è€…</a></li>
        <li><a href="admin-frames.html" class="nav-item" data-page="frames">ğŸ¨ AIãƒ•ãƒ¬ãƒ¼ãƒ </a></li>
        <li><a href="admin-payments.html" class="nav-item" data-page="payments">ğŸ’³ æ±ºæ¸ˆãƒ»CBç®¡ç†</a></li>
      </ul>
    </nav>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="admin-content">
      <section>
        <div class="sec-title-row">
          <h1>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
          <span class="pill">ãƒ›ãƒ¼ãƒ </span>
        </div>
        
        <!-- ãƒ•ã‚£ãƒ«ã‚¿ -->
        <div style="display: flex; gap: 16px; margin-bottom: 20px;">
          <select id="periodFilter" style="padding: 8px; border-radius: 8px;">
            <option value="today">ä»Šæ—¥</option>
            <option value="week">ä»Šé€±</option>
            <option value="month">ä»Šæœˆ</option>
          </select>
          <select id="eventFilter" style="padding: 8px; border-radius: 8px;">
            <option value="all">å…¨ã‚¤ãƒ™ãƒ³ãƒˆ</option>
            <option value="oi-flea">å¤§äº•ãƒ•ãƒªãƒ</option>
          </select>
          <button id="refreshBtn" class="ghost">ğŸ”„ æ›´æ–°</button>
        </div>
      </section>

      <!-- ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¡¨ç¤º -->
      <div class="grid">
        <section>
          <h2>ä»Šæ—¥ã®æ±ºæ¸ˆã‚µãƒãƒª</h2>
          <div style="font-size: 28px; font-weight: 700; color: var(--fleapay-blue); margin: 12px 0;">
            <span id="paymentCount">-</span><span style="font-size: 16px; margin-left: 4px;">ä»¶</span>
          </div>
          <div style="font-size: 14px; color: var(--fleapay-gray);">
            å£²ä¸Šåˆè¨ˆ: <span id="totalRevenue">Â¥0</span><br>
            ç´”å£²ä¸Š: <span id="netRevenue">Â¥0</span>
          </div>
        </section>
        
        <section>
          <h2>ãƒãƒ£ãƒ¼ã‚¸ãƒãƒƒã‚¯ / è¿”é‡‘</h2>
          <div style="font-size: 28px; font-weight: 700; color: var(--warning-amber); margin: 12px 0;">
            <span id="disputeCount">-</span><span style="font-size: 16px; margin-left: 4px;">ä»¶</span>
          </div>
          <div style="font-size: 14px; color: var(--fleapay-gray);">
            è¿”é‡‘: <span id="refundCount">-</span>ä»¶<br>
            æœŸé™é–“è¿‘: <span id="urgentCount" style="color: var(--error-maroon);">-</span>ä»¶ ğŸ””
          </div>
        </section>
      </div>

      <!-- ã‚¢ãƒ©ãƒ¼ãƒˆ -->
      <section>
        <h2>æœ€è¿‘ã®ã‚¢ãƒ©ãƒ¼ãƒˆ</h2>
        <div id="alertsList">
          <div style="text-align: center; padding: 20px; color: var(--fleapay-gray);">
            èª­ã¿è¾¼ã¿ä¸­...
          </div>
        </div>
      </section>

      <!-- eBayå£²ã‚Œç­‹ -->
      <section>
        <h2>eBayå£²ã‚Œç­‹ï¼ˆç›´è¿‘90æ—¥ï¼‰</h2>
        <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 10px;">
          <input
            id="ebayKeyword"
            type="text"
            placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆä¾‹: Pokemon cardï¼‰"
            style="padding: 8px; border-radius: 8px; min-width: 240px;"
          />
          <select id="ebayMarketplace" style="padding: 8px; border-radius: 8px;">
            <option value="EBAY_US">US</option>
            <option value="EBAY_GB">UK</option>
            <option value="EBAY_JP">JP</option>
          </select>
          <select id="ebayLimit" style="padding: 8px; border-radius: 8px;">
            <option value="10">10ä»¶</option>
            <option value="20">20ä»¶</option>
            <option value="50" selected>50ä»¶</option>
          </select>
          <button id="ebaySearchBtn" class="ghost">ğŸ” æ¤œç´¢</button>
        </div>
        <div id="ebaySoldStatus" style="font-size: 12px; color: var(--fleapay-gray); margin-bottom: 6px;"></div>
        <div id="ebaySoldList">
          <div style="text-align: center; padding: 20px; color: var(--fleapay-gray);">
            æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
          </div>
        </div>
        <div style="font-size: 12px; color: var(--fleapay-gray); margin-top: 6px;">
          â€» Marketplace Insights APIï¼ˆeBayæä¾›ï¼‰ã‚’ä½¿ç”¨ã€‚æœªæ‰¿èªã®å ´åˆã¯å–å¾—ã§ãã¾ã›ã‚“ã€‚
        </div>
      </section>

      <!-- å‡ºåº—è€…ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ -->
      <section>
        <h2>å‡ºåº—è€…ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£</h2>
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: var(--fleapay-cream);">
                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #eee;">å‡ºåº—è€…ID</th>
                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #eee;">åº—å</th>
                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #eee;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #eee;">æœ€çµ‚åˆ©ç”¨</th>
              </tr>
            </thead>
            <tbody id="recentSellers">
              <tr>
                <td colspan="4" style="padding: 20px; text-align: center; color: var(--fleapay-gray);">
                  èª­ã¿è¾¼ã¿ä¸­...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
    // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å›ºæœ‰ã®åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', async () => {
      // èªè¨¼ãƒã‚§ãƒƒã‚¯
      checkAuth();
      
      // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
      await loadDashboardData();
      initEbaySection();
      setupEventListeners();
      startAutoRefresh();
    });

    // èªè¨¼ãƒã‚§ãƒƒã‚¯
    function checkAuth() {
      const token = window.ADMIN_TOKEN || localStorage.getItem('ADMIN_TOKEN');
      if (!token) {
        console.warn('èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        // é–‹ç™ºç’°å¢ƒç”¨ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¨­å®š
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
          localStorage.setItem('ADMIN_TOKEN', 'admin-devtoken');
          console.log('é–‹ç™ºç’°å¢ƒç”¨ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¨­å®šã—ã¾ã—ãŸ');
        }
      }
    }

    async function loadDashboardData() {
      try {
        // âœ… ä¿®æ­£: /admin/dashboard â†’ /api/admin/dashboard
        const data = await adminAPI.request('/api/admin/dashboard');
        updateMetrics(data);
        adminUI.showToast('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
      } catch (error) {
        console.error('Dashboard load error:', error);
        adminUI.showToast('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
        
        // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¡¨ç¤º
        updateMetrics({
          paymentCount: 0,
          totalRevenue: 0,
          netRevenue: 0,
          disputeCount: 0,
          refundCount: 0
        });
        
        // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
        document.getElementById('alertsList').innerHTML = `
          <div class="err" style="padding: 12px;">
            <strong>âš ï¸ ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</strong><br>
            <small>${error.message || 'ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“'}</small>
          </div>
        `;
        
        // å‡ºåº—è€…ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        document.getElementById('recentSellers').innerHTML = `
          <tr>
            <td colspan="4" style="padding: 20px; text-align: center; color: var(--error-maroon);">
              ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ
            </td>
          </tr>
        `;
      }
    }

    function updateMetrics(data) {
      // æ±ºæ¸ˆã‚µãƒãƒªã®æ›´æ–°
      document.getElementById('paymentCount').textContent = data.paymentCount || 0;
      document.getElementById('totalRevenue').textContent = adminUI.formatCurrency(data.totalRevenue || 0);
      document.getElementById('netRevenue').textContent = adminUI.formatCurrency(data.netRevenue || 0);
      
      // ãƒãƒ£ãƒ¼ã‚¸ãƒãƒƒã‚¯ãƒ»è¿”é‡‘ã®æ›´æ–°
      document.getElementById('disputeCount').textContent = data.disputeCount || 0;
      document.getElementById('refundCount').textContent = data.refundCount || 0;
      
      // æœŸé™é–“è¿‘ã®ä»¶æ•°ï¼ˆurgentCountãŒã‚ã‚Œã°è¡¨ç¤ºï¼‰
      const urgentCountEl = document.getElementById('urgentCount');
      if (urgentCountEl) {
        urgentCountEl.textContent = data.urgentCount || 0;
      }
      
      // ã‚¢ãƒ©ãƒ¼ãƒˆã®æ›´æ–°
      updateAlerts(data);
      
      // å‡ºåº—è€…ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã®æ›´æ–°
      updateRecentSellers(data);
    }

    function updateAlerts(data) {
      const alertsList = document.getElementById('alertsList');
      
      // ã‚¢ãƒ©ãƒ¼ãƒˆãŒãªã„å ´åˆ
      if (!data.disputeCount && !data.urgentCount) {
        alertsList.innerHTML = `
          <div style="text-align: center; padding: 20px; color: var(--success-green);">
            âœ… ã‚¢ãƒ©ãƒ¼ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“
          </div>
        `;
        return;
      }
      
      // ã‚¢ãƒ©ãƒ¼ãƒˆãŒã‚ã‚‹å ´åˆ
      let html = '';
      
      if (data.urgentCount > 0) {
        html += `
          <div class="err" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <div>
              <strong>âš ï¸ ãƒãƒ£ãƒ¼ã‚¸ãƒãƒƒã‚¯ ${data.urgentCount}ä»¶ï¼ˆæœŸé™é–“è¿‘ï¼‰</strong><br>
              <small>æ—©æ€¥ãªå¯¾å¿œãŒå¿…è¦ã§ã™</small>
            </div>
            <button class="small" onclick="location.href='admin-payments.html?status=disputed'">å¯¾å¿œ</button>
          </div>
        `;
      }
      
      if (data.disputeCount > 0) {
        html += `
          <div style="background: #fef9e7; padding: 12px; border-radius: 8px; border: 1px solid var(--warning-amber);">
            <strong>ğŸ“‹ ãƒãƒ£ãƒ¼ã‚¸ãƒãƒƒã‚¯ ${data.disputeCount}ä»¶</strong><br>
            <small>å¯¾å¿œçŠ¶æ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„</small>
          </div>
        `;
      }
      
      alertsList.innerHTML = html;
    }

    function updateRecentSellers(data) {
      const tbody = document.getElementById('recentSellers');
      
      // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºï¼ˆå®Ÿéš›ã®APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹å ´åˆã¯ç½®ãæ›ãˆï¼‰
      if (!data.recentSellers || data.recentSellers.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" style="padding: 20px; text-align: center; color: var(--fleapay-gray);">
              ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“
            </td>
          </tr>
        `;
        return;
      }
      
      // å‡ºåº—è€…ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆ
      const rows = data.recentSellers.map(seller => `
        <tr>
          <td style="padding: 10px; border-bottom: 1px solid #eee;">${seller.id}</td>
          <td style="padding: 10px; border-bottom: 1px solid #eee;">${seller.name}</td>
          <td style="padding: 10px; border-bottom: 1px solid #eee;">
            <span style="background: #f0f9f4; color: var(--success-green); padding: 2px 8px; border-radius: 12px; font-size: 12px;">
              ${seller.status}
            </span>
          </td>
          <td style="padding: 10px; border-bottom: 1px solid #eee;">${adminUI.formatDate(seller.lastUsed)}</td>
        </tr>
      `).join('');
      
      tbody.innerHTML = rows;
    }

    function escapeHtml(value) {
      return String(value ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function formatEbayPrice(avgPrice) {
      if (!avgPrice || avgPrice.value === null || avgPrice.value === undefined) {
        return 'â€”';
      }
      const value = Number(avgPrice.value);
      if (!Number.isFinite(value)) return 'â€”';
      const currency = (avgPrice.currency || '').toUpperCase();
      const symbol = currency === 'USD' ? '$' : currency === 'GBP' ? 'Â£' : currency === 'JPY' ? 'Â¥' : '';
      const amount = value.toLocaleString(currency === 'JPY' ? 'ja-JP' : 'en-US');
      return symbol ? `${symbol}${amount}` : `${amount} ${currency || ''}`.trim();
    }

    function renderEbaySoldItems(payload) {
      const listEl = document.getElementById('ebaySoldList');
      const statusEl = document.getElementById('ebaySoldStatus');
      if (!listEl) return;

      const items = Array.isArray(payload.items) ? payload.items : [];
      if (!items.length) {
        listEl.innerHTML = `
          <div style="text-align: center; padding: 20px; color: var(--fleapay-gray);">
            è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“
          </div>
        `;
        if (statusEl) {
          statusEl.textContent = 'å–å¾—çµæœ: 0ä»¶';
        }
        return;
      }

      const rows = items.map((item, index) => {
        const title = escapeHtml(item.title || 'â€”');
        const sold = adminUI.formatNumber(item.soldQuantity || 0);
        const avgPrice = formatEbayPrice(item.averageSoldPrice);
        const link = item.itemUrl
          ? `<a href="${escapeHtml(item.itemUrl)}" target="_blank" rel="noopener">${title}</a>`
          : title;
        return `
          <tr>
            <td style="padding: 10px; border-bottom: 1px solid #eee; width: 60px;">${index + 1}</td>
            <td style="padding: 10px; border-bottom: 1px solid #eee;">${link}</td>
            <td style="padding: 10px; border-bottom: 1px solid #eee; width: 120px; text-align: right;">${sold}</td>
            <td style="padding: 10px; border-bottom: 1px solid #eee; width: 140px; text-align: right;">${avgPrice}</td>
          </tr>
        `;
      }).join('');

      listEl.innerHTML = `
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: var(--fleapay-cream);">
              <th style="padding: 10px; text-align: left; border-bottom: 1px solid #eee;">é †ä½</th>
              <th style="padding: 10px; text-align: left; border-bottom: 1px solid #eee;">å•†å“</th>
              <th style="padding: 10px; text-align: right; border-bottom: 1px solid #eee;">å£²ã‚ŒãŸæ•°</th>
              <th style="padding: 10px; text-align: right; border-bottom: 1px solid #eee;">å¹³å‡ä¾¡æ ¼</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;

      if (statusEl) {
        statusEl.textContent = `å–å¾—çµæœ: ${items.length}ä»¶`;
      }
    }

    async function loadEbayTopSold({ showToast = false } = {}) {
      const keywordEl = document.getElementById('ebayKeyword');
      const marketplaceEl = document.getElementById('ebayMarketplace');
      const limitEl = document.getElementById('ebayLimit');
      const listEl = document.getElementById('ebaySoldList');
      const statusEl = document.getElementById('ebaySoldStatus');

      if (!keywordEl || !listEl) return;

      const keyword = keywordEl.value.trim();
      if (!keyword) {
        listEl.innerHTML = `
          <div style="text-align: center; padding: 20px; color: var(--fleapay-gray);">
            ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
          </div>
        `;
        if (statusEl) statusEl.textContent = '';
        return;
      }

      const marketplace = marketplaceEl ? marketplaceEl.value : 'EBAY_US';
      const limit = limitEl ? limitEl.value : '10';
      localStorage.setItem('adminEbayKeyword', keyword);

      listEl.innerHTML = `
        <div style="text-align: center; padding: 20px; color: var(--fleapay-gray);">
          èª­ã¿è¾¼ã¿ä¸­...
        </div>
      `;
      if (statusEl) statusEl.textContent = `å–å¾—ä¸­: ${keyword}`;

      try {
        const params = new URLSearchParams({
          q: keyword,
          marketplace,
          limit
        });
        const data = await adminAPI.request(`/api/admin/ebay-sold?${params.toString()}`);
        if (!data.ok) {
          throw new Error(data.message || 'eBayãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        renderEbaySoldItems(data);
        if (showToast) {
          adminUI.showToast('eBayå£²ã‚Œç­‹ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
        }
      } catch (error) {
        listEl.innerHTML = `
          <div style="text-align: center; padding: 20px; color: var(--error-maroon);">
            ${escapeHtml(error.message || 'eBayãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ')}
          </div>
        `;
        if (statusEl) statusEl.textContent = 'å–å¾—å¤±æ•—';
        if (showToast) {
          adminUI.showToast('eBayå£²ã‚Œç­‹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }
      }
    }

    function initEbaySection() {
      const keywordEl = document.getElementById('ebayKeyword');
      const searchBtn = document.getElementById('ebaySearchBtn');
      const marketplaceEl = document.getElementById('ebayMarketplace');
      const limitEl = document.getElementById('ebayLimit');

      if (!keywordEl) return;

      const savedKeyword = localStorage.getItem('adminEbayKeyword');
      keywordEl.value = savedKeyword || 'Pokemon card';

      if (searchBtn) {
        searchBtn.addEventListener('click', () => loadEbayTopSold({ showToast: true }));
      }

      keywordEl.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          loadEbayTopSold({ showToast: true });
        }
      });

      if (marketplaceEl) {
        marketplaceEl.addEventListener('change', () => loadEbayTopSold());
      }
      if (limitEl) {
        limitEl.addEventListener('change', () => loadEbayTopSold());
      }

      loadEbayTopSold();
    }

    function setupEventListeners() {
      // æ›´æ–°ãƒœã‚¿ãƒ³
      document.getElementById('refreshBtn').addEventListener('click', async () => {
        const btn = document.getElementById('refreshBtn');
        btn.disabled = true;
        btn.textContent = 'ğŸ”„ æ›´æ–°ä¸­...';
        
        await loadDashboardData();
        
        btn.disabled = false;
        btn.textContent = 'ğŸ”„ æ›´æ–°';
      });
      
      // æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿
      document.getElementById('periodFilter').addEventListener('change', async (e) => {
        console.log('Period changed:', e.target.value);
        // æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ã«å¿œã˜ãŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å‡¦ç†ã‚’è¿½åŠ 
        await loadDashboardData();
      });
      
      // ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ã‚£ãƒ«ã‚¿
      document.getElementById('eventFilter').addEventListener('change', async (e) => {
        console.log('Event changed:', e.target.value);
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ã‚£ãƒ«ã‚¿ã«å¿œã˜ãŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å‡¦ç†ã‚’è¿½åŠ 
        await loadDashboardData();
      });
    }

    function startAutoRefresh() {
      // 5åˆ†ã”ã¨ã«è‡ªå‹•æ›´æ–°
      setInterval(() => {
        console.log('Auto refresh triggered');
        loadDashboardData();
      }, 300000);
    }
  </script>
</body>
</html>

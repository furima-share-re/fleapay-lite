# 手数料徴収機能実装 - レビュー資料

**作成日**: 2025 年 1 月  
**実装者**: AI Assistant  
**レビュー対象**: 手数料率マスタと手数料徴収機能の実装

---

## 📋 目次

1. [目的](#目的)
2. [前提条件](#前提条件)
3. [変更内容](#変更内容)
4. [実装ファイル一覧](#実装ファイル一覧)
5. [動作フロー](#動作フロー)
6. [データベース変更](#データベース変更)
7. [影響範囲](#影響範囲)
8. [テスト項目](#テスト項目)
9. [次のステップ](#次のステップ)

---

## 🎯 目的

### 主目的

**「出店者管理・手数料方式 仕様整理資料（最終）」に基づき、手数料徴収機能を実装する**

- 決済時に自動的に手数料を差し引く（Stripe 上で処理）
- プラン別の手数料率をマスタで管理
- チャージバック対応オプション込みの手数料率もマスタで設定可能

### 背景

- 現状、`app/api/checkout/session/route.ts`で手数料が徴収されていない
- 手数料率がハードコードされていない
- プラン別の手数料率管理機能がない

---

## 📐 前提条件

### 仕様要件

1. **基本方針**

   - edoichiba は売上金を一切保有しない
   - 売上金は Stripe から出店者口座へ直接入金
   - 手数料は決済時に自動差引（Stripe 上で処理）

2. **手数料設計**

   - 決済金額に対し ◯% **マスタで設定し、各出店者毎のプランによる**
   - 初期費用・月額費用なし
   - チャージバック対応オプションは基本手数料に込み（+1〜2%相当）

3. **出店者管理**
   - `seller_subscriptions`テーブルでプラン管理（'standard', 'pro', 'kids'）
   - プランに応じた手数料率を適用

### 技術的前提

- **データベース**: Supabase (PostgreSQL)
- **ORM**: Prisma
- **決済**: Stripe Connect
  - **重要**: `transfer_data.destination`と`application_fee_amount`を使用するため、**出店者は Stripe Connect の connected account（Express/Custom/Standard）を持つ必要がある**
  - 出店者が Connect に登録済みであることが前提
  - 未登録の場合は決済をブロック（オンボーディング導線が必要）
- **マイグレーション**: Supabase CLI / GitHub Actions

---

## 🔧 変更内容

### 1. 手数料率マスタテーブルの作成

**ファイル**: `supabase/migrations/20250116_120000_create_fee_rate_master.sql`

**内容**:

- `fee_rate_master`テーブルを作成
- プラン別の手数料率を管理（'standard', 'pro', 'kids'）
- 有効期間の管理（`effective_from`, `effective_to`）
- 初期データ投入（全プラン 7%で設定）

**テーブル構造**:

```sql
CREATE TABLE fee_rate_master (
  id uuid PRIMARY KEY,
  plan_type text NOT NULL,  -- 'standard', 'pro', 'kids'
  fee_rate numeric(5,4) NOT NULL,  -- 手数料率（例: 0.0700 = 7%）
  effective_from timestamptz NOT NULL,
  effective_to timestamptz,  -- NULLの場合は現在有効
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
```

### 2. Prisma スキーマの更新

**ファイル**: `prisma/schema.prisma`

**内容**:

- `FeeRateMaster`モデルを追加
- データベースがソースオブトゥルースのため、マイグレーション適用後に`prisma db pull`が必要

### 3. 手数料率取得関数の実装

**ファイル**: `lib/utils.ts`

**内容**:

- `getFeeRateFromMaster()`関数を追加
- プラン別の手数料率をマスタから取得
- マスタにデータがない場合はデフォルト値（7%）を返す

**関数シグネチャ**:

```typescript
export async function getFeeRateFromMaster(
  prisma: PrismaClient,
  planType: string
): Promise<number>;
```

### 4. 手数料徴収機能の実装

**ファイル**: `app/api/checkout/session/route.ts`

**変更内容**:

1. `getFeeRateFromMaster`をインポート
2. 出店者のプランを取得（`seller_subscriptions`テーブルから）
3. マスタから手数料率を取得
4. 手数料を計算（`order.amount * feeRate`）
5. `payment_intent_data.application_fee_amount`に設定
6. プラン情報と手数料率をメタデータに保存

**変更前**:

```typescript
payment_intent_data: {
  transfer_data: {
    destination: stripeAccountId,
  },
  // application_fee_amount が設定されていない
}
```

**変更後**:

```typescript
// プラン取得
const subscription = await prisma.sellerSubscription.findFirst({...});
const planType = subscription?.planType || 'standard';

// 手数料率取得
const feeRate = await getFeeRateFromMaster(prisma, planType);
const fee = Math.round(order.amount * feeRate);

payment_intent_data: {
  application_fee_amount: fee,  // 手数料を設定
  transfer_data: {
    destination: stripeAccountId,
  },
  metadata: {
    sellerId: order.sellerId,
    orderId: order.id,
    planType,
    feeRate: feeRate.toString(),
  },
}
```

---

## 📁 実装ファイル一覧

| ファイル                                                         | 変更内容                         | ステータス |
| ---------------------------------------------------------------- | -------------------------------- | ---------- |
| `supabase/migrations/20250116_120000_create_fee_rate_master.sql` | 新規作成                         | ✅         |
| `prisma/schema.prisma`                                           | `FeeRateMaster`モデル追加        | ✅         |
| `lib/utils.ts`                                                   | `getFeeRateFromMaster()`関数追加 | ✅         |
| `app/api/checkout/session/route.ts`                              | 手数料徴収ロジック追加           | ✅         |

---

## 🔄 動作フロー

### 決済フロー（変更後）

```
1. ユーザーが決済を開始
   ↓
2. POST /api/checkout/session
   ↓
3. 注文情報を取得
   ↓
4. 出店者のStripeアカウントIDを取得
   ↓
5. 【新規】出店者のプランを取得（seller_subscriptions）
   ↓
6. 【新規】マスタから手数料率を取得（fee_rate_master）
   ↓
7. 【新規】手数料を計算（order.amount * feeRate）
   ↓
8. Stripe Checkout Sessionを作成
   - application_fee_amount: 計算した手数料
   - transfer_data.destination: 出店者のStripeアカウント
   ↓
9. 決済完了
   - 顧客から: order.amount（手数料込み）
   - edoichibaへ: application_fee_amount（手数料）
   - 出店者へ: order.amount - application_fee_amount（純額）
```

### 手数料率取得フロー

```
1. getFeeRateFromMaster(prisma, planType) 呼び出し
   ↓
2. fee_rate_masterテーブルから有効な手数料率を取得
   - WHERE plan_type = planType
   - AND effective_from <= now()
   - AND (effective_to IS NULL OR effective_to >= now())
   ↓
3. データが見つかった場合
   → その手数料率を返す
   ↓
4. データが見つからない場合
   → デフォルト値（7%）を返す
```

---

## 🗄️ データベース変更

### 新規テーブル

**`fee_rate_master`**

| カラム           | 型           | 説明                                    |
| ---------------- | ------------ | --------------------------------------- |
| `id`             | uuid         | 主キー                                  |
| `plan_type`      | text         | プラン種別（'standard', 'pro', 'kids'） |
| `fee_rate`       | numeric(5,4) | 手数料率（0.0700 = 7%）                 |
| `effective_from` | timestamptz  | 有効開始日時                            |
| `effective_to`   | timestamptz  | 有効終了日時（NULL=現在有効）           |
| `created_at`     | timestamptz  | 作成日時                                |
| `updated_at`     | timestamptz  | 更新日時                                |

### 初期データ

```sql
INSERT INTO fee_rate_master (plan_type, fee_rate, effective_from) VALUES
  ('standard', 0.0700, now()),  -- 標準プラン: 7%
  ('pro', 0.0700, now()),       -- プロプラン: 7%
  ('kids', 0.0700, now());      -- キッズプラン: 7%
```

### 既存テーブルへの影響

- **変更なし**: 既存テーブルへの影響はありません
- **参照**: `seller_subscriptions`テーブルを参照（既存）

---

## 📊 影響範囲

### 影響を受ける機能

1. **決済処理** (`/api/checkout/session`)

   - 手数料が自動的に徴収されるようになる
   - プランに応じた手数料率が適用される

2. **売上計算**
   - 既存の手数料表示機能は影響なし（`stripe_payments.amount_fee`を使用）
   - Stripe が自動的に手数料を計算・記録するため

### 影響を受けない機能

- 現金決済（手数料 0 のまま）
- 売上サマリー表示（既存ロジックのまま）
- チャージバック対応機能（既存のまま）

### 後方互換性

- ✅ 既存の決済処理は動作し続ける
- ✅ プランがない出店者はデフォルト（7%）が適用される
- ✅ マスタにデータがない場合もデフォルト（7%）が適用される

---

## 🧪 テスト項目

### 単体テスト

1. **手数料率取得関数**

   - [ ] プラン別の手数料率が正しく取得できる
   - [ ] マスタにデータがない場合、デフォルト値（7%）が返される
   - [ ] 有効期間外のデータは取得されない

2. **手数料計算**
   - [ ] 手数料が正しく計算される（`order.amount * feeRate`）
   - [ ] 端数処理が正しい（`Math.round`）

### 統合テスト

1. **決済フロー**

   - [ ] 標準プランで決済時、正しい手数料が徴収される
   - [ ] プロプランで決済時、正しい手数料が徴収される
   - [ ] キッズプランで決済時、正しい手数料が徴収される
   - [ ] プランがない出店者で決済時、デフォルト手数料が適用される

2. **Stripe 連携**
   - [ ] `application_fee_amount`が正しく設定される
   - [ ] 出店者への入金額が正しい（`order.amount - fee`）
   - [ ] メタデータにプラン情報と手数料率が保存される

### 手動テスト

1. **マイグレーション**

   - [ ] `fee_rate_master`テーブルが作成される
   - [ ] 初期データが投入される
   - [ ] Prisma スキーマが更新される

2. **決済テスト**
   - [ ] 実際に決済を実行して手数料が徴収されることを確認
   - [ ] Stripe Dashboard で手数料が正しく記録されることを確認

---

## 🚀 次のステップ

### 実装後の作業

1. **マイグレーションの適用**

   ```bash
   # Gitにコミット・プッシュ
   git add supabase/migrations/20250116_120000_create_fee_rate_master.sql
   git commit -m "feat: add fee_rate_master table for fee rate management"
   git push origin main

   # GitHub Actionsが自動的にマイグレーションを適用
   # または手動で実行
   supabase db push
   ```

2. **Prisma スキーマの更新**

   ```bash
   # マイグレーション適用後
   npx prisma db pull
   npx prisma generate
   ```

3. **手数料率の設定**
   - 必要に応じて`fee_rate_master`テーブルでプラン別の手数料率を調整
   - チャージバック対応オプション込みのプランは、手数料率を高く設定（例: 8〜9%）

### 今後の改善

1. **手数料率マスタの管理 UI**

   - 管理者が手数料率を設定・変更できる UI
   - プラン別の手数料率履歴管理

2. **明細名最適化機能**
   - チャージバック対応オプション利用時の明細名最適化
   - Stripe Checkout Session の`line_items`で明細名を調整

---

## ⚠️ 注意事項

### 重要なポイント

1. **手数料率の初期値**

   - 現在は全プラン 7%で設定
   - 本番環境では、実際の手数料率に合わせて調整が必要

2. **チャージバック対応オプション**

   - 基本手数料に込みのため、追加の手数料加算ロジックは不要
   - チャージバック対応込みのプランは、マスタで手数料率を高く設定（例: 8〜9%）

3. **後方互換性**

   - プランがない出店者はデフォルト（7%）が適用される
   - 既存の決済処理は動作し続ける

4. **データベース操作**
   - マイグレーションは GitHub Actions で自動実行される
   - 手動で実行する場合は、`supabase db push`を使用

---

## 📝 変更サマリー

| 項目             | 内容                                                         |
| ---------------- | ------------------------------------------------------------ |
| **新規ファイル** | 1 件（マイグレーション SQL）                                 |
| **変更ファイル** | 3 件（Prisma スキーマ、utils.ts、checkout/session/route.ts） |
| **新規テーブル** | 1 件（fee_rate_master）                                      |
| **新規関数**     | 1 件（getFeeRateFromMaster）                                 |
| **影響範囲**     | 決済処理のみ（後方互換性あり）                               |
| **破壊的変更**   | なし                                                         |

---

**最終更新**: 2025 年 1 月  
**レビュー準備完了**: ✅

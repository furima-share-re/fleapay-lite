# æœ¬ç•ªç’°å¢ƒãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨ã‚¬ã‚¤ãƒ‰

**ä½œæˆæ—¥**: 2026-01-14  
**å•é¡Œ**: `fee_rate_master` ãƒ†ãƒ¼ãƒ–ãƒ«ãŒæœ¬ç•ªç’°å¢ƒã«å­˜åœ¨ã—ãªã„ãŸã‚ã€HTTP 500ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ

---

## ğŸ” å•é¡Œã®æ¦‚è¦

æœ¬ç•ªç’°å¢ƒï¼ˆ`edo-ichiba.com`ï¼‰ã§ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ï¼š

- **ã‚¨ãƒ©ãƒ¼**: `relation "fee_rate_master" does not exist`
- **å½±éŸ¿ç¯„å›²**: 
  - `/api/admin/fee-rates` - æ‰‹æ•°æ–™ç‡ãƒã‚¹ã‚¿å–å¾—API
  - `/api/admin/benchmark-data` - ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ãƒ‡ãƒ¼ã‚¿å–å¾—APIï¼ˆ`benchmark_data` ãƒ†ãƒ¼ãƒ–ãƒ«ã‚‚å­˜åœ¨ã—ãªã„å¯èƒ½æ€§ï¼‰

---

## ğŸ“‹ é©ç”¨ãŒå¿…è¦ãªãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

### 1. `fee_rate_master` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `supabase/migrations/20250116_120000_create_fee_rate_master.sql`

**å†…å®¹**:
- `fee_rate_master` ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ
- ãƒ—ãƒ©ãƒ³åˆ¥ã®æ‰‹æ•°æ–™ç‡ç®¡ç†ï¼ˆ'standard', 'pro', 'kids'ï¼‰
- åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥ï¼ˆå…¨ãƒ—ãƒ©ãƒ³ 7%ã§è¨­å®šï¼‰

### 2. Tieråˆ¶ã‚·ã‚¹ãƒ†ãƒ è¿½åŠ 

**ãƒ•ã‚¡ã‚¤ãƒ«**: `supabase/migrations/20250117_120000_add_strategy_f_tier_system.sql`

**å†…å®¹**:
- `fee_rate_master` ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ‹¡å¼µï¼ˆTieråˆ¶å¯¾å¿œï¼‰
- `community_goal_master` ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ
- `community_transaction_volume` ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ
- Tieråˆ¶ã®åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥

### 3. `benchmark_data` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰

**æ³¨æ„**: ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã¯ç¾åœ¨å­˜åœ¨ã—ã¾ã›ã‚“ã€‚å¿…è¦ã«å¿œã˜ã¦ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

---

## ğŸš€ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨æ–¹æ³•

### æ–¹æ³•A: Supabase CLIã‚’ä½¿ç”¨ï¼ˆæ¨å¥¨ï¼‰

#### ã‚¹ãƒ†ãƒƒãƒ—1: Supabase CLIã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```bash
# Supabase CLIã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆæœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®å ´åˆï¼‰
npm install -g supabase

# ã¾ãŸã¯ã€npxã‚’ä½¿ç”¨
npx supabase --version
```

#### ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ãƒªãƒ³ã‚¯

```bash
# ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
export SUPABASE_ACCESS_TOKEN="your-access-token"
export SUPABASE_PROJECT_ID="your-project-id"

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ãƒªãƒ³ã‚¯
supabase link --project-ref $SUPABASE_PROJECT_ID
```

**æ³¨æ„**: æœ¬ç•ªç’°å¢ƒã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚

#### ã‚¹ãƒ†ãƒƒãƒ—3: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®é©ç”¨

```bash
# ã™ã¹ã¦ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨
supabase db push

# ã¾ãŸã¯ã€ç‰¹å®šã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é©ç”¨
supabase migration up
```

---

### æ–¹æ³•B: Supabase Dashboardã®SQL Editorã‚’ä½¿ç”¨

#### ã‚¹ãƒ†ãƒƒãƒ—1: Supabase Dashboardã«ã‚¢ã‚¯ã‚»ã‚¹

1. https://app.supabase.com ã«ãƒ­ã‚°ã‚¤ãƒ³
2. æœ¬ç•ªç’°å¢ƒã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ

#### ã‚¹ãƒ†ãƒƒãƒ—2: SQL Editorã‚’é–‹ã

1. å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ **SQL Editor** ã‚’é¸æŠ
2. **New query** ã‚’ã‚¯ãƒªãƒƒã‚¯

#### ã‚¹ãƒ†ãƒƒãƒ—3: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’å®Ÿè¡Œ

1. `supabase/migrations/20250116_120000_create_fee_rate_master.sql` ã®å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼
2. SQL Editorã«è²¼ã‚Šä»˜ã‘
3. **Run** ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å®Ÿè¡Œ

#### ã‚¹ãƒ†ãƒƒãƒ—4: 2ã¤ç›®ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨

1. `supabase/migrations/20250117_120000_add_strategy_f_tier_system.sql` ã®å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼
2. SQL Editorã«è²¼ã‚Šä»˜ã‘
3. **Run** ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å®Ÿè¡Œ

---

### æ–¹æ³•C: GitHub Actionsã‚’ä½¿ç”¨ï¼ˆè‡ªå‹•åŒ–ï¼‰

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã¯ `.github/workflows/apply-migrations.yml` ãŒå­˜åœ¨ã—ã¾ã™ã€‚

#### ã‚¹ãƒ†ãƒƒãƒ—1: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆ

```bash
git add supabase/migrations/
git commit -m "chore: add fee_rate_master migration"
git push origin main
```

#### ã‚¹ãƒ†ãƒƒãƒ—2: GitHub Actionsã®å®Ÿè¡Œ

1. GitHubãƒªãƒã‚¸ãƒˆãƒªã«ã‚¢ã‚¯ã‚»ã‚¹
2. **Actions** ã‚¿ãƒ–ã‚’é–‹ã
3. **Apply Migrations** ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ç¢ºèª
4. å¿…è¦ã«å¿œã˜ã¦æ‰‹å‹•å®Ÿè¡Œï¼ˆ`workflow_dispatch`ï¼‰

**æ³¨æ„**: æœ¬ç•ªç’°å¢ƒã¸ã®é©ç”¨ã¯æ‰‹å‹•æ‰¿èªãŒå¿…è¦ãªå ´åˆãŒã‚ã‚Šã¾ã™ã€‚

---

## âœ… é©ç”¨å¾Œã®ç¢ºèª

### 1. ãƒ†ãƒ¼ãƒ–ãƒ«ã®å­˜åœ¨ç¢ºèª

Supabase SQL Editorã§ä»¥ä¸‹ã‚’å®Ÿè¡Œï¼š

```sql
-- fee_rate_masterãƒ†ãƒ¼ãƒ–ãƒ«ã®ç¢ºèª
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
  AND table_name IN ('fee_rate_master', 'community_goal_master', 'community_transaction_volume')
ORDER BY table_name;

-- fee_rate_masterãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ç¢ºèª
SELECT * FROM fee_rate_master ORDER BY plan_type, tier NULLS LAST;
```

### 2. APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ç¢ºèª

ãƒ–ãƒ©ã‚¦ã‚¶ã¾ãŸã¯curlã§ä»¥ä¸‹ã‚’ç¢ºèªï¼š

```bash
# æ‰‹æ•°æ–™ç‡ãƒã‚¹ã‚¿å–å¾—API
curl -H "x-admin-token: your-admin-token" \
  https://edo-ichiba.com/api/admin/fee-rates

# ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ãƒ‡ãƒ¼ã‚¿å–å¾—APIï¼ˆbenchmark_dataãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
curl -H "x-admin-token: your-admin-token" \
  "https://edo-ichiba.com/api/admin/benchmark-data?weekStart=2026-01-12"
```

### 3. Prismaã‚¹ã‚­ãƒ¼ãƒã®æ›´æ–°

ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨å¾Œã€Prismaã‚¹ã‚­ãƒ¼ãƒã‚’æ›´æ–°ï¼š

```bash
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã‚¹ã‚­ãƒ¼ãƒã‚’å–å¾—
npx prisma db pull

# Prisma Clientã‚’å†ç”Ÿæˆ
npx prisma generate
```

---

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚¨ãƒ©ãƒ¼: "relation already exists"

ãƒ†ãƒ¼ãƒ–ãƒ«ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã® `CREATE TABLE IF NOT EXISTS` ã«ã‚ˆã‚Šå®‰å…¨ã«å‡¦ç†ã•ã‚Œã¾ã™ã€‚

### ã‚¨ãƒ©ãƒ¼: "permission denied"

Supabaseã®æ¨©é™è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`service_role` ã‚­ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã€ã™ã¹ã¦ã®æ“ä½œãŒè¨±å¯ã•ã‚Œã¾ã™ã€‚

### ã‚¨ãƒ©ãƒ¼: "connection refused"

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæƒ…å ±ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š
- `DATABASE_URL` ç’°å¢ƒå¤‰æ•°
- Supabase Dashboardã® **Settings** > **Database** > **Connection string**

---

## ğŸ“ æ³¨æ„äº‹é …

1. **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—**: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨å‰ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–å¾—ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚

2. **ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ **: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨ä¸­ã¯ã€è©²å½“APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒä¸€æ™‚çš„ã«åˆ©ç”¨ã§ããªããªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

3. **ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯**: å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã€Supabase Dashboardã® **Database** > **Migrations** ã‹ã‚‰ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ãã¾ã™ã€‚

4. **ãƒ†ã‚¹ãƒˆç’°å¢ƒ**: å¯èƒ½ã§ã‚ã‚Œã°ã€ã¾ãšãƒ†ã‚¹ãƒˆç’°å¢ƒã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨ã—ã¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚

---

## ğŸ”— é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- `supabase/migrations/20250116_120000_create_fee_rate_master.sql`
- `supabase/migrations/20250117_120000_add_strategy_f_tier_system.sql`
- `app/api/admin/fee-rates/route.ts`
- `app/api/admin/benchmark-data/route.ts`
- `.github/workflows/apply-migrations.yml`

---

## ğŸ“ ã‚µãƒãƒ¼ãƒˆ

å•é¡ŒãŒè§£æ±ºã—ãªã„å ´åˆï¼š
1. ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªï¼ˆ`logs_result (4).json`ï¼‰
2. Supabase Dashboardã®ãƒ­ã‚°ã‚’ç¢ºèª
3. ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨˜éŒ²ã—ã¦é–‹ç™ºãƒãƒ¼ãƒ ã«å ±å‘Š

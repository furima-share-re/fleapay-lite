# 本番環境・検証環境マイグレーション適用ガイド

**作成日**: 2026-01-14  
**問題**: `fee_rate_master` テーブルが本番環境に存在しないため、HTTP 500エラーが発生

---

## 🔍 問題の概要

本番環境（`edo-ichiba.com`）で以下のエラーが発生しています：

- **エラー**: `relation "fee_rate_master" does not exist`
- **影響範囲**: 
  - `/api/admin/fee-rates` - 手数料率マスタ取得API
  - `/api/admin/benchmark-data` - ベンチマークデータ取得API（`benchmark_data` テーブルも存在しない可能性）

---

## ⚠️ 重要な注意事項

**本番環境と検証環境は別々のSupabaseプロジェクトを使用しています。**

- **検証環境**: `edo ichiba staging` (Project ID: `mluvjdhqgfpcfsmvjae`)
- **本番環境**: 別のSupabaseプロジェクト

**✅ 自動適用の仕組み**: `main`ブランチにマイグレーションファイルをプッシュすると、**検証環境と本番環境の両方に自動適用**されます。

**実行順序**:
1. 検証環境に自動適用（手動承認不要）
2. 検証環境が成功したら、本番環境に自動適用（手動承認が必要な場合あり）

---

## 📋 適用が必要なマイグレーション

### 1. `fee_rate_master` テーブル作成

**ファイル**: `supabase/migrations/20250116_120000_create_fee_rate_master.sql`

**内容**:
- `fee_rate_master` テーブルの作成
- プラン別の手数料率管理（'standard', 'pro', 'kids'）
- 初期データ投入（全プラン 7%で設定）

### 2. Tier制システム追加

**ファイル**: `supabase/migrations/20250117_120000_add_strategy_f_tier_system.sql`

**内容**:
- `fee_rate_master` テーブルの拡張（Tier制対応）
- `community_goal_master` テーブルの作成
- `community_transaction_volume` テーブルの作成
- Tier制の初期データ投入

### 3. `benchmark_data` テーブル作成（必要に応じて）

**注意**: このテーブルのマイグレーションファイルは現在存在しません。必要に応じて作成する必要があります。

---

## 🚀 マイグレーション適用方法

**⚠️ ルール**: 人間はSQLを直接実行しません。すべてのマイグレーションはCLIまたはGitHub Actionsを使用して適用します。

### 方法A: Supabase CLIを使用（推奨）

#### ステップ1: Supabase CLIのセットアップ

```bash
# Supabase CLIをインストール（未インストールの場合）
npm install -g supabase

# または、npxを使用
npx supabase --version
```

#### ステップ2: 検証環境に適用

```bash
# 検証環境のプロジェクトにリンク
export SUPABASE_ACCESS_TOKEN="your-access-token"
export SUPABASE_PROJECT_ID="mluvjdhqgfpcfsmvjae"  # 検証環境のProject ID

# プロジェクトにリンク
supabase link --project-ref $SUPABASE_PROJECT_ID

# マイグレーションを適用
supabase db push
```

#### ステップ3: 本番環境に適用

```bash
# 本番環境のプロジェクトにリンク
export SUPABASE_ACCESS_TOKEN="your-access-token"
export SUPABASE_PROJECT_ID="your-production-project-id"  # 本番環境のProject ID

# プロジェクトにリンク
supabase link --project-ref $SUPABASE_PROJECT_ID

# マイグレーションを適用
supabase db push
```

**重要**: 検証環境で問題がないことを確認してから、本番環境に適用してください。

---

### 方法B: GitHub Actionsを使用（自動化・推奨）

**✅ 自動実行の仕組み**

`main`ブランチに`supabase/migrations/`配下のファイルをプッシュすると、**自動的にマイグレーションが適用されます**。

#### 自動実行の条件

1. ✅ `main`ブランチにプッシュする
2. ✅ `supabase/migrations/`配下のファイルが変更される
3. ✅ GitHub Secretsが正しく設定されている
   - `SUPABASE_ACCESS_TOKEN`
   - `SUPABASE_PROJECT_ID`
4. ⚠️ 手動承認が必要な場合は承認する（環境保護が有効な場合）

#### 実行手順

```bash
# マイグレーションファイルをコミット
git add supabase/migrations/
git commit -m "chore: add fee_rate_master migration"
git push origin main
```

**プッシュ後、自動的に以下が実行されます：**
1. マイグレーションファイルの検証
2. マイグレーションの適用（`supabase db push`）
3. Prismaスキーマの更新（`prisma db pull` + `prisma generate`）
4. Prismaスキーマ更新のPR作成

#### 実行順序

1. **検証環境に自動適用**（手動承認不要）
2. **本番環境に自動適用**（検証環境成功後、手動承認が必要）

**重要**: 検証環境で問題が発生した場合、本番環境への適用は自動的にスキップされます。

#### 必要なGitHub Secrets

以下のSecretsをGitHubリポジトリに設定する必要があります：

- `SUPABASE_ACCESS_TOKEN` - Supabase APIアクセストークン（共通）
- `SUPABASE_PROJECT_ID_STAGING` - 検証環境のProject ID（`mluvjdhqgfpcfsmvjae`）
- `SUPABASE_PROJECT_ID_PRODUCTION` - 本番環境のProject ID

**設定方法**:
1. GitHubリポジトリ → **Settings** → **Secrets and variables** → **Actions**
2. **New repository secret** をクリック
3. 上記のSecretsを追加

#### GitHub環境の設定（オプション）

本番環境への適用時に手動承認を必須にする場合：

1. GitHubリポジトリ → **Settings** → **Environments**
2. **New environment** をクリック
3. 環境名: `production` を入力
4. **Required reviewers** を有効化（必要に応じて）
5. **Deployment branches** を設定（`main`ブランチのみなど）

**検証環境**は自動実行のため、環境保護は設定しなくても動作します。

---

## ✅ 適用後の確認

### 1. APIエンドポイントの確認

**検証環境と本番環境の両方で以下を確認：**

```bash
# 手数料率マスタ取得API（検証環境）
curl -H "x-admin-token: your-admin-token" \
  https://your-staging-domain.com/api/admin/fee-rates

# 手数料率マスタ取得API（本番環境）
curl -H "x-admin-token: your-admin-token" \
  https://edo-ichiba.com/api/admin/fee-rates

# ベンチマークデータ取得API（benchmark_dataテーブルが存在する場合）
curl -H "x-admin-token: your-admin-token" \
  "https://edo-ichiba.com/api/admin/benchmark-data?weekStart=2026-01-12"
```

### 2. Prismaスキーマの更新

マイグレーション適用後、Prismaスキーマを更新：

```bash
# データベースからスキーマを取得
npx prisma db pull

# Prisma Clientを再生成
npx prisma generate
```

---

## 🔧 トラブルシューティング

### エラー: "relation already exists"

テーブルが既に存在する場合、マイグレーションファイルの `CREATE TABLE IF NOT EXISTS` により安全に処理されます。

### エラー: "permission denied"

Supabaseの権限設定を確認してください。`service_role` キーを使用している場合、すべての操作が許可されます。

### エラー: "connection refused"

データベース接続情報を確認してください：
- `DATABASE_URL` 環境変数
- Supabase Dashboardの **Settings** > **Database** > **Connection string**

---

## 📝 注意事項

1. **バックアップ**: マイグレーション適用前にデータベースのバックアップを取得することを推奨します。

2. **ダウンタイム**: マイグレーション適用中は、該当APIエンドポイントが一時的に利用できなくなる可能性があります。

3. **ロールバック**: 問題が発生した場合、Supabase CLIまたはGitHub Actionsを使用してロールバックできます（SQL Editorは使用しません）。

4. **テスト環境**: 可能であれば、まずテスト環境でマイグレーションを適用して確認してください。

---

## 🔗 関連ファイル

- `supabase/migrations/20250116_120000_create_fee_rate_master.sql`
- `supabase/migrations/20250117_120000_add_strategy_f_tier_system.sql`
- `app/api/admin/fee-rates/route.ts`
- `app/api/admin/benchmark-data/route.ts`
- `.github/workflows/apply-migrations.yml`

---

## 📞 サポート

問題が解決しない場合：
1. ログファイルを確認（`logs_result (4).json`）
2. Supabase Dashboardのログを確認
3. エラーメッセージを記録して開発チームに報告

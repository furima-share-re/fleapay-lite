# Phase 1.8: 本番環境DB移行 工数見積もり

**作成日**: 2026-01-03  
**見積もり基準**: 検証環境DB移行（Phase 1.3）の実績を基に算出

---

## 📊 検証環境DB移行の実績（参考）

**Phase 1.3: 検証環境データ移行**
- **実装日**: 2026-01-02
- **予定期間**: Week 2 Day 1-2（2日間）
- **実際の所要時間**: **約1日**（1日で完了）
- **作業内容**:
  - Supabaseプロジェクト作成（既存）
  - スキーマ移行
  - データ移行
  - 動作確認

---

## 🔍 本番環境DB移行の工数見積もり

### 前提条件

- ✅ 検証環境のDB移行が完了している（Phase 1.3）
- ✅ スキーマ移行の手順が確立されている
- ✅ データ移行の手順が確立されている
- ⚠️ 本番環境はより慎重な作業が必要
- ⚠️ データバックアップが必須
- ⚠️ ロールバック計画が必要

---

## 📋 作業項目別工数見積もり

### Step 1: 本番環境Supabaseプロジェクト作成

**工数**: **15-30分**

**作業内容**:
- Supabase Dashboardで新規プロジェクト作成
- プロジェクト設定（名前、リージョン、プラン選択）
- 接続情報の取得・保存

**リスク要因**:
- プラン選択に迷う場合: +15分
- 接続情報の確認に時間がかかる場合: +15分

**最適**: 15分  
**通常**: 20分  
**最悪**: 30分

---

### Step 2: 本番環境データバックアップ取得

**工数**: **30分-1時間**

**作業内容**:
- Render Dashboardでデータベース接続情報を取得
- `pg_dump`でデータダンプを取得
- バックアップファイルの保存・確認

**リスク要因**:
- データ量が多い場合: +30分-1時間
- ネットワークが遅い場合: +30分
- バックアップファイルの検証に時間がかかる場合: +15分

**最適**: 30分（データ量が少ない場合）  
**通常**: 45分（中規模データ）  
**最悪**: 1時間（大規模データ）

---

### Step 3: Supabaseへのスキーマ移行

**工数**: **30分-1時間**

**作業内容**:
- Supabase SQL Editorでスキーマを実行
- テーブル・インデックスの作成確認
- スキーマの整合性確認

**リスク要因**:
- スキーマエラーが発生する場合: +30分-1時間
- 外部キー制約のエラー: +15-30分
- インデックスの作成に時間がかかる場合: +15分

**最適**: 30分（検証環境と同じスキーマを使用）  
**通常**: 45分（軽微な調整が必要）  
**最悪**: 1時間（エラー修正が必要）

---

### Step 4: Supabaseへのデータ移行

**工数**: **1-3時間**（データ量による）

**作業内容**:
- データダンプファイルのインポート
- データ整合性の確認
- レコード数の確認

**リスク要因**:
- データ量が多い場合: +1-2時間
- データ整合性エラーが発生する場合: +30分-1時間
- 外部キー制約エラー: +30分-1時間
- ネットワークが遅い場合: +30分-1時間

**最適**: 1時間（データ量が少ない場合、< 10,000レコード）  
**通常**: 2時間（中規模データ、10,000-100,000レコード）  
**最悪**: 3時間（大規模データ、> 100,000レコード）

---

### Step 5: 本番環境の環境変数設定

**工数**: **15-30分**

**作業内容**:
- Render Dashboardで環境変数を更新
- 環境変数の確認
- デプロイの確認

**リスク要因**:
- 環境変数の設定ミス: +15分
- デプロイエラー: +15-30分

**最適**: 15分  
**通常**: 20分  
**最悪**: 30分

---

### Step 6: 本番環境動作確認

**注意**: Prisma Clientの再生成は不要です。`package.json`の`postinstall`スクリプトにより、デプロイ時に自動的に実行されます。

**工数**: **1-2時間**

**作業内容**:
- APIエンドポイントの動作確認
- 決済機能の動作確認
- 既存ユーザーのデータ確認
- データ整合性の確認

**リスク要因**:
- エラーが発生する場合: +1-2時間
- パフォーマンス問題: +30分-1時間
- データ不整合: +30分-1時間

**最適**: 1時間（問題なく動作する場合）  
**通常**: 1.5時間（軽微な問題がある場合）  
**最悪**: 2時間（重大な問題がある場合）

---

### Step 8: トラブルシューティング（予備）

**工数**: **1-2時間**（問題が発生した場合）

**作業内容**:
- エラーの調査・修正
- データ整合性の問題修正
- パフォーマンス問題の対応

**リスク要因**:
- 重大な問題が発生する場合: +2-4時間
- ロールバックが必要な場合: +1-2時間

**最適**: 0時間（問題が発生しない場合）  
**通常**: 1時間（軽微な問題がある場合）  
**最悪**: 2時間（重大な問題がある場合）

---

## 📊 工数見積もりサマリー

### 最適ケース（問題なく進む場合）

| 作業項目 | 工数 |
|---------|------|
| Step 1: Supabaseプロジェクト作成 | 15分 |
| Step 2: データバックアップ取得 | 30分 |
| Step 3: スキーマ移行 | 30分 |
| Step 4: データ移行 | 1時間 |
| Step 5: 環境変数設定 | 15分 |
| Step 6: Prisma Client再生成 | 5分 |
| Step 7: 動作確認 | 1時間 |
| Step 8: トラブルシューティング | 0時間 |
| **合計** | **約3時間45分** |

### 通常ケース（軽微な問題がある場合）

| 作業項目 | 工数 |
|---------|------|
| Step 1: Supabaseプロジェクト作成 | 20分 |
| Step 2: データバックアップ取得 | 45分 |
| Step 3: スキーマ移行 | 45分 |
| Step 4: データ移行 | 2時間 |
| Step 5: 環境変数設定 | 20分 |
| Step 6: Prisma Client再生成 | 10分 |
| Step 7: 動作確認 | 1.5時間 |
| Step 8: トラブルシューティング | 1時間 |
| **合計** | **約7時間10分** |

### 最悪ケース（重大な問題がある場合）

| 作業項目 | 工数 |
|---------|------|
| Step 1: Supabaseプロジェクト作成 | 30分 |
| Step 2: データバックアップ取得 | 1時間 |
| Step 3: スキーマ移行 | 1時間 |
| Step 4: データ移行 | 3時間 |
| Step 5: 環境変数設定 | 30分 |
| Step 6: Prisma Client再生成 | 15分 |
| Step 7: 動作確認 | 2時間 |
| Step 8: トラブルシューティング | 2時間 |
| **合計** | **約10時間15分** |

---

## 🎯 推奨見積もり

### 工数見積もり

**最適**: **約3.5-4時間**（0.5日）  
**通常**: **約6.5-7時間**（1日）  
**最悪**: **約9-10時間**（1.5日）

### 推奨スケジュール

**推奨**: **1日（8時間）**を確保

- 午前中（4時間）: Step 1-4（準備・移行）
- 午後（4時間）: Step 5-7（設定・確認）+ 予備時間

### リスク要因

1. **データ量**: 本番環境のデータ量が多い場合、移行時間が長くなる
2. **ネットワーク**: データ転送速度が遅い場合、移行時間が長くなる
3. **エラー発生**: スキーマエラーやデータ整合性エラーが発生する場合、修正時間が必要
4. **動作確認**: 問題が発生する場合、トラブルシューティングに時間がかかる

---

## 📋 工数削減のポイント

1. **事前準備**
   - 検証環境で手順を完全に確認
   - スキーマファイルを事前に準備
   - データバックアップを事前に取得

2. **段階的移行**
   - まずスキーマのみ移行して確認
   - その後、データを移行

3. **自動化**
   - 可能な限りスクリプトを使用
   - 手動作業を最小限に

---

## ⚠️ 注意事項

- **ダウンタイム**: 環境変数の変更のみで切り替え可能なため、ダウンタイムは最小限（数分）
- **ロールバック**: 環境変数を元に戻すだけでロールバック可能（数分）
- **データバックアップ**: 必ず事前にバックアップを取得
- **動作確認**: 十分な時間を確保して動作確認を実施

---

## 📊 検証環境との比較

| 項目 | 検証環境（Phase 1.3） | 本番環境（Phase 1.8） |
|------|---------------------|---------------------|
| **実装日** | 2026-01-02 | 未実施 |
| **所要時間** | 約1日 | 見積もり: 1日 |
| **データ量** | 少ない（テストデータ） | 多い（本番データ） |
| **リスク** | 低 | 高 |
| **慎重度** | 中 | 高 |
| **バックアップ** | 不要 | 必須 |
| **ロールバック計画** | 不要 | 必須 |

---

## 🎯 結論

**推奨工数**: **1日（8時間）**

- **最適ケース**: 約4時間（0.5日）
- **通常ケース**: 約7-8時間（1日）
- **最悪ケース**: 約10-12時間（1.5日）

**推奨スケジュール**: **1日を確保**して、余裕を持って実施することを推奨します。


# 出店者管理・手数料方式 実装状況レポート

**作成日**: 2025 年 1 月  
**確認対象**: 「出店者管理・手数料方式 仕様整理資料（最終）」に基づく実装状況

---

## 📊 実装状況サマリー

| 機能                             | 実装状況          | 詳細                                                   |
| -------------------------------- | ----------------- | ------------------------------------------------------ |
| **基本方針（資金非保有）**       | ✅ 実装済み       | `transfer_data`で Stripe から出店者口座へ直接入金      |
| **手数料徴収**                   | ⚠️ 不整合あり     | `app/api/checkout/session/route.ts`で手数料未設定      |
| **手数料表示**                   | ✅ 実装済み       | 売上サマリー API で手数料を表示                        |
| **出金機能**                     | ✅ 不要（仕様上） | Stripe から直接入金されるため不要                      |
| **チャージバック対応**           | ✅ 実装済み       | Webhook、証拠生成・提出機能あり                        |
| **チャージバック対応オプション** | ⚠️ 部分実装       | `seller_subscriptions`テーブルはあるが、手数料連動なし |

---

## 1. 基本方針の実装状況

### ✅ 実装済み: 資金非保有方式

**仕様要件**:

- edoichiba は売上金を一切保有しない
- 売上金は Stripe から出店者口座へ直接入金

**実装状況**:

- ✅ `transfer_data`を使用して Stripe から出店者アカウントへ直接転送
- **場所**: `app/api/checkout/session/route.ts` (行 178-186)

```typescript
payment_intent_data: {
  transfer_data: {
    destination: stripeAccountId, // 出店者のStripeアカウントへ直接転送
  },
}
```

**評価**: ✅ 仕様に完全に合致

---

## 2. 手数料（Fee）実装状況

### ✅ 実装済み機能

#### 2.1 Stripe 決済の手数料記録

- **場所**: `payments.js`, `app/api/webhooks/stripe/route.ts`
- **実装内容**:
  - Stripe の`balance_transaction`から手数料を取得
  - `stripe_payments`テーブルの`amount_fee`カラムに保存
  - Webhook で自動記録

```javascript
// payments.js (行101-119)
const balanceTx = await stripe.balanceTransactions.retrieve(balanceTxId);
fee = balanceTx.fee || 0;
```

#### 2.2 手数料の集計・表示

- **場所**: `payments.js` (行 325-376), `app/api/seller/summary/route.ts`
- **実装内容**:
  - 今日の手数料合計を計算
  - 累計手数料を計算
  - 売上サマリー API で返却

```sql
-- 手数料(fee)
--   現金 : 0
--   カード: amount_fee
COALESCE(SUM(
  CASE
    WHEN om.is_cash = true THEN 0
    WHEN sp.id IS NOT NULL AND sp.status = 'succeeded' THEN COALESCE(sp.amount_fee, 0)
    ELSE 0
  END
), 0) AS fee
```

#### 2.3 現金決済の手数料

- **実装内容**: 現金決済は手数料 0 として扱われる
- **場所**: 上記 SQL クエリ内

### ⚠️ 未実装・課題

#### 2.4 手数料徴収の不整合（重要）

**仕様要件（修正版）**:

- 決済時に自動差引（Stripe 上で処理）
- 基本手数料: 決済金額に対し ◯% **マスタで設定し、各出店者毎のプランによる**
- 初期費用・月額費用なし

**現状の問題**:

1. **`app/api/checkout/session/route.ts`**: `application_fee_amount`が設定されていない
   - 手数料が徴収されていない可能性
2. **`public/server.js`**: `application_fee_amount: fee`が設定されている（10%）

   - 古い実装との不整合

3. **手数料率マスタの未実装**
   - マスタで手数料率を設定する機能がない
   - 出店者ごとのプランに応じた手数料率の適用ロジックがない

**必要な修正**:

```typescript
// app/api/checkout/session/route.ts に追加
// 1. 出店者のプランを取得
const subscription = await prisma.sellerSubscription.findFirst({
  where: {
    sellerId: order.sellerId,
    status: 'active',
    OR: [
      { endedAt: null },
      { endedAt: { gt: new Date() } }
    ]
  },
  orderBy: { startedAt: 'desc' }
});

// 2. プランに応じた手数料率をマスタから取得
const feeRate = await getFeeRateFromMaster(subscription?.planType || 'standard');

// 3. 手数料を計算
const fee = Math.round(order.amount * feeRate);

// 4. payment_intent_dataに追加
payment_intent_data: {
  application_fee_amount: fee,
  transfer_data: {
    destination: stripeAccountId,
  },
}
```

#### 2.5 手数料率マスタの実装（新規要件）

**仕様要件（修正版）**:

- 手数料率は**マスタで設定し、各出店者毎のプランによる**

**現状**:

- ❌ 手数料率マスタテーブルが存在しない
- ❌ プラン別の手数料率設定機能がない
- ❌ 出店者ごとのプランに応じた手数料率の適用ロジックがない

**必要な実装**:

1. **手数料率マスタテーブルの作成**

```sql
CREATE TABLE fee_rate_master (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  plan_type text NOT NULL,  -- 'standard', 'pro', 'kids'
  fee_rate numeric(5,4) NOT NULL,  -- 手数料率（例: 0.0700 = 7%）
  effective_from timestamptz NOT NULL DEFAULT now(),
  effective_to timestamptz,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now(),
  UNIQUE(plan_type, effective_from)
);

CREATE INDEX idx_fee_rate_master_plan_type ON fee_rate_master(plan_type);
```

2. **手数料率取得関数の実装**

```typescript
async function getFeeRateFromMaster(planType: string): Promise<number> {
  const feeRate = await prisma.feeRateMaster.findFirst({
    where: {
      planType: planType,
      effectiveFrom: { lte: new Date() },
      OR: [{ effectiveTo: null }, { effectiveTo: { gte: new Date() } }],
    },
    orderBy: { effectiveFrom: "desc" },
  });

  return feeRate?.feeRate || 0.07; // デフォルト7%
}
```

---

## 3. 出金（Withdrawal/Payout）実装状況

### ✅ 仕様上不要（実装不要）

**仕様要件**:

- 出金管理・入金スピードには関与しない
- Stripe から出店者口座へ直接入金されるため、出金機能は不要

**実装状況**:

- ✅ `transfer_data`により自動的に出店者アカウントへ入金
- ❌ 出金リクエスト機能は不要（仕様上）

**評価**: ✅ 仕様に合致（出金機能は不要）

---

## 4. チャージバック対応オプション実装状況

### ✅ 実装済み機能

#### 4.1 チャージバック対応機能（Webhook 処理）

- **場所**: `payments.js`, `app/api/webhooks/stripe/route.ts`
- **実装内容**:
  - `charge.dispute.created`イベントの処理
  - `charge.dispute.closed`イベントの処理
  - `stripe_payments`テーブルの`dispute_status`更新
  - チャージバック発生時のステータス管理

#### 4.2 チャージバック証拠生成・提出

- **場所**:
  - `app/api/admin/disputes/generate_evidence/route.ts` - 証拠生成
  - `app/api/admin/disputes/submit_evidence/route.ts` - 証拠提出
- **実装内容**:
  - Stripe Dispute API を使用した証拠生成
  - 証拠の自動提出機能
  - 証拠提出ステータスの管理

### ⚠️ 未実装・課題

#### 4.3 チャージバック対応オプション（基本料金に込み）

**仕様要件（修正版）**:

- 価格: 料金に含む**+1〜2%相当**（基本手数料に込み）
- 内容: 明細名最適化、詳細取引データ送信、証拠自動生成、Stripe 反証対応代行
- ※ 金銭補填・保証は行わない

**重要な理解**:

- チャージバック対応オプションは**追加料金ではなく、基本手数料に含まれている**
- プランに応じた基本手数料率がマスタで設定され、その中にチャージバック対応オプションの費用（+1〜2%相当）が含まれている
- 例: チャージバック対応オプション付きプランの基本手数料率 = 通常プランの基本手数料率 + 1〜2%

**現状**:

- ✅ `seller_subscriptions`テーブルは存在（`plan_type`: 'standard', 'pro', 'kids'）
- ✅ チャージバック対応機能は実装済み（証拠生成・提出）
- ❌ プラン別の手数料率マスタが未実装（チャージバック対応オプション込みの手数料率を設定できない）
- ⚠️ 明細名最適化機能は未確認

**必要な実装**:

1. **手数料率マスタの実装**（セクション 2.5 参照）

   - プラン別の基本手数料率をマスタで設定
   - チャージバック対応オプション込みのプランは、手数料率を高く設定（例: 通常 7% → チャージバック対応込み 8〜9%）

2. **明細名最適化機能の実装**

   - チャージバック対応オプション利用時に明細名を最適化
   - Stripe Checkout Session の`line_items`で明細名を調整
   - プランまたはオプション設定で判定

**実装方針**:

```typescript
// チャージバック対応オプションは基本手数料に含まれるため、
// プランに応じた手数料率をマスタから取得するだけで良い
const feeRate = await getFeeRateFromMaster(planType); // 既にチャージバック対応込みの手数料率
const fee = Math.round(order.amount * feeRate);
```

---

## 5. データベーススキーマ

### 手数料関連テーブル

#### `stripe_payments` テーブル

```sql
- amount_gross: 総額（手数料込み）
- amount_fee: 手数料
- amount_net: 純額（手数料差し引き後）
```

#### `seller_subscriptions` テーブル（既存）

```sql
- seller_id: 出店者ID
- plan_type: プラン種別（'standard', 'pro', 'kids'）
- status: ステータス（'active', 'inactive', 'cancelled'）
- started_at: 開始日時
- ended_at: 終了日時
```

### 手数料率マスタテーブル（未実装）

**必要なテーブル**:

```sql
CREATE TABLE fee_rate_master (
  id uuid PRIMARY KEY,
  plan_type text NOT NULL,
  fee_rate numeric(5,4) NOT NULL,
  effective_from timestamptz NOT NULL,
  effective_to timestamptz,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
```

### 出金関連テーブル

- **現状**: 出金専用のテーブルは存在しない
- **仕様上不要**: Stripe から直接入金されるため不要

---

## 6. API エンドポイント

### 実装済み

#### 手数料関連

- ✅ `GET /api/seller/summary` - 手数料を含む売上サマリー
- ✅ `GET /api/seller/analytics` - 手数料を含む分析データ

### 未実装

#### 出金関連

- ❌ `POST /api/seller/payouts/request` - 出金リクエスト作成
- ❌ `GET /api/seller/payouts` - 出金履歴取得
- ❌ `GET /api/seller/payouts/:id` - 出金詳細取得
- ❌ `POST /api/seller/payout-methods` - 出金方法設定
- ❌ `GET /api/seller/payout-methods` - 出金方法一覧取得

---

## 7. 推奨実装項目

### 優先度: 高（緊急）

1. **手数料率マスタの実装** ⚠️ **最重要**

   - `fee_rate_master`テーブルの作成
   - プラン別の手数料率設定機能
   - 手数料率取得関数の実装

2. **手数料徴収の修正** ⚠️ **重要**

   - `app/api/checkout/session/route.ts`に`application_fee_amount`を追加
   - 出店者のプランを取得し、マスタから手数料率を取得
   - プランに応じた手数料を計算・適用

3. **チャージバック対応オプションの実装**
   - 明細名最適化機能の実装
   - プランに応じた手数料率はマスタで設定（基本手数料に込みのため、追加の手数料加算ロジックは不要）

### 優先度: 中

4. **出店者健全性管理の強化**

   - チャージバック率の監視
   - 返金率の監視
   - 自動的な出店審査強化・利用停止機能

5. **手数料率マスタの管理 UI**
   - 管理者が手数料率を設定・変更できる UI
   - プラン別の手数料率履歴管理

### 優先度: 低

5. **出店者オンボーディングの改善**
   - 店舗名／屋号の入力促進
   - Stripe Onboarding の完了状況確認

---

## 8. 参考資料

### 仕様書

- **出店者管理・手数料方式 仕様整理資料（最終）** - 本レポートの基準仕様

### 実装ファイル

- `app/api/checkout/session/route.ts` - チェックアウトセッション作成（手数料設定要修正）
- `payments.js` - 手数料計算・集計
- `app/api/seller/summary/route.ts` - 売上サマリー（手数料含む）
- `app/api/webhooks/stripe/route.ts` - Stripe Webhook（手数料記録）
- `app/api/admin/disputes/generate_evidence/route.ts` - チャージバック証拠生成
- `app/api/admin/disputes/submit_evidence/route.ts` - チャージバック証拠提出

### Stripe 関連

- `docs/03_ops/メモ.md` - Stripe Connect の状態確認（`payouts_enabled`）

---

## 9. 次のステップ（優先順位順）

### 緊急対応（優先度: 高）

1. **手数料率マスタの実装** ⚠️ **最重要**

   - `fee_rate_master`テーブルの作成
   - プラン別の手数料率設定（初期値の決定が必要）
   - 手数料率取得関数の実装

2. **手数料徴収の修正** ⚠️

   - `app/api/checkout/session/route.ts`に`application_fee_amount`を追加
   - 出店者のプランを取得
   - マスタから手数料率を取得して計算・適用

3. **チャージバック対応オプションの実装**
   - 明細名最適化機能の実装
   - プランに応じた手数料率はマスタで設定（基本手数料に込みのため、追加の手数料加算ロジックは不要）

### 通常対応（優先度: 中）

3. **出店者健全性管理の強化**

   - チャージバック率・返金率の監視機能
   - 自動的な出店審査強化・利用停止機能

4. **テスト**
   - 手数料徴収のテスト
   - チャージバック対応オプションのテスト

---

**最終更新**: 2025 年 1 月

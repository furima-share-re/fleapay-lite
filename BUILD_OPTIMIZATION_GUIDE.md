# ビルドパイプライン最適化ガイド

## 📊 現在のビルド時間

現在のプロジェクトの推定ビルド時間:
- `npm install`: 1-3分
- `npm run build`: 2-5分
- `postbuild`: 10-30秒
- **合計: 約4-9分/デプロイ**

## 🎯 解決策

### 解決策1: Professionalプランへアップグレード ⭐推奨

**効果**:
- Hobby: 500分/月（全員で共有）
- Professional: 500分/ユーザー/月（個人ごと）

**コスト**: $19/月

**推奨するケース**:
- チームが5人以上
- 月間デプロイ回数が100回以上
- 本番環境で安定した運用が必要

---

### 解決策2: ビルド時間の最適化（無料）

#### 2.1 .dockerignoreの活用 ✅実装済み

不要ファイルをビルドコンテキストから除外:
- `.ai`ディレクトリ
- ドキュメントファイル
- テストファイル
- IDE設定ファイル

**削減効果**: 10-20%のビルド時間短縮

#### 2.2 Next.js設定の最適化 ✅実装済み

`next.config.js`に追加:
- `productionBrowserSourceMaps: false` - 本番でソースマップ無効化
- `optimizeCss: true` - CSS最適化を有効化

**削減効果**: 5-15%のビルド時間短縮

#### 2.3 package-lock.jsonの最適化

依存関係の解決時間を短縮:
```bash
npm ci  # npm installの代わりに使用（より高速）
```

`render.yaml`を更新:
```yaml
buildCommand: npm ci && npm run build
```

**削減効果**: 10-30秒の短縮

#### 2.4 Prisma生成の最適化

`postinstall`で実行される`prisma generate`を最適化:
- ビルド時に既に生成済みならスキップ可能

---

### 解決策3: デプロイ戦略の最適化

#### 3.1 プレビュー環境のデプロイを制限

現在: 本番とプレビューで自動デプロイ → 2倍のビルド時間

推奨: プレビュー環境を手動デプロイのみに設定

**削減効果**: 約50%のビルド時間削減

#### 3.2 デプロイ頻度の最適化

- 小さな変更はバッチでまとめてデプロイ
- 重要でない変更は週1-2回にまとめる

**削減効果**: 月間デプロイ回数に依存

#### 3.3 条件付きビルドの活用

変更がない場合はスキップ:
```yaml
# render.yaml (Renderでは直接サポートされていないが、GitHub Actionsで実現可能)
# または、ビルドコマンドで変更をチェック
```

---

## 📈 最適化効果の試算

### 現在（最適化なし）
- 1回のビルド: 7分
- 月間100回デプロイ: 700分
- **不足: 200分**

### 最適化後（解決策2のみ）
- 1回のビルド: 5-6分（10-30%削減）
- 月間100回デプロイ: 500-600分
- **不足: 0-100分**

### 最適化後 + デプロイ戦略変更（解決策2 + 3.1）
- プレビュー環境を手動に: 月間50回に削減
- 1回のビルド: 5-6分
- 月間使用量: 250-300分
- **余裕: 200-250分**

### Professionalプラン（解決策1）
- 1回のビルド: 7分（最適化なしでも可）
- 月間使用量: 700分
- **制限**: 500分/ユーザー（5人なら2,500分）
- **チーム5人の場合: 余裕あり**

---

## 🚀 実装手順

### ステップ1: ビルド最適化を適用 ✅完了

1. `.dockerignore`の作成 ✅
2. `next.config.js`の最適化 ✅

### ステップ2: render.yamlの最適化

`npm ci`を使用する場合:
```yaml
buildCommand: npm ci && npm run build
```

### ステップ3: プレビュー環境の設定変更

Render Dashboardで:
1. `fleapay-lite-web-preview`サービスを開く
2. Settings → Auto-Deploy を無効化
3. 必要な時だけ手動デプロイ

### ステップ4: ビルド時間の監視

Render Dashboardの「Metrics」で:
- 各デプロイのビルド時間を確認
- 最適化の効果を測定

---

## 💡 追加の最適化案

### 1. 依存関係の削減

未使用のパッケージを削除:
```bash
npm prune
npx depcheck
```

### 2. TypeScriptの最適化

`tsconfig.json`で:
- `incremental: true` ✅既に設定済み
- `skipLibCheck: true` ✅既に設定済み

### 3. ビルドキャッシュの活用

Renderは自動的にキャッシュを使用:
- `node_modules`をキャッシュ
- `.next/cache`をキャッシュ

### 4. Performance Pipeline（Professional以上）

より高速なインスタンスでビルド:
- ビルド時間: 30-50%短縮
- ただし分数の消費は同じ

---

## 📋 チェックリスト

- [x] `.dockerignore`を作成
- [x] `next.config.js`を最適化
- [ ] `render.yaml`で`npm ci`を使用
- [ ] プレビュー環境の自動デプロイを無効化
- [ ] ビルド時間を監視
- [ ] Professionalプランへのアップグレードを検討

---

## 🎯 推奨アクション

1. **即座に実施**: ビルド最適化（解決策2）✅完了
2. **今週中**: プレビュー環境のデプロイ戦略変更
3. **月次レビュー**: ビルド時間の監視と効果測定
4. **必要に応じて**: Professionalプランへアップグレード
5. **1000分が必要な場合**: `BUILD_PIPELINE_1000_MINUTES_SOLUTION.md`を参照


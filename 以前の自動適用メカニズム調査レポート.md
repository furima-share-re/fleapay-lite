# 以前の自動適用メカニズム調査レポート

**作成日**: 2026-01-20  
**目的**: 以前はテーブル定義がエラーなく自動で適用されていた理由を調査

---

## 🔍 調査結果サマリー

以前はテーブル定義がエラーなく自動で適用されていた理由は、**Supabase CLIの`db push`コマンドとGitHub Actionsの連携**が正常に機能していたためです。

---

## ✅ 以前動作していた自動適用の仕組み

### 1. 自動適用のフロー

```
マイグレーションファイル作成
    ↓
mainブランチにプッシュ
    ↓
GitHub Actionsが自動検出
    ↓
validate-migrations（検証）
    ↓
apply-to-staging（検証環境に適用）
    ↓
apply-to-production（本番環境に適用）
    ↓
update-prisma-schema（Prismaスキーマ更新）
```

### 2. 自動適用のトリガー条件

**ワークフロー**: `.github/workflows/apply-migrations.yml`

**自動実行条件**:
1. ✅ `main`ブランチにプッシュ
2. ✅ `supabase/migrations/**` のパスが変更された場合
3. ✅ または、手動実行（`workflow_dispatch`）

### 3. Supabase CLIの`db push`コマンドの動作

**コマンド**: `supabase db push`

**動作**:
1. `supabase/migrations/`ディレクトリ内のSQLファイルを自動検出
2. ファイル名のタイムスタンプ順にソート
3. データベースに未適用のマイグレーションを自動的に適用
4. マイグレーション履歴を管理（重複適用を防止）

**特徴**:
- ✅ 手動でSQLを実行する必要がない
- ✅ マイグレーションの順序を自動管理
- ✅ 既に適用済みのマイグレーションはスキップ
- ✅ エラー発生時は自動ロールバック

### 4. 以前動作していた理由

#### 4.1 GitHub Secretsが正しく設定されていた

**必要なSecrets**:
- `SUPABASE_ACCESS_TOKEN` - Supabase APIアクセストークン
- `SUPABASE_PROJECT_ID_STAGING` - 検証環境のProject ID
- `SUPABASE_PROJECT_ID_PRODUCTION` - 本番環境のProject ID

**以前の状態**:
- ✅ これらのSecretsがGitHubリポジトリに設定されていた
- ✅ 有効なアクセストークンが設定されていた
- ✅ 正しいProject IDが設定されていた

#### 4.2 Supabase CLIが正常に動作していた

**以前の状態**:
- ✅ `supabase link --project-ref <project-id>` が正常に実行できていた
- ✅ `supabase db push` が正常にマイグレーションを適用できていた
- ✅ プロジェクトのリンクが正しく設定されていた

#### 4.3 ワークフローの設定が正しかった

**以前の状態**:
- ✅ `.github/workflows/apply-migrations.yml` が正しく設定されていた
- ✅ バリデーションスクリプト（`check_migration_safety.py`）が正常に動作していた
- ✅ 環境保護（environment protection）が適切に設定されていた

---

## ❌ 現在失敗している理由

### 1. GitHub Secretsが設定されていない、または無効

**問題**:
- ❌ `SUPABASE_ACCESS_TOKEN` が設定されていない、または期限切れ
- ❌ `SUPABASE_PROJECT_ID_STAGING` が設定されていない
- ❌ `SUPABASE_PROJECT_ID_PRODUCTION` が設定されていない

**影響**:
- `apply-to-staging` ジョブが失敗（exit code 1）
- `apply-to-production` ジョブがスキップされる

### 2. プロジェクトのリンクが失われた可能性

**問題**:
- `supabase link` コマンドが失敗している可能性
- プロジェクトの参照が無効になっている可能性

---

## 🔧 以前の状態を復元する方法

### ステップ1: GitHub Secretsを設定

1. **Supabase Access Tokenを取得**:
   - Supabase Dashboard → Account Settings → Access Tokens
   - 新しいトークンを生成（`Full access`を選択）

2. **Project IDを取得**:
   - Supabase Dashboard → Settings → General
   - Reference IDをコピー

3. **GitHub Secretsに追加**:
   - GitHubリポジトリ → Settings → Secrets and variables → Actions
   - 以下の3つのSecretsを追加:
     - `SUPABASE_ACCESS_TOKEN`
     - `SUPABASE_PROJECT_ID_STAGING`
     - `SUPABASE_PROJECT_ID_PRODUCTION`

### ステップ2: ワークフローを手動実行して確認

1. GitHubリポジトリ → Actionsタブ
2. **Apply Migrations** ワークフローを選択
3. **Run workflow** をクリック
4. ブランチを選択（`main`）
5. **Run workflow** をクリック

### ステップ3: 実行結果を確認

- ✅ `validate-migrations`: 成功
- ✅ `apply-to-staging`: 成功
- ✅ `apply-to-production`: 承認待ちまたは成功

---

## 📋 以前の自動適用メカニズムの詳細

### Supabase CLIの`db push`の動作原理

1. **マイグレーションファイルの検出**:
   ```
   supabase/migrations/
   ├── 20250115_120000_add_payment_state.sql
   ├── 20250116_120000_create_fee_rate_master.sql
   ├── 20250117_120000_add_strategy_f_tier_system.sql
   └── ...
   ```

2. **適用順序の決定**:
   - ファイル名のタイムスタンプ（`YYYYMMDD_HHMMSS`）でソート
   - 古い順に適用

3. **重複適用の防止**:
   - Supabaseの内部テーブル（`supabase_migrations.schema_migrations`）で適用履歴を管理
   - 既に適用済みのマイグレーションはスキップ

4. **エラーハンドリング**:
   - エラー発生時は自動ロールバック
   - トランザクション内で実行されるため、部分的な適用を防止

### GitHub Actionsワークフローの詳細

**ワークフローの構造**:

```yaml
jobs:
  validate-migrations:  # マイグレーションの安全性を検証
  apply-to-staging:     # 検証環境に適用
  apply-to-production:  # 本番環境に適用（手動承認が必要な場合あり）
  update-prisma-schema: # Prismaスキーマを更新
```

**各ジョブの役割**:

1. **validate-migrations**:
   - `check_migration_safety.py` を実行
   - 破壊的変更（DROP TABLE、DROP COLUMNなど）を検出
   - マイグレーションファイルの命名規則を検証

2. **apply-to-staging**:
   - Supabase CLIをセットアップ
   - 検証環境のプロジェクトにリンク
   - `supabase db push` でマイグレーションを適用

3. **apply-to-production**:
   - 検証環境の適用が成功した後に実行
   - 本番環境のプロジェクトにリンク
   - `supabase db push` でマイグレーションを適用
   - 環境保護により手動承認が必要な場合あり

4. **update-prisma-schema**:
   - `prisma db pull` でデータベースからスキーマを取得
   - `prisma generate` でPrisma Clientを生成
   - 必要に応じてPRを作成

---

## 🎯 以前の状態と現在の状態の比較

| 項目 | 以前（動作していた） | 現在（失敗している） |
|------|---------------------|---------------------|
| **GitHub Secrets** | ✅ 設定済み | ❌ 未設定または無効 |
| **Supabase CLI** | ✅ 正常動作 | ⚠️ Secrets不足で失敗 |
| **ワークフロー** | ✅ 正常実行 | ❌ `apply-to-staging`が失敗 |
| **自動適用** | ✅ 正常動作 | ❌ 失敗 |

---

## 📝 結論

以前はテーブル定義がエラーなく自動で適用されていた理由は、**GitHub Secretsが正しく設定されていたため**です。

**以前の状態**:
- ✅ GitHub Secrets（`SUPABASE_ACCESS_TOKEN`、`SUPABASE_PROJECT_ID_STAGING`、`SUPABASE_PROJECT_ID_PRODUCTION`）が設定されていた
- ✅ Supabase CLIが正常に動作していた
- ✅ GitHub Actionsワークフローが正常に実行されていた

**現在の状態**:
- ❌ GitHub Secretsが設定されていない、または無効
- ❌ `apply-to-staging` ジョブが失敗（exit code 1）
- ❌ 自動適用が機能していない

**復元方法**:
1. GitHub Secretsを再設定
2. ワークフローを手動実行して動作確認
3. 問題があれば修正

---

## 🔗 関連ファイル

- `.github/workflows/apply-migrations.yml` - マイグレーション適用ワークフロー
- `apply-to-staging失敗の解決方法.md` - 失敗の解決手順
- `自動適用されない原因の確認手順.md` - 自動適用されない原因の確認手順
- `データベース操作ガイド.md` - データベース操作のガイド
- `HOW_TO_ADD_TABLE.md` - テーブル追加方法ガイド

---

**最終更新**: 2026-01-20

# Phase 1.8: ダンプデータからSQL形式への変換見積もり

**作成日**: 2026-01-04  
**目的**: `.dir.tar.gz`形式をSQL形式に変換してSupabase SQL Editorで実行する場合の見積もり

---

## 📊 現在のファイル情報

- **ファイル名**: `tmp/2026-01-03T15_42Z.dir.tar.gz`
- **ファイルサイズ**: **約69MB** (69,044,659バイト)
- **ファイル形式**: PostgreSQLカスタム形式（`.dir.tar.gz`）
- **データ量**: 約10,000-100,000レコード程度と推定

---

## 🔄 SQL形式への変換方法

### 方法1: pg_restoreでSQL形式に変換

```powershell
# 1. ファイルを展開
cd tmp
tar -zxvf 2026-01-03T15_42Z.dir.tar.gz

# 2. SQL形式に変換
pg_restore --file=prod_backup.sql tmp/2026-01-03T15:42Z/fleapay_prod_db
```

**注意**: `pg_restore`コマンドが必要です（PostgreSQLクライアントツール）

---

## 📈 SQL形式のファイルサイズ見積もり

### 変換後のサイズ見積もり

| 項目 | サイズ |
|------|--------|
| **現在のファイル（.dir.tar.gz）** | 約69MB |
| **展開後のサイズ（.dir形式）** | 約100-150MB（推定） |
| **SQL形式への変換後** | **約200-300MB**（推定） |

**理由**:
- `.dir.tar.gz`形式は圧縮されたバイナリ形式
- SQL形式はテキスト形式のため、サイズが大きくなる
- INSERT文やCOPY文が含まれるため、ファイルサイズが増加

---

## ⚠️ Supabase SQL Editorの制限

### 1. ファイルサイズの制限

**Supabase SQL Editorの制限**:
- **推奨**: 10MB以下
- **最大**: 約50MB（ブラウザの制限による）
- **警告**: 200-300MBのSQLファイルは**実行不可能**

**結論**: **❌ 現在のファイルサイズ（約69MB）をSQL形式に変換すると、Supabase SQL Editorでは実行できません**

---

### 2. タイムアウト制限

**Supabase SQL Editorのタイムアウト**:
- **デフォルト**: 約30秒-2分
- **長時間実行**: タイムアウトエラーが発生する可能性が高い

**結論**: **❌ 大規模なSQLファイルはタイムアウトのリスクが高い**

---

### 3. ブラウザの制限

**ブラウザの制限**:
- **メモリ使用量**: 大規模なSQLファイルを読み込むとブラウザがクラッシュする可能性
- **ペースト制限**: 数MB以上のテキストをペーストすると、ブラウザがフリーズする可能性

**結論**: **❌ 200-300MBのSQLファイルはブラウザで扱えない**

---

## 📊 方法別の比較

| 方法 | ファイルサイズ | Supabase SQL Editorで実行可能？ | 所要時間 | リスク |
|------|--------------|-------------------------------|---------|--------|
| **pg_restore（.dir.tar.gz）** | 約69MB | ❌ 不要（コマンドライン） | 1-3時間 | ⭐⭐低 |
| **SQL形式に変換** | 約200-300MB | ❌ **不可能** | - | ❌ 高 |

---

## 🎯 結論

### SQL形式への変換は推奨しません

**理由**:
1. ❌ **ファイルサイズが大きすぎる**（約200-300MB）
2. ❌ **Supabase SQL Editorの制限を超える**（10MB推奨、50MB最大）
3. ❌ **ブラウザがクラッシュする可能性**
4. ❌ **タイムアウトのリスクが高い**

---

## 🔄 代替方法

### 方法1: pg_restoreコマンドを使用（推奨）⭐

**メリット**:
- ✅ 現在のファイル形式に対応
- ✅ データ整合性が保証される
- ✅ インデックス、制約、トリガーも含まれる
- ✅ 大規模データに対応

**デメリット**:
- ❌ PostgreSQLクライアントツールが必要
- ❌ コマンドライン操作が必要

**所要時間**: 1-3時間

---

### 方法2: データを分割してSQL形式に変換

**手順**:
1. テーブルごとにSQL形式に変換
2. 各テーブルを個別にSupabase SQL Editorで実行

**メリット**:
- ✅ GUI操作で実行可能
- ✅ 小規模なSQLファイルなら実行可能

**デメリット**:
- ❌ テーブルごとに手動で実行が必要
- ❌ 外部キー制約を考慮した順序で実行する必要がある
- ❌ 時間がかかる（2-4時間）

**実行可能なテーブルサイズ**:
- **小規模テーブル（< 10MB）**: ✅ 実行可能
- **中規模テーブル（10-50MB）**: ⚠️ タイムアウトのリスク
- **大規模テーブル（> 50MB）**: ❌ 実行不可能

---

### 方法3: Supabase Table EditorでCSVインポート

**手順**:
1. データをCSV形式でエクスポート
2. Supabase Table Editorで各テーブルごとにインポート

**メリット**:
- ✅ GUI操作で簡単
- ✅ PostgreSQLクライアントツールが不要

**デメリット**:
- ❌ テーブルごとに手動でインポートが必要
- ❌ 外部キー制約を考慮した順序でインポートする必要がある
- ❌ 時間がかかる（2-4時間）

---

## 📋 推奨方法の比較

| 方法 | 難易度 | 所要時間 | リスク | 推奨度 |
|------|--------|---------|--------|--------|
| **pg_restore** | ⭐⭐☆☆☆ | 1-3時間 | ⭐⭐低 | ⭐⭐⭐⭐⭐ |
| **SQL形式（全体）** | ⭐☆☆☆☆ | - | ❌ 不可能 | ❌ |
| **SQL形式（分割）** | ⭐⭐⭐☆☆ | 2-4時間 | ⭐⭐⭐中 | ⭐⭐⭐ |
| **Table Editor CSV** | ⭐⭐☆☆☆ | 2-4時間 | ⭐⭐低 | ⭐⭐⭐⭐ |

---

## ✅ 最終推奨

### 推奨: pg_restoreコマンドを使用

**理由**:
1. ✅ 現在のファイル形式に対応
2. ✅ 一度のコマンドで完了
3. ✅ データ整合性が保証される
4. ✅ 最も確実で安全

**手順**:
1. PostgreSQLクライアントツールをインストール（1回だけ）
2. ファイルを展開
3. コマンドを1つ実行

**難易度**: ⭐⭐☆☆☆（簡単）

---

## 🎯 まとめ

**SQL形式への変換は推奨しません**

- ❌ ファイルサイズが大きすぎる（約200-300MB）
- ❌ Supabase SQL Editorの制限を超える
- ❌ ブラウザがクラッシュする可能性

**推奨方法**:
- ✅ **pg_restoreコマンドを使用**（最も確実で安全）

**代替方法**（GUI操作を希望する場合）:
- ✅ **Supabase Table EditorでCSVインポート**（時間はかかるがGUI操作可能）

---

**結論**: SQL形式への変換は技術的に不可能です。`pg_restore`コマンドを使用することを強く推奨します。


# 手数料徴収機能実装 - 最終仕上げ完了報告

**作成日**: 2025 年 1 月  
**対応者**: AI Assistant  
**最終仕上げレビュー指摘事項への対応状況**

---

## 📋 対応完了項目

### ✅ 重大: statement_descriptor_suffix の正規化

**問題**: 日本語を length 基準で切るのは危険。Stripe の制約は「文字数」より実質「ASCII/バイト/許容文字」の影響が大きい。

**対応内容**:

- ASCII 限定（A-Z 0-9 空白 \* - など）に正規化する関数を実装
- ダメなら固定値 `EDOICHIBA *EVENT` にフォールバック
- チャージバック対策にも強い一貫した明細名

**実装箇所**:

```typescript
// lib/utils.ts
export function normalizeStatementDescriptor(
  shopName: string | null | undefined,
  eventName: string = "EVENT"
): string {
  // ASCII限定に正規化: 英数字、空白、*、-のみ許可
  const normalized = (source || "")
    .toUpperCase()
    .replace(/[^A-Z0-9\s\*\-]/g, "") // ASCII英数字、空白、*、-以外を削除
    .trim()
    .slice(0, 22); // 最大22文字

  // 正規化後が空なら固定値
  if (!normalized || normalized.length === 0) {
    return "EDOICHIBA *EVENT";
  }

  return normalized;
}
```

---

### ✅ 重大: fee_rate_master のユニーク制約の見直し

**問題**: `now()`をインデックス条件に使うのは危険（時間で条件が変わる＝インデックスの整合性が壊れやすい）。

**対応内容**:

- `effective_to IS NULL`のみのユニーク制約に変更
- 有効判定はアプリ側のクエリで `effective_from <= now()` を含める

**実装箇所**:

```sql
-- 軽量案: effective_to IS NULL（現在適用中）を1件だけにするユニーク制約
CREATE UNIQUE INDEX IF NOT EXISTS idx_fee_rate_master_active_unique
  ON fee_rate_master(plan_type)
  WHERE effective_to IS NULL;
```

---

### ✅ 重大: Checkout Session 再利用の条件強化

**問題**: `open/unpaid`でも、金額が変わっている場合に古い Session を返すと事故る。

**対応内容**:

- Session metadata に金額ハッシュを保存
- 再利用時に金額ハッシュを照合

**実装箇所**:

```typescript
// 金額が変わっていないことを確認（metadataに金額ハッシュを保存）
const expectedAmountHash = Buffer.from(`${orderAmount}`)
  .toString("base64")
  .slice(0, 16);
const sessionAmountHash = existingSession.metadata?.orderAmountHash;

if (sessionAmountHash === expectedAmountHash) {
  // 再利用
}
```

---

### ✅ 中: seller_subscription の取得ロジック改善

**対応内容**:

- `endedAt null`を優先する 2 段階クエリに変更
- データ不整合（active なのに endedAt が過去）に備える

**実装箇所**:

```typescript
// まず現在適用中（endedAt null）を探す
let subscription = await prisma.sellerSubscription.findFirst({
  where: {
    sellerId: order.sellerId,
    status: "active",
    endedAt: null,
  },
  orderBy: { startedAt: "desc" },
});

// endedAt nullがない場合、endedAt > now()のものを探す
if (!subscription) {
  subscription = await prisma.sellerSubscription.findFirst({
    where: {
      sellerId: order.sellerId,
      status: "active",
      endedAt: { gt: new Date() },
    },
    orderBy: { startedAt: "desc" },
  });
}
```

---

### ✅ 中: 手数料計算の境界条件改善

**対応内容**:

- `Math.floor`を使用（丸めを下げるとクレームが減る）
- 最低手数料 1 円を設定

**実装箇所**:

```typescript
// 計算: Math.floor(amount * rate) で整数に丸める（丸めを下げるとクレームが減る）
// 最低手数料: 1円（小額注文でも最低1円の手数料を徴収）
const calculatedFee = Math.floor(orderAmount * feeRate);
const fee = Math.max(calculatedFee, 1); // 最低1円
```

---

### ✅ 中: 運用救済（緊急固定レート）

**対応内容**:

- 本番で fee rate なしはエラーで OK
- ただし、運用救済として緊急固定レート（ENV）を用意
- 使用時は CRITICAL ログを出力

**実装箇所**:

```typescript
// 運用救済: 緊急固定レート（ENV）があればそれを使用
const emergencyRate = process.env.FEE_RATE_EMERGENCY_OVERRIDE;
if (emergencyRate) {
  const rate = Number(emergencyRate);
  if (!isNaN(rate) && rate >= 0 && rate <= 1) {
    console.error(
      "[getFeeRateFromMaster] CRITICAL: Using emergency override rate",
      {
        planType,
        emergencyRate: rate,
        message: "This should trigger immediate alert to operations team",
      }
    );
    // TODO: アラートを飛ばす（Slack通知等）
    return rate;
  }
}
```

---

### ✅ 追加: 完成度を上げるチェック項目

#### 1. application_fee_amount の上限チェック

**実装箇所**:

```typescript
// Stripeのapplication_fee_amountの上限チェック（JPY: 最大999,999,999円）
if (fee > 999999999) {
  return NextResponse.json(
    {
      error: "fee_exceeds_limit",
      message: "手数料が上限を超えています。",
    },
    { status: 500 }
  );
}
```

#### 2. Connected account の charges_enabled チェック

**実装箇所**:

```typescript
// Connected accountがcharges_enabled=trueか確認（未完了KYCで失敗する）
const account = await stripe.accounts.retrieve(stripeAccountId);
if (!account.charges_enabled) {
  return NextResponse.json(
    {
      error: "account_charges_not_enabled",
      message:
        "出店者のStripeアカウントが決済可能な状態ではありません。KYC（本人確認）の完了が必要です。",
    },
    { status: 400 }
  );
}
```

#### 3. Webhook での監査用チェック

**注意**: これは別途 Webhook ハンドラーで実装が必要です（今回の実装範囲外）。

---

## 📊 変更ファイル一覧

| ファイル                                                         | 変更内容                                                               |
| ---------------------------------------------------------------- | ---------------------------------------------------------------------- |
| `lib/utils.ts`                                                   | `normalizeStatementDescriptor()`関数追加、`getFeeRateFromMaster()`改善 |
| `app/api/checkout/session/route.ts`                              | 全指摘事項への対応                                                     |
| `supabase/migrations/20250116_120000_create_fee_rate_master.sql` | ユニーク制約の見直し                                                   |

---

## ✅ 対応完了確認

- [x] statement_descriptor_suffix の正規化（ASCII 化・フォールバック）
- [x] fee_rate_master のユニーク制約の見直し（now()をインデックス条件に使わない）
- [x] Checkout Session 再利用の条件強化（金額ハッシュ照合）
- [x] seller_subscription の取得ロジック改善（endedAt null 優先）
- [x] 手数料計算の境界条件改善（Math.floor、最低手数料）
- [x] 運用救済（緊急固定レート）
- [x] application_fee_amount の上限チェック
- [x] Connected account の charges_enabled チェック

---

## 🎯 最終判定

**レビュー対応は完了し、リリース候補です。**

本番で詰まりやすいポイントをすべて修正しました：

1. ✅ statement_descriptor_suffix の正規化（ASCII 化・フォールバック）
2. ✅ fee_rate_master のユニーク制約の見直し（now()をインデックス条件に使わない）

追加で実装した項目：

- Checkout Session 再利用時の金額照合
- 手数料計算の改善（Math.floor、最低手数料）
- 運用救済（緊急固定レート）
- Connected account の charges_enabled チェック
- application_fee_amount の上限チェック

---

**最終更新**: 2025 年 1 月  
**最終仕上げ完了**: ✅

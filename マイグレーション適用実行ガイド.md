# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨å®Ÿè¡Œã‚¬ã‚¤ãƒ‰

**ä½œæˆæ—¥**: 2026-01-14  
**ç›®çš„**: æ¤œè¨¼ç’°å¢ƒãƒ»æœ¬ç•ªç’°å¢ƒã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨ã™ã‚‹

---

## ğŸ“‹ é©ç”¨ãŒå¿…è¦ãªãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

ä»¥ä¸‹ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ãŒæœ¬ç•ªç’°å¢ƒã«é©ç”¨ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼š

1. âœ… `supabase/migrations/20250116_120000_create_fee_rate_master.sql` - `fee_rate_master` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
2. âœ… `supabase/migrations/20250117_120000_add_strategy_f_tier_system.sql` - Tieråˆ¶ã‚·ã‚¹ãƒ†ãƒ è¿½åŠ 
3. âœ… `supabase/migrations/20260120_120000_create_kpi_management_tables.sql` - `benchmark_data` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ

---

## ğŸš€ å®Ÿè¡Œæ–¹æ³•

### æ–¹æ³•A: Supabase CLIã§ç›´æ¥é©ç”¨ï¼ˆæ¨å¥¨ãƒ»å³åº§ã«å®Ÿè¡Œå¯èƒ½ï¼‰

#### ã‚¹ãƒ†ãƒƒãƒ—1: Supabase Access Tokenã‚’å–å¾—

1. [Supabase Dashboard](https://supabase.com/dashboard) ã«ãƒ­ã‚°ã‚¤ãƒ³
2. å³ä¸Šã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
3. **Account Settings** ã‚’é¸æŠ
4. å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ **Access Tokens** ã‚’é–‹ã
5. **Generate new token** ã‚’ã‚¯ãƒªãƒƒã‚¯
6. ãƒˆãƒ¼ã‚¯ãƒ³åã‚’å…¥åŠ›ï¼ˆä¾‹: `migration-token`ï¼‰
7. **Generate token** ã‚’ã‚¯ãƒªãƒƒã‚¯
8. **ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚³ãƒ”ãƒ¼**ï¼ˆä¸€åº¦ã—ã‹è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ï¼‰

#### ã‚¹ãƒ†ãƒƒãƒ—2: ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šï¼ˆPowerShellï¼‰

```powershell
# Access Tokenã‚’è¨­å®š
$env:SUPABASE_ACCESS_TOKEN = "your-access-token-here"

# æ¤œè¨¼ç’°å¢ƒã®Project IDã‚’è¨­å®š
$env:SUPABASE_PROJECT_ID_STAGING = "mluvjdhqgfpcfsmvjae"

# æœ¬ç•ªç’°å¢ƒã®Project IDã‚’è¨­å®šï¼ˆæœ¬ç•ªç’°å¢ƒã®Project IDã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰
$env:SUPABASE_PROJECT_ID_PRODUCTION = "your-production-project-id"
```

**æœ¬ç•ªç’°å¢ƒã®Project IDã®ç¢ºèªæ–¹æ³•**:
1. Supabase Dashboardã§æœ¬ç•ªç’°å¢ƒã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ
2. **Settings** â†’ **General** ã‚’é–‹ã
3. **Reference ID** ã‚’ã‚³ãƒ”ãƒ¼

#### ã‚¹ãƒ†ãƒƒãƒ—3: æ¤œè¨¼ç’°å¢ƒã«é©ç”¨

```powershell
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«ç§»å‹•
cd "c:\Users\yasho\OneDrive\ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ\GitHub\fleapay-lite"

# æ¤œè¨¼ç’°å¢ƒã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨
.\scripts\apply-migrations-supabase-cli.ps1 -Environment staging
```

#### ã‚¹ãƒ†ãƒƒãƒ—4: æ¤œè¨¼ç’°å¢ƒã®å‹•ä½œç¢ºèª

æ¤œè¨¼ç’°å¢ƒã§ä»¥ä¸‹ã‚’ç¢ºèªï¼š

```powershell
# APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ç¢ºèªï¼ˆæ¤œè¨¼ç’°å¢ƒã®URLã‚’ä½¿ç”¨ï¼‰
curl -H "x-admin-token: your-admin-token" `
  https://your-staging-domain.com/api/admin/fee-rates
```

#### ã‚¹ãƒ†ãƒƒãƒ—5: æœ¬ç•ªç’°å¢ƒã«é©ç”¨ï¼ˆæ¤œè¨¼ç’°å¢ƒã§å•é¡ŒãŒãªã„ã“ã¨ã‚’ç¢ºèªå¾Œï¼‰

```powershell
# æœ¬ç•ªç’°å¢ƒã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨
.\scripts\apply-migrations-supabase-cli.ps1 -Environment production
```

#### ã‚¹ãƒ†ãƒƒãƒ—6: æœ¬ç•ªç’°å¢ƒã®å‹•ä½œç¢ºèª

```powershell
# APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ç¢ºèª
curl -H "x-admin-token: your-admin-token" `
  https://edo-ichiba.com/api/admin/fee-rates
```

---

### æ–¹æ³•B: GitHub Actionsã‚’ä½¿ç”¨ï¼ˆè‡ªå‹•åŒ–ãƒ»æ¨å¥¨ï¼‰

GitHub Actionsã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã®SecretsãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š

- `SUPABASE_ACCESS_TOKEN`
- `SUPABASE_PROJECT_ID_STAGING`
- `SUPABASE_PROJECT_ID_PRODUCTION`

**å®Ÿè¡Œæ–¹æ³•**:
1. GitHubãƒªãƒã‚¸ãƒˆãƒª â†’ **Actions** ã‚¿ãƒ–
2. **Apply Migrations** ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’é¸æŠ
3. **Run workflow** ã‚’ã‚¯ãƒªãƒƒã‚¯
4. ãƒ–ãƒ©ãƒ³ãƒã‚’é¸æŠï¼ˆ`main`ï¼‰
5. **Run workflow** ã‚’ã‚¯ãƒªãƒƒã‚¯

**æ³¨æ„**: `apply-to-staging`ãŒæˆåŠŸã—ãŸå¾Œã€`apply-to-production`ã¯æ‰‹å‹•æ‰¿èªãŒå¿…è¦ãªå ´åˆãŒã‚ã‚Šã¾ã™ã€‚

---

## âœ… é©ç”¨å¾Œã®ç¢ºèª

### 1. ãƒ†ãƒ¼ãƒ–ãƒ«ã®å­˜åœ¨ç¢ºèª

Supabase Dashboardã§ä»¥ä¸‹ã‚’ç¢ºèªï¼š

1. **Table Editor** ã‚’é–‹ã
2. ä»¥ä¸‹ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªï¼š
   - âœ… `fee_rate_master`
   - âœ… `benchmark_data`
   - âœ… `kpi_metrics`
   - âœ… `goal_achievements`
   - âœ… `community_goal_master`ï¼ˆTieråˆ¶ã‚·ã‚¹ãƒ†ãƒ ï¼‰
   - âœ… `community_transaction_volume`ï¼ˆTieråˆ¶ã‚·ã‚¹ãƒ†ãƒ ï¼‰

### 2. APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ç¢ºèª

```powershell
# æ‰‹æ•°æ–™ç‡ãƒã‚¹ã‚¿å–å¾—API
curl -H "x-admin-token: your-admin-token" `
  https://edo-ichiba.com/api/admin/fee-rates

# ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ãƒ‡ãƒ¼ã‚¿å–å¾—API
curl -H "x-admin-token: your-admin-token" `
  "https://edo-ichiba.com/api/admin/benchmark-data?weekStart=2026-01-12"
```

### 3. Prismaã‚¹ã‚­ãƒ¼ãƒã®æ›´æ–°ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰

```powershell
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã‚¹ã‚­ãƒ¼ãƒã‚’å–å¾—
npx prisma db pull

# Prisma Clientã‚’å†ç”Ÿæˆ
npx prisma generate
```

---

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚¨ãƒ©ãƒ¼: "Secret SUPABASE_ACCESS_TOKEN not found"

**åŸå› **: ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„

**è§£æ±ºæ–¹æ³•**: ã‚¹ãƒ†ãƒƒãƒ—2ã§ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦ãã ã•ã„

### ã‚¨ãƒ©ãƒ¼: "Project not found"

**åŸå› **: Project IDãŒé–“é•ã£ã¦ã„ã‚‹

**è§£æ±ºæ–¹æ³•**: Supabase Dashboardã§Project IDã‚’å†ç¢ºèªã—ã¦ãã ã•ã„

### ã‚¨ãƒ©ãƒ¼: "Permission denied" ã¾ãŸã¯ "Invalid access token"

**åŸå› **: Access Tokenã®æ¨©é™ãŒä¸è¶³ã—ã¦ã„ã‚‹ã€ã¾ãŸã¯ç„¡åŠ¹

**è§£æ±ºæ–¹æ³•**: æ–°ã—ã„Access Tokenã‚’ç”Ÿæˆã—ã¦ãã ã•ã„

### ã‚¨ãƒ©ãƒ¼: "relation already exists"

**åŸå› **: ãƒ†ãƒ¼ãƒ–ãƒ«ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹

**è§£æ±ºæ–¹æ³•**: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã¯ `CREATE TABLE IF NOT EXISTS` ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€å®‰å…¨ã«å‡¦ç†ã•ã‚Œã¾ã™ã€‚ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ã—ã¦å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚

---

## ğŸ“ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] Supabase Access Tokenã‚’å–å¾—
- [ ] ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šï¼ˆ`SUPABASE_ACCESS_TOKEN`, `SUPABASE_PROJECT_ID_STAGING`, `SUPABASE_PROJECT_ID_PRODUCTION`ï¼‰
- [ ] æ¤œè¨¼ç’°å¢ƒã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨
- [ ] æ¤œè¨¼ç’°å¢ƒã§APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å‹•ä½œã‚’ç¢ºèª
- [ ] æœ¬ç•ªç’°å¢ƒã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨
- [ ] æœ¬ç•ªç’°å¢ƒã§APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å‹•ä½œã‚’ç¢ºèª
- [ ] Prismaã‚¹ã‚­ãƒ¼ãƒã‚’æ›´æ–°ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰

---

## ğŸ”— é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- `scripts/apply-migrations-supabase-cli.ps1` - ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
- `supabase/migrations/20250116_120000_create_fee_rate_master.sql`
- `supabase/migrations/20250117_120000_add_strategy_f_tier_system.sql`
- `supabase/migrations/20260120_120000_create_kpi_management_tables.sql`
- `.github/workflows/apply-migrations.yml` - GitHub Actionsãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

# セキュリティガイド：認証情報の管理

**作成日**: 2026-01-14  
**重要**: パスワード、トークン、認証情報は**絶対にgitにコミットしない**

---

## ❌ 絶対にやってはいけないこと

1. **認証情報をコードに直接書く**
   ```typescript
   // ❌ 絶対にダメ
   const token = "sbp_xxxxxxxxxxxxxxxxxxxxx";
   ```

2. **認証情報を含むファイルをgitにコミット**
   ```bash
   # ❌ 絶対にダメ
   git add .env
   git commit -m "Add env file"
   ```

3. **認証情報をREADMEやドキュメントに書く**
   ```markdown
   <!-- ❌ 絶対にダメ -->
   Access Token: sbp_xxxxxxxxxxxxxxxxxxxxx
   ```

---

## ✅ 安全な方法

### 方法1: GitHub Secrets（推奨・CI/CD用）

**GitHub Secretsは安全です**：
- ✅ gitリポジトリには**コミットされません**
- ✅ GitHubの暗号化されたストレージに保存されます
- ✅ ワークフロー実行時のみ使用可能
- ✅ リポジトリの設定画面でのみ管理可能

**設定方法**:
1. GitHubリポジトリ → **Settings** → **Secrets and variables** → **Actions**
2. **New repository secret** をクリック
3. Secret名と値を入力
4. **Add secret** をクリック

**使用例**（ワークフローファイル内）:
```yaml
env:
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
```

---

### 方法2: 環境変数（ローカル開発用）

**一時的な環境変数として設定**（gitにコミットしない）:

#### PowerShell（Windows）
```powershell
# 一時的な環境変数として設定（セッション終了時に消える）
$env:SUPABASE_ACCESS_TOKEN = "sbp_xxxxxxxxxxxxxxxxxxxxx"
$env:SUPABASE_PROJECT_ID = "your-project-id"

# コマンドを実行
npx supabase link --project-ref $env:SUPABASE_PROJECT_ID
npx supabase db push
```

#### Bash（Linux/Mac）
```bash
# 一時的な環境変数として設定（セッション終了時に消える）
export SUPABASE_ACCESS_TOKEN="sbp_xxxxxxxxxxxxxxxxxxxxx"
export SUPABASE_PROJECT_ID="your-project-id"

# コマンドを実行
npx supabase link --project-ref $SUPABASE_PROJECT_ID
npx supabase db push
```

**注意**: この方法では、環境変数は現在のターミナルセッションでのみ有効です。gitにコミットされません。

---

### 方法3: .envファイル（ローカル開発用・注意が必要）

**`.env`ファイルを使用する場合**：

1. **`.gitignore`に含まれていることを確認**
   ```gitignore
   .env
   .env.local
   .env.*.local
   ```
   ✅ このプロジェクトでは既に`.gitignore`に含まれています

2. **`.env`ファイルを作成**（gitにコミットしない）
   ```bash
   # .envファイルを作成（gitにコミットしない）
   SUPABASE_ACCESS_TOKEN=sbp_xxxxxxxxxxxxxxxxxxxxx
   SUPABASE_PROJECT_ID=your-project-id
   ```

3. **gitにコミットしないことを確認**
   ```bash
   # .envファイルがgitに含まれていないか確認
   git status
   
   # .envファイルが表示されていれば、gitに追加しない
   ```

**注意**: `.env`ファイルはローカル開発用です。本番環境では使用しません。

---

## 🔒 セキュリティチェックリスト

認証情報を扱う前に、以下を確認してください：

- [ ] 認証情報をコードに直接書いていない
- [ ] `.env`ファイルが`.gitignore`に含まれている
- [ ] `.env`ファイルをgitにコミットしていない
- [ ] 認証情報をREADMEやドキュメントに書いていない
- [ ] GitHub Secretsを使用している（CI/CDの場合）
- [ ] 環境変数は一時的に設定している（ローカル実行の場合）

---

## 🚨 もし誤ってコミットしてしまった場合

### ステップ1: すぐに認証情報を無効化

1. Supabase DashboardでAccess Tokenを削除
2. 新しいAccess Tokenを生成
3. データベースパスワードを変更（必要に応じて）

### ステップ2: git履歴から削除

```bash
# git履歴からファイルを削除（注意：履歴が書き換わります）
git filter-branch --force --index-filter \
  "git rm --cached --ignore-unmatch .env" \
  --prune-empty --tag-name-filter cat -- --all

# リモートに強制プッシュ（注意：チームと相談してから）
git push origin --force --all
```

**注意**: 履歴の書き換えは慎重に行ってください。チームと相談してから実行してください。

---

## 📋 推奨される方法

### CI/CD（GitHub Actions）の場合

✅ **GitHub Secretsを使用**
- gitリポジトリにはコミットされない
- 暗号化されて保存される
- ワークフロー実行時のみ使用可能

### ローカル開発の場合

✅ **一時的な環境変数として設定**
- PowerShell/Bashで一時的に設定
- セッション終了時に自動的に消える
- gitにコミットされない

### 本番環境の場合

✅ **環境変数として設定**（Vercel、Render等）
- プラットフォームの環境変数機能を使用
- gitリポジトリにはコミットされない
- 暗号化されて保存される

---

## 🔗 関連ファイル

- `.gitignore` - `.env`ファイルが除外されていることを確認
- `.github/workflows/apply-migrations.yml` - GitHub Secretsの使用例
- `SECURITY_POLICY_SQL.md` - セキュリティポリシー

---

## 📝 まとめ

**重要な原則**:
1. ✅ **認証情報は絶対にgitにコミットしない**
2. ✅ **GitHub Secretsを使用**（CI/CDの場合）
3. ✅ **一時的な環境変数として設定**（ローカル実行の場合）
4. ✅ **`.env`ファイルは`.gitignore`に含まれていることを確認**

**今回のマイグレーション適用の場合**:
- ✅ GitHub Secretsを使用（推奨）
- ✅ または、一時的な環境変数として設定してSupabase CLIを実行

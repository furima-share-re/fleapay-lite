# API仕様: `/api/seller/order-detail-full`

## 概要

出店者（販売者）が自分の注文の詳細情報を取得するためのAPI。注文の基本情報に加えて、画像、購入者属性、商品カテゴリなどの付帯情報をまとめて返す。

**注意**: このドキュメントは説明用です。**正（Source of Truth）は `spec/openapi.yml` を参照してください。**

---

## 誰が使う想定か

**販売者（出店者）用API**

- エンドポイントパスが`/api/seller/`配下であることから、販売者向け
- `seller-dashboard.html`で使用されており、販売者のダッシュボード画面で注文詳細モーダルを表示する際に呼び出される
- 認証方式：
  - **クエリパラメータで`sellerId`を受け取るのみ**
  - **明示的な認証チェック（セッション、トークン等）は実装されていない**
  - `seller_id`で絞り込みを行うため、他人の注文は取得できない仕組み

---

## データ取得ロジック

- `orders`テーブルを基準に、以下のテーブルを`LEFT JOIN`で結合：
  - `order_metadata`
  - `buyer_attributes`
  - `images`
- `images`については、`created_at DESC`でソートし、最新の1件のみ取得（`LIMIT 1`）
- すべてのJOINは`LEFT JOIN`のため、関連データが存在しない場合でも注文情報は返される
- 欠損値はデフォルト値で補完される（`|| ""`、`|| "unknown"`、`|| 0`、`|| null`）
- **論理削除された注文は除外される**（`deleted_at IS NULL`）

---

## 仕様として曖昧な点・判断できない点

### 1. **認証・認可の不備**
- クエリパラメータの`sellerId`のみでアクセス制御を行っている
- セッションやトークンベースの認証がなく、URLを知っていれば他者の注文IDを推測してアクセスする余地がある可能性
- ただし、`seller_id`で絞り込むため、他者の注文を取得することはできない

### 2. **エラーハンドリングの不足**
- データベースエラー時は`server_error`を返すが、具体的なエラー種別の識別ができない
- 404エラーは「注文が見つからない」場合に返されるが、以下のケースで同一のエラーになる：
  - 注文IDが存在しない
  - 注文は存在するが、指定された`sellerId`に紐づいていない
  - 論理削除された注文（`deleted_at`が設定されている）

### 3. **画像の取得ロジック**
- `ORDER BY img.created_at DESC NULLS LAST LIMIT 1`で最新の画像1件を取得
- 複数画像がある場合の扱いが不明（最新1件のみが正しい仕様なのか）

### 4. **データの整合性**
- `LEFT JOIN`のため、関連データが存在しない場合でも注文情報は返される
- 例：画像が存在しない注文でも`imageUrl: null`として返される
- ただし、`buyer_attributes`や`order_metadata`にデータがない場合、`unknown`や空文字が返される

### 5. **パラメータの検証不足**
- `sellerId`と`orderId`の存在チェックはあるが、形式の検証（SQLインジェクション対策以外）は見当たらない
- 実装ではプレースホルダ（`$1`、`$2`）を使用しているため、SQLインジェクション対策はされている

---

## 実装場所

- **定義場所**: `server.js` 644行目
- **使用場所**: `public/seller-dashboard.html` 1747行目
- **類似API**: `payments.js`の`/api/seller/order-detail`（写真・属性なしの簡易版）

---

## 関連ドキュメント

- **正（Source of Truth）**: `spec/openapi.yml`
- **タイムアウト設定**: `truth/infra/timeout.yml`
- **リトライ戦略**: `truth/infra/retry.yml`


# デプロイ状態確認ガイド

**作成日**: 2026-01-02  
**目的**: 検証環境に最新のコードがデプロイされているか確認してから動作確認を行う

---

## 📋 概要

動作確認を行う前に、検証環境に最新のコードがデプロイされているかを確認することが重要です。デプロイされていない状態で動作確認を行っても、正しい結果が得られません。

---

## 🔍 デプロイ状態確認方法

### 方法1: デプロイ状態確認スクリプトを使用（推奨）

**スクリプト**: `scripts/check-deployment-status.ps1`

**使用方法**:
```powershell
.\scripts\check-deployment-status.ps1 -BaseUrl "https://fleapay-lite-t1.onrender.com"
```

**確認内容**:
1. ローカルの最新コミット情報を取得
2. 検証環境のAPIからバージョン情報を取得
3. デプロイ状態を判定

**出力例**:
```
🔍 デプロイ状態を確認しています...

📋 ローカルの最新コミット情報:
  コミットハッシュ: 1aeeee7
  コミット日時: 2026-01-02 15:44:10 +0900
  コミットメッセージ: Phase 1.4: 検証環境環境移行完了

🌐 検証環境のデプロイ状態を確認中...
  ✅ サーバーは正常に応答しています
  バージョン: 3.2.0-seller-summary-fixed
  タイムスタンプ: 2026-01-02T06:40:26.445Z
  Prisma状態: connected
  ✅ コミット情報が含まれています

📊 デプロイ状態の判定:
  ✅ データベース接続: 正常

✅ デプロイ状態確認完了
```

---

### 方法2: デプロイ状態確認 + 動作確認を一括実行

**スクリプト**: `scripts/verify-with-deployment-check.ps1`

**使用方法**:
```powershell
.\scripts\verify-with-deployment-check.ps1 -BaseUrl "https://fleapay-lite-t1.onrender.com"
```

**確認内容**:
1. デプロイ状態確認（方法1と同じ）
2. 基本動作確認（ヘルスチェック、APIエンドポイント、画面）

**出力例**:
```
╔═══════════════════════════════════════════════════════════╗
║  デプロイ状態確認 + 動作確認スクリプト                    ║
╚═══════════════════════════════════════════════════════════╝

📋 Step 1: デプロイ状態確認
─────────────────────────────────────────────────────────
[デプロイ状態確認の出力]

📋 Step 2: 動作確認
─────────────────────────────────────────────────────────

🔍 基本動作確認を開始します...

1. ヘルスチェック (/api/ping)
   ✅ ステータス: 200
   ✅ バージョン: 3.2.0-seller-summary-fixed
   ✅ Prisma: connected

2. APIエンドポイント確認
   ✅ 売上サマリー (Standard): OK (planType: standard)
   ✅ 売上サマリー (Pro): OK (planType: pro)
   ✅ 売上サマリー (Kids): OK (planType: kids)

3. 画面確認（HTMLの存在確認）
   ✅ セラーダッシュボード: OK (Status: 200)
   ✅ レジ画面: OK (Status: 200)

╔═══════════════════════════════════════════════════════════╗
║  ✅ すべての動作確認が正常に完了しました                ║
╚═══════════════════════════════════════════════════════════╝
```

---

### 方法3: 手動でAPIを確認

**APIエンドポイント**: `GET /api/ping`

**確認方法**:
```powershell
$response = Invoke-WebRequest -Uri "https://fleapay-lite-t1.onrender.com/api/ping" -UseBasicParsing
$data = $response.Content | ConvertFrom-Json
Write-Host "バージョン: $($data.version)"
Write-Host "コミットハッシュ: $($data.git.commit)"
Write-Host "コミット日時: $($data.git.date)"
```

**期待される応答**:
```json
{
  "ok": true,
  "timestamp": "2026-01-02T06:40:26.445Z",
  "version": "3.2.0-seller-summary-fixed",
  "prisma": "connected",
  "git": {
    "commit": "1aeeee7",
    "date": "2026-01-02 15:44:10 +0900"
  }
}
```

---

## ✅ デプロイ状態の判定基準

### 正常な状態

- ✅ サーバーが正常に応答する（`/api/ping`が200を返す）
- ✅ Prisma接続が正常（`prisma: "connected"`）
- ✅ Gitコミット情報が含まれている（`git.commit`と`git.date`が存在）
- ✅ ローカルのコミットハッシュと検証環境のコミットハッシュが一致

### 要確認の状態

- ⚠️ サーバーが応答しない（接続エラー）
- ⚠️ Prisma接続が失敗している（`prisma: "not_available"`）
- ⚠️ Gitコミット情報が含まれていない（デプロイ環境でGitが利用できない場合）
- ⚠️ ローカルのコミットハッシュと検証環境のコミットハッシュが一致しない

---

## 🚨 デプロイされていない場合の対処

### 1. Render Dashboardでデプロイ状態を確認

1. Render Dashboardにログイン
2. `fleapay-lite-t1` サービスを選択
3. **Events** タブで最新のデプロイ状態を確認
4. **Logs** タブでデプロイログを確認

### 2. 手動でデプロイをトリガー

1. Render Dashboardで **Manual Deploy** をクリック
2. 最新のコミットを選択
3. デプロイが完了するまで待機（通常5-10分）

### 3. Gitのプッシュを確認

```powershell
# 最新のコミットがリモートにプッシュされているか確認
git log origin/main -1

# プッシュされていない場合はプッシュ
git push origin main
```

---

## 📝 動作確認前のチェックリスト

動作確認を行う前に、以下を確認してください：

- [ ] ローカルの最新コミット情報を確認
- [ ] 検証環境のAPIからバージョン情報を取得
- [ ] コミットハッシュが一致していることを確認
- [ ] Prisma接続が正常であることを確認
- [ ] サーバーが正常に応答することを確認

**すべての項目が確認できたら、動作確認を開始してください。**

---

## 🔧 トラブルシューティング

### 問題1: Git情報が取得できない

**原因**: デプロイ環境でGitが利用できない、または`.git`ディレクトリが含まれていない

**対処**: 
- Renderのビルド設定で`.git`ディレクトリを含めるように設定
- または、環境変数でコミットハッシュを設定

### 問題2: コミットハッシュが一致しない

**原因**: 最新のコードがデプロイされていない

**対処**:
1. Render Dashboardで最新のデプロイを確認
2. 必要に応じて手動でデプロイをトリガー
3. デプロイが完了するまで待機

### 問題3: Prisma接続が失敗している

**原因**: データベース接続エラー、またはPrisma Clientが生成されていない

**対処**:
1. `DATABASE_URL`環境変数を確認
2. Renderのログでエラーを確認
3. `postinstall`スクリプトが正常に実行されているか確認

---

## 📚 関連ドキュメント

- `scripts/check-deployment-status.ps1` - デプロイ状態確認スクリプト
- `scripts/verify-with-deployment-check.ps1` - デプロイ状態確認 + 動作確認スクリプト
- `.ai/history/reports/PHASE_1_4_VERIFICATION_REPORT.md` - Phase 1.4動作確認レポート

---

**次回更新**: デプロイ状態確認機能の改善時


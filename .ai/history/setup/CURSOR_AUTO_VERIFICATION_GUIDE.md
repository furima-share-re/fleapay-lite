# Cursor用: 自動デプロイ状態確認 + 動作確認ガイド

**作成日**: 2026-01-02  
**目的**: CursorのAIアシスタントが動作確認時に自動でデプロイ状態を判断できるようにする

---

## 📋 概要

CursorのAIアシスタントが動作確認を行う際に、自動的にデプロイ状態を確認し、デプロイされていない場合は警告を表示して動作確認をスキップする機能を実装しました。

---

## 🔧 実装内容

### 1. 自動デプロイ状態確認 + 動作確認スクリプト

**ファイル**: `scripts/auto-verify-staging.ps1`

**機能**:
1. ローカルの最新コミット情報を取得
2. 検証環境のデプロイ状態を確認
3. コミットハッシュを比較してデプロイ状態を判定
4. デプロイされていない場合は警告を表示して終了
5. デプロイされている場合は動作確認を実行

**使用方法**:
```powershell
# 基本的な使用方法（デプロイ状態確認 + 動作確認）
.\scripts\auto-verify-staging.ps1

# デプロイ状態確認をスキップして動作確認のみ実行
.\scripts\auto-verify-staging.ps1 -SkipDeploymentCheck

# カスタムURLを指定
.\scripts\auto-verify-staging.ps1 -BaseUrl "https://your-custom-url.onrender.com"
```

---

## 🤖 CursorのAIアシスタントでの使用方法

### 方法1: スクリプトを直接実行（推奨）

CursorのAIアシスタントが動作確認を行う際に、以下のコマンドを実行します：

```powershell
.\scripts\auto-verify-staging.ps1
```

**動作**:
- デプロイ状態を自動確認
- デプロイされていない場合は警告を表示して終了（exit code 1）
- デプロイされている場合は動作確認を実行

### 方法2: 手動でデプロイ状態を確認してから動作確認

```powershell
# Step 1: デプロイ状態確認
.\scripts\check-deployment-status.ps1

# Step 2: デプロイ状態が正常な場合のみ動作確認
.\scripts\auto-verify-staging.ps1
```

---

## ✅ 自動判定のロジック

### デプロイ状態の判定基準

1. **サーバーが正常に応答する**
   - `/api/ping`が200を返す
   - Prisma接続が正常（`prisma: "connected"`）

2. **Gitコミット情報が含まれている**
   - `git.commit`と`git.date`が存在
   - `git.commit`が`"unknown"`でない

3. **ローカルのコミットハッシュと一致する**
   - ローカルのコミットハッシュ（短縮版）と検証環境のコミットハッシュが一致

### 判定結果

| 状態 | 判定 | 動作 |
|------|------|------|
| ✅ すべての条件を満たす | **デプロイ済み** | 動作確認を実行 |
| ⚠️ サーバーが応答しない | **デプロイされていない** | 警告を表示して終了（exit code 1） |
| ⚠️ Git情報が含まれていない | **要確認** | ユーザーに確認を求める |
| ⚠️ コミットハッシュが一致しない | **デプロイされていない** | 警告を表示して終了（exit code 1） |

---

## 📝 CursorのAIアシスタントへの指示

CursorのAIアシスタントが動作確認を行う際は、以下のように指示してください：

### 基本的な指示

```
動作確認を実行してください。デプロイ状態を自動確認してから動作確認を行ってください。
```

### 詳細な指示

```
検証環境の動作確認を実行してください。
1. まず、デプロイ状態を確認してください（.\scripts\auto-verify-staging.ps1 を実行）
2. デプロイされていない場合は、デプロイを促すメッセージを表示してください
3. デプロイされている場合は、動作確認を実行してください
```

---

## 🔍 実行例

### 例1: デプロイ済みの場合

```powershell
PS> .\scripts\auto-verify-staging.ps1

╔═══════════════════════════════════════════════════════════╗
║  Cursor用: 自動デプロイ状態確認 + 動作確認スクリプト    ║
╚═══════════════════════════════════════════════════════════╝

📋 Step 1: デプロイ状態確認
─────────────────────────────────────────────────────────

🔍 ローカルの最新コミット情報を取得中...
  ✅ コミットハッシュ: 1aeeee7
  ✅ コミット日時: 2026-01-02 15:44:10 +0900
  ✅ コミットメッセージ: Phase 1.4: 検証環境環境移行完了

🌐 検証環境のデプロイ状態を確認中...
  ✅ サーバーは正常に応答しています
  バージョン: 3.2.0-seller-summary-fixed
  Prisma状態: connected
  ✅ Gitコミット情報が含まれています
  デプロイ済みコミット: 1aeeee7
  デプロイ日時: 2026-01-02 15:44:10 +0900
  ✅ ローカルのコミットハッシュと一致しています

✅ デプロイ状態確認完了

📋 Step 2: 動作確認
─────────────────────────────────────────────────────────
[動作確認の結果...]

╔═══════════════════════════════════════════════════════════╗
║  ✅ すべての動作確認が正常に完了しました                ║
╚═══════════════════════════════════════════════════════════╝
```

### 例2: デプロイされていない場合

```powershell
PS> .\scripts\auto-verify-staging.ps1

╔═══════════════════════════════════════════════════════════╗
║  Cursor用: 自動デプロイ状態確認 + 動作確認スクリプト    ║
╚═══════════════════════════════════════════════════════════╝

📋 Step 1: デプロイ状態確認
─────────────────────────────────────────────────────────

🔍 ローカルの最新コミット情報を取得中...
  ✅ コミットハッシュ: 1aeeee7
  ✅ コミット日時: 2026-01-02 15:44:10 +0900

🌐 検証環境のデプロイ状態を確認中...
  ✅ サーバーは正常に応答しています
  バージョン: 3.2.0-seller-summary-fixed
  Prisma状態: connected
  ✅ Gitコミット情報が含まれています
  デプロイ済みコミット: abc1234
  デプロイ日時: 2026-01-01 10:00:00 +0900
  ⚠️ ローカルのコミットハッシュと一致しません
     ローカル: 1aeeee7
     検証環境: abc1234

  ❌ 最新のコードがデプロイされていません
     動作確認をスキップします。

  💡 対処方法:
     1. 最新のコードをコミット・プッシュしてください
     2. Render Dashboardでデプロイが完了するまで待機してください
     3. デプロイ完了後、再度このスクリプトを実行してください
```

---

## 🚨 エラーハンドリング

### エラー1: サーバーが応答しない

**原因**: 検証環境がダウンしている、またはネットワークエラー

**対処**:
1. Render Dashboardでサービスの状態を確認
2. ネットワーク接続を確認
3. サービスがダウンしている場合は再起動

### エラー2: Git情報が取得できない

**原因**: ローカルでGitが利用できない、または`.git`ディレクトリが存在しない

**対処**:
- Gitがインストールされているか確認
- プロジェクトルートでGitリポジトリが初期化されているか確認

### エラー3: コミットハッシュが一致しない

**原因**: 最新のコードがデプロイされていない

**対処**:
1. 最新のコードをコミット・プッシュ
2. Render Dashboardでデプロイが完了するまで待機
3. デプロイ完了後、再度スクリプトを実行

---

## 📚 関連ドキュメント

- `scripts/auto-verify-staging.ps1` - 自動デプロイ状態確認 + 動作確認スクリプト
- `scripts/check-deployment-status.ps1` - デプロイ状態確認スクリプト
- `.ai/history/setup/DEPLOYMENT_STATUS_CHECK_GUIDE.md` - デプロイ状態確認ガイド

---

## 💡 ベストプラクティス

### CursorのAIアシスタントが動作確認を行う際の推奨フロー

1. **動作確認の依頼を受けたら**:
   ```powershell
   .\scripts\auto-verify-staging.ps1
   ```

2. **デプロイされていない場合**:
   - ユーザーにデプロイを促すメッセージを表示
   - デプロイ完了を待つよう指示

3. **デプロイされている場合**:
   - 動作確認を実行
   - 結果をレポートとして保存

### 手動で動作確認を行う場合

```powershell
# デプロイ状態のみ確認
.\scripts\check-deployment-status.ps1

# デプロイ状態確認 + 動作確認
.\scripts\auto-verify-staging.ps1
```

---

**次回更新**: 自動判定ロジックの改善時


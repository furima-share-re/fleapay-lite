# 手数料徴収機能実装 - 最終確認対応完了報告

**対応日**: 2025 年 1 月  
**対応者**: AI Assistant  
**最終確認指摘事項への対応状況**

---

## 📋 対応完了項目

### ✅ 1. normalizeStatementDescriptor のバグ修正

**問題**: `source`が定義されていない（実際には定義されていたが、nullish coalescing を使うべき）

**対応内容**:

- `const source = shopName ?? eventName;` に修正
- 返り値を suffix だけにする（`EDOICHIBA *EVENT`ではなく`EVENT`）
- プラットフォーム側の descriptor と重複しないようにする

**実装箇所**:

```typescript
export function normalizeStatementDescriptor(
  shopName: string | null | undefined,
  eventName: string = "EVENT"
): string {
  const source = shopName ?? eventName;

  const normalized = (source || "")
    .toUpperCase()
    .replace(/[^A-Z0-9\s\*\-]/g, "")
    .replace(/\s+/g, " ")
    .trim()
    .slice(0, 22);

  // 正規化後が空なら固定値（suffixだけ、EDOICHIBAは含まない）
  if (!normalized || normalized.length === 0) {
    return "EVENT";
  }

  return normalized;
}
```

---

### ✅ 2. statement_descriptor_suffix の設計修正

**問題**: `EDOICHIBA *EVENT`を返すと、プラットフォーム側の descriptor と重複したり、`*`の位置が意図せず二重になる

**対応内容**:

- 関数は suffix だけ返す（`EVENT` / `SHOPNAME`だけ）
- descriptor 本体は Stripe の設定（または`payment_intent_data.statement_descriptor`）側で`EDOICHIBA`を持つ

**実装箇所**:

```typescript
// suffixだけを返す（EDOICHIBAは含まない）
const statementDescriptorSuffix = normalizeStatementDescriptor(
  seller?.shopName || seller?.displayName,
  "EVENT"
);
```

---

### ✅ 3. 金額ハッシュの強化

**問題**: `base64(amount)`は推測可能で、改ざん検知としては弱い

**対応内容**:

- `orderId + amount + currency`を連結して HMAC でハッシュ
- Node 標準 crypto で 16 文字に切る

**実装箇所**:

```typescript
import crypto from "crypto";

// orderId + amount + currencyを連結してHMACでハッシュ（改ざん検知を強化）
const hashInput = `${order.id}:${orderAmount}:jpy`;
const secret = process.env.STRIPE_SECRET_KEY || "default-secret";
const orderAmountHash = crypto
  .createHmac("sha256", secret)
  .update(hashInput)
  .digest("base64")
  .slice(0, 16);
```

---

### ✅ 4. Math.max(calculatedFee, 1) の 0 円決済対応

**問題**: 0 円決済や無料クーポンで手数料 1 円が取れず決済失敗や乖離が起きる

**対応内容**:

- `orderAmount === 0`の場合は`fee = 0`にする
- 0 円注文は不可の仕様なら不要（現状は`orderAmount <= 0`でバリデーション）

**実装箇所**:

```typescript
const calculatedFee = Math.floor(orderAmount * feeRate);
const fee = orderAmount === 0 ? 0 : Math.max(calculatedFee, 1); // 0円の場合は0、それ以外は最低1円
```

---

### ✅ 5. fee 上限チェックの改善

**問題**: `fee > 999,999,999`の上限は根拠が弱い

**対応内容**:

- 主防御は不変条件（`fee >= 0`、`fee < orderAmount`）
- 上限チェックは補助的（安全弁）として残す

**実装箇所**:

```typescript
// 手数料の不変条件チェック（主防御）
// 1. fee >= 0（負の手数料は不可）
// 2. fee < orderAmount（手数料が注文金額以上にならない）
if (fee < 0) {
  // エラー処理
}

if (fee >= orderAmount && orderAmount > 0) {
  // エラー処理
}

// Stripeのapplication_fee_amountの上限チェック（補助的、安全弁）
// 注意: Stripeの制限は通貨やAPIの型制約に依存するため、主防御は上記の不変条件
if (fee > 999999999) {
  // エラー処理
}
```

---

### ✅ 6. charges_enabled チェックの頻度への注意

**問題**: 毎回`stripe.accounts.retrieve`をやるとレイテンシ/コストが増える

**対応内容**:

- コメントで将来のキャッシュ化を明記
- `seller`テーブルに`chargesEnabled`をキャッシュして、Webhook（`account.updated`）で更新することを推奨

**実装箇所**:

```typescript
// Connected accountがcharges_enabled=trueか確認（未完了KYCで失敗する）
// 注意: 毎回retrieveするとレイテンシ/コストが増えるため、
// 将来はsellerテーブルにchargesEnabledをキャッシュして、
// Webhook（account.updated）で更新することを推奨
```

---

### ✅ 7. fee_rate_master の未来予約運用方針の明記

**問題**: 将来「来月から手数料変更」をしたい場合の運用が不明確

**対応内容**:

- 運用方針をコメントで明記
- 変更日当日に新しいレコードを INSERT、古いレコードの`effective_to`を更新する運用を推奨

**実装箇所**:

```sql
-- 運用方針: 未来予約はしない（変更日は手動で切替）
-- 将来「来月から手数料変更」をしたい場合:
--   - 変更日当日に新しいレコードをINSERT（effective_to IS NULL）
--   - 古いレコードのeffective_toを更新（過去日時を設定）
-- または別テーブル/別列で管理し、切替バッチでeffective_toを埋める運用も可能
```

---

## 📊 変更ファイル一覧

| ファイル                                                         | 変更内容                                                    |
| ---------------------------------------------------------------- | ----------------------------------------------------------- |
| `lib/utils.ts`                                                   | `normalizeStatementDescriptor()`のバグ修正、suffix 設計修正 |
| `app/api/checkout/session/route.ts`                              | 金額ハッシュ強化、0 円決済対応、不変条件チェック改善        |
| `supabase/migrations/20250116_120000_create_fee_rate_master.sql` | 未来予約運用方針の明記                                      |

---

## ✅ 対応完了確認

- [x] normalizeStatementDescriptor のバグ修正（source 未定義 → nullish coalescing 使用）
- [x] statement_descriptor_suffix の設計修正（suffix だけ返す）
- [x] 金額ハッシュの強化（HMAC 使用）
- [x] Math.max(calculatedFee, 1) の 0 円決済対応
- [x] fee 上限チェックの改善（不変条件を主防御に）
- [x] charges_enabled チェックの頻度への注意（コメント追加）
- [x] fee_rate_master の未来予約運用方針の明記

---

## 🎯 最終判定

**リリース可**

最低限の(1) source 未定義と(2) suffix 設計の修正が完了しました。

その他の改善事項もすべて対応済みです。

---

**最終更新**: 2025 年 1 月  
**最終確認対応完了**: ✅

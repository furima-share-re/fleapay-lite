# SQL直接実行セキュリティポリシー

**更新日**: 2026-01-06  
**目的**: データベースへの直接SQL実行を防止し、セキュリティを強化する

---

## 🚫 ポリシー概要

このプロジェクトでは、**データベースへの直接SQL実行を禁止**しています。すべてのデータベース操作は、適切な認証・認可を持つAPIエンドポイント経由で行う必要があります。

---

## ✅ 実装された対策

### 1. SQL実行APIの無効化

#### Next.js API (`app/api/admin/bootstrap-sql/route.ts`)
- **本番環境では常に無効化**: `NODE_ENV=production` の場合、SQL実行APIは完全にブロックされます
- **開発環境でも明示的な有効化が必要**: `ADMIN_BOOTSTRAP_SQL_ENABLED=true` の設定が必要です
- **監査ログ**: すべてのSQL実行試行は監査ログに記録されます

#### Express.js API (`public/server.js`)
- 同様のセキュリティ対策が実装されています
- 本番環境では常に無効化されます

### 2. SQLファイルのアーカイブ

- すべてのSQLファイル（`*.sql`）は `scripts/archived/` ディレクトリに移動されました
- これらのファイルは参考用として保存されていますが、直接実行はできません
- 詳細は `scripts/archived/README.md` を参照してください

### 3. データベースアクセスの原則

#### 許可される方法
1. **Prisma ORM**: すべてのデータベース操作はPrismaを通じて行います
   - 型安全なクエリ
   - SQLインジェクション対策が自動的に適用されます
2. **APIエンドポイント**: 認証・認可を持つAPI経由での操作
3. **Prisma Migrations**: スキーマ変更は `supabase/migrations/` ディレクトリのマイグレーションファイルを使用

#### 禁止される方法
1. **生SQLの直接実行**: `$executeRawUnsafe` の使用は禁止（緊急時を除く）
2. **データベースクライアントツール**: 本番データベースへの直接接続は禁止
3. **SQLファイルの直接実行**: `scripts/archived/` のSQLファイルは実行しない

---

## 🔒 セキュリティチェックリスト

### 本番環境デプロイ前の確認

- [ ] `ADMIN_BOOTSTRAP_SQL_ENABLED` が設定されていない、または `false` であることを確認
- [ ] `NODE_ENV=production` が設定されていることを確認
- [ ] データベース接続文字列が適切に保護されていることを確認
- [ ] すべてのSQLファイルが `scripts/archived/` に移動されていることを確認

### 開発環境での注意事項

- 開発環境でSQL実行APIを使用する場合でも、`ADMIN_BOOTSTRAP_SQL_ENABLED=true` の設定が必要です
- 開発環境での使用は、テスト目的に限定してください
- 本番データベースには接続しないでください

---

## 📋 環境変数

### `ADMIN_BOOTSTRAP_SQL_ENABLED`
- **用途**: SQL実行APIの有効/無効を制御
- **デフォルト**: 未設定（無効）
- **本番環境**: 常に無効（設定しても無視されます）
- **開発環境**: `true` に設定することで有効化可能

### `NODE_ENV`
- **用途**: 実行環境の識別
- **本番環境**: `production` に設定されている場合、SQL実行は完全にブロックされます

---

## 🛡️ セキュリティ監査

### 監査ログに記録されるイベント

1. **SQL実行試行**: すべてのSQL実行試行が記録されます
2. **本番環境でのブロック**: 本番環境でのSQL実行試行は自動的にブロックされ、ログに記録されます
3. **認証失敗**: 管理者認証の失敗も記録されます
4. **危険なSQLパターンの検出**: DROP、TRUNCATE、DELETEなどの危険なSQLパターンが検出された場合も記録されます

### ログの確認方法

監査ログは `audit()` 関数を通じて記録されます。ログの出力先は、アプリケーションの設定に依存します。

---

## 🔄 データベース操作の代替手段

### データの確認
- **Prisma Studio**: 開発環境でデータを確認する場合
- **APIエンドポイント**: `/api/debug/db-status` など、適切なAPIを使用

### データの変更
- **Prisma Client**: アプリケーションコード内でPrismaを使用
- **マイグレーション**: スキーマ変更は `supabase/migrations/` を使用
- **管理API**: 適切な認証を持つ管理APIエンドポイントを使用

### 緊急時の対応
- 緊急時でも、本番環境での直接SQL実行は禁止されています
- 代わりに、適切な認証を持つ管理APIエンドポイントを使用してください
- 必要に応じて、新しいAPIエンドポイントを作成してください

---

## 📚 関連ドキュメント

- `scripts/archived/README.md` - アーカイブされたSQLファイルの説明
- `prisma/schema.prisma` - データベーススキーマ定義
- `supabase/migrations/` - データベースマイグレーションファイル

---

## ⚠️ 違反時の対応

SQL直接実行の試行が検出された場合：

1. **即座にブロック**: 本番環境では自動的にブロックされます
2. **監査ログに記録**: すべての試行がログに記録されます
3. **調査**: ログを確認し、必要に応じて追加のセキュリティ対策を実施

---

## 🔄 ポリシーの更新

このポリシーは、セキュリティ要件の変更に応じて更新される可能性があります。重要な変更がある場合は、すべての関係者に通知されます。

---

**最終更新**: 2026-01-06  
**実装者**: AI Assistant  
**承認**: プロジェクト管理者


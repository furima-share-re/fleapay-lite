# SQL直接実行セキュリティポリシー

**更新日**: 2026-01-06  
**目的**: データベースへの直接SQL実行を防止し、セキュリティを強化する

---

## 🚫 ポリシー概要

このプロジェクトでは、**データベースへの直接SQL実行を禁止**しています。すべてのデータベース操作は、適切な認証・認可を持つAPIエンドポイント経由で行う必要があります。

---

## ✅ 実装された対策

### 1. SQL実行APIの完全削除（原則4の実装）

**原則4: 永続データは人が触らない** に基づき、手動SQL実行エンドポイントは完全に削除されました。

- **削除されたエンドポイント**: `app/api/admin/bootstrap-sql/route.ts`
- **理由**: 人が直接SQLを実行することを物理的に不可能にするため
- **代替手段**: SupabaseマイグレーションファイルとCI/CDによる自動適用のみ

#### 以前の実装（削除済み）
- ~~本番環境では常に無効化~~ → **完全削除**
- ~~開発環境でも明示的な有効化が必要~~ → **完全削除**
- ~~監査ログ~~ → **不要（エンドポイント自体が存在しない）**

### 2. SQLファイルのアーカイブ

- すべてのSQLファイル（`*.sql`）は `scripts/archived/` ディレクトリに移動されました
- これらのファイルは参考用として保存されていますが、直接実行はできません
- 詳細は `scripts/archived/README.md` を参照してください

### 3. データベースアクセスの原則

#### 許可される方法
1. **Prisma ORM**: すべてのデータベース操作はPrismaを通じて行います
   - 型安全なクエリ
   - SQLインジェクション対策が自動的に適用されます
2. **APIエンドポイント**: 認証・認可を持つAPI経由での操作
3. **Prisma Migrations**: スキーマ変更は `supabase/migrations/` ディレクトリのマイグレーションファイルを使用

#### 禁止される方法
1. **生SQLの直接実行**: `$executeRawUnsafe` の使用は禁止（緊急時を除く）
2. **データベースクライアントツール**: 本番データベースへの直接接続は禁止
3. **SQLファイルの直接実行**: `scripts/archived/` のSQLファイルは実行しない

---

## 🔒 セキュリティチェックリスト

### 本番環境デプロイ前の確認

- [ ] 手動SQL実行エンドポイントが存在しないことを確認（`app/api/admin/bootstrap-sql/route.ts` が削除されている）
- [ ] `NODE_ENV=production` が設定されていることを確認
- [ ] データベース接続文字列が適切に保護されていることを確認
- [ ] すべてのSQLファイルが `scripts/archived/` に移動されていることを確認
- [ ] マイグレーションファイルが `supabase/migrations/` に正しく配置されていることを確認

### 開発環境での注意事項

- **手動SQL実行は完全に禁止されています**
- データベース変更は `supabase/migrations/` ディレクトリのマイグレーションファイルのみを使用
- マイグレーションファイルはCI/CDで自動検証されます
- 本番データベースには直接接続しないでください

---

## 📋 環境変数

### `NODE_ENV`
- **用途**: 実行環境の識別
- **本番環境**: `production` に設定されていることを確認

### `SUPABASE_ACCESS_TOKEN`（CI/CD用）
- **用途**: Supabase CLIによる自動マイグレーション適用
- **設定場所**: GitHub Secrets
- **使用方法**: `.github/workflows/apply-migrations.yml` で使用

### `SUPABASE_PROJECT_ID`（CI/CD用）
- **用途**: Supabaseプロジェクトの識別
- **設定場所**: GitHub Secrets

---

## 🛡️ セキュリティ監査

### CI/CDによる自動検証

1. **破壊的変更の検知**: `.github/workflows/migration-safety.yml` が自動的に検証
2. **命名規則の検証**: マイグレーションファイルの命名規則をチェック
3. **マージ前の検証**: すべてのPRでマイグレーションファイルが検証されます

### 検証内容

- `DROP TABLE`, `DROP COLUMN` などの破壊的変更の検知
- `RENAME COLUMN`, `RENAME TABLE` の検知
- 型変更、NOT NULL化の検知
- マイグレーションファイルの命名規則（`YYYYMMDD_HHMMSS_description.sql`）の検証

---

## 🔄 データベース操作の代替手段

### データの確認
- **Prisma Studio**: 開発環境でデータを確認する場合
- **APIエンドポイント**: `/api/debug/db-status` など、適切なAPIを使用

### データの変更
- **Prisma Client**: アプリケーションコード内でPrismaを使用
- **マイグレーション**: スキーマ変更は `supabase/migrations/` を使用
- **管理API**: 適切な認証を持つ管理APIエンドポイントを使用

### 緊急時の対応
- 緊急時でも、本番環境での直接SQL実行は禁止されています
- 代わりに、適切な認証を持つ管理APIエンドポイントを使用してください
- 必要に応じて、新しいAPIエンドポイントを作成してください

---

## 📚 関連ドキュメント

- `docs/PRINCIPLE_4_IMPLEMENTATION.md` - 原則4の実装ガイド（**重要**）
- `scripts/archived/README.md` - アーカイブされたSQLファイルの説明
- `prisma/schema.prisma` - データベーススキーマ定義
- `supabase/migrations/` - データベースマイグレーションファイル
- `.github/workflows/migration-safety.yml` - マイグレーション安全性チェック
- `.github/workflows/apply-migrations.yml` - 自動マイグレーション適用

---

## ⚠️ 違反時の対応

破壊的変更が検出された場合：

1. **CI/CDで自動ブロック**: PRのマージが自動的に拒否されます
2. **エラーメッセージの表示**: どのマイグレーションファイルのどの行が問題かを表示
3. **修正の指示**: エラーメッセージに修正方法が含まれます

---

## 🔄 ポリシーの更新

このポリシーは、セキュリティ要件の変更に応じて更新される可能性があります。重要な変更がある場合は、すべての関係者に通知されます。

---

**最終更新**: 2026-01-06  
**実装者**: AI Assistant  
**承認**: プロジェクト管理者


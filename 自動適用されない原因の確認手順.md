# 自動適用されない原因の確認手順

**作成日**: 2026-01-14  
**問題**: GitHub Actionsでマイグレーションが自動適用されない

---

## 🔍 自動適用の条件

GitHub Actionsのワークフロー（`.github/workflows/apply-migrations.yml`）は以下の条件で自動実行されます：

1. ✅ `main`ブランチにプッシュ
2. ✅ `supabase/migrations/**` のパスが変更された場合
3. ✅ または、手動実行（`workflow_dispatch`）

---

## ❌ 自動適用されない可能性のある原因

### 1. マイグレーションファイルが`main`ブランチにプッシュされていない

**確認方法**:
```powershell
# 現在のブランチを確認
git branch

# mainブランチに切り替え
git checkout main

# マイグレーションファイルが存在するか確認
ls supabase/migrations/

# 最新のコミット履歴を確認
git log --oneline --name-only -10
```

**解決方法**:
```powershell
# マイグレーションファイルをコミット
git add supabase/migrations/
git commit -m "chore: add missing migrations"
git push origin main
```

---

### 2. GitHub Secretsが設定されていない

**必要なSecrets**:
- `SUPABASE_ACCESS_TOKEN` - Supabase APIアクセストークン
- `SUPABASE_PROJECT_ID_STAGING` - 検証環境のProject ID
- `SUPABASE_PROJECT_ID_PRODUCTION` - 本番環境のProject ID

**確認方法**:
1. GitHubリポジトリ → **Settings** → **Secrets and variables** → **Actions**
2. 上記の3つのSecretsが存在するか確認

**解決方法**:
1. Supabase DashboardでAccess Tokenを取得
2. 各環境のProject IDを取得
3. GitHub Secretsに追加

---

### 3. ワークフローが実行されたが、検証ステップで失敗している

**確認方法**:
1. GitHubリポジトリ → **Actions** タブ
2. **Apply Migrations** ワークフローを選択
3. 最新の実行履歴を確認
4. 失敗しているステップを確認

**よくある失敗原因**:
- ❌ `validate-migrations` ジョブが失敗（`check_migration_safety.py`のエラー）
- ❌ `apply-to-staging` ジョブが失敗（Secretsが間違っている、接続エラー）
- ❌ Pythonスクリプトが実行できない（Python環境の問題）

**解決方法**:
- ワークフローのログを確認して、具体的なエラーメッセージを確認
- エラーに応じて修正

---

### 4. 本番環境への適用が手動承認待ちになっている

**確認方法**:
1. GitHubリポジトリ → **Actions** タブ
2. **Apply Migrations** ワークフローを選択
3. 最新の実行で **Review deployments** が表示されているか確認

**解決方法**:
1. **Review deployments** をクリック
2. **production** 環境を選択
3. **Approve and deploy** をクリック

---

### 5. バリデーションスクリプトが失敗している

**確認方法**:
1. GitHub Actionsのログで `validate-migrations` ジョブを確認
2. `check_migration_safety.py` の実行結果を確認

**解決方法**:
```powershell
# ローカルでバリデーションスクリプトを実行
python scripts/check_migration_safety.py
```

---

## 🚀 即座に解決する方法

### 方法1: ワークフローを手動実行（推奨）

1. GitHubリポジトリ → **Actions** タブ
2. 左メニューから **Apply Migrations** を選択
3. **Run workflow** ボタンをクリック
4. ブランチを選択（`main`）
5. **Run workflow** をクリック

**メリット**:
- 自動実行の条件を満たしていなくても実行できる
- すぐに実行できる

---

### 方法2: Supabase CLIで直接適用（最も確実）

```powershell
# 環境変数を設定
$env:SUPABASE_ACCESS_TOKEN = "your-access-token"
$env:SUPABASE_PROJECT_ID = "your-production-project-id"

# プロジェクトにリンク
npx supabase link --project-ref $env:SUPABASE_PROJECT_ID

# マイグレーションを適用
npx supabase db push
```

**メリット**:
- GitHub Actionsの設定に依存しない
- 即座に適用できる
- エラーメッセージが明確

---

## 📋 チェックリスト

自動適用が機能しない場合、以下を確認してください：

- [ ] マイグレーションファイルが`main`ブランチに存在する
- [ ] `SUPABASE_ACCESS_TOKEN` がGitHub Secretsに設定されている
- [ ] `SUPABASE_PROJECT_ID_STAGING` がGitHub Secretsに設定されている
- [ ] `SUPABASE_PROJECT_ID_PRODUCTION` がGitHub Secretsに設定されている
- [ ] GitHub Actionsのワークフローが実行されている（Actionsタブで確認）
- [ ] ワークフローが成功している（失敗している場合はログを確認）
- [ ] 本番環境への適用が承認待ちになっていない（Review deploymentsを確認）

---

## 🔧 トラブルシューティング

### エラー: "Secret not found"

**原因**: GitHub Secretsが設定されていない

**解決方法**:
1. GitHubリポジトリ → **Settings** → **Secrets and variables** → **Actions**
2. 必要なSecretsを追加

### エラー: "Project not found"

**原因**: Project IDが間違っている

**解決方法**:
1. Supabase DashboardでProject IDを再確認
2. GitHub Secretsの値を更新

### エラー: "Permission denied"

**原因**: Access Tokenの権限が不足している

**解決方法**:
1. Supabase Dashboardで新しいAccess Tokenを生成
2. **Full access** を選択
3. GitHub Secretsの値を更新

---

## 📝 推奨される対応

**今すぐ解決したい場合**:
1. ✅ **Supabase CLIで直接適用**（方法2）- 最も確実で速い

**今後も自動適用を機能させたい場合**:
1. ✅ GitHub Secretsを設定
2. ✅ ワークフローを手動実行して動作確認
3. ✅ 問題があれば修正

---

## 🔗 関連ファイル

- `.github/workflows/apply-migrations.yml`
- `scripts/check_migration_safety.py`
- `本番環境マイグレーション即時適用手順.md`
- `本番環境マイグレーション適用ガイド.md`

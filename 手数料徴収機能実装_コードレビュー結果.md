# æ‰‹æ•°æ–™å¾´åæ©Ÿèƒ½å®Ÿè£… - ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ

**ãƒ¬ãƒ“ãƒ¥ãƒ¼æ—¥**: 2025 å¹´ 1 æœˆ  
**ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼**: AI Assistant

---

## ğŸ› ç™ºè¦‹ã•ã‚ŒãŸå•é¡Œ

### âŒ é‡å¤§: æœªå®šç¾©å¤‰æ•°ã®ä½¿ç”¨

**å•é¡Œç®‡æ‰€**: `app/api/checkout/session/route.ts` 377 è¡Œç›®

```typescript
product_data: {
  name: statementDescriptor,  // âŒ æœªå®šç¾©å¤‰æ•°
},
```

**å•é¡Œ**: `statementDescriptor`ã¨ã„ã†å¤‰æ•°ãŒå®šç¾©ã•ã‚Œã¦ã„ãªã„ã€‚`statementDescriptorSuffix`ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ãŒã€ã“ã‚Œã¯`statement_descriptor_suffix`ç”¨ã§ã€`product_data.name`ã«ã¯åˆ¥ã®å€¤ãŒå¿…è¦ã€‚

**ä¿®æ­£æ¡ˆ**:

- `statementDescriptorSuffix`ã‚’`product_data.name`ã«ã‚‚ä½¿ç”¨ã™ã‚‹ã‹
- ã¾ãŸã¯ã€åˆ¥é€”`productName`å¤‰æ•°ã‚’å®šç¾©ã™ã‚‹

---

### âŒ é‡å¤§: å¤‰æ•°ã®ã‚¹ã‚³ãƒ¼ãƒ—ã‚¨ãƒ©ãƒ¼

**å•é¡Œç®‡æ‰€**: `app/api/checkout/session/route.ts` 206 è¡Œç›®

```typescript
// é‡‘é¡ãŒå¤‰ã‚ã£ã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèªï¼ˆmetadataã«é‡‘é¡ãƒãƒƒã‚·ãƒ¥ã‚’ä¿å­˜ï¼‰
const expectedAmountHash = Buffer.from(`${orderAmount}`)
  .toString("base64")
  .slice(0, 16);
```

**å•é¡Œ**: `orderAmount`ã¯ 274 è¡Œç›®ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ãŒã€198-232 è¡Œç›®ã® Idempotency å¯¾ç­–ã®ã‚³ãƒ¼ãƒ‰ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã€‚å¤‰æ•°ã®ã‚¹ã‚³ãƒ¼ãƒ—ãŒé€†è»¢ã—ã¦ã„ã‚‹ã€‚

**ä¿®æ­£æ¡ˆ**: `orderAmount`ã®å®šç¾©ã‚’ Idempotency å¯¾ç­–ã®å‰ã«ç§»å‹•ã™ã‚‹

---

### âš ï¸ ä¸­: é‡‘é¡ãƒãƒƒã‚·ãƒ¥ã®è¨ˆç®—æ–¹æ³•

**å•é¡Œç®‡æ‰€**: `app/api/checkout/session/route.ts` 206 è¡Œç›®ã€403 è¡Œç›®

```typescript
const expectedAmountHash = Buffer.from(`${orderAmount}`)
  .toString("base64")
  .slice(0, 16);
```

**å•é¡Œ**: å˜ç´”ãª base64 ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã§ã¯è¡çªã®å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚ã‚ˆã‚Šå®‰å…¨ãªãƒãƒƒã‚·ãƒ¥é–¢æ•°ï¼ˆSHA-256 ç­‰ï¼‰ã‚’ä½¿ç”¨ã™ã¹ãã€‚

**ä¿®æ­£æ¡ˆ**:

```typescript
import crypto from "crypto";
const expectedAmountHash = crypto
  .createHash("sha256")
  .update(`${order.id}:${orderAmount}`)
  .digest("base64")
  .slice(0, 16);
```

---

### âš ï¸ ä¸­: ãƒ­ã‚°å‡ºåŠ›ã®ä¸æ•´åˆ

**å•é¡Œç®‡æ‰€**: `app/api/checkout/session/route.ts` 350-357 è¡Œç›®

```typescript
console.log("[Checkout] Fee calculation", {
  orderId: order.id,
  sellerId: order.sellerId,
  planType,
  feeRate,
  orderAmount: order.amount, // order.amountã‚’ä½¿ç”¨
  calculatedFee: fee,
});
```

**å•é¡Œ**: `orderAmount`å¤‰æ•°ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã®ã«ã€ãƒ­ã‚°ã§ã¯`order.amount`ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã€‚ä¸€è²«æ€§ãŒãªã„ã€‚

**ä¿®æ­£æ¡ˆ**: `orderAmount`ã‚’ä½¿ç”¨ã™ã‚‹

---

## âœ… è‰¯ã„ç‚¹

1. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ãƒ­ã‚°å‡ºåŠ›
2. **ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**: é‡‘é¡ã€ãƒ—ãƒ©ãƒ³ã‚¿ã‚¤ãƒ—ã€Stripe ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®çŠ¶æ…‹ã‚’é©åˆ‡ã«ãƒã‚§ãƒƒã‚¯
3. **Idempotency å¯¾ç­–**: ã‚»ãƒƒã‚·ãƒ§ãƒ³å†åˆ©ç”¨ã®ãƒ­ã‚¸ãƒƒã‚¯ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
4. **æ‰‹æ•°æ–™è¨ˆç®—**: `Math.floor`ã¨æœ€ä½æ‰‹æ•°æ–™ã®è¨­å®šãŒé©åˆ‡
5. **é‹ç”¨æ•‘æ¸ˆ**: ç·Šæ€¥å›ºå®šãƒ¬ãƒ¼ãƒˆã®å®Ÿè£…ãŒè‰¯ã„

---

## ğŸ“ æ¨å¥¨æ”¹å–„äº‹é …

### 1. å¤‰æ•°ã®å®šç¾©é †åºã‚’ä¿®æ­£

```typescript
// orderAmountã‚’å…ˆã«å®šç¾©
const orderAmount = Number(order.amount);
if (!Number.isInteger(orderAmount) || orderAmount <= 0) {
  // ã‚¨ãƒ©ãƒ¼å‡¦ç†
}

// ãã®å¾Œã€Idempotencyå¯¾ç­–ã§ä½¿ç”¨
if (order.stripeSid) {
  const expectedAmountHash = Buffer.from(`${orderAmount}`)
    .toString("base64")
    .slice(0, 16);
  // ...
}
```

### 2. product_data.name ã®ä¿®æ­£

```typescript
// statementDescriptorSuffixã‚’product_data.nameã«ã‚‚ä½¿ç”¨
// ã¾ãŸã¯ã€åˆ¥é€”productNameã‚’å®šç¾©
const productName = seller?.shopName || seller?.displayName || order.summary || 'å•†å“';

line_items: [
  {
    price_data: {
      currency: 'jpy',
      product_data: {
        name: productName,  // ä¿®æ­£
      },
      unit_amount: orderAmount,
    },
    quantity: 1,
  },
],
```

### 3. é‡‘é¡ãƒãƒƒã‚·ãƒ¥ã®æ”¹å–„ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

ã‚ˆã‚Šå®‰å…¨ãªãƒãƒƒã‚·ãƒ¥é–¢æ•°ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ãŒã€ç¾çŠ¶ã®å®Ÿè£…ã§ã‚‚å‹•ä½œã¯ã—ã¾ã™ã€‚

---

## ğŸ¯ ä¿®æ­£å„ªå…ˆåº¦

1. **é«˜**: æœªå®šç¾©å¤‰æ•°`statementDescriptor`ã®ä¿®æ­£
2. **é«˜**: `orderAmount`ã®ã‚¹ã‚³ãƒ¼ãƒ—ã‚¨ãƒ©ãƒ¼ä¿®æ­£
3. **ä¸­**: ãƒ­ã‚°å‡ºåŠ›ã®ä¸€è²«æ€§æ”¹å–„
4. **ä½**: é‡‘é¡ãƒãƒƒã‚·ãƒ¥ã®æ”¹å–„ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

---

**ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†**: 2025 å¹´ 1 æœˆ

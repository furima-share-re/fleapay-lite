# 手数料修正 動作確認ガイド

**作成日**: 2025年1月  
**対象**: 手数料徴収機能の動作確認

---

## 📋 確認項目

### 1. 手数料率マスタの確認

#### 1.1 データベースでの確認

**SQLクエリ**:
```sql
-- 現在有効な手数料率を確認
SELECT 
  plan_type,
  fee_rate,
  fee_rate * 100 AS fee_rate_percent,
  effective_from,
  effective_to
FROM fee_rate_master
WHERE effective_from <= now()
  AND (effective_to IS NULL OR effective_to >= now())
ORDER BY plan_type, effective_from DESC;
```

**期待される結果**:
- 各プラン（standard, pro, kids）に対して有効な手数料率が1件ずつ存在
- `effective_to`が`NULL`（現在有効）

#### 1.2 手数料率マスタの初期データ投入（未設定の場合）

```sql
-- Standardプラン: 7%
INSERT INTO fee_rate_master (plan_type, fee_rate, effective_from)
VALUES ('standard', 0.0700, now());

-- Proプラン: 7%
INSERT INTO fee_rate_master (plan_type, fee_rate, effective_from)
VALUES ('pro', 0.0700, now());

-- Kidsプラン: 7%
INSERT INTO fee_rate_master (plan_type, fee_rate, effective_from)
VALUES ('kids', 0.0700, now());
```

---

### 2. チェックアウト時の手数料計算確認

#### 2.1 API経由での確認

**エンドポイント**: `POST /api/checkout/session`

**リクエスト例**:
```json
{
  "sellerId": "test-seller-pro",
  "amount": 1000,
  "summary": "テスト商品"
}
```

**確認ポイント**:
1. レスポンスのログで手数料計算が正しいか確認
2. Stripe Checkout Sessionの`application_fee_amount`が設定されているか

**サーバーログで確認**:
```
[Checkout] Fee calculation {
  orderId: 'xxx',
  sellerId: 'test-seller-pro',
  planType: 'pro',
  feeRate: 0.07,
  orderAmount: 1000,
  calculatedFee: 70,
  finalFee: 70
}
```

**計算式**:
- `fee = Math.floor(orderAmount * feeRate)`
- 例: 1000円 × 7% = 70円

#### 2.2 手数料率の取得ロジック確認

**環境変数による制御**:
- `ENABLE_STRATEGY_F_TIER_SYSTEM=false`: 従来のplan_typeベース
- `ENABLE_STRATEGY_F_TIER_SYSTEM=true`（デフォルト）: Tier制対応

**確認方法**:
1. 環境変数を設定/変更
2. チェックアウトAPIを呼び出し
3. ログで使用されている手数料率を確認

---

### 3. ダッシュボードでの手数料表示確認

#### 3.1 出店者ダッシュボード

**URL**: `/seller-dashboard.html?s=test-seller-pro`

**確認ポイント**:
- [ ] **Tier（ランク）情報が表示される**
  - 現在のTier番号とランク名（例: Tier 1 ビギナー）
  - 現在の手数料率（例: 4.5%）
  - 今月のQR決済回数
  - 次のランクへの条件（例: あと3回でTier 2になり、手数料が4.2%になります）
- [ ] 手数料が正しく表示される（今日の手数料合計）
- [ ] 取引履歴に手数料が含まれている
- [ ] 純売上 = 総売上 - 手数料 が正しく計算されている

**API確認**:
```
GET /api/seller/summary?s=test-seller-pro
GET /api/seller/tier-status?s=test-seller-pro
```

**Tier情報APIレスポンス例**:
```json
{
  "success": true,
  "data": {
    "tier": {
      "number": 1,
      "name": "ビギナー",
      "currentFeeRate": 0.045,
      "currentFeeRatePercent": "4.50",
      "nextFeeRate": "4.20",
      "feeRateMessage": "あと3回のQR決済でTier 2（レギュラー）になり、手数料が4.2%になります！"
    },
    "transactionCount": {
      "current": 1,
      "range": {
        "min": 0,
        "max": 3
      }
    },
    "communityGoal": {
      "phase": "phase1",
      "targetAmount": 1000000,
      "currentAmount": 500000,
      "achievementRate": 50.0,
      "isAchieved": false,
      "message": "現在の達成率: 50.0%"
    }
  }
}
```

**レスポンス例**:
```json
{
  "salesToday": {
    "net": 930,
    "gross": 1000,
    "fee": 70
  },
  "recent": [
    {
      "amount": 1000,
      "net_amount": 930,
      "fee": 70
    }
  ]
}
```

#### 3.2 管理者ダッシュボード

**URL**: `/admin/dashboard`

**確認ポイント**:
- [ ] 今日の手数料合計が表示される
- [ ] 累計手数料が表示される

**API確認**:
```
GET /api/admin/dashboard
Headers: { "x-admin-token": "admin-devtoken" }
```

#### 3.3 手数料率設定画面（専用ページ）

**URL**: `/admin/fee-rates`

**確認ポイント**:
- [ ] **手数料率マスタが表示される**
  - プラン別の手数料率（standard, pro, kids）
  - Tier別の手数料率（Tier 1-5）
  - 有効期間（effective_from, effective_to）
- [ ] **Tier定義が表示される**
  - 各Tierの名前、QR決済回数範囲、手数料率
- [ ] サイドバーから「💰 手数料率設定」にアクセスできる

**API確認**:
```
GET /api/admin/fee-rates
Headers: { "x-admin-token": "admin-devtoken" }
```

**手数料率マスタAPIレスポンス例**:
```json
{
  "success": true,
  "data": {
    "feeRates": [
      {
        "id": "xxx",
        "planType": "pro",
        "feeRate": 0.045,
        "feeRatePercent": "4.50",
        "tier": 1,
        "effectiveFrom": "2025-01-01T00:00:00Z",
        "effectiveTo": null
      }
    ],
    "tierDefinitions": {
      "1": { "name": "ビギナー", "min": 0, "max": 3, "defaultRate": 0.0450 },
      "2": { "name": "レギュラー", "min": 4, "max": 10, "defaultRate": 0.0420 }
    }
  }
}
```

---

### 4. 実際の決済での手数料徴収確認

#### 4.1 テスト決済の実行

**手順**:
1. 出店者購入画面で注文を作成
   - URL: `/seller-purchase-standard?s=test-seller-pro`
   - 金額: 1000円
2. チェックアウト画面で決済を実行
   - URL: `/checkout?s=test-seller-pro&order={orderId}`
3. Stripeテストカードで決済完了
   - カード番号: `4242 4242 4242 4242`
   - 有効期限: 任意の未来日付
   - CVC: 任意の3桁

#### 4.2 Stripeダッシュボードでの確認

**確認項目**:
1. **Payment Intent**:
   - `application_fee_amount`: 手数料額（例: 70円）
   - `transfer_data.destination`: 出店者のStripeアカウントID
   - `amount`: 注文金額（例: 1000円）

2. **Balance Transaction**:
   - Application Fee: 手数料額が正しく記録されているか
   - Transfer: 出店者への送金額 = 注文金額 - 手数料

**計算確認**:
- 顧客から請求: 1000円
- edoichibaの手数料: 70円（7%）
- 出店者への送金: 930円

#### 4.3 データベースでの確認

**確認クエリ**:
```sql
-- 最新の決済情報を確認
SELECT 
  o.id AS order_id,
  o.amount AS order_amount,
  sp.amount_gross,
  sp.amount_net,
  sp.amount_fee,
  sp.status
FROM orders o
LEFT JOIN stripe_payments sp ON o.id = sp.order_id
WHERE o.seller_id = 'test-seller-pro'
ORDER BY o.created_at DESC
LIMIT 5;
```

**期待される結果**:
- `amount_gross`: 1000円（顧客から請求された金額）
- `amount_net`: 930円（出店者への送金額）
- `amount_fee`: 70円（手数料）

---

### 5. エラーケースの確認

#### 5.1 手数料率マスタ未設定時の動作

**確認方法**:
1. 手数料率マスタから該当プランのレコードを削除
2. チェックアウトAPIを呼び出し
3. エラーレスポンスを確認

**期待される動作**:
- 開発環境: デフォルト値（7%）を使用
- 本番環境: エラーレスポンスを返す

#### 5.2 手数料計算エラーの確認

**異常値でのテスト**:
- 注文金額: 0円 → 手数料: 0円
- 注文金額: 負の値 → エラー
- 手数料率: 100%超 → エラー

---

### 6. プラン別の手数料率確認

#### 6.1 各プランでの手数料率確認

**テスト用sellerId**:
- Standardプラン: `test-seller-standard`
- Proプラン: `test-seller-pro`
- Kidsプラン: `test-seller-kids`

**確認手順**:
1. 各プランで1000円の注文を作成
2. チェックアウトAPIを呼び出し
3. ログで手数料率と手数料額を確認

**期待される結果**:
- 各プランで設定された手数料率が適用される
- 手数料額 = 1000円 × 手数料率

---

### 7. Tier制（戦略F）の確認

#### 7.1 Tier制の有効化確認

**環境変数**:
```bash
ENABLE_STRATEGY_F_TIER_SYSTEM=true
```

**確認方法**:
1. 月間QR決済回数を確認
2. Tierを判定
3. Tierに応じた手数料率を取得

**Tier定義**:
- Tier 1: 0-10回 → 手数料率: 設定値
- Tier 2: 11-50回 → 手数料率: 設定値
- Tier 3: 51-200回 → 手数料率: 設定値
- Tier 4: 201-1000回 → 手数料率: 設定値
- Tier 5: 1001回以上 → 手数料率: コミュニティ目標達成状況に応じて変動

---

## 🔧 動作確認手順（簡易版）

### ステップ1: 手数料率マスタの確認

```sql
-- Supabase SQL Editorで実行
SELECT * FROM fee_rate_master 
WHERE effective_to IS NULL;
```

### ステップ2: チェックアウトAPIのテスト

```bash
# PowerShell
$body = @{
  sellerId = "test-seller-pro"
  amount = 1000
  summary = "テスト商品"
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:3000/api/checkout/session" `
  -Method POST `
  -Body $body `
  -ContentType "application/json"
```

### ステップ3: ダッシュボードでの確認

1. **出店者ダッシュボード**: `http://localhost:3000/seller-dashboard.html?s=test-seller-pro`
   - **Tier（ランク）情報の確認**:
     - 「現在のランク」カードが表示されているか確認
     - Tier番号、ランク名、手数料率が表示されているか確認
     - 今月のQR決済回数が表示されているか確認
     - 次のランクへの条件（あと○回でランクアップ）が表示されているか確認
   - **手数料の確認**:
     - 手数料が正しく表示されているか確認
     - 取引履歴に手数料が含まれているか確認

2. **管理者ダッシュボード**: `http://localhost:3000/admin/dashboard`
   - 今日の手数料合計が表示されているか確認
   - サイドバーから「💰 手数料率設定」にアクセスできるか確認

3. **手数料率設定画面**: `http://localhost:3000/admin/fee-rates`
   - 手数料率マスタが表示されているか確認
   - Tier定義が表示されているか確認

### ステップ4: 実際の決済テスト

1. 出店者購入画面で注文作成
2. チェックアウト画面で決済
3. Stripeテストカードで決済完了
4. Stripeダッシュボードで手数料を確認

---

## ⚠️ 注意事項

1. **Stripe Connect必須**: 出店者はStripe Connectの接続アカウントが必要
2. **テスト環境**: 本番環境では必ずテスト決済で確認してから本番決済を実行
3. **手数料率変更**: 手数料率を変更する場合は、運用手順書に従って実施
4. **ログ確認**: サーバーログで手数料計算の詳細を確認可能

---

## 🔗 関連ドキュメント

- `手数料率マスタ_運用手順書.md` - 手数料率の変更手順
- `手数料徴収機能実装_レビュー資料.md` - 実装詳細
- `出店者画面_動作確認ガイド.md` - 出店者側画面の動作確認

---

**最終更新**: 2025年1月

# æ‰‹æ•°æ–™å¾´åæ©Ÿèƒ½å®Ÿè£… - ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾å¿œå®Œäº†å ±å‘Š

**ä½œæˆæ—¥**: 2025 å¹´ 1 æœˆ  
**å¯¾å¿œè€…**: AI Assistant  
**ãƒ¬ãƒ“ãƒ¥ãƒ¼æŒ‡æ‘˜äº‹é …ã¸ã®å¯¾å¿œçŠ¶æ³**

---

## ğŸ“‹ å¯¾å¿œå®Œäº†é …ç›®

### âœ… é‡å¤§ï¼ˆä»•æ§˜ãƒ»æˆç«‹æ¡ä»¶ï¼‰

#### 1. Stripe Connect æ¥ç¶šã‚¢ã‚«ã‚¦ãƒ³ãƒˆå¿…é ˆã®å‰æã‚’æ˜è¨˜

**å¯¾å¿œå†…å®¹**:

- `app/api/checkout/session/route.ts`ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã€ŒStripe Connect ã¸ã®ç™»éŒ²ãŒå¿…è¦ã€ã‚’æ˜è¨˜
- ãƒ¬ãƒ“ãƒ¥ãƒ¼è³‡æ–™ã«å‰ææ¡ä»¶ã‚’è¿½åŠ 

**å®Ÿè£…ç®‡æ‰€**:

```typescript
// é‡è¦: transfer_data.destination ã¨ application_fee_amount ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€
// å‡ºåº—è€…ã¯ Stripe Connect ã® connected account (Express/Custom/Standard) ã‚’æŒã¤å¿…è¦ãŒã‚ã‚‹
```

#### 2. åº—èˆ—å/å±‹å·ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†

**å¯¾å¿œå†…å®¹**:

- å‡ºåº—è€…æƒ…å ±ã‚’å–å¾—ï¼ˆ`shopName`, `displayName`ï¼‰
- å„ªå…ˆé †ä½: `shopName` > `displayName` > `order.summary` > 'å•†å“'
- `statement_descriptor_suffix`ã«è¨­å®šï¼ˆæœ€å¤§ 22 æ–‡å­—ã€æ—¥æœ¬èªã¯ç´„ 11 æ–‡å­—ï¼‰

**å®Ÿè£…ç®‡æ‰€**:

```typescript
const statementDescriptor =
  seller?.shopName || seller?.displayName || order.summary || "å•†å“";
const statementDescriptorSuffix =
  statementDescriptor.length > 11
    ? statementDescriptor.substring(0, 11)
    : statementDescriptor;
```

---

### âœ… é‡å¤§ï¼ˆèª²é‡‘è¨ˆç®—ãƒ»Stripe è¦ä»¶ï¼‰

#### 3. application_fee_amount ã¯æœ€å°é€šè²¨å˜ä½ã®æ•´æ•°

**å¯¾å¿œå†…å®¹**:

- `order.amount`ãŒæ•´æ•°ã§ã‚ã‚‹ã“ã¨ã‚’ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- ã‚³ãƒ¡ãƒ³ãƒˆã§ã€Œæœ€å°é€šè²¨å˜ä½ï¼ˆJPY ãªã‚‰å††ï¼‰ã®æ•´æ•°ã€ã‚’æ˜è¨˜
- æ‰‹æ•°æ–™è¨ˆç®—æ™‚ã«æ•´æ•°ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ 

**å®Ÿè£…ç®‡æ‰€**:

```typescript
// é‡‘é¡ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: order.amountã¯æœ€å°é€šè²¨å˜ä½ï¼ˆJPYãªã‚‰å††ï¼‰ã®æ•´æ•°ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚‹
const orderAmount = Number(order.amount);
if (!Number.isInteger(orderAmount) || orderAmount <= 0) {
  // ã‚¨ãƒ©ãƒ¼å‡¦ç†
}

// application_fee_amount: feeï¼ˆæ•´æ•°ï¼‰
```

#### 4. æ‰‹æ•°æ–™ç®—å®šãƒ™ãƒ¼ã‚¹ã®æ˜ç¢ºåŒ–

**å¯¾å¿œå†…å®¹**:

- ã‚³ãƒ¡ãƒ³ãƒˆã§ã€Œæœ€çµ‚è«‹æ±‚é¡ï¼ˆorder.amountï¼‰ã«å¯¾ã—ã¦èª²é‡‘ã€ã‚’æ˜è¨˜
- å°†æ¥ã®ç¨ãƒ»é€æ–™ãƒ»å‰²å¼•å¯¾å¿œã«ã¤ã„ã¦ã‚‚è¨€åŠ

**å®Ÿè£…ç®‡æ‰€**:

```typescript
// ã€é‡è¦ã€‘æ‰‹æ•°æ–™ç®—å®šãƒ™ãƒ¼ã‚¹: æœ€çµ‚è«‹æ±‚é¡ï¼ˆorder.amountï¼‰ã«å¯¾ã—ã¦èª²é‡‘
// - ç¾åœ¨ã®å®Ÿè£…ã§ã¯ã€order.amountãŒæœ€çµ‚è«‹æ±‚é¡ã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹
// - å°†æ¥ã€ç¨ãƒ»é€æ–™ãƒ»å‰²å¼•ãŒè¿½åŠ ã•ã‚Œã‚‹å ´åˆã¯ã€Stripe Checkout Sessionã®æœ€çµ‚é‡‘é¡ï¼ˆamount_totalï¼‰ã‚’åŸºæº–ã«ã™ã‚‹
```

---

### âœ… DB/ãƒã‚¹ã‚¿è¨­è¨ˆï¼ˆä¸­ã€œé‡å¤§ï¼‰

#### 5. fee_rate_master ã®åˆ¶ç´„ãƒ»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å¼·åŒ–

**å¯¾å¿œå†…å®¹**:

- `id`ã«`DEFAULT gen_random_uuid()`ã‚’è¿½åŠ 
- æœ‰åŠ¹ãƒ‡ãƒ¼ã‚¿æ¤œç´¢ç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ 
- åŒä¸€ plan ã§æœ‰åŠ¹æœŸé–“ãŒé‡è¤‡ã—ãªã„åˆ¶ç´„ï¼ˆéƒ¨åˆ†ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‰ã‚’è¿½åŠ 
- ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ»ã‚«ãƒ©ãƒ ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 

**å®Ÿè£…ç®‡æ‰€**:

```sql
-- éƒ¨åˆ†ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆæœ‰åŠ¹ãªãƒ¬ã‚³ãƒ¼ãƒ‰ã¯1ä»¶ã®ã¿ï¼‰
CREATE UNIQUE INDEX IF NOT EXISTS idx_fee_rate_master_active_unique
  ON fee_rate_master(plan_type)
  WHERE effective_to IS NULL OR effective_to >= now();
```

#### 6. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ 7%ã®å±é™ºæ€§å¯¾å¿œ

**å¯¾å¿œå†…å®¹**:

- æœ¬ç•ªç’°å¢ƒã§ã¯ã€ãƒã‚¹ã‚¿ã«ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ã‚‹
- é–‹ç™ºç’°å¢ƒã§ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆ7%ï¼‰ã‚’è¿”ã™ï¼ˆ`allowDefault`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼‰
- ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã«ã€ŒCRITICALã€ã‚’æ˜è¨˜

**å®Ÿè£…ç®‡æ‰€**:

```typescript
export async function getFeeRateFromMaster(
  prisma: PrismaClient,
  planType: string,
  allowDefault: boolean = process.env.NODE_ENV !== "production"
): Promise<number> {
  // æœ¬ç•ªç’°å¢ƒ: ã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ã‚‹ï¼ˆå£²ä¸Šæ¯€æé˜²æ­¢ï¼‰
  if (!allowDefault) {
    throw new Error(`Fee rate not found for planType: ${planType}...`);
  }
}
```

---

### âœ… å®Ÿè£…å“è³ªï¼ˆä¸­ï¼‰

#### 7. seller_subscription å–å¾—ã®ä»•æ§˜æ˜ç¢ºåŒ–

**å¯¾å¿œå†…å®¹**:

- `orderBy: { startedAt: 'desc' }`ã§æœ€æ–°ã®ã‚‚ã®ã‚’å–å¾—ã™ã‚‹ã“ã¨ã‚’æ˜è¨˜
- ãƒ—ãƒ©ãƒ³ãŒãªã„å ´åˆã¯æ¨™æº–ãƒ—ãƒ©ãƒ³ã¨ã—ã¦æ‰±ã†
- ãƒ—ãƒ©ãƒ³ã‚¿ã‚¤ãƒ—ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 

**å®Ÿè£…ç®‡æ‰€**:

```typescript
const subscription = await prisma.sellerSubscription.findFirst({
  where: {
    sellerId: order.sellerId,
    status: "active",
    OR: [{ endedAt: null }, { endedAt: { gt: new Date() } }],
  },
  orderBy: { startedAt: "desc" }, // æœ€æ–°ã®ã‚‚ã®ã‚’å–å¾—
});
```

#### 8. Idempotency å¯¾ç­–

**å¯¾å¿œå†…å®¹**:

- æ—¢å­˜ã® Checkout Session ã‚’å†åˆ©ç”¨ã™ã‚‹å‡¦ç†ã‚’è¿½åŠ 
- Stripe API å‘¼ã³å‡ºã—æ™‚ã«`idempotencyKey`ã‚’æŒ‡å®š

**å®Ÿè£…ç®‡æ‰€**:

```typescript
// æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å†åˆ©ç”¨
if (order.stripeSid) {
  const existingSession = await stripe.checkout.sessions.retrieve(
    order.stripeSid
  );
  if (
    existingSession.status === "open" &&
    existingSession.payment_status === "unpaid"
  ) {
    return NextResponse.json({
      url: existingSession.url,
      sessionId: existingSession.id,
      reused: true,
    });
  }
}

// Stripe APIå‘¼ã³å‡ºã—æ™‚ã«idempotencyKeyã‚’æŒ‡å®š
const session = await stripe.checkout.sessions.create(sessionParams, {
  idempotencyKey: `checkout_session_${order.id}`,
});
```

#### 9. ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ç½®ãå ´

**å¯¾å¿œå†…å®¹**:

- `payment_intent_data.metadata`ã«è¿½åŠ ï¼ˆæ—¢å­˜ï¼‰
- `session.metadata`ã«ã‚‚è¿½åŠ ï¼ˆæ¤œç´¢ãŒæ¥½ã«ãªã‚‹ï¼‰

**å®Ÿè£…ç®‡æ‰€**:

```typescript
payment_intent_data: {
  metadata: {
    sellerId: order.sellerId,
    orderId: order.id,
    planType,
    feeRate: feeRate.toString(),
  },
},
// session.metadataã«ã‚‚è¿½åŠ ï¼ˆæ¤œç´¢ãŒæ¥½ã«ãªã‚‹ï¼‰
metadata: {
  sellerId: order.sellerId,
  orderId: order.id,
  planType,
},
```

---

## ğŸ“ è¿½åŠ å®Ÿè£…é …ç›®

### æ‰‹æ•°æ–™è¨ˆç®—ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¼·åŒ–

- æ‰‹æ•°æ–™ãŒ 0 ä»¥ä¸‹ã¾ãŸã¯æ³¨æ–‡é‡‘é¡ä»¥ä¸Šã«ãªã‚‰ãªã„ã“ã¨ã‚’ç¢ºèª
- ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã«è©³ç´°æƒ…å ±ã‚’è¨˜éŒ²

### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ”¹å–„

- æ‰‹æ•°æ–™ç‡å–å¾—å¤±æ•—æ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿½åŠ 
- ãƒ—ãƒ©ãƒ³ã‚¿ã‚¤ãƒ—ä¸æ­£æ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿½åŠ 

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆé …ç›®ï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼æŒ‡æ‘˜ï¼‰

ä»¥ä¸‹ã®ãƒ†ã‚¹ãƒˆé …ç›®ãŒè¿½åŠ ã§å¿…è¦ã§ã™ï¼š

1. **fee_rate_master ã®æœ‰åŠ¹æœŸé–“ãŒé‡è¤‡ã—ã¦ã„ã‚‹å ´åˆã®æŒ™å‹•**

   - éƒ¨åˆ†ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«ã‚ˆã‚Šã€æœ‰åŠ¹ãªãƒ¬ã‚³ãƒ¼ãƒ‰ã¯ 1 ä»¶ã®ã¿ã«ãªã‚‹ã“ã¨ã‚’ç¢ºèª

2. **planType ãŒä¸æ­£å€¤/NULL/æœªçŸ¥å€¤ã®å ´åˆã®æŒ™å‹•**

   - ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã§ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ã“ã¨ã‚’ç¢ºèª

3. **order.amount ãŒæœ€å°é€šè²¨å˜ä½ã§ã‚ã‚‹ã“ã¨ã®ä¿è¨¼ãƒ†ã‚¹ãƒˆ**

   - æ•´æ•°ãƒã‚§ãƒƒã‚¯ã§ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ã“ã¨ã‚’ç¢ºèª

4. **Checkout Session ä½œæˆã‚’ 2 å›å©ã„ãŸã¨ãäºŒé‡èª²é‡‘ã«ãªã‚‰ãªã„ï¼ˆidempotencyï¼‰**

   - æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å†åˆ©ç”¨ã€ã¾ãŸã¯ idempotencyKey ã«ã‚ˆã‚‹é‡è¤‡é˜²æ­¢ã‚’ç¢ºèª

5. **connected account æœªè¨­å®šã®å‡ºåº—è€…ãŒæ±ºæ¸ˆã—ãŸã¨ãï¼ˆUI/ã‚¨ãƒ©ãƒ¼æ–‡è¨€å«ã‚€ï¼‰**
   - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã€ŒStripe Connect ã¸ã®ç™»éŒ²ãŒå¿…è¦ã€ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

---

## ğŸ“Š å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

| ãƒ•ã‚¡ã‚¤ãƒ«                                                         | å¤‰æ›´å†…å®¹                                               |
| ---------------------------------------------------------------- | ------------------------------------------------------ |
| `supabase/migrations/20250116_120000_create_fee_rate_master.sql` | åˆ¶ç´„ãƒ»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å¼·åŒ–ã€ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ                    |
| `lib/utils.ts`                                                   | `getFeeRateFromMaster()`é–¢æ•°ã®æ”¹å–„ï¼ˆæœ¬ç•ªç’°å¢ƒã§ã‚¨ãƒ©ãƒ¼ï¼‰ |
| `app/api/checkout/session/route.ts`                              | å…¨æŒ‡æ‘˜äº‹é …ã¸ã®å¯¾å¿œ                                     |

---

## âœ… å¯¾å¿œå®Œäº†ç¢ºèª

- [x] Stripe Connect æ¥ç¶šã‚¢ã‚«ã‚¦ãƒ³ãƒˆå¿…é ˆã®å‰æã‚’æ˜è¨˜
- [x] åº—èˆ—å/å±‹å·ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
- [x] application_fee_amount ã¯æœ€å°é€šè²¨å˜ä½ã®æ•´æ•°ã§ã‚ã‚‹ã“ã¨ã‚’æ˜è¨˜
- [x] æ‰‹æ•°æ–™ç®—å®šãƒ™ãƒ¼ã‚¹ã®æ˜ç¢ºåŒ–
- [x] fee_rate_master ã®åˆ¶ç´„ãƒ»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å¼·åŒ–
- [x] ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ 7%ã®å±é™ºæ€§å¯¾å¿œï¼ˆæœ¬ç•ªã§ã¯ã‚¨ãƒ©ãƒ¼ï¼‰
- [x] seller_subscription å–å¾—ã®ä»•æ§˜æ˜ç¢ºåŒ–
- [x] Idempotency å¯¾ç­–
- [x] ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ç½®ãå ´ï¼ˆsession.metadata ã«ã‚‚è¿½åŠ ï¼‰

---

**æœ€çµ‚æ›´æ–°**: 2025 å¹´ 1 æœˆ  
**ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾å¿œå®Œäº†**: âœ…

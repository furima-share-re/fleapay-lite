# Stripe Checkout リダイレクト動作分析

## 概要

15のテストケースにおいて、Stripe Checkoutから遷移元（アプリケーション）にリダイレクトされるかどうかを分析します。

## Stripe Checkout Session のリダイレクト仕様

Stripe Checkout Sessionでは、以下の2つのURLが設定されます：

- **`success_url`**: 決済成功時にリダイレクトされるURL
- **`cancel_url`**: ユーザーがキャンセルボタンをクリックした時にリダイレクトされるURL

**重要なポイント:**
- 決済失敗（カードエラーなど）の場合、Stripe Checkoutは**自動的にエラーメッセージを表示**し、ユーザーは**Stripe Checkoutページ内に留まります**
- ユーザーはエラー後、**再試行**または**キャンセルボタンをクリック**することができます
- キャンセルボタンをクリックした場合のみ、`cancel_url`にリダイレクトされます

---

## 各テストケースのリダイレクト動作

| テストケース | リダイレクト先 | リダイレクトされるか | 備考 |
|------------|--------------|------------------|------|
| **TC-001**: 決済成功（通常カード） | `success_url` | ✅ **はい** | 決済成功時に自動リダイレクト |
| **TC-002**: 3D Secure認証成功 | `success_url` | ✅ **はい** | 認証成功後、決済成功時に自動リダイレクト |
| **TC-003**: 3D Secure認証失敗 | - | ❌ **いいえ** | Stripe Checkoutページ内に留まり、エラー表示。ユーザーがキャンセルボタンをクリックした場合のみ`cancel_url`にリダイレクト |
| **TC-004**: カード残高不足 | - | ❌ **いいえ** | Stripe Checkoutページ内に留まり、エラー表示。ユーザーがキャンセルボタンをクリックした場合のみ`cancel_url`にリダイレクト |
| **TC-005**: カード期限切れ | - | ❌ **いいえ** | Stripe Checkoutページ内に留まり、エラー表示。ユーザーがキャンセルボタンをクリックした場合のみ`cancel_url`にリダイレクト |
| **TC-006**: ユーザーキャンセル | `cancel_url` | ✅ **はい** | ユーザーがキャンセルボタンをクリックした時にリダイレクト |
| **TC-007**: Sessionタイムアウト | - | ❌ **いいえ** | ユーザーが離脱しているため、リダイレクトは発生しない |
| **TC-008**: Webhook遅延 | `success_url` | ✅ **はい** | 決済成功時に自動リダイレクト（Webhookの遅延とは無関係） |
| **TC-009**: 返金（全額） | - | ❌ **該当なし** | 既に決済完了後で、Stripe Checkoutのフロー外 |
| **TC-010**: 返金（一部） | - | ❌ **該当なし** | 既に決済完了後で、Stripe Checkoutのフロー外 |
| **TC-011**: チャージバック発生 | - | ❌ **該当なし** | 既に決済完了後で、Stripe Checkoutのフロー外 |
| **TC-012**: チャージバック勝訴 | - | ❌ **該当なし** | 既に決済完了後で、Stripe Checkoutのフロー外 |
| **TC-013**: チャージバック敗訴 | - | ❌ **該当なし** | 既に決済完了後で、Stripe Checkoutのフロー外 |
| **TC-014**: 複数決済試行 | `success_url` | ✅ **はい** | 最終的に決済成功した場合、`success_url`にリダイレクト |
| **TC-015**: 無効なカード番号 | - | ❌ **いいえ** | Stripe Checkoutページ内に留まり、バリデーションエラー表示。ユーザーがキャンセルボタンをクリックした場合のみ`cancel_url`にリダイレクト |

---

## 詳細分析

### ✅ リダイレクトされるケース（6ケース）

#### 1. TC-001: 決済成功（通常カード）
- **リダイレクト先**: `/success?order={orderId}`
- **タイミング**: 決済成功時
- **自動**: はい

#### 2. TC-002: 3D Secure認証成功
- **リダイレクト先**: `/success?order={orderId}`
- **タイミング**: 3D Secure認証成功後、決済成功時
- **自動**: はい

#### 3. TC-006: ユーザーキャンセル
- **リダイレクト先**: `/cancel?s={sellerId}&order={orderId}`
- **タイミング**: ユーザーがキャンセルボタンをクリックした時
- **自動**: いいえ（ユーザー操作）

#### 4. TC-008: Webhook遅延
- **リダイレクト先**: `/success?order={orderId}`
- **タイミング**: 決済成功時（Webhookの遅延とは無関係）
- **自動**: はい

#### 5. TC-014: 複数決済試行（最終的に成功）
- **リダイレクト先**: `/success?order={orderId}`
- **タイミング**: 最終的に決済成功した時
- **自動**: はい

---

### ❌ リダイレクトされないケース（6ケース）

#### 1. TC-003: 3D Secure認証失敗
- **動作**: Stripe Checkoutページ内に留まり、エラーメッセージを表示
- **ユーザー操作**: 
  - 再試行可能
  - キャンセルボタンをクリックした場合のみ`cancel_url`にリダイレクト

#### 2. TC-004: カード残高不足
- **動作**: Stripe Checkoutページ内に留まり、エラーメッセージを表示
- **ユーザー操作**: 
  - 再試行可能
  - キャンセルボタンをクリックした場合のみ`cancel_url`にリダイレクト

#### 3. TC-005: カード期限切れ
- **動作**: Stripe Checkoutページ内に留まり、エラーメッセージを表示
- **ユーザー操作**: 
  - 再試行可能
  - キャンセルボタンをクリックした場合のみ`cancel_url`にリダイレクト

#### 4. TC-007: Sessionタイムアウト
- **動作**: ユーザーが既に離脱しているため、リダイレクトは発生しない
- **注意**: ユーザーが再度Session URLにアクセスした場合、期限切れエラーが表示される

#### 5. TC-015: 無効なカード番号
- **動作**: Stripe Checkoutページ内に留まり、バリデーションエラーを表示
- **ユーザー操作**: 
  - 再試行可能（正しいカード番号を入力）
  - キャンセルボタンをクリックした場合のみ`cancel_url`にリダイレクト

---

### ❌ 該当なし（3ケース）

#### TC-009, TC-010, TC-011, TC-012, TC-013
- **理由**: これらのテストケースは、既に決済完了後の処理（返金、チャージバック）であり、Stripe Checkout Sessionのフロー外
- **リダイレクト**: 該当なし（Webhookイベントのみ）

---

## まとめ

### リダイレクトされるケース: **6ケース**
- TC-001: 決済成功
- TC-002: 3D Secure認証成功
- TC-006: ユーザーキャンセル
- TC-008: Webhook遅延（決済成功時）
- TC-014: 複数決済試行（最終的に成功）

### リダイレクトされないケース: **6ケース**
- TC-003: 3D Secure認証失敗（Stripe Checkoutページ内に留まる）
- TC-004: カード残高不足（Stripe Checkoutページ内に留まる）
- TC-005: カード期限切れ（Stripe Checkoutページ内に留まる）
- TC-007: Sessionタイムアウト（ユーザーが離脱）
- TC-015: 無効なカード番号（Stripe Checkoutページ内に留まる）

### 該当なし: **3ケース**
- TC-009, TC-010, TC-011, TC-012, TC-013: 返金・チャージバック（決済完了後の処理）

---

## 重要なポイント

### 1. 決済失敗時の動作

**Stripe Checkoutは、決済失敗時に自動的にリダイレクトしません。**

- エラーメッセージがStripe Checkoutページ内に表示される
- ユーザーは再試行できる
- ユーザーがキャンセルボタンをクリックした場合のみ、`cancel_url`にリダイレクトされる

### 2. ユーザーがキャンセルボタンをクリックしない場合

TC-003, TC-004, TC-005, TC-015では、ユーザーがキャンセルボタンをクリックしない限り、**Stripe Checkoutページ内に留まり続けます**。

### 3. 実装上の考慮事項

- **成功時**: `success_url`にリダイレクトされるため、`/success`ページで決済状態を確認する必要がある
- **失敗時**: ユーザーがキャンセルボタンをクリックした場合のみ`cancel_url`にリダイレクトされるため、失敗を検知するには：
  - ユーザーが`cancel_url`にリダイレクトされたことを確認する
  - または、Webhook `payment_intent.payment_failed`を処理する（現在未実装）

---

## 推奨される改善

### 1. 決済失敗時の検知

現在、決済失敗時に自動的にリダイレクトされないため、以下の方法で検知できます：

1. **Webhook `payment_intent.payment_failed`を処理する**（推奨）
   - 決済失敗を確実に検知できる
   - ログ記録や監視に有用

2. **ユーザーが`cancel_url`にリダイレクトされたことを確認する**
   - ただし、ユーザーがキャンセルボタンをクリックしない場合、検知できない

### 2. タイムアウト処理

TC-007（Sessionタイムアウト）の場合、ユーザーが離脱しているため、リダイレクトは発生しません。

- 定期的なバッチ処理で、期限切れのSessionを検知する
- または、ユーザーが再度Session URLにアクセスした場合、期限切れエラーを表示する

---

## 結論

**15のテストケースのうち、6ケースのみが遷移元にリダイレクトされます。**

- **リダイレクトされる**: 6ケース（決済成功時、ユーザーキャンセル時）
- **リダイレクトされない**: 6ケース（決済失敗時、Stripe Checkoutページ内に留まる）
- **該当なし**: 3ケース（返金・チャージバック、決済完了後の処理）

**重要なポイント**: 決済失敗時は、ユーザーがキャンセルボタンをクリックしない限り、Stripe Checkoutページ内に留まり続けます。


# なぜ失敗が続くのか：原因分析と解決策

**作成日**: 2026-01-14  
**問題**: 以前は1回でできていたマイグレーション適用が、今回10回以上失敗している

---

## 🔍 以前は1回でできていた理由

以前は成功していた可能性のある理由：

1. **GitHub Secretsが既に設定されていた**
   - 以前のマイグレーション適用時には、既にSecretsが設定されていた
   - 今回は新しい環境やリポジトリで、Secretsが未設定だった

2. **Git LFSの問題がなかった**
   - 以前はマイグレーションファイルがGit LFSで管理されていなかった
   - または、`.gitattributes`の設定が異なっていた

3. **ワークフローファイルが正しく設定されていた**
   - Python環境のセットアップが既に含まれていた
   - Git LFSの設定が正しかった

---

## ❌ 今回失敗している原因

### 問題1: GitHub Secretsが未設定

**原因**: 
- 新しい環境やリポジトリで、GitHub Secretsが設定されていない
- または、Secretsが削除された

**影響**: 
- `SUPABASE_ACCESS_TOKEN` が空
- `SUPABASE_PROJECT_ID_STAGING` が空
- `SUPABASE_PROJECT_ID_PRODUCTION` が空

**解決策**: 
- ✅ GitHub Secretsを設定（3つのSecrets）

### 問題2: Git LFSの問題

**原因**: 
- `.gitattributes`で`*.sql`がGit LFSで追跡されている
- マイグレーションファイルがGit LFSのポインタファイルになっている
- GitHub Actionsでチェックアウトした際に、実際のSQLファイルではなくポインタファイルが取得される

**影響**: 
- SQLファイルが実行できない（`version https://git-lfs.github.com/spec/v1`というエラー）

**解決策**: 
- ✅ `.gitattributes`を修正（`supabase/migrations/*.sql`をGit LFSから除外）
- ✅ ワークフローで`lfs: true`オプションを有効化

### 問題3: Python環境の問題

**原因**: 
- ワークフローファイルにPythonのセットアップが含まれていなかった

**影響**: 
- `validate-migrations`ジョブが失敗

**解決策**: 
- ✅ Pythonのセットアップステップを追加

---

## 📊 問題の連鎖

```
1. GitHub Secrets未設定
   ↓
   apply-to-staging失敗
   ↓
2. Git LFSの問題を発見
   ↓
   ワークフローファイルを修正
   ↓
3. Git LFSセットアップアクションが見つからない
   ↓
   ワークフローファイルを再修正
   ↓
4. まだGit LFSの問題が残っている
   ↓
   継続的な失敗...
```

---

## ✅ 根本的な解決策

### 方法1: すべての問題を一度に解決（推奨）

以下の3つをすべて設定・修正する：

1. **GitHub Secretsを設定**
   - `SUPABASE_ACCESS_TOKEN`
   - `SUPABASE_PROJECT_ID_STAGING`
   - `SUPABASE_PROJECT_ID_PRODUCTION`

2. **`.gitattributes`を修正**
   - `supabase/migrations/*.sql`をGit LFSから除外

3. **ワークフローファイルを修正**
   - Python環境のセットアップ
   - Git LFSのサポート（`lfs: true`）

### 方法2: より確実な方法（代替案）

GitHub Actionsに依存せず、**Supabase Dashboardから直接適用**：

1. Supabase Dashboardにログイン
2. SQL Editorを開く
3. マイグレーションファイルの内容をコピー&ペースト
4. 実行

**メリット**:
- GitHub Actionsの設定に依存しない
- 即座に適用できる
- エラーメッセージが明確

**デメリット**:
- 手動操作が必要
- 自動化されない

---

## 🔧 今後のために

### チェックリスト：マイグレーション適用前の確認

マイグレーションを適用する前に、以下を確認してください：

- [ ] GitHub Secretsが設定されている
  - `SUPABASE_ACCESS_TOKEN`
  - `SUPABASE_PROJECT_ID_STAGING`
  - `SUPABASE_PROJECT_ID_PRODUCTION`
- [ ] `.gitattributes`でマイグレーションファイルがGit LFSから除外されている
- [ ] ワークフローファイルが正しく設定されている
  - Python環境のセットアップ
  - Git LFSのサポート
- [ ] マイグレーションファイルが正しい形式である
  - ファイル名: `YYYYMMDD_HHMMSS_description.sql`
  - 実際のSQLファイル（Git LFSのポインタではない）

---

## 📝 まとめ

**なぜ以前は1回でできていたのか**:
- GitHub Secretsが既に設定されていた
- Git LFSの問題がなかった
- ワークフローファイルが正しく設定されていた

**なぜ今回は失敗しているのか**:
- GitHub Secretsが未設定
- Git LFSの問題が発生
- ワークフローファイルに不備があった

**解決策**:
1. ✅ すべての問題を一度に解決（GitHub Secrets、`.gitattributes`、ワークフローファイル）
2. ✅ または、Supabase Dashboardから直接適用（より確実）

**今後のために**:
- ✅ マイグレーション適用前のチェックリストを作成
- ✅ 問題が発生した場合のトラブルシューティングガイドを整備

---

## 🔗 関連ファイル

- `GitHub Secrets設定手順_CI_CD専用.md` - GitHub Secretsの設定方法
- `Git LFS問題の解決方法.md` - Git LFS問題の解決方法
- `.github/workflows/apply-migrations.yml` - ワークフローファイル
- `.gitattributes` - Git LFSの設定ファイル

name: Document Guard

on:
  pull_request:
    branches: ["main", "master"]
  workflow_dispatch:
    inputs:
      enforce:
        description: "true にすると強制モード（fail）"
        required: false
        default: "false"

jobs:
  doc-guard:
    runs-on: ubuntu-latest

    env:
      # PRでは基本「警告モード」。強制したいときはリポジトリ変数 or workflow_dispatch で切替。
      ENFORCE_DOC_GUARD: ${{ github.event_name == 'workflow_dispatch' && inputs.enforce || 'false' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show mode
        run: |
          echo "ENFORCE_DOC_GUARD=${ENFORCE_DOC_GUARD}"
          if [ "${ENFORCE_DOC_GUARD}" = "true" ]; then
            echo "Mode: ENFORCE (will fail on violations)"
          else
            echo "Mode: WARN (will not fail on violations)"
          fi

      # --- 1) OpenAPI validate (spec is Source of Truth) ---
      - name: Validate OpenAPI (swagger-cli)
        run: |
          if [ -f "spec/openapi.yml" ] || [ -f "spec/openapi.yaml" ]; then
            FILE="spec/openapi.yml"
            [ -f "spec/openapi.yaml" ] && FILE="spec/openapi.yaml"
            echo "Validating ${FILE}"
            npx --yes swagger-cli@4.0.4 validate "${FILE}"
          else
            echo "No spec/openapi.yml found. Skipping."
          fi

      # --- 2) Parse truth YAML (truth must be valid YAML) ---
      - name: Validate truth YAML syntax
        run: |
          python -m pip install --quiet pyyaml
          python - << 'PY'
          import os, sys, glob, yaml
          files = glob.glob("truth/**/*.yml", recursive=True) + glob.glob("truth/**/*.yaml", recursive=True)
          if not files:
            print("No truth YAML files found. (OK for early phase)")
            sys.exit(0)
          ok = True
          for f in files:
            try:
              with open(f, "r", encoding="utf-8") as fp:
                yaml.safe_load(fp)
            except Exception as e:
              ok = False
              print(f"❌ YAML parse error: {f}\n  {e}\n")
          if not ok:
            sys.exit(1)
          print(f"✅ truth YAML parsed OK: {len(files)} files")
          PY

      # --- 3) Docs numeric pollution check (WARN -> ENFORCE) ---
      - name: Check numeric/policy values are not in docs (WARN/ENFORCE)
        id: docs_check
        run: |
          # 仕様数値っぽいものだけを検出（章番号や日付はなるべく拾わない）
          # - 単位/通貨/%/回数/時間/件数など
          # - "truth/" 参照行は許可（例: `truth/infra/timeout.yml`）
          #
          # 必要に応じて単位を追加してください。
          PATTERN='\b[0-9]+(\.[0-9]+)?\s*(ms|秒|分|時間|回|%|件|人|円|ドル|USD|JPY)\b'
          echo "Pattern: ${PATTERN}"

          if [ ! -d "docs" ]; then
            echo "docs/ not found. Skipping."
            exit 0
          fi

          # docs 内の markdown を対象
          MATCHES=$(grep -RInE "${PATTERN}" docs --include="*.md" --exclude-dir=".git" || true)

          # truth 参照行（ファイルパスを示すだけの行）は許可
          # ※ 例外が必要ならここに追加していく
          FILTERED=$(echo "${MATCHES}" | grep -vE 'truth/|spec/openapi\.yml|spec/openapi\.yaml' || true)

          if [ -n "${FILTERED}" ]; then
            echo "❌ Docs pollution detected (spec-like numbers in docs/):"
            echo "${FILTERED}"
            echo ""
            echo "→ 数値・条件・制約は truth/** または spec/** に移動してください。"
            if [ "${ENFORCE_DOC_GUARD}" = "true" ]; then
              exit 1
            else
              echo "::warning::Docs pollution detected (WARN mode)."
              exit 0
            fi
          else
            echo "✅ No numeric pollution detected in docs/"
          fi

      # --- 4) Warn when docs changed but truth not changed ---
      - name: Warn if docs changed without truth changes
        run: |
          # PR差分の対象：ベースブランチとの差分
          BASE_REF="${{ github.base_ref }}"
          if [ -z "${BASE_REF}" ]; then
            echo "Not a PR event. Skipping."
            exit 0
          fi

          git fetch origin "${BASE_REF}:${BASE_REF}" --quiet

          CHANGED=$(git diff --name-only "origin/${BASE_REF}...HEAD")
          DOCS_CHANGED=$(echo "${CHANGED}" | grep '^docs/' || true)
          TRUTH_CHANGED=$(echo "${CHANGED}" | grep '^truth/' || true)

          if [ -n "${DOCS_CHANGED}" ] && [ -z "${TRUTH_CHANGED}" ]; then
            echo "⚠ docs/ changed but truth/ not changed."
            echo "Changed docs:"
            echo "${DOCS_CHANGED}"
            echo "::warning::docs/ のみ変更されています。truth/ も更新すべきか確認してください。"
          else
            echo "✅ docs/truth change relationship looks OK"
          fi


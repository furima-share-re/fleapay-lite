name: Migration Safety
on:
  pull_request:
    # Migrationé–¢é€£ãŒå¤‰æ›´ã•ã‚ŒãŸã¨ãã ã‘å®Ÿè¡Œã™ã‚‹ï¼ˆæ—¢å­˜è³‡ç”£ã§è½ã¡ç¶šã‘ã‚‹ã®ã‚’é˜²ãï¼‰
    paths:
      - "migrations/**"
      - "prisma/migrations/**"
      - "backend/migrations/**"
      - "supabase/migrations/**"
      - "scripts/check_migration_safety.py"

jobs:
  migration-safety:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run migration safety gate
        run: python scripts/check_migration_safety.py

      - name: Validate migration file structure
        run: |
          echo "ğŸ” Checking migration file structure..."
          if [ -d "supabase/migrations" ]; then
            for file in supabase/migrations/*.sql; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                if ! [[ "$filename" =~ ^[0-9]{8}_[0-9]{6}_[a-z0-9_]+\.sql$ ]]; then
                  echo "âŒ Invalid migration filename: $filename"
                  echo "   Expected format: YYYYMMDD_HHMMSS_description.sql"
                  exit 1
                fi
              fi
            done
            echo "âœ… All migration files follow naming convention"
          else
            echo "â„¹ï¸  No supabase/migrations directory found"
          fi

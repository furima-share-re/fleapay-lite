# æœ¬ç•ªç’°å¢ƒãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å³æ™‚é©ç”¨æ‰‹é †

**ä½œæˆæ—¥**: 2026-01-14  
**å•é¡Œ**: `fee_rate_master` ã¨ `benchmark_data` ãƒ†ãƒ¼ãƒ–ãƒ«ãŒæœ¬ç•ªç’°å¢ƒã«å­˜åœ¨ã—ãªã„

---

## ğŸ” ç¾åœ¨ã®çŠ¶æ³

æœ¬ç•ªç’°å¢ƒï¼ˆ`edo-ichiba.com`ï¼‰ã§ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿï¼š
- âŒ `relation "fee_rate_master" does not exist`
- âŒ `relation "benchmark_data" does not exist`

**åŸå› **: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã¯å­˜åœ¨ã™ã‚‹ãŒã€æœ¬ç•ªç’°å¢ƒã«é©ç”¨ã•ã‚Œã¦ã„ãªã„

---

## ğŸš€ å³åº§ã«é©ç”¨ã™ã‚‹æ–¹æ³•ï¼ˆæ¨å¥¨ï¼‰

### æ–¹æ³•1: Supabase CLIã‚’ä½¿ç”¨ï¼ˆæœ€ã‚‚ç°¡å˜ãƒ»å®‰å…¨ï¼‰

#### ã‚¹ãƒ†ãƒƒãƒ—1: Supabase CLIã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```powershell
# npmã§ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install -g supabase

# ã¾ãŸã¯ã€npxã‚’ä½¿ç”¨ï¼ˆã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸è¦ï¼‰
npx supabase --version
```

#### ã‚¹ãƒ†ãƒƒãƒ—2: Supabase Access Tokenã‚’å–å¾—

1. Supabase Dashboardã«ãƒ­ã‚°ã‚¤ãƒ³: https://supabase.com/dashboard
2. **Account Settings** â†’ **Access Tokens** ã‚’é–‹ã
3. **Generate new token** ã‚’ã‚¯ãƒªãƒƒã‚¯
4. ãƒˆãƒ¼ã‚¯ãƒ³åã‚’å…¥åŠ›ï¼ˆä¾‹: `migration-token`ï¼‰
5. ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆ**ä¸€åº¦ã—ã‹è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“**ï¼‰

#### ã‚¹ãƒ†ãƒƒãƒ—3: æœ¬ç•ªç’°å¢ƒã®Project IDã‚’ç¢ºèª

1. Supabase Dashboardã§æœ¬ç•ªç’°å¢ƒã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ
2. **Settings** â†’ **General** ã‚’é–‹ã
3. **Reference ID** ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆä¾‹: `xxxxxxxxxxxxx`ï¼‰

#### ã‚¹ãƒ†ãƒƒãƒ—4: æœ¬ç•ªç’°å¢ƒã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨

```powershell
# ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
$env:SUPABASE_ACCESS_TOKEN = "your-access-token-here"
$env:SUPABASE_PROJECT_ID = "your-production-project-id"

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ãƒªãƒ³ã‚¯
npx supabase link --project-ref $env:SUPABASE_PROJECT_ID

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨
npx supabase db push
```

**é‡è¦**: 
- `your-access-token-here` ã‚’ã‚¹ãƒ†ãƒƒãƒ—2ã§å–å¾—ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã«ç½®ãæ›ãˆã‚‹
- `your-production-project-id` ã‚’ã‚¹ãƒ†ãƒƒãƒ—3ã§å–å¾—ã—ãŸProject IDã«ç½®ãæ›ãˆã‚‹

#### ã‚¹ãƒ†ãƒƒãƒ—5: é©ç”¨çµæœã‚’ç¢ºèª

```powershell
# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®é©ç”¨çŠ¶æ³ã‚’ç¢ºèª
npx supabase migration list
```

---

### æ–¹æ³•2: GitHub Actionsã‚’æ‰‹å‹•å®Ÿè¡Œ

#### ã‚¹ãƒ†ãƒƒãƒ—1: GitHubãƒªãƒã‚¸ãƒˆãƒªã«ã‚¢ã‚¯ã‚»ã‚¹

1. GitHubãƒªãƒã‚¸ãƒˆãƒªã‚’é–‹ã
2. **Actions** ã‚¿ãƒ–ã‚’é–‹ã
3. å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ **Apply Migrations** ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’é¸æŠ

#### ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’æ‰‹å‹•å®Ÿè¡Œ

1. **Run workflow** ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
2. ãƒ–ãƒ©ãƒ³ãƒã‚’é¸æŠï¼ˆ`main`ï¼‰
3. **Run workflow** ã‚’ã‚¯ãƒªãƒƒã‚¯

#### ã‚¹ãƒ†ãƒƒãƒ—3: æœ¬ç•ªç’°å¢ƒã¸ã®é©ç”¨ã‚’æ‰¿èª

1. æ¤œè¨¼ç’°å¢ƒã¸ã®é©ç”¨ãŒæˆåŠŸã—ãŸã‚‰ã€æœ¬ç•ªç’°å¢ƒã¸ã®é©ç”¨ãŒæ‰¿èªå¾…ã¡ã«ãªã‚‹
2. **Review deployments** ã‚’ã‚¯ãƒªãƒƒã‚¯
3. **production** ç’°å¢ƒã‚’é¸æŠ
4. **Approve and deploy** ã‚’ã‚¯ãƒªãƒƒã‚¯

---

## ğŸ“‹ é©ç”¨ãŒå¿…è¦ãªãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

ä»¥ä¸‹ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ãŒæœ¬ç•ªç’°å¢ƒã«é©ç”¨ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼š

1. âœ… `supabase/migrations/20250116_120000_create_fee_rate_master.sql`
   - `fee_rate_master` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ

2. âœ… `supabase/migrations/20250117_120000_add_strategy_f_tier_system.sql`
   - `fee_rate_master` ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ‹¡å¼µï¼ˆTieråˆ¶å¯¾å¿œï¼‰
   - `community_goal_master` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ

3. âœ… `supabase/migrations/20260120_120000_create_kpi_management_tables.sql`
   - `benchmark_data` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
   - `kpi_metrics` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
   - `goal_achievements` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ

---

## âœ… é©ç”¨å¾Œã®ç¢ºèª

### 1. APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ç¢ºèª

```powershell
# æ‰‹æ•°æ–™ç‡ãƒã‚¹ã‚¿å–å¾—API
curl -H "x-admin-token: your-admin-token" `
  https://edo-ichiba.com/api/admin/fee-rates

# ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ãƒ‡ãƒ¼ã‚¿å–å¾—API
curl -H "x-admin-token: your-admin-token" `
  "https://edo-ichiba.com/api/admin/benchmark-data?weekStart=2026-01-12"
```

### 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç¢ºèª

Supabase Dashboardã§ä»¥ä¸‹ã‚’ç¢ºèªï¼š
1. **Table Editor** ã‚’é–‹ã
2. ä»¥ä¸‹ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèªï¼š
   - âœ… `fee_rate_master`
   - âœ… `benchmark_data`
   - âœ… `kpi_metrics`
   - âœ… `goal_achievements`
   - âœ… `community_goal_master`

---

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚¨ãƒ©ãƒ¼: "permission denied"

**åŸå› **: Supabase Access Tokenã®æ¨©é™ãŒä¸è¶³ã—ã¦ã„ã‚‹

**è§£æ±ºæ–¹æ³•**:
1. Supabase Dashboardã§ **Account Settings** â†’ **Access Tokens** ã‚’é–‹ã
2. æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆï¼ˆ**Full access** ã‚’é¸æŠï¼‰

### ã‚¨ãƒ©ãƒ¼: "project not found"

**åŸå› **: Project IDãŒé–“é•ã£ã¦ã„ã‚‹

**è§£æ±ºæ–¹æ³•**:
1. Supabase Dashboardã§æœ¬ç•ªç’°å¢ƒã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ
2. **Settings** â†’ **General** ã§ **Reference ID** ã‚’å†ç¢ºèª

### ã‚¨ãƒ©ãƒ¼: "migration already applied"

**åŸå› **: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ—¢ã«é©ç”¨ã•ã‚Œã¦ã„ã‚‹

**è§£æ±ºæ–¹æ³•**: 
- ã“ã®ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ã—ã¦å•é¡Œã‚ã‚Šã¾ã›ã‚“
- ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„

---

## ğŸ“ æ³¨æ„äº‹é …

1. **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—**: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨å‰ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–å¾—ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™
2. **ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ **: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨ä¸­ã¯ã€è©²å½“APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒä¸€æ™‚çš„ã«åˆ©ç”¨ã§ããªããªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
3. **é †åº**: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯æ™‚ç³»åˆ—é †ã«é©ç”¨ã•ã‚Œã¾ã™ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åã®æ—¥æ™‚é †ï¼‰

---

## ğŸ”— é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- `supabase/migrations/20250116_120000_create_fee_rate_master.sql`
- `supabase/migrations/20250117_120000_add_strategy_f_tier_system.sql`
- `supabase/migrations/20260120_120000_create_kpi_management_tables.sql`
- `.github/workflows/apply-migrations.yml`
- `æœ¬ç•ªç’°å¢ƒãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨ã‚¬ã‚¤ãƒ‰.md`

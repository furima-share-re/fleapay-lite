# 技術スタック整合化ロードマップ：AI駆動開発 × edoichiba (FleaPay)

**参考元**: `AI駆動開発 と edoichiba 技術スタック比較 (1).html`

> **注意**: 本ドキュメントは意思決定の根拠（ADR）です。数値・条件の詳細は `truth/` を参照してください。

---

## エグゼクティブサマリー

### 現状の課題

現在のedoichibaはExpress.js + Vanilla JS構成であり、AI（LLM）が最も得意とする「型安全なモダンReact構成」と乖離があります。このため、AIによるコード修正成功率が60%程度に留まり、バグ混入リスクが高い状態です。

### 期待される効果

AI駆動開発標準スタック（Next.js App Router + TypeScript）へ移行することで、AI修正成功率を98%まで引き上げます。これにより、開発速度の向上と、人的ミスの劇的な削減を実現します。

### 主要指標

- AI修正成功率: 60% → 98%
- 推奨移行期間: 3-6ヶ月
- 投資対効果(ROI): High
- 運用コスト基盤: 維持

---

## 技術スタック比較マトリクス

| カテゴリ | AI駆動開発（推奨） | edoichiba（現状） | ギャップ | AI修正成功率への影響 |
|---------|------------------|------------------|---------|-------------------|
| フロントエンド基盤 | Next.js 14 App Router | Vanilla JS + HTML | × | 極大（コンポーネント理解不能） |
| 言語・型安全性 | TypeScript (Strict) | JavaScript (No Type) | × | 極大（幻覚によるバグ発生） |
| バックエンド | Server Actions | Express.js (server.js) | △ | 大（API型定義の欠如） |
| DBアクセス | Prisma ORM | 直接SQL実行 (pg) | △ | 中（スキーマ変更リスク） |
| 開発環境 | GitHub Codespaces | ローカル個別構築 | △ | 中（環境依存エラー） |
| インフラ | Render / Vercel | Render | ◎ | なし（互換性あり） |

---

## 重大な技術的ギャップ詳細分析

### 3.1 フロントエンド構成

**Vanilla JS → Next.js + TS**

- **影響**: AI修正成功率 60% → 98%
- **理由**: LLMの学習データはReactエコシステムが圧倒的に多く、Vanilla JSのDOM操作はコンテキストを見失いやすいため。

### 3.2 バックエンドアーキテクチャ

**Express.js単一ファイル → Server Actions**

- **影響**: 型安全性の確保、デプロイ同期リスク解消
- **理由**: フロントエンドとバックエンドで型定義を自動共有でき、APIドキュメント管理が不要になるため。

### 3.3 データベースアクセス層

**直接SQL → Prisma ORM**

- **影響**: マイグレーション事故の防止
- **理由**: AIはPrisma Schemaの理解度が非常に高く、正確なマイグレーションファイルを生成できるため。

### 3.4 開発環境

**ローカル構築 → GitHub Codespaces**

- **影響**: 環境差異による「動かない」の撲滅
- **理由**: コンテナベースで全員（AI含む）が完全に同一の環境で作業できるため。

---

## 段階的移行計画

### Phase 0: 現状維持（移行不要な要素）

以下の要素はAI駆動開発においても有効、または移行コストに見合わないため維持します。

| 要素 | 現状技術 | 判断理由 |
|-----|---------|---------|
| 決済基盤 | Stripe | 業界標準であり、AIのサポートも手厚いため |
| ストレージ | AWS S3 | 変更する必要性がないインフラ要素 |
| AI連携 | OpenAI API | コア機能であり維持 |
| インフラ | Render | Next.jsのホスティングもサポートしており、移行不要 |

### Phase 1: 緊急対応（2-3週間） HIGH PRIORITY

**目標**: AI修正成功率 60% → 85% / 環境構築時間 5分以下

**実施項目:**
- ✅ TypeScript導入: 既存JSへのJSDoc型付け、または段階的な.ts化
- ✅ Prisma ORM導入: 既存DBからスキーマをPullし、SQLベタ書きを廃止
- ✅ Codespaces化: devcontainer定義ファイルの追加

### Phase 2: 基盤移行（1-2ヶ月） HIGH PRIORITY

**目標**: AI修正成功率 85% → 95% / 完全なモダン構成へ

**実施項目:**
- ✅ Next.js App Router移行: ExpressルートをRoute Handlersへ置換
- ✅ コンポーネント化: Tailwind CSS + shadcn/ui の導入
- ✅ Server Actions化: 内部API呼び出しの関数化

**技術戦略**: ExpressとNext.jsを一時的に共存させ、画面単位で段階的にカットオーバーを行います。

### Phase 3: 最適化（2-3ヶ月） MEDIUM

- ✅ 完全TypeScript化（any型排除）
- ✅ React Hook Form + Zod統合
- ✅ Helicone統合（LLMコスト・品質監視）
- ✅ Sentry統合（エラー監視）

### Phase 4: 運用自動化（3-6ヶ月） LOW

- ✅ 自動テスト（E2E）の拡充
- ✅ 自動ロールバック機構
- ✅ AI駆動開発9原則の完全実装

---

## 技術選択の判断基準マトリクス

| 評価軸 | 重要度 | 現状スコア | 移行後スコア | ROI評価 |
|-------|-------|----------|------------|---------|
| AI修正成功率 | 高 | 3.0 / 10 | 9.8 / 10 | 極めて高い |
| 開発速度 | 高 | 4.0 / 10 | 9.0 / 10 | 高い |
| 学習コスト | 中 | 8.0 / 10 | 6.0 / 10 | 一時的低下 |
| 運用コスト | 中 | ¥0増 | 微増 | 許容範囲 |
| セキュリティ | 高 | 5.0 / 10 | 9.0 / 10 | 大幅改善 |

---

## リスク評価と対策

| リスク項目 | レベル | 対策 |
|----------|-------|------|
| 移行中のサービス停止 | High | Express/Next.js並行稼働構成とし、リバースプロキシで振り分ける |
| データ損失・不整合 | High | DBスキーマ変更はPrisma Migrateのドライランで必ず検証。バックアップ自動化 |
| 学習コスト超過 | Med | 実装詳細をAIに任せ、人間は「仕様」と「レビュー」に集中する体制へシフト |
| パフォーマンス劣化 | Low | Server Components活用により、クライアントJS量を削減 |

---

## コスト影響分析

| 項目 | 現状月額 (概算) | 移行後月額 (概算) | 差額 |
|-----|--------------|----------------|------|
| 開発環境 (Cursor/Codespaces) | $20 | $40 | +$20 |
| インフラ (Render) | $25 | $25 | $0 |
| 監視 (Helicone/Sentry) | $0 | $76 | +$76 |
| AI API / Stripe | 従量 | 従量 | $0 |
| **総計** | **$45~** | **$141~** | **+$96** |

> **注意**: 月額約$100のコスト増となりますが、開発効率向上による人的コスト削減効果（月数十時間分）により、ROIはプラスとなります。

---

## 統合後の推奨技術スタック完全版

### フロントエンド
- **FW**: Next.js 14 App Router
- **Lang**: TypeScript
- **Style**: Tailwind CSS
- **UI**: shadcn/ui
- **Form**: React Hook Form + Zod

### バックエンド
- **FW**: Next.js (Server Actions)
- **API**: Route Handlers
- **Runtime**: Node.js
- **Lang**: TypeScript

### データベース
- **Engine**: PostgreSQL (Render)
- **ORM**: Prisma
- **Migration**: AI生成
- **Control**: Git管理

### インフラ・運用
- **Host**: Render
- **Env**: GitHub Codespaces
- **CI/CD**: GitHub Actions
- **Monitor**: Helicone + Sentry

---

## マイルストーン・タイムライン

| Phase | 期間 | 主要タスク | 完了条件 |
|------|------|----------|---------|
| Phase 1 | Week 1-3 | TypeScript/Prisma導入 | 型チェックが通る、Prisma経由でDB操作可能 |
| Phase 2 | Month 2 | Next.js移行、UI刷新 | 全画面がApp Routerで動作、Express廃止 |
| Phase 3 | Month 3-4 | 最適化・監視導入 | Helicone/Sentryでの可視化完了 |
| Phase 4 | Month 5-6 | 運用自動化 | デプロイ・ロールバックの完全自動化 |

---

## 成功指標 (KPI)

| 指標 | 現状値 | Phase 1目標 | 最終目標 |
|-----|-------|-----------|---------|
| AI修正成功率 | 60% | 85% | **98%** |
| 機能追加リードタイム | 3日 | 2日 | **0.5日** |
| 障害発生率 | 高 | 中 | **極低** |
| 環境構築時間 | 120分 | 5分 | **5分** |

---

## 推奨アクション

### 今週実施すべきこと

1. 現状のPostgreSQLスキーマをバックアップ
2. Prismaをインストールし、`db pull` でスキーマ定義を生成
3. GitHub Codespacesを有効化し、チーム全員の環境を統一

### 今月実施すべきこと

1. Next.js 14のプロジェクトスケルトン作成
2. 既存Express APIのTypeScript型定義作成
3. 最初の1画面（例：商品一覧）のみNext.jsへ移植し、本番疎通確認

---

*Document Version: 1.0*  
*Last Updated: 2025*  
*参考元: AI駆動開発 と edoichiba 技術スタック比較 (1).html*

